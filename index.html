<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a12">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Tarot de los 28 Arcanos - Los Trabajos de H√©rcules">
    <title>Tarot 28 Arcanos - v2.6.5</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="tarot-images.js"></script>
    <style>
        :root {
            --bg-deep: #0a0a12;
            --bg-card: #12121f;
            --bg-elevated: #1a1a2e;
            --gold: #d4a853;
            --gold-light: #f0d890;
            --gold-dark: #a67c31;
            --text: #e8e8f0;
            --text-dim: #888899;
            --accent-purple: #6b4c9a;
            --accent-blue: #2a4a6e;
            --danger: #c44;
            --success: #4a8;
            --radius: 16px;
            --shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Cormorant Garamond', Georgia, serif;
            background: var(--bg-deep);
            color: var(--text);
            line-height: 1.6;
        }

        /* ===== APP CONTAINER ===== */
        .app {
            height: 100%;
            max-width: 100%;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            background: 
                radial-gradient(ellipse at 50% 0%, rgba(107, 76, 154, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(42, 74, 110, 0.1) 0%, transparent 40%),
                var(--bg-deep);
        }

        /* ===== HEADER ===== */
        .header {
            padding: 16px 20px;
            text-align: center;
            background: linear-gradient(to bottom, rgba(10,10,18,0.95), transparent);
            position: relative;
            z-index: 100;
        }

        .header h1 {
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--gold);
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        .header-sub {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-top: 4px;
        }

        /* ===== NAVIGATION ===== */
        .nav {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-card);
            border-bottom: 1px solid rgba(212,168,83,0.2);
        }

        .nav-btn {
            background: transparent;
            border: 1px solid rgba(212,168,83,0.3);
            color: var(--text-dim);
            padding: 10px 18px;
            border-radius: 25px;
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--gold-dark), var(--gold));
            color: var(--bg-deep);
            border-color: var(--gold);
        }

        .nav-btn:not(.active):hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        /* ===== MAIN CONTENT ===== */
        .main {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            scroll-behavior: smooth;
        }

        .main::-webkit-scrollbar {
            width: 4px;
        }

        .main::-webkit-scrollbar-thumb {
            background: var(--gold-dark);
            border-radius: 2px;
        }

        /* ===== SCREENS ===== */
        .screen {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== HOY SCREEN ===== */
        .hoy-card {
            background: var(--bg-elevated);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(212,168,83,0.2);
            box-shadow: var(--shadow);
        }

        .hoy-date {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: var(--gold);
            text-align: center;
            margin-bottom: 16px;
            letter-spacing: 0.1em;
        }

        .hoy-exaltacion {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, rgba(107,76,154,0.2), rgba(42,74,110,0.2));
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .hoy-exaltacion-simbolos {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .hoy-exaltacion-texto {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: var(--gold-light);
        }

        .hoy-mito {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .hoy-mito-titulo {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: var(--gold);
            margin-bottom: 8px;
        }

        .hoy-mito-texto {
            font-size: 0.95rem;
            color: var(--text-dim);
            font-style: italic;
            line-height: 1.7;
        }

        .hoy-esencia {
            text-align: center;
            font-size: 1.1rem;
            color: var(--text);
            padding: 16px;
            border-left: 3px solid var(--gold);
            background: rgba(212,168,83,0.05);
            margin: 16px 0;
        }

        .hoy-interpretacion {
            font-size: 1rem;
            color: var(--text-light);
            line-height: 1.7;
            padding: 16px;
            background: rgba(212,168,83,0.1);
            border-left: 3px solid var(--gold);
            border-radius: 0 12px 12px 0;
            margin: 16px 0;
        }

        .hoy-figuras, .hoy-aspectos, .hoy-transitos-natal {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }

        .hoy-section-title {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            color: var(--gold);
            margin-bottom: 12px;
            text-align: center;
        }

        .hoy-figura-item {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .hoy-figura-item strong {
            color: var(--gold);
        }

        .hoy-figura-item em {
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        .figura-planetas {
            display: block;
            font-size: 0.8rem;
            color: #9b8cd4;
            margin: 4px 0;
        }

        .hoy-aspectos-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 12px;
        }

        .hoy-aspecto-item {
            background: rgba(0,0,0,0.3);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 1rem;
            border: 1px solid;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .hoy-aspecto-item small {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .hoy-aspectos-detalle {
            border-top: 1px solid rgba(212,168,83,0.2);
            padding-top: 12px;
            margin-top: 8px;
        }

        .aspecto-explicacion {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 8px;
            padding: 6px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
        }

        .aspecto-explicacion em {
            color: var(--text);
        }

        .hoy-transitos-natal {
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .hoy-figuras-natal {
            margin-bottom: 12px;
        }

        .hoy-colores {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }

        .hoy-colores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
        }

        .hoy-color-item {
            background: rgba(0,0,0,0.2);
            padding: 8px 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .color-planeta {
            font-size: 1.3rem;
        }

        .color-funcion {
            font-size: 0.75rem;
            color: var(--text-dim);
            line-height: 1.2;
        }

        .hoy-posiciones {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            text-align: center;
        }

        .hoy-posiciones-titulo {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: var(--gold);
            margin-bottom: 12px;
        }

        .hoy-posiciones-grid {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .hoy-planeta-pos {
            font-size: 1.2rem;
            padding: 6px 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            cursor: help;
        }

        .hoy-exaltacion-subtitulo {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 4px;
        }

        .hoy-fase {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-top: 16px;
        }

        .hoy-fase-emoji {
            font-size: 2rem;
        }

        .hoy-fase-info {
            text-align: left;
        }

        .hoy-fase-nombre {
            font-family: 'Cinzel', serif;
            color: var(--text);
        }

        .hoy-fase-dia {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        /* Carta del d√≠a */
        .carta-dia-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .carta-dia {
            width: 145px;
            height: 280px;  /* Proporci√≥n 1:1.94 como las im√°genes originales */
            perspective: 1000px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .carta-dia-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .carta-dia.revelada .carta-dia-inner {
            transform: rotateY(180deg);
        }

        .carta-dia-front, .carta-dia-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .carta-dia-front {
            background: 
                repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(212,168,83,0.03) 10px, rgba(212,168,83,0.03) 20px),
                linear-gradient(135deg, #1a1a4e, #2a2a6e);
            border: 2px solid var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .carta-dia-front::before {
            content: 'üÉè';
            font-size: 3rem;
            opacity: 0.6;
        }

        .carta-dia-front::after {
            content: 'Toca para revelar';
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            color: var(--gold);
            margin-top: 12px;
            opacity: 0.7;
            letter-spacing: 0.1em;
        }

        .carta-dia-back {
            transform: rotateY(180deg);
            background: #f5f0e6;
            overflow: hidden;
        }

        .carta-dia-back img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .carta-dia.invertida .carta-dia-back img {
            transform: rotate(180deg);
        }

        .carta-dia-info {
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s 0.5s;
        }

        .carta-dia.revelada + .carta-dia-info,
        .carta-dia-info.visible {
            opacity: 1;
        }

        .carta-dia-nombre {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            color: var(--gold);
            margin-bottom: 8px;
        }

        .carta-dia-estado {
            display: inline-block;
            padding: 4px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-bottom: 12px;
        }

        .carta-dia-estado.normal {
            background: rgba(68, 170, 136, 0.2);
            color: var(--success);
        }

        .carta-dia-estado.invertida {
            background: rgba(204, 68, 68, 0.2);
            color: var(--danger);
        }

        .carta-dia-significado {
            font-size: 1rem;
            color: var(--text);
            line-height: 1.7;
            max-width: 320px;
            margin: 0 auto;
        }

        .btn-nueva-carta {
            margin-top: 20px;
            background: transparent;
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 12px 28px;
            border-radius: 25px;
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-nueva-carta:hover {
            background: var(--gold);
            color: var(--bg-deep);
        }

        /* ===== TIRADAS SCREEN ===== */
        .tiradas-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .tirada-card {
            background: var(--bg-elevated);
            border: 1px solid rgba(212,168,83,0.15);
            border-radius: var(--radius);
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .tirada-card:hover, .tirada-card:active {
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(212,168,83,0.15);
        }

        .tirada-card.especial {
            grid-column: span 2;
            background: linear-gradient(135deg, rgba(107,76,154,0.3), rgba(42,74,110,0.3));
        }

        .tirada-num {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: var(--gold);
            margin-bottom: 4px;
        }

        .tirada-nombre {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: var(--text);
            margin-bottom: 4px;
        }

        .tirada-desc {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* ===== TIRADA ACTIVA ===== */
        .tirada-activa {
            text-align: center;
        }

        .tirada-titulo {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            color: var(--gold);
            margin-bottom: 8px;
        }

        .tirada-subtitulo {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-bottom: 24px;
        }

        .cartas-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .carta-mini {
            width: 62px;
            height: 120px;  /* Proporci√≥n 1:1.94 */
            perspective: 800px;
            cursor: pointer;
        }

        .carta-mini.small {
            width: 46px;
            height: 89px;
        }

        .carta-mini.tiny {
            width: 38px;
            height: 74px;
        }

        .carta-mini-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }

        .carta-mini.revelada .carta-mini-inner {
            transform: rotateY(180deg);
        }

        .carta-mini-front, .carta-mini-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .carta-mini-front {
            background: linear-gradient(135deg, #1a1a4e, #2a2a6e);
            border: 1px solid var(--gold-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--gold);
            opacity: 0.6;
        }

        .carta-mini-front::before {
            content: '‚ú¶';
        }

        .carta-mini.small .carta-mini-front::before,
        .carta-mini.tiny .carta-mini-front::before {
            font-size: 1rem;
        }

        .carta-mini-back {
            transform: rotateY(180deg);
            background: #f5f0e6;
            overflow: hidden;
        }

        .carta-mini-back img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .carta-mini.invertida .carta-mini-back img {
            transform: rotate(180deg);
        }

        .carta-mini-pos {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 6px;
            text-align: center;
            max-width: 70px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .btn-revelar-todas {
            background: linear-gradient(135deg, var(--gold-dark), var(--gold));
            color: var(--bg-deep);
            border: none;
            padding: 14px 32px;
            border-radius: 25px;
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 16px;
        }

        .btn-revelar-todas:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(212,168,83,0.3);
        }

        .btn-volver {
            background: transparent;
            border: 1px solid var(--text-dim);
            color: var(--text-dim);
            padding: 10px 24px;
            border-radius: 20px;
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-volver:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        /* Lectura detallada */
        .lectura-container {
            margin-top: 24px;
        }

        .lectura-item {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            gap: 16px;
            border: 1px solid rgba(212,168,83,0.1);
        }

        .lectura-img {
            width: 70px;
            flex-shrink: 0;
        }

        .lectura-img img {
            width: 100%;
            height: 136px;  /* Proporci√≥n 1:1.94 */
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .lectura-img.invertida img {
            transform: rotate(180deg);
        }

        .lectura-content {
            flex: 1;
            min-width: 0;
        }

        .lectura-pos {
            font-size: 0.75rem;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }

        .lectura-nombre {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            color: var(--text);
            margin-bottom: 4px;
        }

        .lectura-estado {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-bottom: 8px;
        }

        .lectura-estado.normal {
            background: rgba(68, 170, 136, 0.2);
            color: var(--success);
        }

        .lectura-estado.invertida {
            background: rgba(204, 68, 68, 0.2);
            color: var(--danger);
        }

        .lectura-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }

        .lectura-tag {
            background: rgba(212,168,83,0.15);
            color: var(--gold);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .lectura-sig {
            font-size: 0.9rem;
            color: var(--text-dim);
            line-height: 1.6;
        }

        /* ===== CALENDARIO SCREEN ===== */
        .calendario-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .calendario-nav-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--gold-dark);
            color: var(--gold);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .calendario-nav-btn:hover {
            background: var(--gold);
            color: var(--bg-deep);
        }

        .calendario-year-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .year-input {
            background: var(--bg-card);
            border: 1px solid rgba(212,168,83,0.5);
            color: var(--gold);
            padding: 10px 16px;
            border-radius: 20px;
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            width: 100px;
            text-align: center;
            outline: none;
        }

        .year-input:focus {
            border-color: var(--gold);
            box-shadow: 0 0 10px rgba(212,168,83,0.3);
        }

        .year-btn {
            background: var(--bg-elevated);
            border: 1px solid rgba(212,168,83,0.3);
            color: var(--gold);
            padding: 10px 16px;
            border-radius: 20px;
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .year-btn:hover {
            background: var(--gold);
            color: var(--bg-deep);
        }

        .year-label {
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        .calendario-mes-titulo {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: var(--gold);
            text-align: center;
        }

        .calendario-ciclo {
            font-size: 0.8rem;
            color: var(--text-dim);
            text-align: center;
        }

        .calendario-dias-semana {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }

        .dia-semana-header {
            text-align: center;
            font-size: 0.7rem;
            color: var(--text-dim);
            padding: 8px 0;
            font-family: 'Cinzel', serif;
        }

        .calendario-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .cal-dia {
            aspect-ratio: 1;
            background: var(--bg-elevated);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            padding: 4px;
        }

        .cal-dia:hover {
            border-color: var(--gold);
        }

        .cal-dia.hoy {
            border-color: var(--gold);
            background: rgba(212,168,83,0.15);
        }

        .cal-dia.vacio {
            background: transparent;
            cursor: default;
        }

        .cal-dia-fecha {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .cal-dia-fase {
            font-size: 1.2rem;
            margin: 1px 0;
        }

        .cal-dia-planeta {
            font-size: 1.1rem;
            color: var(--gold);
        }
        
        .cal-dia-eventos {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--danger);
            color: white;
            font-size: 0.6rem;
            font-weight: 700;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cal-dia { position: relative; }

        /* ===== RESPONSIVE - M√ìVILES ===== */
        @media (max-width: 480px) {
            /* App general */
            .app {
                padding: 0;
            }
            
            .screen {
                width: 100%;
                overflow-x: hidden;
            }
            
            /* Header */
            .header {
                padding: 10px 12px;
            }
            .header-title {
                font-size: 1.1rem;
                letter-spacing: 0.1em;
            }
            .header-sub {
                font-size: 0.7rem;
            }
            
            /* Navegaci√≥n principal */
            .nav {
                padding: 8px 4px;
                gap: 3px;
                flex-wrap: wrap;
                justify-content: center;
            }
            .nav-btn {
                padding: 6px 10px;
                font-size: 0.6rem;
                letter-spacing: 0.03em;
            }
            
            /* Main content */
            .main {
                padding: 8px;
            }
            
            /* Calendario */
            .calendario-year-selector {
                flex-wrap: wrap;
                gap: 4px;
                justify-content: center;
                margin-bottom: 8px;
            }
            .year-label {
                font-size: 0.75rem;
            }
            .year-input {
                width: 55px;
                padding: 5px;
                font-size: 0.8rem;
            }
            .year-btn {
                padding: 5px 8px;
                font-size: 0.7rem;
            }
            .calendario-tools {
                flex-wrap: wrap;
                gap: 3px;
                justify-content: center;
                margin-bottom: 8px;
            }
            .tool-btn {
                padding: 5px 8px;
                font-size: 0.6rem;
            }
            .calendario-header {
                padding: 4px;
                gap: 2px;
            }
            .calendario-nav-btn {
                padding: 4px 8px;
                font-size: 0.9rem;
            }
            .calendario-mes-titulo {
                font-size: 0.8rem;
            }
            .calendario-ciclo {
                font-size: 0.6rem;
            }
            .calendario-dias-semana {
                gap: 1px;
                width: 100%;
            }
            .dia-semana-header {
                font-size: 0.55rem;
                padding: 3px 0;
            }
            .calendario-grid {
                gap: 1px;
                width: 100%;
            }
            .cal-dia {
                border-radius: 4px;
                padding: 2px;
                aspect-ratio: auto;
                min-height: 45px;
            }
            .cal-dia-fecha {
                font-size: 0.7rem;
            }
            .cal-dia-fase {
                font-size: 0.75rem;
                margin: 0;
            }
            .cal-dia-planeta {
                font-size: 0.7rem;
            }
            .cal-dia-eventos {
                width: 12px;
                height: 12px;
                font-size: 0.5rem;
                top: 1px;
                right: 1px;
            }
            
            /* Modal */
            .modal {
                padding: 10px;
                margin: 5px;
                max-height: 92vh;
                width: calc(100% - 10px);
                border-radius: 12px;
            }
            .modal-header {
                padding: 10px;
            }
            .modal-title {
                font-size: 0.95rem;
            }
            .modal-body {
                font-size: 0.8rem;
                padding: 10px;
            }
            .modal-subtitle {
                font-size: 0.7rem;
            }
            .modal-close {
                font-size: 1.2rem;
                padding: 4px;
            }
            
            /* Pantalla Hoy */
            .hoy-card {
                padding: 16px;
            }
            .hoy-section-title {
                font-size: 0.8rem;
            }
            .carta-dia-container {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 10px;
            }
            .carta-dia {
                width: 110px;
                height: 185px;
            }
            .carta-dia-nombre {
                font-size: 0.9rem;
            }
            .carta-dia-estado {
                font-size: 0.7rem;
                padding: 3px 10px;
            }
            .carta-dia-significado {
                font-size: 0.75rem;
            }
            .hoy-fase, .hoy-exalt {
                font-size: 0.75rem;
            }
            .hoy-date {
                font-size: 0.85rem;
            }
            .hoy-interpretacion {
                font-size: 0.8rem;
                padding: 12px;
            }
            
            /* Personal - Signos */
            .perfil-signos {
                gap: 12px;
                flex-wrap: wrap;
                justify-content: center;
            }
            .perfil-signo-symbol {
                font-size: 1.5rem;
            }
            .perfil-signo-label {
                font-size: 0.6rem;
            }
            
            /* Personal - Tabs */
            .personal-tabs {
                gap: 3px;
                justify-content: center;
            }
            .personal-tab {
                padding: 5px 8px;
                font-size: 0.55rem;
            }
            .setup-card {
                padding: 12px;
            }
            .setup-title {
                font-size: 1rem;
            }
            .setup-desc {
                font-size: 0.8rem;
            }
            .form-group {
                margin-bottom: 10px;
            }
            .form-label {
                font-size: 0.75rem;
            }
            .form-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .analysis-card {
                padding: 10px;
                margin-bottom: 10px;
            }
            .analysis-card h3 {
                font-size: 0.85rem;
            }
            .analysis-card p, .analysis-card li {
                font-size: 0.8rem;
            }
            
            /* Formularios */
            .form-input, .form-input-event, select, input[type="date"], input[type="time"], input[type="text"], textarea {
                font-size: 16px;
                padding: 8px;
            }
            .category-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 4px;
            }
            .category-item {
                padding: 6px 3px;
            }
            .category-icon {
                font-size: 1rem;
            }
            .category-label {
                font-size: 0.5rem;
            }
            
            /* Eventos */
            .events-section {
                padding: 10px;
            }
            .events-section-title {
                font-size: 0.85rem;
            }
            .event-item {
                padding: 8px;
            }
            .proximos-eventos-section {
                padding: 10px;
                margin-top: 12px;
            }
            .proximos-eventos-title {
                font-size: 0.9rem;
            }
            
            /* B√∫squeda y Pron√≥stico */
            .pronostico-tabs {
                gap: 4px;
            }
            .pronostico-tab {
                padding: 5px 12px;
                font-size: 0.7rem;
            }
            .pronostico-dia-header {
                padding: 8px 10px;
            }
            .pronostico-dia-fecha {
                font-size: 0.8rem;
            }
            .pronostico-dia-content {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            .search-cat-btn {
                font-size: 0.6rem;
                padding: 4px 6px;
            }
            .search-filters {
                gap: 8px;
            }
            .search-row {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            .search-result-item {
                padding: 8px;
            }
            .search-result-title {
                font-size: 0.85rem;
            }
            .search-result-date {
                font-size: 0.7rem;
            }
            
            /* Aspectos y patrones */
            .aspecto-item, .patron-badge {
                font-size: 0.75rem;
                padding: 5px 7px;
            }
            .section-title {
                font-size: 0.75rem;
            }
            .figura-planetas {
                font-size: 0.7rem;
            }
            
            /* Tiradas */
            .tirada-card {
                padding: 12px;
            }
            .tirada-card h3 {
                font-size: 0.95rem;
            }
            .tirada-card p {
                font-size: 0.8rem;
            }
            .lectura-carta {
                width: 60px;
            }
            .lectura-carta-nombre {
                font-size: 0.65rem;
            }
        }
        
        @media (max-width: 360px) {
            .header-title {
                font-size: 0.9rem;
            }
            .header-sub {
                font-size: 0.6rem;
            }
            .nav-btn {
                padding: 5px 7px;
                font-size: 0.5rem;
            }
            .dia-semana-header {
                font-size: 0.5rem;
            }
            .cal-dia {
                min-height: 40px;
            }
            .cal-dia-fecha {
                font-size: 0.6rem;
            }
            .cal-dia-fase {
                font-size: 0.65rem;
            }
            .cal-dia-planeta {
                font-size: 0.6rem;
            }
            .tool-btn {
                padding: 4px 6px;
                font-size: 0.55rem;
            }
            .modal {
                margin: 3px;
                padding: 8px;
                width: calc(100% - 6px);
            }
            .modal-title {
                font-size: 0.85rem;
            }
            .carta-dia {
                width: 90px;
                height: 150px;
            }
            .carta-dia-nombre {
                font-size: 0.8rem;
            }
            .carta-dia-significado {
                font-size: 0.7rem;
            }
            .personal-tab {
                padding: 4px 5px;
                font-size: 0.45rem;
            }
            .perfil-signo-symbol {
                font-size: 1.2rem;
            }
            .category-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .hoy-section-title {
                font-size: 0.7rem;
            }
            .hoy-card {
                padding: 12px;
            }
        }
        
        /* Pr√≥ximos Eventos */
        .proximos-eventos-section {
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
        }
        
        .proximos-eventos-title {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: var(--gold);
            margin-bottom: 12px;
        }
        
        .proximos-eventos-fecha {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-dim);
            padding: 8px 0 4px 0;
            border-bottom: 1px solid rgba(212,168,83,0.2);
            margin-top: 8px;
        }
        
        .proximos-eventos-fecha:first-of-type { margin-top: 0; }
        
        .proximo-evento-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            margin-top: 8px;
            background: var(--bg-elevated);
            border-radius: 8px;
            border-left: 3px solid var(--gold);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .proximo-evento-item:hover { transform: translateX(4px); }
        
        .proximo-evento-hora {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gold);
            min-width: 50px;
        }
        
        .proximo-evento-info { flex: 1; }
        
        .proximo-evento-titulo {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .proximo-evento-cat {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* Modal d√≠a */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-elevated);
            border-radius: var(--radius);
            max-width: 400px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid var(--gold-dark);
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(212,168,83,0.2);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: var(--gold);
        }

        .modal-subtitle {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-top: 4px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-carta {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .modal-carta img {
            width: 100px;
            height: 194px;  /* Proporci√≥n 1:1.94 */
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
        }

        .modal-carta-info {
            flex: 1;
        }

        .modal-carta-nombre {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: var(--text);
            margin-bottom: 8px;
        }

        .modal-interpretacion {
            font-size: 1rem;
            color: var(--text-light);
            line-height: 1.7;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(212,168,83,0.1);
            border-left: 3px solid var(--gold);
            border-radius: 0 12px 12px 0;
        }

        .modal-posiciones {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
            text-align: center;
        }

        .modal-posiciones-titulo {
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            color: var(--gold);
            margin-bottom: 8px;
        }

        .modal-posiciones-grid {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .planeta-pos {
            font-size: 1.1rem;
            padding: 4px 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            cursor: help;
        }

        .modal-mito {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 16px;
        }

        .modal-mito-titulo {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: var(--gold);
            margin-bottom: 8px;
        }

        .modal-mito-texto {
            font-size: 0.9rem;
            color: var(--text-dim);
            font-style: italic;
            line-height: 1.7;
        }
        
        /* Secci√≥n compartir */
        .share-section {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(212,168,83,0.2);
        }
        
        .share-title {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 12px;
            text-align: center;
        }
        
        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .share-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .share-btn:hover { transform: scale(1.1); }
        
        .share-btn.twitter {
            background: #000;
            color: white;
            font-weight: bold;
            font-family: Arial, sans-serif;
        }
        
        .share-btn.facebook {
            background: #1877f2;
            color: white;
            font-weight: bold;
            font-family: Arial, sans-serif;
            font-size: 1.4rem;
        }
        
        .share-btn.whatsapp {
            background: #25d366;
            color: white;
        }
        
        .share-btn.telegram {
            background: #0088cc;
            color: white;
        }
        
        .share-btn.copy {
            background: var(--bg-elevated);
            border: 1px solid var(--gold);
            color: var(--gold);
        }
        
        .share-btn-main {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .share-btn-main:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        /* Modal compartir imagen */
        .share-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .share-modal.active { display: flex; }
        
        .share-modal-content {
            background: var(--bg-elevated);
            border-radius: 16px;
            padding: 20px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .share-modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .share-modal-title {
            text-align: center;
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: var(--gold);
            margin-bottom: 15px;
        }
        
        .share-modal-preview {
            background: var(--bg-deep);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .share-modal-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
        }
        
        .share-modal-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .share-modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .share-modal-btn.native {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .share-modal-btn.download {
            background: linear-gradient(135deg, var(--gold), #c49b38);
            color: var(--bg-deep);
        }
        
        .share-modal-btn:hover { transform: scale(1.02); }
        
        .share-modal-redes {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .share-modal-hint {
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-dim);
            margin: 0;
        }

        /* ===== LOADING ===== */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bg-elevated);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== CREDITS ===== */
        .credits {
            text-align: center;
            padding: 20px;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .credits a {
            color: var(--gold);
            text-decoration: none;
        }

        /* ===== INSTALL PROMPT ===== */
        .install-prompt {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: var(--bg-elevated);
            border: 1px solid var(--gold);
            border-radius: var(--radius);
            padding: 16px;
            z-index: 500;
            box-shadow: var(--shadow);
        }

        .install-prompt.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .install-prompt-text {
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .install-prompt-btns {
            display: flex;
            gap: 12px;
        }

        .install-btn {
            flex: 1;
            padding: 10px;
            border-radius: 20px;
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .install-btn.primary {
            background: var(--gold);
            color: var(--bg-deep);
            border: none;
        }

        .install-btn.secondary {
            background: transparent;
            color: var(--text-dim);
            border: 1px solid var(--text-dim);
        }

        /* ===== AGENDA / EVENTOS ===== */
        
        /* Fotos y v√≠deos en eventos */
        .media-upload-section {
            margin: 16px 0;
        }
        
        .media-upload-btns {
            display: flex;
            gap: 10px;
        }
        
        .media-upload-btn {
            flex: 1;
            background: var(--bg-card);
            border: 2px dashed rgba(212,168,83,0.3);
            border-radius: 12px;
            padding: 16px 10px;
            color: var(--text-dim);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        
        .media-upload-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
        }
        
        .media-upload-btn .icon {
            font-size: 1.4rem;
        }
        
        .photos-preview-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        
        .photo-preview-item {
            position: relative;
            width: 70px;
            height: 70px;
        }
        
        .photo-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid rgba(212,168,83,0.3);
        }
        
        .photo-preview-item .remove-photo {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            background: var(--danger);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .video-input-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .video-input-row input {
            flex: 1;
        }
        
        .video-input-row button {
            background: var(--gold);
            border: none;
            color: var(--bg-deep);
            padding: 0 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .videos-list {
            margin-top: 10px;
        }
        
        .video-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-card);
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        
        .video-item .video-url {
            flex: 1;
            color: var(--accent-blue);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .video-item .remove-video {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
        }
        
        /* Vista de evento con fotos */
        .event-detail-photos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin: 16px 0;
        }
        
        .event-detail-photos img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .event-detail-videos {
            margin: 16px 0;
        }
        
        .event-detail-videos iframe {
            width: 100%;
            aspect-ratio: 16/9;
            border: none;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .event-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(212,168,83,0.2);
        }
        
        .event-btn-edit, .event-btn-delete {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .event-btn-edit {
            background: var(--bg-card);
            border: 1px solid var(--gold);
            color: var(--gold);
        }
        
        .event-btn-delete {
            background: var(--bg-card);
            border: 1px solid var(--danger);
            color: var(--danger);
        }
        
        /* Lightbox para fotos */
        .photo-lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .photo-lightbox.active { display: flex; }
        
        .photo-lightbox img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }
        
        .photo-lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }
        
        .hidden-file-input { display: none; }
        
        /* Botones de exportar calendario */
        .export-calendar-section {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(212,168,83,0.2);
        }
        
        .export-calendar-title {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: var(--gold);
            margin-bottom: 12px;
        }
        
        .export-btns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .export-btn {
            flex: 1;
            min-width: 120px;
            background: var(--bg-elevated);
            border: 1px solid rgba(212,168,83,0.3);
            border-radius: 10px;
            padding: 12px;
            color: var(--text);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        
        .export-btn:hover {
            border-color: var(--gold);
            background: rgba(212,168,83,0.1);
        }
        
        .export-btn .icon {
            font-size: 1.4rem;
        }
        
        .export-btn.google {
            border-color: rgba(66,133,244,0.5);
        }
        
        .export-btn.google:hover {
            border-color: #4285f4;
            background: rgba(66,133,244,0.1);
        }
        
        .export-btn.word {
            border-color: rgba(43,87,151,0.5);
        }
        
        .export-btn.word:hover {
            border-color: #2b5797;
            background: rgba(43,87,151,0.1);
        }
        
        .export-word-options {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            font-size: 0.85rem;
        }
        
        .export-word-options input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--gold);
        }
        
        /* Selector de alarma */
        .alarm-selector {
            margin-bottom: 12px;
        }
        
        .alarm-selector label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 6px;
        }
        
        .alarm-selector select {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid rgba(212,168,83,0.3);
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--text);
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .alarm-selector select:focus {
            outline: none;
            border-color: var(--gold);
        }
        
        /* has-event ya no necesita el punto, mostramos n√∫mero */
        
        .event-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-deep);
            border-radius: 10px;
            margin-bottom: 8px;
            border-left: 3px solid var(--accent-purple);
        }
        .event-time { font-size: 0.75rem; color: var(--text-dim); min-width: 45px; }
        .event-title { flex: 1; font-size: 0.85rem; }
        .event-category { font-size: 1.1rem; }
        .event-delete { background: none; border: none; color: var(--danger); font-size: 1.2rem; cursor: pointer; padding: 4px 8px; }
        .btn-add-event-dia { width: 100%; padding: 12px; margin-top: 12px; background: linear-gradient(135deg, rgba(212,168,83,0.2), rgba(212,168,83,0.1)); border: 1px dashed var(--gold); border-radius: 8px; color: var(--gold); font-family: 'Cinzel', serif; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; }
        .btn-add-event-dia:hover { background: linear-gradient(135deg, rgba(212,168,83,0.3), rgba(212,168,83,0.2)); }
        
        .events-section {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: var(--radius);
        }
        .events-section-title {
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            color: var(--gold);
            margin-bottom: 12px;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        .category-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 6px;
            background: var(--bg-deep);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
        }
        .category-item.selected {
            border-color: var(--gold);
            background: rgba(212,168,83,0.1);
        }
        .category-icon { font-size: 1.3rem; margin-bottom: 4px; }
        .category-label { font-size: 0.6rem; color: var(--text-dim); }
        
        .form-input-event {
            width: 100%;
            padding: 12px;
            background: var(--bg-deep);
            border: 1px solid rgba(212,168,83,0.3);
            border-radius: 10px;
            color: var(--text);
            font-size: 0.95rem;
            margin-bottom: 12px;
        }
        .form-input-event:focus { outline: none; border-color: var(--gold); }
        .form-row-event { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-label-event { display: block; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 6px; }

        /* ===== ASPECTOS Y PATRONES ===== */
        .patrones-section, .aspectos-section {
            margin-top: 16px;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 10px;
        }
        .section-title {
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            color: var(--gold);
            margin-bottom: 10px;
        }
        .patron-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
        }
        .patron-icono { font-size: 1.4rem; }
        .patron-info { display: flex; flex-direction: column; gap: 2px; flex: 1; }
        .patron-nombre { font-size: 0.9rem; font-weight: 600; }
        .patron-elemento { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; }
        .patron-planetas { font-size: 1rem; color: var(--gold-light); }
        .patron-apex { font-size: 0.7rem; color: var(--text-dim); }
        
        .aspectos-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }
        .aspecto-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px;
            background: var(--bg-deep);
            border-radius: 8px;
            border-left: 3px solid;
        }
        .aspecto-simbolo { font-size: 1.1rem; }
        .aspecto-planetas { font-size: 0.9rem; margin: 2px 0; }
        .aspecto-orbe { font-size: 0.65rem; color: var(--text-dim); }
        
        .cal-dia.has-pattern::before {
            content: '‚ú°';
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 0.5rem;
            color: #6495ed;
        }
        .cal-dia { position: relative; }

        /* ===== PERSONAL SECTION ===== */
        .personal-setup {
            max-width: 500px;
            margin: 0 auto;
        }

        .setup-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid rgba(212,168,83,0.2);
        }

        .setup-title {
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            color: var(--gold);
            text-align: center;
            margin-bottom: 8px;
        }

        .setup-desc {
            text-align: center;
            color: var(--text-dim);
            font-size: 0.9rem;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 6px;
            font-family: 'Cinzel', serif;
        }

        .form-input {
            width: 100%;
            background: var(--bg-deep);
            border: 1px solid var(--border-color, rgba(212,168,83,0.3));
            color: var(--text);
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--gold);
        }
        
        .form-hint {
            display: block;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 4px;
            opacity: 0.7;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .city-search-container {
            position: relative;
        }

        .city-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-elevated);
            border: 1px solid var(--gold-dark);
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }

        .city-results.show { display: block; }

        .city-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid rgba(212,168,83,0.1);
        }

        .city-result-item:hover {
            background: var(--bg-card);
        }

        .city-name { font-weight: 600; color: var(--text); }
        .city-country { font-size: 0.8rem; color: var(--text-dim); }

        .btn-gold {
            width: 100%;
            background: linear-gradient(135deg, var(--gold-dark), var(--gold));
            color: var(--bg-deep);
            border: none;
            padding: 14px 24px;
            border-radius: 25px;
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            transition: transform 0.2s;
        }

        .btn-gold:active { transform: scale(0.98); }

        .btn-secondary {
            width: 100%;
            background: transparent;
            color: var(--text-dim);
            border: 1px solid rgba(212,168,83,0.3);
            padding: 12px 20px;
            border-radius: 20px;
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Perfil Resumen */
        .perfil-resumen {
            background: linear-gradient(135deg, rgba(107,76,154,0.2), rgba(42,74,110,0.2));
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid rgba(212,168,83,0.2);
        }

        .perfil-nombre {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--gold);
            margin-bottom: 5px;
        }

        .perfil-fecha {
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .perfil-ciudad {
            color: var(--gold-light);
            font-size: 0.85rem;
            margin-top: 3px;
        }

        .perfil-signos {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(212,168,83,0.2);
        }

        .perfil-signo {
            text-align: center;
        }

        .perfil-signo-symbol {
            font-size: 2rem;
            display: block;
        }

        .perfil-signo-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            font-family: 'Cinzel', serif;
        }

        /* Personal Tabs */
        .personal-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
            -webkit-overflow-scrolling: touch;
            flex-wrap: wrap;
        }

        .personal-tab {
            background: var(--bg-card);
            border: 1px solid rgba(212,168,83,0.3);
            color: var(--text-dim);
            padding: 8px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            white-space: nowrap;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            transition: all 0.3s;
        }

        .personal-tab.active {
            background: linear-gradient(135deg, var(--gold-dark), var(--gold));
            color: var(--bg-deep);
            border-color: var(--gold);
        }

        .personal-panel {
            display: none;
        }

        .personal-panel.active {
            display: block;
        }

        /* Triplicidades */
        .triplicidad-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(212,168,83,0.2);
        }

        .triplicidad-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .triplicidad-title {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            font-size: 1rem;
        }

        .triplicidad-badge {
            background: rgba(212,168,83,0.2);
            color: var(--gold);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
        }

        .triplicidad-fases {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .fase-card {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            opacity: 0.6;
            border: 2px solid transparent;
        }

        .fase-card.active {
            opacity: 1;
            border-color: var(--gold);
            background: rgba(212,168,83,0.1);
        }

        .fase-a√±os {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .fase-planeta {
            font-size: 2rem;
            margin: 8px 0;
        }

        .fase-nombre {
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            color: var(--text);
        }

        /* Analysis Cards */
        .analysis-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(212,168,83,0.2);
        }

        .analysis-title {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            font-size: 0.95rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-content {
            color: var(--text);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .analysis-highlight {
            background: rgba(212,168,83,0.1);
            border-left: 3px solid var(--gold);
            padding: 12px;
            border-radius: 0 10px 10px 0;
            margin-top: 10px;
        }

        .casa-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 12px;
        }

        .casa-item {
            background: var(--bg-elevated);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }

        .casa-numero {
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .casa-signo {
            font-size: 1.5rem;
            margin: 4px 0;
        }

        .casa-nombre {
            font-size: 0.75rem;
            color: var(--gold-light);
        }

        .dignidad-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .dignidad-exaltacion { background: rgba(39,174,96,0.2); color: #27ae60; }
        .dignidad-domicilio { background: rgba(52,152,219,0.2); color: #3498db; }
        .dignidad-exilio { background: rgba(243,156,18,0.2); color: #f39c12; }
        .dignidad-caida { background: rgba(231,76,60,0.2); color: #e74c3c; }

        /* ===== HERRAMIENTAS CALENDARIO ===== */
        .calendario-tools {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            justify-content: center;
        }
        .tool-btn {
            padding: 10px 16px;
            background: var(--bg-elevated);
            border: 1px solid rgba(212,168,83,0.3);
            border-radius: 20px;
            color: var(--text);
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .tool-btn:hover {
            background: rgba(212,168,83,0.15);
            border-color: var(--gold);
        }

        /* ===== MODAL B√öSQUEDA ===== */
        .search-filters {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }
        .search-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .search-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        .search-cat-btn {
            padding: 6px 12px;
            background: var(--bg-deep);
            border: 1px solid rgba(212,168,83,0.2);
            border-radius: 15px;
            color: var(--text-dim);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .search-cat-btn.active {
            background: rgba(212,168,83,0.2);
            border-color: var(--gold);
            color: var(--gold);
        }
        .search-results {
            max-height: 400px;
            overflow-y: auto;
        }
        .search-result-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .search-result-item:hover {
            background: rgba(212,168,83,0.1);
        }
        .search-result-icon {
            font-size: 1.5rem;
        }
        .search-result-info {
            flex: 1;
        }
        .search-result-title {
            font-weight: 600;
            color: var(--text);
        }
        .search-result-date {
            font-size: 0.8rem;
            color: var(--text-dim);
        }
        .search-result-rec {
            font-size: 0.75rem;
            color: var(--gold);
        }
        .search-empty {
            text-align: center;
            padding: 32px;
            color: var(--text-dim);
        }

        /* ===== MODAL PRON√ìSTICO ===== */
        .pronostico-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            justify-content: center;
        }
        .pronostico-tab {
            padding: 8px 20px;
            background: var(--bg-deep);
            border: 1px solid rgba(212,168,83,0.2);
            border-radius: 20px;
            color: var(--text-dim);
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .pronostico-tab.active {
            background: rgba(212,168,83,0.2);
            border-color: var(--gold);
            color: var(--gold);
        }
        .pronostico-list {
            max-height: 500px;
            overflow-y: auto;
        }
        .pronostico-dia {
            background: var(--bg-elevated);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .pronostico-dia-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-deep);
            cursor: pointer;
        }
        .pronostico-dia-header:hover {
            background: rgba(212,168,83,0.1);
        }
        .pronostico-dia-fecha {
            font-family: 'Cinzel', serif;
            font-weight: 600;
            color: var(--text);
        }
        .pronostico-dia-fecha.es-hoy {
            color: var(--gold);
        }
        .pronostico-dia-iconos {
            display: flex;
            gap: 6px;
            font-size: 1.1rem;
        }
        .pronostico-dia-content {
            padding: 12px 16px;
            display: none;
        }
        .pronostico-dia.expanded .pronostico-dia-content {
            display: block;
        }
        .pronostico-aspectos {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }
        .pronostico-aspecto {
            padding: 4px 8px;
            background: var(--bg-deep);
            border-radius: 6px;
            font-size: 0.8rem;
        }
        .pronostico-eventos {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .pronostico-evento {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 0.85rem;
        }
        .pronostico-intensidad {
            display: flex;
            gap: 3px;
        }
        .intensidad-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--bg-deep);
        }
        .intensidad-dot.active { background: var(--gold); }
        .intensidad-dot.tension { background: #e74c3c; }
        .intensidad-dot.armonia { background: #27ae60; }
        
        /* ===== GOOGLE ADMOB BANNER ===== */
        #admob-banner-container {
            width: 100%;
            min-height: 50px;
            max-height: 90px;
            background: rgba(10, 10, 18, 0.98);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(212,168,83,0.2);
            border-bottom: 1px solid rgba(212,168,83,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px 0;
            position: relative;
            z-index: 90;
        }
    </style>
    
    <!-- Google AdMob - IMPORTANTE: Reemplaza con tu Publisher ID real -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3940256099942544"
         crossorigin="anonymous"></script>
    
<!-- <script src="astronomy.min.js"></script> -->
</head>
<body>
    <div class="app">
        <header class="header">
            <h1>‚ú¶ Tarot 28 Arcanos ‚ú¶</h1>
            <p class="header-sub">Los Trabajos de H√©rcules</p>
        </header>

        <!-- ========================================================================
             GOOGLE ADMOB BANNER - Siempre visible en header
             ======================================================================== -->
        <div id="admob-banner-container">
            <!-- AdMob Banner: ID de prueba de Google -->
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-3940256099942544"
                 data-ad-slot="6300978111"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
        </div>

        <nav class="nav">
            <button class="nav-btn active" data-screen="hoy">Hoy</button>
            <button class="nav-btn" data-screen="tiradas">Tiradas</button>
            <button class="nav-btn" data-screen="calendario">Calendario</button>
            <button class="nav-btn" data-screen="personal">Personal</button>
        </nav>

        <main class="main">
            <!-- PANTALLA HOY -->
            <section id="screen-hoy" class="screen active">
                <div class="loading" id="hoy-loading">
                    <div class="loading-spinner"></div>
                </div>
                <div id="hoy-content"></div>
            </section>

            <!-- PANTALLA TIRADAS -->
            <section id="screen-tiradas" class="screen">
                <div id="tiradas-list"></div>
                <div id="tirada-activa"></div>
            </section>

            <!-- PANTALLA CALENDARIO -->
            <section id="screen-calendario" class="screen">
                <div id="calendario-content"></div>
            </section>

            <!-- PANTALLA PERSONAL -->
            <section id="screen-personal" class="screen">
                <div id="personal-setup" class="personal-setup">
                    <div class="setup-card">
                        <h2 class="setup-title">‚ú® Tu Perfil Natal</h2>
                        <p class="setup-desc">Ingresa tus datos para calcular tu carta y an√°lisis personalizado</p>
                        
                        <div class="form-group">
                            <label class="form-label">Nombre</label>
                            <input type="text" id="perfil-nombre" class="form-input" placeholder="Tu nombre">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Fecha de nacimiento</label>
                                <input type="date" id="perfil-fecha" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Hora de nacimiento</label>
                                <input type="time" id="perfil-hora" class="form-input" value="12:00">
                            </div>
                        </div>
                        
                        <div class="form-group city-search-container">
                            <label class="form-label">üè† Lugar de nacimiento</label>
                            <input type="text" id="perfil-ciudad" class="form-input" placeholder="Buscar ciudad de nacimiento..." autocomplete="off">
                            <div id="city-results" class="city-results"></div>
                            <input type="hidden" id="perfil-lat">
                            <input type="hidden" id="perfil-lon">
                            <input type="hidden" id="perfil-country">
                            <input type="hidden" id="perfil-tz">
                            <div id="tz-info" style="font-size:0.75rem;color:var(--gold-light);margin-top:4px;display:none;">
                                üïê <span id="tz-display"></span>
                            </div>
                        </div>
                        
                        <div class="form-group city-search-container">
                            <label class="form-label">üìç Lugar de residencia actual</label>
                            <input type="text" id="perfil-residencia" class="form-input" placeholder="Buscar ciudad de residencia..." autocomplete="off">
                            <div id="city-results-res" class="city-results"></div>
                            <input type="hidden" id="perfil-res-lat">
                            <input type="hidden" id="perfil-res-lon">
                            <input type="hidden" id="perfil-res-tz">
                            <small class="form-hint">Para calcular tr√°nsitos y calendario diario</small>
                        </div>
                        
                        <button id="calcular-carta" class="btn-gold">üîÆ Calcular Mi Carta</button>
                    </div>
                </div>
                
                <div id="personal-content" style="display:none;">
                    <!-- Resumen del perfil -->
                    <div id="perfil-resumen" class="perfil-resumen"></div>
                    
                    <!-- Tabs de an√°lisis -->
                    <div class="personal-tabs">
                        <button class="personal-tab active" data-tab="vocacion">üíº Vocaci√≥n</button>
                        <button class="personal-tab" data-tab="finanzas">üí∞ Finanzas</button>
                        <button class="personal-tab" data-tab="hogar">üè† Hogar</button>
                        <button class="personal-tab" data-tab="relaciones">üíï Relaciones</button>
                        <button class="personal-tab" data-tab="espiritual">üßò Espiritual</button>
                        <button class="personal-tab" data-tab="elecciones">üåü Elecciones</button>
                    </div>
                    
                    <div id="tab-vocacion" class="personal-panel active"></div>
                    <div id="tab-finanzas" class="personal-panel"></div>
                    <div id="tab-hogar" class="personal-panel"></div>
                    <div id="tab-relaciones" class="personal-panel"></div>
                    <div id="tab-espiritual" class="personal-panel"></div>
                    <div id="tab-elecciones" class="personal-panel"></div>
                    
                    <button id="editar-perfil" class="btn-secondary">‚úèÔ∏è Editar Datos</button>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <div class="modal-title" id="modal-title"></div>
                    <div class="modal-subtitle" id="modal-subtitle"></div>
                </div>
                <button class="modal-close" id="modal-close">√ó</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <!-- Modal para crear eventos -->
    <div class="modal-overlay" id="modal-event">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <div class="modal-title">üìù Nuevo Evento</div>
                    <div class="modal-subtitle">A√±ade un evento a tu agenda</div>
                </div>
                <button class="modal-close" id="modal-event-close">√ó</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 16px;">
                    <span class="form-label-event">Categor√≠a</span>
                    <div class="category-grid" id="event-categories">
                        <div class="category-item" data-cat="cumple"><span class="category-icon">üéÇ</span><span class="category-label">Cumplea√±os</span></div>
                        <div class="category-item selected" data-cat="trabajo"><span class="category-icon">üíº</span><span class="category-label">Trabajo</span></div>
                        <div class="category-item" data-cat="dinero"><span class="category-icon">üí∞</span><span class="category-label">Dinero</span></div>
                        <div class="category-item" data-cat="amor"><span class="category-icon">‚ù§Ô∏è</span><span class="category-label">Amor</span></div>
                        <div class="category-item" data-cat="salud"><span class="category-icon">üè•</span><span class="category-label">Salud</span></div>
                        <div class="category-item" data-cat="viaje"><span class="category-icon">‚úàÔ∏è</span><span class="category-label">Viaje</span></div>
                        <div class="category-item" data-cat="familia"><span class="category-icon">üë®‚Äçüë©‚Äçüëß</span><span class="category-label">Familia</span></div>
                        <div class="category-item" data-cat="espiritual"><span class="category-icon">üßò</span><span class="category-label">Espiritual</span></div>
                        <div class="category-item" data-cat="otro"><span class="category-icon">üìå</span><span class="category-label">Otro</span></div>
                    </div>
                </div>
                <div>
                    <span class="form-label-event">T√≠tulo</span>
                    <input type="text" class="form-input-event" id="event-title" placeholder="Nombre del evento">
                </div>
                <div class="form-row-event">
                    <div>
                        <span class="form-label-event">Fecha</span>
                        <input type="date" class="form-input-event" id="event-date">
                    </div>
                    <div>
                        <span class="form-label-event">Hora</span>
                        <input type="time" class="form-input-event" id="event-time">
                    </div>
                </div>
                <div>
                    <span class="form-label-event">üîÑ Repetir</span>
                    <select class="form-input-event" id="event-recurrence" onchange="toggleRecurrenceFields()">
                        <option value="none">No repetir</option>
                        <option value="daily">Cada d√≠a</option>
                        <option value="weekly">Cada semana</option>
                        <option value="monthly">Cada mes</option>
                        <option value="yearly">Cada a√±o (cumplea√±os)</option>
                    </select>
                </div>
                <div id="recurrence-dates" style="display:none;">
                    <div class="form-row-event">
                        <div>
                            <span class="form-label-event">Desde</span>
                            <input type="date" class="form-input-event" id="event-rec-start">
                        </div>
                        <div>
                            <span class="form-label-event">Hasta</span>
                            <input type="date" class="form-input-event" id="event-rec-end">
                        </div>
                    </div>
                    <div style="font-size:0.75rem;color:var(--text-dim);margin-top:4px;">
                        Deja "Hasta" vac√≠o para repetir indefinidamente
                    </div>
                </div>
                <div>
                    <span class="form-label-event">Notas</span>
                    <textarea class="form-input-event" id="event-notes" rows="2" placeholder="Notas adicionales..." style="resize:none;"></textarea>
                </div>
                
                <!-- Secci√≥n de fotos -->
                <div class="media-upload-section">
                    <span class="form-label-event">üì∏ Fotos</span>
                    <div class="media-upload-btns">
                        <label class="media-upload-btn">
                            <span class="icon">üñºÔ∏è</span>
                            Galer√≠a
                            <input type="file" class="hidden-file-input" id="event-photos-gallery" accept="image/*" multiple>
                        </label>
                        <label class="media-upload-btn">
                            <span class="icon">üì∑</span>
                            C√°mara
                            <input type="file" class="hidden-file-input" id="event-photos-camera" accept="image/*" capture="environment">
                        </label>
                    </div>
                    <div class="photos-preview-grid" id="event-photos-preview"></div>
                </div>
                
                <!-- Secci√≥n de v√≠deos -->
                <div class="media-upload-section">
                    <span class="form-label-event">üé¨ V√≠deos</span>
                    <div class="media-upload-btns">
                        <label class="media-upload-btn">
                            <span class="icon">üì±</span>
                            Del equipo
                            <input type="file" class="hidden-file-input" id="event-video-file" accept="video/*">
                        </label>
                        <label class="media-upload-btn">
                            <span class="icon">üé•</span>
                            Grabar
                            <input type="file" class="hidden-file-input" id="event-video-camera" accept="video/*" capture="environment">
                        </label>
                    </div>
                    <div class="video-input-row" style="margin-top:8px;">
                        <input type="url" class="form-input-event" id="event-video-url" placeholder="URL de YouTube (opcional)">
                        <button type="button" id="event-add-video">+</button>
                    </div>
                    <div class="videos-list" id="event-videos-list"></div>
                </div>
                
                <button id="event-save" style="width:100%;padding:14px;background:linear-gradient(135deg,var(--gold),#c49b38);border:none;border-radius:12px;color:var(--bg-deep);font-family:'Cinzel',serif;font-size:1rem;font-weight:600;cursor:pointer;margin-top:8px;">üíæ Guardar Evento</button>
            </div>
        </div>
    </div>
    
    <div class="install-prompt" id="install-prompt">
        <div class="install-prompt-text">üì≤ Instala la app para acceder sin conexi√≥n</div>
        <div class="install-prompt-btns">
            <button class="install-btn secondary" id="install-later">Despu√©s</button>
            <button class="install-btn primary" id="install-now">Instalar</button>
        </div>
    </div>
    
    <!-- Lightbox para fotos -->
    <div class="photo-lightbox" id="photo-lightbox">
        <button class="photo-lightbox-close" id="photo-lightbox-close">√ó</button>
        <img src="" alt="Foto ampliada" id="photo-lightbox-img">
    </div>

    <!-- Swiss Ephemeris Data (1950-2050) -->
    <script src="ephemeris-data.js"></script>
    
    <script>
    // ========================================================================
    // DATOS DEL TAROT
    // ========================================================================
    
    const PLANET_SYMBOLS = {
        'Sol': '‚òâ', 'Luna': '‚òΩ', 'Mercurio': '‚òø', 'Venus': '‚ôÄ',
        'Marte': '‚ôÇ', 'J√∫piter': '‚ôÉ', 'Saturno': '‚ôÑ',
        'Urano': '‚ôÖ', 'Neptuno': '‚ôÜ', 'Plut√≥n': '‚ôá',
        'Nodo Norte': '‚òä', 'Nodo Sur': '‚òã'
    };
    
    const SIGN_SYMBOLS = {
        'Aries': '‚ôà', 'Tauro': '‚ôâ', 'G√©minis': '‚ôä', 'C√°ncer': '‚ôã',
        'Leo': '‚ôå', 'Virgo': '‚ôç', 'Libra': '‚ôé', 'Escorpio': '‚ôè',
        'Sagitario': '‚ôê', 'Capricornio': '‚ôë', 'Acuario': '‚ôí', 'Piscis': '‚ôì',
        'Ofiuco': '‚õé', 'Pegaso': 'ü™Ω'
    };

    const DIAS_SEMANA = {
        0: { nombre: 'Domingo', planeta: 'Sol', simbolo: '‚òâ' },
        1: { nombre: 'Lunes', planeta: 'Luna', simbolo: '‚òΩ' },
        2: { nombre: 'Martes', planeta: 'Marte', simbolo: '‚ôÇ' },
        3: { nombre: 'Mi√©rcoles', planeta: 'Mercurio', simbolo: '‚òø' },
        4: { nombre: 'Jueves', planeta: 'J√∫piter', simbolo: '‚ôÉ' },
        5: { nombre: 'Viernes', planeta: 'Venus', simbolo: '‚ôÄ' },
        6: { nombre: 'S√°bado', planeta: 'Saturno', simbolo: '‚ôÑ' }
    };

    const MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

    const FASES_LUNARES = [
        { rango: [1, 1], nombre: 'Luna Nueva', emoji: 'üåë' },
        { rango: [2, 7], nombre: 'Creciente', emoji: 'üåí' },
        { rango: [8, 8], nombre: 'Cuarto Creciente', emoji: 'üåì' },
        { rango: [9, 14], nombre: 'Gibosa Creciente', emoji: 'üåî' },
        { rango: [15, 15], nombre: 'Luna Llena', emoji: 'üåï' },
        { rango: [16, 21], nombre: 'Gibosa Menguante', emoji: 'üåñ' },
        { rango: [22, 22], nombre: 'Cuarto Menguante', emoji: 'üåó' },
        { rango: [23, 28], nombre: 'Bals√°mica', emoji: 'üåò' }
    ];

    const LUNAS_NUEVAS = [
        '2024-01-11T11:57:00Z','2024-02-09T22:59:00Z','2024-03-10T09:00:00Z','2024-04-08T18:21:00Z',
        '2024-05-08T03:22:00Z','2024-06-06T12:38:00Z','2024-07-05T22:57:00Z','2024-08-04T11:13:00Z',
        '2024-09-03T01:56:00Z','2024-10-02T18:49:00Z','2024-11-01T12:47:00Z','2024-12-01T06:21:00Z',
        '2024-12-30T22:27:00Z','2025-01-29T12:36:00Z','2025-02-28T00:45:00Z','2025-03-29T10:58:00Z',
        '2025-04-27T19:31:00Z','2025-05-27T03:02:00Z','2025-06-25T10:32:00Z','2025-07-24T19:11:00Z',
        '2025-08-23T06:07:00Z','2025-09-21T19:54:00Z','2025-10-21T12:25:00Z','2025-11-20T06:47:00Z',
        '2025-12-20T01:43:00Z','2026-01-18T19:52:00Z','2026-02-17T12:01:00Z','2026-03-19T01:23:00Z',
        '2026-04-17T11:52:00Z','2026-05-16T19:01:00Z','2026-06-15T02:54:00Z','2026-07-14T09:44:00Z',
        '2026-08-12T17:37:00Z','2026-09-11T03:27:00Z','2026-10-10T15:50:00Z','2026-11-09T07:02:00Z',
        '2026-12-09T00:52:00Z','2027-01-07T20:24:00Z','2027-02-06T15:56:00Z','2027-03-08T09:29:00Z',
        '2027-04-06T23:51:00Z','2027-05-06T10:59:00Z','2027-06-04T19:40:00Z','2027-07-04T03:02:00Z',
        '2027-08-02T10:05:00Z','2027-08-31T17:41:00Z','2027-09-30T02:36:00Z','2027-10-29T13:36:00Z',
        '2027-11-28T03:24:00Z','2027-12-27T20:12:00Z','2028-01-26T15:12:00Z','2028-02-25T10:37:00Z',
        '2028-03-26T04:31:00Z','2028-04-24T19:47:00Z','2028-05-24T08:16:00Z','2028-06-22T18:27:00Z',
        '2028-07-22T02:02:00Z','2028-08-20T10:44:00Z','2028-09-18T18:24:00Z','2028-10-18T03:57:00Z',
        '2028-11-16T15:18:00Z','2028-12-16T04:06:00Z','2029-01-14T17:24:00Z','2029-02-13T06:31:00Z',
        '2029-03-14T18:19:00Z','2029-04-13T04:40:00Z','2029-05-12T13:36:00Z','2029-06-10T21:43:00Z',
        '2029-07-10T05:51:00Z','2029-08-08T14:55:00Z','2029-09-07T01:44:00Z','2029-10-06T14:14:00Z',
        '2029-11-05T04:24:00Z','2029-12-04T19:52:00Z','2030-01-03T11:49:00Z','2030-02-02T03:07:00Z',
        '2030-03-03T17:34:00Z','2030-04-02T06:02:00Z','2030-05-01T16:23:00Z','2030-05-31T01:21:00Z',
        '2030-06-29T09:57:00Z','2030-07-28T18:54:00Z','2030-08-27T04:43:00Z','2030-09-25T15:54:00Z',
        '2030-10-25T04:32:00Z','2030-11-23T18:44:00Z','2030-12-23T10:32:00Z'
    ].map(d => new Date(d));

    const EXALTACIONES = [
        {planeta:'Sol',signo:'Leo',titulo:'La Piel Invulnerable',esencia:'Usa tus propios recursos internos. La soluci√≥n est√° en ti mismo, en tu ingenio y capacidad de adaptaci√≥n.',texto:'Heracles no sab√≠a c√≥mo abrir la piel del le√≥n hasta que Atenea lo inspir√≥. Us√≥ las garras de la bestia, tan afiladas como cuchillas, y con ellas obtuvo la piel invulnerable para convertirla en su armadura y su yelmo.'},
        {planeta:'Luna',signo:'C√°ncer',titulo:'La Constelaci√≥n',esencia:'El servicio tiene su recompensa. Aunque otros no reconozcan tu trabajo, el universo lo registra.',texto:'Hera, en reconocimiento al cangrejo que acudi√≥ en su nombre, lo alz√≥ al cielo y lo convirti√≥ en un signo zodiacal. Sin embargo, Euristeo neg√≥ la validez del trabajo, argumentando que la presencia de Yolao ‚Äîquien encendi√≥ las teas purificadoras‚Äî invalidaba la prueba.'},
        {planeta:'Marte',signo:'Escorpio',titulo:'La Cierva de Cerinea',esencia:'La perseverancia sin violencia. Lograr el objetivo sin da√±ar, con paciencia infinita y precisi√≥n quir√∫rgica.',texto:'Heracles no quiso herir a la cierva sagrada. La sigui√≥ durante un a√±o, hasta capturarla sin causarle da√±o.'},
        {planeta:'J√∫piter',signo:'Sagitario',titulo:'La Batalla de los Centauros',esencia:'Defender el honor, incluso el de un enemigo. La nobleza se muestra vengando las ofensas ajenas.',texto:'Heracles gan√≥ gran fama al vengar con nobleza una ofensa hecha a un antiguo enemigo.'},
        {planeta:'Sol',signo:'Capricornio',titulo:'La Cacer√≠a Celestial',esencia:'Persistencia implacable. Contin√∫a hasta el final aunque el enemigo huya; otros completar√°n lo que inicies.',texto:'Abati√≥ a centenares de aves mientras hu√≠an batiendo las alas rumbo a la isla de Ares, en el Mar Negro, lugar donde tiempo despu√©s ser√≠an encontradas por los argonautas.'},
        {planeta:'Luna',signo:'Acuario',titulo:'El Legado de Deucali√≥n',esencia:'La herencia y el linaje. De peque√±os actos nacen grandes legados; tus descendientes definir√°n tu historia.',texto:'Deucali√≥n fue padre de Oresteo, y en tiempos de este una perra blanca pari√≥ una estaca. Oresteo la plant√≥ y aquella estaca acab√≥ creciendo hasta convertirse en una vid.'},
        {planeta:'J√∫piter',signo:'Piscis',titulo:'Faetonte y el Toro',esencia:'Dominar por fuerza y astucia. Cuando te confundan con otro, aprovecha para someter al adversario.',texto:'Faetonte atac√≥ a Heracles creyendo que era un le√≥n, pero Heracles agarr√≥ al toro por el cuerno izquierdo y lo derrib√≥ al suelo.'},
        {planeta:'Marte',signo:'Aries',titulo:'El Viaje del H√©roe',esencia:'Emprender el viaje con aliados. Busca voluntarios y visita amigos en el camino; no vayas solo.',texto:'Con varios voluntarios, Heracles naveg√≥ hacia Tracia y, de paso, visit√≥ a su amigo Admeto, rey de Peras.'},
        {planeta:'Venus',signo:'Tauro',titulo:'Las Amazonas',esencia:'Inversi√≥n de roles y poder. Cuestiona qui√©n debe hacer qu√©; el orden establecido puede ser revertido.',texto:'Las amazonas segu√≠an la descendencia materna, y Lisipe orden√≥ que los hombres hicieran las tareas dom√©sticas, mientras las mujeres gobernaban y luchaban.'},
        {planeta:'Mercurio',signo:'G√©minis',titulo:'Los Bueyes de Geriones',esencia:'Tomar sin pedir ni pagar. Audacia para reclamar lo que consideras tuyo, aunque est√© bien custodiado.',texto:'El d√©cimo trabajo de Heracles fue tomar los bueyes de Ger√≠ones en Eriteya sin pedirlos ni pagarlos.'},
        {planeta:'Venus',signo:'Libra',titulo:'El Jard√≠n de las Hesp√©rides',esencia:'Proteger lo valioso con muros y guardianes. El orgullo del jardinero que construye defensas ante profec√≠as.',texto:'Atlante estaba tan orgulloso de aquellas manzanas que las cuidaba como un jardinero celoso, y por eso levant√≥ fuertes murallas alrededor del huerto para protegerlo de cualquier intruso.'},
        {planeta:'Mercurio',signo:'Virgo',titulo:'Los Misterios de Eleusis',esencia:'Purificaci√≥n antes de la iniciaci√≥n. Limpia tus manos de sangre, busca padrinos y prep√°rate para lo sagrado.',texto:'Para prepararse, Heracles fue a Eleusis y pidi√≥ ser admitido en los Misterios.'},
        {planeta:'Saturno',signo:'G√©minis',titulo:'El Guardi√°n Ca√≠do',esencia:'Ca√≠da de los protectores. Los guardianes pueden ser vencidos; la lealtad tiene un precio mortal.',texto:'Ortro atac√≥ a Heracles, pero este lo mat√≥ con la clava, y Euriti√≥n, el pastor, muri√≥ igual al intentar defenderlo.'},
        {planeta:'Venus',signo:'Acuario',titulo:'El Diluvio de Deucali√≥n',esencia:'Previsi√≥n y sustento. Construir el arca, llenarla de provisiones, sobrevivir con tu pareja al cataclismo.',texto:'Deucali√≥n construy√≥ un arca, la llen√≥ de provisiones y embarc√≥ en ella con su esposa Pirra.'},
        {planeta:'Luna',signo:'Libra',titulo:'La Fuente y la Serpiente',esencia:'Crear recursos de la nada. Golpear la tierra para que brote agua; salvar a otros con tu esfuerzo.',texto:'Heracles golpe√≥ la tierra con los pies y abri√≥ un manantial que m√°s tarde salvar√≠a a los argonautas.'},
        {planeta:'Mercurio',signo:'Capricornio',titulo:'Las Aves de Est√≠nfalo',esencia:'Ahuyentar lo peligroso con ruido. Los problemas huyen cuando los enfrentas con estruendo y decisi√≥n.',texto:'Heracles ten√≠a que espantar a las aves antrop√≥fagas, dotadas de pico, alas y garras de bronce.'},
        {planeta:'Sol',signo:'Virgo',titulo:'El √Ålamo Blanco',esencia:'Haza√±as en ambos mundos. El sudor transforma lo oscuro en plateado; tus obras dejan marca en lo visible y lo invisible.',texto:'Las hojas que tocaban la frente de Heracles se volv√≠an blanco plateado por el brillo de su sudor glorioso.'},
        {planeta:'Luna',signo:'Piscis',titulo:'El Arbitraje de Aug√≠as',esencia:'La verdad no siempre gana. Aunque testifiques correctamente, el poderoso puede expulsarte e invalidar tu trabajo.',texto:'Cuando los jueces se sentaron y Fileo dijo la verdad, Aug√≠as los expuls√≥ de √âlide.'},
        {planeta:'J√∫piter',signo:'C√°ncer',titulo:'El Cangrejo Celestial',esencia:'Pedir ayuda y cauterizar heridas. Cuando el enemigo se regenera, grita por auxilio y quema las ra√≠ces del mal.',texto:'Heracles pidi√≥ ayuda a Yolao, y este cauteriz√≥ las ra√≠ces con ramas encendidas.'},
        {planeta:'Sol',signo:'Aries',titulo:'La Justicia Divina',esencia:'Justicia po√©tica. Hacer que el tirano sufra su propio castigo; alimentar al monstruo con su creador.',texto:'Heracles dej√≥ a Diomedes aturdido con un golpe de su clava y lo arroj√≥ ante sus propias yeguas, que se lanzaron sobre √©l y lo devoraron.'},
        {planeta:'Marte',signo:'Leo',titulo:'La B√∫squeda del Le√≥n',esencia:'Buscar sin gu√≠a hasta encontrar. En territorio despoblado, la perseverancia revela al enemigo invulnerable.',texto:'Heracles lleg√≥ a Nemea al mediod√≠a, pero el le√≥n hab√≠a vaciado la zona y no encontr√≥ a nadie que lo guiara.'},
        {planeta:'Saturno',signo:'Acuario',titulo:'Los Lobos de Parnaso',esencia:'Seguir las se√±ales y augurios. Los aullidos que despiertan gu√≠an hacia la salvaci√≥n en la monta√±a.',texto:'Los lobos despertaron a los habitantes de Parnaso, que los siguieron hasta la cima de la monta√±a.'},
        {planeta:'Venus',signo:'Ofiuco',titulo:'El Sacrificio Imp√≠o',esencia:'La devoci√≥n que degenera. La religiosidad extrema lleva a violar las leyes sagradas de hospitalidad.',texto:'Su excesivo fervor religioso lo llev√≥ a realizar sacrificios humanos, violando la ley sagrada de la hospitalidad.'},
        {planeta:'Marte',signo:'Pegaso',titulo:'Amimone y el S√°tiro',esencia:'Despertar peligros sin querer. Persiguiendo un objetivo, puedes activar fuerzas dormidas que te atacar√°n.',texto:'Amimone persegu√≠a a un ciervo y, sin querer, despert√≥ a un s√°tiro que dorm√≠a.'},
        {planeta:'Saturno',signo:'Libra',titulo:'El Enga√±o a Atlante',esencia:'Enga√±ar al enga√±ador. Simular aceptar una trampa para revertirla; la astucia vence a la fuerza bruta.',texto:'Heracles fingi√≥ aceptar el trato, pero le pidi√≥ a Atlante que sostuviera el globo un momento m√°s mientras √©l se preparaba. Atlante cay√≥ en la trampa sin dificultad.'},
        {planeta:'J√∫piter',signo:'Pegaso',titulo:'El Tridente de Poseid√≥n',esencia:'Invocar protecci√≥n divina. Cuando el agresor ataca, clamar al dios correcto que lanzar√° su arma en tu defensa.',texto:'Posid√≥n, atendiendo a su llamada, arroj√≥ su tridente contra el s√°tiro.'},
        {planeta:'Luna',signo:'Ofiuco',titulo:'La Resurrecci√≥n de N√≠ctimo',esencia:'Segunda oportunidad y sucesi√≥n. La vida puede ser devuelta; el hijo asesinado heredar√° el reino.',texto:'Despu√©s resucit√≥ a N√≠ctimo, que sucedi√≥ a su padre como rey de Arcadia.'},
        {planeta:'Saturno',signo:'Ofiuco',titulo:'Los Hijos de Lica√≥n',esencia:'La impiedad castigada. Los dioses disfrazados prueban a los mortales; el crimen contra el hu√©sped trae destrucci√≥n.',texto:'Los descendientes de Lica√≥n eran conocidos por desafiar toda ley divina. Zeus, adoptando la figura de un mendigo, los puso frente a s√≠ mismos, y ellos, ciegos de impiedad, no dudaron en matar a uno de los suyos.'}
    ];

    // Im√°genes de cartas incluidas en tarot-images.js (base64)
    const ARCANOS = [
        {id:1,numero:'I',nombre:'LE BATELEVR',nombreEs:'El Mago',planeta:'Sol',signo:'Leo',mito:'El Le√≥n de Nemea',imagen:'tarot/01_Batallador.jpg',significado:{normal:'Voluntad, poder creativo, iniciativa, habilidad, confianza en uno mismo. Tienes los recursos internos para vencer cualquier obst√°culo.',invertida:'Manipulaci√≥n, enga√±o, falta de voluntad, talentos desperdiciados. La fuerza bruta no funcionar√°.'},palabrasClave:['voluntad','acci√≥n','poder','iniciativa','creatividad']},
        {id:2,numero:'II',nombre:'LA PAPESSE',nombreEs:'La Papisa',planeta:'Luna',signo:'C√°ncer',mito:'La Hidra de Lerna',imagen:'tarot/02_Papisa.jpg',significado:{normal:'Intuici√≥n, sabidur√≠a oculta, misterios, paciencia. Conf√≠a en tu intuici√≥n para encontrar la verdadera soluci√≥n.',invertida:'Secretos revelados, superficialidad, ignorar la intuici√≥n. Los problemas no resueltos volver√°n.'},palabrasClave:['intuici√≥n','misterio','sabidur√≠a','paciencia','secretos']},
        {id:3,numero:'III',nombre:"L'IMPERATRISE",nombreEs:'La Emperatriz',planeta:'Marte',signo:'Escorpio',mito:'La Cierva de Cerinea',imagen:'tarot/03_Emperatriz.jpg',significado:{normal:'Abundancia, fertilidad, creatividad, naturaleza. La abundancia vendr√° sin forzar.',invertida:'Bloqueo creativo, dependencia, negligencia. Est√°s forzando resultados.'},palabrasClave:['abundancia','fertilidad','creatividad','naturaleza','paciencia']},
        {id:4,numero:'IIII',nombre:"L'EMPEREVR",nombreEs:'El Emperador',planeta:'J√∫piter',signo:'Sagitario',mito:'El Jabal√≠ de Erimanto',imagen:'tarot/04_Emperador.jpg',significado:{normal:'Autoridad, estructura, control, liderazgo, estabilidad. Establece orden y l√≠mites claros.',invertida:'Tiran√≠a, rigidez, falta de disciplina, abuso de poder.'},palabrasClave:['autoridad','estructura','liderazgo','control','estabilidad']},
        {id:5,numero:'V',nombre:'LE PAPE',nombreEs:'El Papa',planeta:'Sol',signo:'Capricornio',mito:'Las Aves Estinf√°lidas',imagen:'tarot/05_Papa.jpg',significado:{normal:'Tradici√≥n, ense√±anza, gu√≠a espiritual. A veces la soluci√≥n est√° en m√©todos no convencionales dentro de la tradici√≥n.',invertida:'Dogmatismo, rebeli√≥n, malos consejos. Cuestiona las estructuras que ya no sirven.'},palabrasClave:['tradici√≥n','ense√±anza','gu√≠a','espiritualidad','sabidur√≠a']},
        {id:6,numero:'VI',nombre:"L'AMOVREVX",nombreEs:'Los Enamorados',planeta:'Venus',signo:'Tauro',mito:'El Cintur√≥n de Hip√≥lita',imagen:'tarot/06_Enamorados.jpg',significado:{normal:'Amor, uni√≥n, elecciones, armon√≠a, valores. Las decisiones del coraz√≥n requieren valent√≠a.',invertida:'Desequilibrio, desuni√≥n, malas elecciones. El deseo sin respeto conduce al conflicto.'},palabrasClave:['amor','elecci√≥n','uni√≥n','armon√≠a','valores']},
        {id:7,numero:'VII',nombre:'LE CHARIOT',nombreEs:'El Carro',planeta:'J√∫piter',signo:'Piscis',mito:'Los Establos de Aug√≠as',imagen:'tarot/07_Carro.jpg',significado:{normal:'Victoria, voluntad, determinaci√≥n, movimiento. El √©xito viene de trabajar inteligentemente.',invertida:'Derrota, falta de direcci√≥n, agresi√≥n, obst√°culos.'},palabrasClave:['victoria','determinaci√≥n','ingenio','movimiento','triunfo']},
        {id:8,numero:'VIII',nombre:'IVSTICE',nombreEs:'La Justicia',planeta:'Venus',signo:'Libra',mito:'Las Manzanas de las Hesp√©rides',imagen:'tarot/08_Justicia.jpg',significado:{normal:'Equilibrio, justicia, verdad, ley, causa y efecto. Recibir√°s lo que mereces.',invertida:'Injusticia, deshonestidad, falta de responsabilidad.'},palabrasClave:['equilibrio','justicia','verdad','karma','decisi√≥n']},
        {id:9,numero:'VIIII',nombre:"L'ERMITE",nombreEs:'El Ermita√±o',planeta:'Luna',signo:'Acuario',mito:'El Toro de Creta',imagen:'tarot/09_Eremita.jpg',significado:{normal:'Introspecci√≥n, soledad, b√∫squeda interior. El viaje interior ilumina el camino externo.',invertida:'Aislamiento excesivo, rechazo a la gu√≠a. Te has alejado demasiado.'},palabrasClave:['introspecci√≥n','soledad','sabidur√≠a','gu√≠a','b√∫squeda']},
        {id:10,numero:'X',nombre:'LA ROVE DE FORTVNE',nombreEs:'La Rueda de la Fortuna',planeta:'Mercurio',signo:'G√©minis',mito:'Los Bueyes de Geriones',imagen:'tarot/10_Fortuna.jpg',significado:{normal:'Ciclos, destino, cambio, suerte, oportunidades. Acepta el cambio.',invertida:'Mala suerte, resistencia al cambio, ciclos negativos.'},palabrasClave:['ciclos','destino','cambio','fortuna','oportunidad']},
        {id:11,numero:'XI',nombre:'LA FORCE',nombreEs:'La Fuerza',planeta:'Marte',signo:'Aries',mito:'Las Yeguas de Diomedes',imagen:'tarot/11_Fuerza.jpg',significado:{normal:'Coraje, persuasi√≥n, influencia, compasi√≥n. Tu fuerza interior supera cualquier obst√°culo.',invertida:'Debilidad, falta de coraje, inseguridad, abuso de fuerza.'},palabrasClave:['coraje','fuerza interior','dominio','compasi√≥n','valent√≠a']},
        {id:12,numero:'XII',nombre:'LE PENDV',nombreEs:'El Colgado',planeta:'Mercurio',signo:'Virgo',mito:'La Captura de Cerbero',imagen:'tarot/12_Colgado.jpg',significado:{normal:'Sacrificio, nueva perspectiva, suspensi√≥n. La iluminaci√≥n viene de ver el mundo al rev√©s.',invertida:'Sacrificio in√∫til, estancamiento. Te aferras a lo que debes liberar.'},palabrasClave:['sacrificio','perspectiva','rendici√≥n','pausa','iluminaci√≥n']},
        {id:13,numero:'XIII',nombre:'LA MORT',nombreEs:'La Muerte',planeta:'Saturno',signo:'G√©minis',mito:'Belo y las Danaides',imagen:'tarot/13_Muerte.jpg',significado:{normal:'Transformaci√≥n, fin de un ciclo, cambio profundo, renacimiento.',invertida:'Resistencia al cambio, estancamiento, miedo a lo nuevo.'},palabrasClave:['transformaci√≥n','fin','renacimiento','cambio','liberaci√≥n']},
        {id:14,numero:'XIIII',nombre:'TENPERANCE',nombreEs:'La Templanza',planeta:'Venus',signo:'Acuario',mito:'Ganimedes',imagen:'tarot/14_Templanza.jpg',significado:{normal:'Equilibrio, moderaci√≥n, paciencia, prop√≥sito, armon√≠a. Encuentra el equilibrio en todo.',invertida:'Desequilibrio, exceso, impaciencia, falta de armon√≠a.'},palabrasClave:['equilibrio','moderaci√≥n','paciencia','armon√≠a','flujo']},
        {id:15,numero:'XV',nombre:'LE DIABLE',nombreEs:'El Diablo',planeta:'Luna',signo:'Libra',mito:'Pan',imagen:'tarot/15_Diablo.jpg',significado:{normal:'Sombra, ataduras, materialismo, instintos. Reconoce tus deseos sin ser esclavo de ellos.',invertida:'Liberaci√≥n, enfrentar miedos, romper cadenas.'},palabrasClave:['sombra','ataduras','instintos','liberaci√≥n','deseo']},
        {id:16,numero:'XVI',nombre:'LA MAISON DIEV',nombreEs:'La Torre',planeta:'Mercurio',signo:'Capricornio',mito:'El Cuerno de la Abundancia',imagen:'tarot/16_Torre.jpg',significado:{normal:'Cambio repentino, revelaci√≥n, despertar. La destrucci√≥n precede a la verdadera riqueza.',invertida:'Evitar desastre, miedo al cambio. Est√°s retrasando lo inevitable.'},palabrasClave:['cambio','revelaci√≥n','destrucci√≥n','despertar','liberaci√≥n']},
        {id:17,numero:'XVII',nombre:"L'ESTOILLE",nombreEs:'La Estrella',planeta:'J√∫piter',signo:'C√°ncer',mito:'Proci√≥n',imagen:'tarot/17_Estrella.jpg',significado:{normal:'Esperanza, inspiraci√≥n, serenidad, renovaci√≥n. Mant√©n la fe.',invertida:'Desesperanza, falta de fe, desconexi√≥n.'},palabrasClave:['esperanza','inspiraci√≥n','fe','renovaci√≥n','gu√≠a']},
        {id:18,numero:'XVIII',nombre:'LA LVNE',nombreEs:'La Luna',planeta:'Luna',signo:'Piscis',mito:'Piscis',imagen:'tarot/18_LUNA.jpg',significado:{normal:'Ilusi√≥n, intuici√≥n, inconsciente, miedos. Conf√≠a en tu intuici√≥n.',invertida:'Confusi√≥n liberada, verdad revelada, superar miedos.'},palabrasClave:['intuici√≥n','ilusi√≥n','inconsciente','sue√±os','misterio']},
        {id:19,numero:'XVIIII',nombre:'LE SOLEIL',nombreEs:'El Sol',planeta:'Sol',signo:'Virgo',mito:'Los Dioscuros',imagen:'tarot/19_Sol.jpg',significado:{normal:'Alegr√≠a, √©xito, vitalidad, claridad, celebraci√≥n. Brilla con luz propia.',invertida:'Tristeza temporal, ego inflado, falta de claridad.'},palabrasClave:['alegr√≠a','√©xito','vitalidad','claridad','luz']},
        {id:20,numero:'XX',nombre:'LE IVGEMENT',nombreEs:'El Juicio',planeta:'Sol',signo:'Aries',mito:'El Tribunal de Diomedes',imagen:'tarot/20_Juicio.jpg',significado:{normal:'Renacimiento, despertar, absoluci√≥n. Lleg√≥ el momento de renacer.',invertida:'Dudas, rechazo al llamado, juicio err√≥neo.'},palabrasClave:['renacimiento','despertar','llamado','absoluci√≥n','verdad']},
        {id:21,numero:'XXI',nombre:'LE MONDE',nombreEs:'El Mundo',planeta:'Marte',signo:'Leo',mito:'El Tois√≥n de Oro',imagen:'tarot/21_Mundo.jpg',significado:{normal:'Completitud, integraci√≥n, logro, viaje. Has completado un ciclo importante.',invertida:'Incompletitud, estancamiento, falta de cierre.'},palabrasClave:['completitud','integraci√≥n','logro','viaje','√©xito']},
        {id:22,numero:'XXII',nombre:'LA FRATERNIT√â',nombreEs:'La Fraternidad',planeta:'Saturno',signo:'Libra',mito:'Los Gemelos Divinos',imagen:'tarot/22_LA_FRATERNITE.jpg',significado:{normal:'Hermandad, cooperaci√≥n, igualdad, alianza. Juntos sois m√°s fuertes.',invertida:'Rivalidad, desigualdad, traici√≥n entre cercanos.'},palabrasClave:['hermandad','cooperaci√≥n','igualdad','comunidad','alianza']},
        {id:23,numero:'XXIII',nombre:"L'ESPERANCE",nombreEs:'La Esperanza',planeta:'Venus',signo:'Ofiuco',mito:'Pandora',imagen:'tarot/23_LESPERANCE.jpg',significado:{normal:'Esperanza, transformaci√≥n del mal, fe inquebrantable. Siempre queda esperanza.',invertida:'Desesperaci√≥n, pesimismo, p√©rdida de fe.'},palabrasClave:['esperanza','fe','transformaci√≥n','resiliencia','luz']},
        {id:24,numero:'XXIIII',nombre:'LE TAVERNIER',nombreEs:'El Tabernero',planeta:'Saturno',signo:'Acuario',mito:'Folo el Centauro',imagen:'tarot/24_LE_TAVERNIER.jpg',significado:{normal:'Hospitalidad, generosidad, abundancia compartida. Ofrece lo mejor que tienes.',invertida:'Mezquindad, codicia, traici√≥n a la hospitalidad.'},palabrasClave:['hospitalidad','generosidad','comunidad','celebraci√≥n','abundancia']},
        {id:25,numero:'XXV',nombre:'LE CAVALIER',nombreEs:'El Caballero',planeta:'J√∫piter',signo:'Pegaso',mito:'Helio',imagen:'tarot/25_LE_CAVALIER.jpg',significado:{normal:'Viaje, b√∫squeda, aventura, movimiento. Emprende tu viaje con determinaci√≥n.',invertida:'Estancamiento, viaje retrasado, direcci√≥n perdida.'},palabrasClave:['viaje','b√∫squeda','aventura','movimiento','exploraci√≥n']},
        {id:26,numero:'XXVI',nombre:'LE PRINCE',nombreEs:'El Pr√≠ncipe',planeta:'Marte',signo:'Pegaso',mito:'Belerofonte',imagen:'tarot/26_LE_PRINCE.jpg',significado:{normal:'Ambici√≥n, logro, elevaci√≥n, dominio de lo salvaje. Doma tus impulsos.',invertida:'Arrogancia, ca√≠da, ambici√≥n desmedida.'},palabrasClave:['ambici√≥n','logro','dominio','elevaci√≥n','poder']},
        {id:27,numero:'XXVII',nombre:'LA PYTHIE',nombreEs:'La Pitia',planeta:'Luna',signo:'Ofiuco',mito:'Las Parcas',imagen:'tarot/27_LA_PYTHIE.jpg',significado:{normal:'Profec√≠a, destino, or√°culos, verdad revelada. Escucha los mensajes del universo.',invertida:'Profec√≠a malinterpretada, negar el destino, confusi√≥n espiritual.'},palabrasClave:['profec√≠a','destino','or√°culo','verdad','visi√≥n']},
        {id:0,numero:'0',nombre:'LE MAT',nombreEs:'El Loco',planeta:'Saturno',signo:'Ofiuco',mito:'Lica√≥n',imagen:'tarot/28_Loco.jpg',significado:{normal:'Nuevos comienzos, inocencia, espontaneidad, libertad. A veces la locura es el inicio de la transformaci√≥n.',invertida:'Imprudencia, riesgo innecesario, locura destructiva.'},palabrasClave:['libertad','inicio','inocencia','espontaneidad','transformaci√≥n']}
    ];

    const TIRADAS = {
        'carta-dia':{nombre:'Carta del D√≠a',descripcion:'Un mensaje para tu jornada',cartas:1,posiciones:['Mensaje del D√≠a']},
        'si-no':{nombre:'S√≠ o No',descripcion:'Respuesta directa',cartas:1,posiciones:['Respuesta']},
        'pasado-presente-futuro':{nombre:'Pasado, Presente, Futuro',descripcion:'El flujo del tiempo',cartas:3,posiciones:['Pasado','Presente','Futuro']},
        'situacion-obstaculo-consejo':{nombre:'Situaci√≥n, Obst√°culo, Consejo',descripcion:'An√°lisis pr√°ctico',cartas:3,posiciones:['Situaci√≥n','Obst√°culo','Consejo']},
        'cuatro-elementos':{nombre:'Los 4 Elementos',descripcion:'Equilibrio elemental',cartas:4,posiciones:['Fuego','Agua','Aire','Tierra']},
        'cruz-simple':{nombre:'Cruz Simple',descripcion:'Las cuatro direcciones',cartas:5,posiciones:['Centro','Norte','Sur','Este','Oeste']},
        'herradura':{nombre:'La Herradura',descripcion:'El arco del destino',cartas:7,posiciones:['Pasado Lejano','Pasado Cercano','Presente','T√∫','Entorno','Esperanzas','Resultado']},
        'cruz-celta':{nombre:'Cruz Celta',descripcion:'La tirada cl√°sica',cartas:10,posiciones:['Presente','Desaf√≠o','Pasado','Futuro','Consciente','Inconsciente','Consejo','Entorno','Esperanzas','Resultado']},
        'trabajos-hercules':{nombre:'Los 12 Trabajos',descripcion:'Las pruebas del h√©roe',cartas:12,posiciones:['Le√≥n','Hidra','Cierva','Jabal√≠','Establos','Aves','Toro','Yeguas','Cintur√≥n','Bueyes','Manzanas','Cerbero']},
        'rueda-zodiacal':{nombre:'Rueda Zodiacal',descripcion:'Las 12 casas astrol√≥gicas',cartas:12,posiciones:['Casa I - Yo','Casa II - Recursos','Casa III - Comunicaci√≥n','Casa IV - Hogar','Casa V - Creatividad','Casa VI - Salud','Casa VII - Relaciones','Casa VIII - Transformaci√≥n','Casa IX - Filosof√≠a','Casa X - Carrera','Casa XI - Amigos','Casa XII - Espiritualidad']},
        'ciclo-lunar':{nombre:'üåô Ciclo Lunar',descripcion:'Los 28 d√≠as del mes',cartas:28,posiciones:Array.from({length:28},(_,i)=>`D√≠a ${i+1}`)},
        'chakras-cuerpos':{nombre:'‚ú® Chakras √ó 4 Cuerpos',descripcion:'7 chakras en 4 niveles',cartas:28,posiciones:['Ra√≠z-F√≠sico','Ra√≠z-Emocional','Ra√≠z-Mental','Ra√≠z-Espiritual','Sacro-F√≠sico','Sacro-Emocional','Sacro-Mental','Sacro-Espiritual','Plexo-F√≠sico','Plexo-Emocional','Plexo-Mental','Plexo-Espiritual','Coraz√≥n-F√≠sico','Coraz√≥n-Emocional','Coraz√≥n-Mental','Coraz√≥n-Espiritual','Garganta-F√≠sico','Garganta-Emocional','Garganta-Mental','Garganta-Espiritual','Tercer Ojo-F√≠sico','Tercer Ojo-Emocional','Tercer Ojo-Mental','Tercer Ojo-Espiritual','Corona-F√≠sico','Corona-Emocional','Corona-Mental','Corona-Espiritual']},
        'mandala-hercules':{nombre:'üèõÔ∏è Mandala de H√©rcules',descripcion:'Esencia, trabajos y camino',cartas:28,posiciones:['Esencia 1','Esencia 2','Esencia 3','Esencia 4','Trabajo 1','Trabajo 2','Trabajo 3','Trabajo 4','Trabajo 5','Trabajo 6','Trabajo 7','Trabajo 8','Trabajo 9','Trabajo 10','Trabajo 11','Trabajo 12','Camino 1','Camino 2','Camino 3','Camino 4','Camino 5','Camino 6','Camino 7','Camino 8','Camino 9','Camino 10','Camino 11','Camino 12']},
        'gran-cruz':{nombre:'‚öîÔ∏è Gran Cruz C√≥smica',descripcion:'4 elementos en 7 niveles',cartas:28,posiciones:['Fuego 1','Fuego 2','Fuego 3','Fuego 4','Fuego 5','Fuego 6','Fuego 7','Agua 1','Agua 2','Agua 3','Agua 4','Agua 5','Agua 6','Agua 7','Aire 1','Aire 2','Aire 3','Aire 4','Aire 5','Aire 6','Aire 7','Tierra 1','Tierra 2','Tierra 3','Tierra 4','Tierra 5','Tierra 6','Tierra 7']},
        'planetas-estaciones':{nombre:'ü™ê Planetas √ó Estaciones',descripcion:'7 planetas en 4 estaciones',cartas:28,posiciones:['Sol-Primavera','Luna-Primavera','Mercurio-Primavera','Venus-Primavera','Marte-Primavera','J√∫piter-Primavera','Saturno-Primavera','Sol-Verano','Luna-Verano','Mercurio-Verano','Venus-Verano','Marte-Verano','J√∫piter-Verano','Saturno-Verano','Sol-Oto√±o','Luna-Oto√±o','Mercurio-Oto√±o','Venus-Oto√±o','Marte-Oto√±o','J√∫piter-Oto√±o','Saturno-Oto√±o','Sol-Invierno','Luna-Invierno','Mercurio-Invierno','Venus-Invierno','Marte-Invierno','J√∫piter-Invierno','Saturno-Invierno']},
        'izarren':{nombre:'‚≠ê Tirada Izarren',descripcion:'Las 28 exaltaciones',cartas:28,posiciones:EXALTACIONES.map(e=>`${PLANET_SYMBOLS[e.planeta]} ${e.planeta} en ${e.signo}`)}
    };

    // ========================================================================
    // ESTADO DE LA APP
    // ========================================================================
    
    const state = {
        currentScreen: 'hoy',
        tiradaActiva: null,
        cartasSeleccionadas: [],
        cartasReveladas: [],
        mesActual: new Date().getMonth(),
        yearActual: new Date().getFullYear(),
        cartaDiaRevelada: false,
        cartaDia: null,
        fechaSeleccionada: null,
        // AGENDA DE EVENTOS
        eventos: JSON.parse(localStorage.getItem('tarot_eventos') || '[]')
    };
    
    // Categor√≠as de eventos
    const CATEGORIAS_EVENTOS = {
        cumple: { icon: 'üéÇ', color: '#e91e63', nombre: 'Cumplea√±os' },
        trabajo: { icon: 'üíº', color: '#3498db', nombre: 'Trabajo' },
        dinero: { icon: 'üí∞', color: '#27ae60', nombre: 'Dinero' },
        amor: { icon: '‚ù§Ô∏è', color: '#e74c3c', nombre: 'Amor' },
        salud: { icon: 'üè•', color: '#9b59b6', nombre: 'Salud' },
        viaje: { icon: '‚úàÔ∏è', color: '#f39c12', nombre: 'Viaje' },
        familia: { icon: 'üë®‚Äçüë©‚Äçüëß', color: '#1abc9c', nombre: 'Familia' },
        espiritual: { icon: 'üßò', color: '#8e44ad', nombre: 'Espiritual' },
        otro: { icon: 'üìå', color: '#95a5a6', nombre: 'Otro' }
    };
    
    // Funciones de eventos
    function guardarEventos() {
        localStorage.setItem('tarot_eventos', JSON.stringify(state.eventos));
    }
    
    function agregarEvento(evento) {
        evento.id = Date.now();
        state.eventos.push(evento);
        guardarEventos();
    }
    
    function eliminarEvento(id) {
        state.eventos = state.eventos.filter(e => e.id !== id);
        guardarEventos();
    }
    
    function getEventosPorFecha(fecha) {
        const fechaStr = fecha.toISOString().split('T')[0];
        const fechaObj = new Date(fecha);
        fechaObj.setHours(0, 0, 0, 0);
        const dia = fechaObj.getDate();
        const mes = fechaObj.getMonth();
        const diaSemana = fechaObj.getDay();
        
        return state.eventos.filter(e => {
            // Evento exacto en esta fecha
            if (e.fecha === fechaStr) return true;
            
            // Sin recurrencia
            if (!e.recurrencia || e.recurrencia === 'none') return false;
            
            // Verificar rango de fechas de recurrencia
            const fechaInicio = new Date((e.recInicio || e.fecha) + 'T00:00:00');
            const fechaFin = e.recFin ? new Date(e.recFin + 'T23:59:59') : null;
            
            // La fecha consultada debe estar dentro del rango
            if (fechaObj < fechaInicio) return false;
            if (fechaFin && fechaObj > fechaFin) return false;
            
            const fechaEvento = new Date(e.fecha + 'T00:00:00');
            
            // Recurrencia diaria
            if (e.recurrencia === 'daily') return true;
            
            // Recurrencia semanal (mismo d√≠a de la semana)
            if (e.recurrencia === 'weekly') {
                return fechaEvento.getDay() === diaSemana;
            }
            
            // Recurrencia mensual (mismo d√≠a del mes)
            if (e.recurrencia === 'monthly') {
                return fechaEvento.getDate() === dia;
            }
            
            // Recurrencia anual (mismo d√≠a y mes - cumplea√±os)
            if (e.recurrencia === 'yearly') {
                return fechaEvento.getDate() === dia && fechaEvento.getMonth() === mes;
            }
            
            return false;
        });
    }

    // ========================================================================
    // FUNCIONES AUXILIARES
    // ========================================================================
    
    function getLunaNuevaAnterior(fecha) {
        // Primero intentamos con las lunas precalculadas
        for (let i = LUNAS_NUEVAS.length - 1; i >= 0; i--) {
            if (LUNAS_NUEVAS[i] <= fecha) return LUNAS_NUEVAS[i];
        }
        // Si la fecha es anterior a nuestras lunas precalculadas, calculamos
        return calcularLunaNuevaCercana(fecha);
    }

    function getSiguienteLunaNueva(fecha) {
        // Primero intentamos con las lunas precalculadas
        for (let ln of LUNAS_NUEVAS) {
            if (ln > fecha) return ln;
        }
        // Si no hay, calculamos la siguiente
        return calcularSiguienteLunaNueva(fecha);
    }

    // Algoritmo para calcular fases lunares de cualquier fecha
    // Basado en el ciclo sin√≥dico lunar de 29.53058867 d√≠as
    const CICLO_LUNAR = 29.53058867;
    // Luna nueva de referencia: 6 de enero de 2000 a las 18:14 UTC
    const LUNA_REF = new Date('2000-01-06T18:14:00Z');

    function calcularLunaNuevaCercana(fecha) {
        const diffMs = fecha.getTime() - LUNA_REF.getTime();
        const diffDias = diffMs / (1000 * 60 * 60 * 24);
        const ciclosCompletos = Math.floor(diffDias / CICLO_LUNAR);
        const lunaNueva = new Date(LUNA_REF.getTime() + ciclosCompletos * CICLO_LUNAR * 24 * 60 * 60 * 1000);
        return lunaNueva;
    }

    function calcularSiguienteLunaNueva(fecha) {
        const lunaCercana = calcularLunaNuevaCercana(fecha);
        if (lunaCercana > fecha) return lunaCercana;
        return new Date(lunaCercana.getTime() + CICLO_LUNAR * 24 * 60 * 60 * 1000);
    }

    function diasEntre(fecha1, fecha2) {
        // Normalizar a medianoche para contar d√≠as calendario completos
        const d1 = new Date(fecha1.getFullYear(), fecha1.getMonth(), fecha1.getDate());
        const d2 = new Date(fecha2.getFullYear(), fecha2.getMonth(), fecha2.getDate());
        return Math.round((d2 - d1) / (24 * 60 * 60 * 1000));
    }

    function getDiaLunar(fecha) {
        const lunaNueva = getLunaNuevaAnterior(fecha);
        return diasEntre(lunaNueva, fecha) + 1;
    }

    function getFaseLunar(diaLunar) {
        for (let fase of FASES_LUNARES) {
            if (diaLunar >= fase.rango[0] && diaLunar <= fase.rango[1]) return fase;
        }
        return FASES_LUNARES[0];
    }

    function getExaltacionDia(diaLunar) {
        const index = (diaLunar - 1) % 28;
        return EXALTACIONES[index];
    }

    // ========================================================================
    // VSOP87 COMPACTO - Posiciones planetarias precisas (¬±0.5¬∞)
    // Basado en "Astronomical Algorithms" de Jean Meeus
    // Funciona 100% offline sin conexi√≥n a servidor
    // ========================================================================
    
    // Convertir fecha a D√≠a Juliano
    function fechaAJuliano(fecha, tzOffset) {
        // Acepta objeto Date o {year, month, day, hour, minute}
        let y, m, d, horaLocal;
        
        if (fecha.year !== undefined) {
            // Objeto simple {year, month, day, hour, minute}
            y = fecha.year;
            m = fecha.month;
            d = fecha.day;
            horaLocal = fecha.hour + (fecha.minute || 0) / 60;
        } else {
            // Objeto Date - usar hora local del navegador
            y = fecha.getFullYear();
            m = fecha.getMonth() + 1;
            d = fecha.getDate();
            horaLocal = fecha.getHours() + fecha.getMinutes() / 60;
            // Si no se proporciona tzOffset, usar el del navegador
            if (tzOffset === undefined) {
                tzOffset = -fecha.getTimezoneOffset() / 60;
            }
        }
        
        // Convertir hora local a UT: horaUT = horaLocal - tzOffset
        const horaUT = horaLocal - (tzOffset || 0);
        const dFrac = d + horaUT / 24;
        
        if (m <= 2) { y--; m += 12; }
        const A = Math.floor(y / 100);
        const B = 2 - A + Math.floor(A / 4);
        return Math.floor(365.25 * (y + 4716)) + Math.floor(30.6001 * (m + 1)) + dFrac + B - 1524.5;
    }
    
    const DEG = Math.PI / 180;
    const norm360 = x => ((x % 360) + 360) % 360;
    
    // ===================== SOL (Meeus cap. 25) =====================
    function calcularSol(jd) {
        const T = (jd - 2451545.0) / 36525;
        const L0 = norm360(280.46646 + 36000.76983 * T + 0.0003032 * T*T);
        const M = norm360(357.52911 + 35999.05029 * T - 0.0001537 * T*T);
        const Mr = M * DEG;
        const C = (1.914602 - 0.004817 * T) * Math.sin(Mr) 
                + 0.019993 * Math.sin(2*Mr) 
                + 0.00029 * Math.sin(3*Mr);
        return norm360(L0 + C);
    }
    
    // ===================== LUNA (Meeus cap. 47) =====================
    function calcularLuna(jd) {
        const T = (jd - 2451545.0) / 36525;
        const Lp = norm360(218.3164477 + 481267.88123421 * T);
        const D = norm360(297.8501921 + 445267.1114034 * T);
        const M = norm360(357.5291092 + 35999.0502909 * T);
        const Mp = norm360(134.9633964 + 477198.8675055 * T);
        const F = norm360(93.272095 + 483202.0175233 * T);
        
        const Dr = D * DEG, Mr = M * DEG, Mpr = Mp * DEG, Fr = F * DEG;
        
        let sumL = 6288774 * Math.sin(Mpr)
                 + 1274027 * Math.sin(2*Dr - Mpr)
                 + 658314 * Math.sin(2*Dr)
                 + 213618 * Math.sin(2*Mpr)
                 - 185116 * Math.sin(Mr)
                 - 114332 * Math.sin(2*Fr)
                 + 58793 * Math.sin(2*Dr - 2*Mpr)
                 + 57066 * Math.sin(2*Dr - Mr - Mpr)
                 + 53322 * Math.sin(2*Dr + Mpr)
                 + 45758 * Math.sin(2*Dr - Mr)
                 - 40923 * Math.sin(Mr - Mpr)
                 - 34720 * Math.sin(Dr)
                 - 30383 * Math.sin(Mr + Mpr);
        
        return norm360(Lp + sumL / 1000000);
    }
    
    // ===================== PLANETAS INTERIORES (Meeus simplificado) =====================
    // Usamos elementos orbitales medios y ecuaci√≥n de Kepler
    
    const PLANETAS = {
        Mercury: { 
            a: 0.387098, e: 0.205635, i: 7.005, 
            L0: 252.25084, Ldot: 4.09233445,  // longitud media
            w0: 77.45645, wdot: 0.15940013,   // argumento perihelio
            O0: 48.33167, Odot: -0.12534113   // longitud nodo
        },
        Venus: { 
            a: 0.723332, e: 0.006772, i: 3.3947,
            L0: 181.97973, Ldot: 1.60213034,
            w0: 131.60247, wdot: 0.00268329,
            O0: 76.68069, Odot: -0.27769418
        },
        Mars: { 
            a: 1.523679, e: 0.093394, i: 1.8497,
            L0: 355.45332, Ldot: 0.52402068,
            w0: 336.04084, wdot: 0.01128058,
            O0: 49.57854, Odot: -0.00778518
        },
        Jupiter: { 
            a: 5.202561, e: 0.048498, i: 1.3053,
            L0: 34.40438, Ldot: 0.08308676,
            w0: 14.75385, wdot: 0.00183714,
            O0: 100.55615, Odot: 0.00183714
        },
        Saturn: { 
            a: 9.554909, e: 0.055509, i: 2.4845,
            L0: 49.94432, Ldot: 0.03346062,
            w0: 92.43194, wdot: 0.00541756,
            O0: 113.71504, Odot: -0.00292750
        }
    };
    
    // Resolver ecuaci√≥n de Kepler
    function keplerE(M, e) {
        M = M * DEG;
        let E = M;
        for (let i = 0; i < 10; i++) {
            E = M + e * Math.sin(E);
        }
        return E;
    }
    
    // Calcular posici√≥n helioc√©ntrica
    function calcularPosHelio(planeta, jd) {
        const p = PLANETAS[planeta];
        const d = jd - 2451545.0; // d√≠as desde J2000
        const T = d / 36525;      // siglos julianos
        
        // Elementos orbitales para la fecha
        const L = norm360(p.L0 + p.Ldot * d);  // longitud media
        const w = norm360(p.w0 + p.wdot * T);  // argumento perihelio
        const M = norm360(L - w);               // anomal√≠a media
        
        // Resolver Kepler
        const E = keplerE(M, p.e);
        
        // Anomal√≠a verdadera
        const xv = p.a * (Math.cos(E) - p.e);
        const yv = p.a * Math.sqrt(1 - p.e*p.e) * Math.sin(E);
        const v = Math.atan2(yv, xv);
        const r = Math.sqrt(xv*xv + yv*yv);
        
        // Longitud helioc√©ntrica (simplificada, sin inclinaci√≥n)
        const lonHelio = norm360((v / DEG) + w);
        
        return { lon: lonHelio, r: r };
    }
    
    // Calcular posici√≥n geoc√©ntrica
    function calcularPlanetaGeo(jd, planeta) {
        // Posici√≥n del planeta
        const posPlaneta = calcularPosHelio(planeta, jd);
        
        // Posici√≥n de la Tierra (desde el Sol)
        const lonSol = calcularSol(jd);
        const lonTierra = norm360(lonSol + 180);
        const rTierra = 1.0;
        
        // Convertir a coordenadas cartesianas
        const xp = posPlaneta.r * Math.cos(posPlaneta.lon * DEG);
        const yp = posPlaneta.r * Math.sin(posPlaneta.lon * DEG);
        const xt = rTierra * Math.cos(lonTierra * DEG);
        const yt = rTierra * Math.sin(lonTierra * DEG);
        
        // Vector geoc√©ntrico
        const dx = xp - xt;
        const dy = yp - yt;
        
        return norm360(Math.atan2(dy, dx) / DEG);
    }
    
    // ===================== L√çMITES SIGNOS (14 - seg√∫n server.py) =====================
    // Formato: (inicio, longitud) donde fin = inicio + longitud
    const LIMITES_SIGNOS = [
        { signo: 'Aries', inicio: 354, longitud: 36 },      // 354-30 (cruza 0¬∞)
        { signo: 'Tauro', inicio: 30, longitud: 30 },       // 30-60
        { signo: 'G√©minis', inicio: 60, longitud: 30 },     // 60-90
        { signo: 'C√°ncer', inicio: 90, longitud: 30 },      // 90-120
        { signo: 'Leo', inicio: 120, longitud: 30 },        // 120-150
        { signo: 'Virgo', inicio: 150, longitud: 36 },      // 150-186
        { signo: 'Libra', inicio: 186, longitud: 24 },      // 186-210
        { signo: 'Escorpio', inicio: 210, longitud: 30 },   // 210-240
        { signo: 'Ofiuco', inicio: 240, longitud: 12 },     // 240-252
        { signo: 'Sagitario', inicio: 252, longitud: 18 },  // 252-270
        { signo: 'Capricornio', inicio: 270, longitud: 36 },// 270-306
        { signo: 'Acuario', inicio: 306, longitud: 18 },    // 306-324
        { signo: 'Pegaso', inicio: 324, longitud: 6 },      // 324-330
        { signo: 'Piscis', inicio: 330, longitud: 24 }      // 330-354
    ];
    
    function getSignoDesdeLongitud(lon) {
        lon = norm360(lon);
        
        for (const s of LIMITES_SIGNOS) {
            const fin = s.inicio + s.longitud;
            if (s.inicio > 354) {
                // Aries cruza 0¬∞
                if (lon >= s.inicio || lon < (fin % 360)) return s.signo;
            } else {
                if (lon >= s.inicio && lon < fin) return s.signo;
            }
        }
        return 'Aries';
    }
    
    // ===================== DIGNIDADES =====================
    const DIGNIDADES = {
        'Sol': {
            exaltacion: ['Leo', 'Aries', 'Capricornio', 'Virgo'],
            domicilio: ['Escorpio', 'G√©minis', 'Pegaso'],
            exilio: ['Tauro', 'Sagitario'],
            caida: ['C√°ncer', 'Piscis', 'Libra', 'Acuario', 'Ofiuco']
        },
        'Luna': {
            exaltacion: ['C√°ncer', 'Piscis', 'Libra', 'Acuario', 'Ofiuco'],
            domicilio: ['Tauro', 'Sagitario'],
            exilio: ['Escorpio', 'G√©minis', 'Pegaso'],
            caida: ['Leo', 'Aries', 'Capricornio', 'Virgo']
        },
        'Mercurio': {
            exaltacion: ['G√©minis', 'Capricornio', 'Virgo'],
            domicilio: ['Leo', 'Aries', 'Escorpio', 'Pegaso'],
            exilio: ['C√°ncer', 'Piscis', 'Sagitario'],
            caida: ['Tauro', 'Libra', 'Acuario', 'Ofiuco']
        },
        'Venus': {
            exaltacion: ['Tauro', 'Libra', 'Acuario', 'Ofiuco'],
            domicilio: ['C√°ncer', 'Piscis', 'Sagitario'],
            exilio: ['Leo', 'Aries', 'Escorpio', 'Pegaso'],
            caida: ['G√©minis', 'Capricornio', 'Virgo']
        },
        'Marte': {
            exaltacion: ['Leo', 'Aries', 'Escorpio', 'Pegaso'],
            domicilio: ['G√©minis', 'Capricornio', 'Virgo'],
            exilio: ['Tauro', 'Libra', 'Acuario', 'Ofiuco'],
            caida: ['C√°ncer', 'Piscis', 'Sagitario']
        },
        'J√∫piter': {
            exaltacion: ['C√°ncer', 'Piscis', 'Sagitario', 'Pegaso'],
            domicilio: ['Tauro', 'Libra', 'Acuario', 'Ofiuco'],
            exilio: ['G√©minis', 'Capricornio', 'Virgo'],
            caida: ['Leo', 'Aries', 'Escorpio']
        },
        'Saturno': {
            exaltacion: ['Ofiuco', 'G√©minis', 'Libra', 'Acuario'],
            domicilio: ['Leo', 'Aries', 'Sagitario'],
            exilio: ['C√°ncer', 'Piscis', 'Escorpio', 'Pegaso'],
            caida: ['Tauro', 'Capricornio', 'Virgo']
        }
    };
    
    function calcularDignidad(planeta, signo) {
        const dig = DIGNIDADES[planeta];
        if (!dig) return { tipo: 'peregrino', fuerza: 0 };
        if (dig.exaltacion.includes(signo)) return { tipo: 'exaltaci√≥n', fuerza: 2 };
        if (dig.domicilio.includes(signo)) return { tipo: 'domicilio', fuerza: 1 };
        if (dig.exilio.includes(signo)) return { tipo: 'exilio', fuerza: -1 };
        if (dig.caida.includes(signo)) return { tipo: 'ca√≠da', fuerza: -2 };
        return { tipo: 'peregrino', fuerza: 0 };
    }
    
    // ===================== ASPECTOS Y PATRONES (orbe 6¬∞) =====================
    const PATTERN_ORBS = {
        conjunction: 6,
        opposition: 6,
        trine: 6,
        square: 6,
        sextile: 6,
        quintile: 6,        // 72¬∞
        biquintile: 6,      // 108¬∞
        sesquiquadrate: 6   // 135¬∞
    };
    
    const ASPECTOS = {
        conjuncion: { angulo: 0, orbe: 6, nombre: 'Conjunci√≥n', simbolo: '‚òå', color: '#e74c3c' },
        sextil: { angulo: 60, orbe: 6, nombre: 'Sextil', simbolo: '‚öπ', color: '#3498db' },
        cuadratura: { angulo: 90, orbe: 6, nombre: 'Cuadratura', simbolo: '‚ñ°', color: '#27ae60' },
        trigono: { angulo: 120, orbe: 6, nombre: 'Tr√≠gono', simbolo: '‚ñ≥', color: '#3498db' },
        oposicion: { angulo: 180, orbe: 6, nombre: 'Oposici√≥n', simbolo: '‚òç', color: '#e74c3c' },
        quintil: { angulo: 72, orbe: 6, nombre: 'Quintil', simbolo: 'Q', color: '#f1c40f' },
        biquintil: { angulo: 108, orbe: 6, nombre: 'Biquintil', simbolo: 'bQ', color: '#f1c40f' },
        sesquicuadratura: { angulo: 135, orbe: 6, nombre: 'Sesquicuadratura', simbolo: '‚öº', color: '#27ae60' }
    };
    
    const PATRONES_DEF = {
        'GRAND_TRINE': { 
            nombre: 'Gran Tr√≠gono', icono: '‚ñ≥', color: '#6495ed', 
            keywords: ['Talento', 'Facilidad', 'Armon√≠a'],
            elemento: 'Agua',
            cualidades: 'Fr√≠o + H√∫medo',
            angulos: '3√ó 120¬∞',
            descripcionElemental: 'Agua (contracci√≥n fluida) - las energ√≠as fluyen sin fricci√≥n en circuito cerrado'
        },
        'T_SQUARE': { 
            nombre: 'T-Cuadrada', icono: '‚ä•', color: '#ff4500', 
            keywords: ['Tensi√≥n', 'Motivaci√≥n', 'Acci√≥n'],
            elemento: 'Tierra/Fuego',
            cualidades: 'Fr√≠o+Seco / C√°lido+Seco',
            angulos: '2√ó 90¬∞ + 1√ó 180¬∞',
            descripcionElemental: 'Tierra+Fuego (tensi√≥n seca) - fricci√≥n contractiva con ignici√≥n expansiva en el √°pex'
        },
        'GRAND_CROSS': { 
            nombre: 'Gran Cruz', icono: '‚úö', color: '#dc143c', 
            keywords: ['Crisis', 'Transformaci√≥n', 'Poder'],
            elemento: 'Tierra/Fuego',
            cualidades: 'Fr√≠o+Seco / C√°lido+Seco',
            angulos: '4√ó 90¬∞ + 2√ó 180¬∞',
            descripcionElemental: 'Tierra+Fuego (m√°xima tensi√≥n seca) - doble eje de fuego con cu√°druple fricci√≥n terrestre'
        },
        'STELLIUM': { 
            nombre: 'Stellium', icono: '‚ú¶', color: '#ffd700', 
            keywords: ['Concentraci√≥n', 'Intensidad', 'Foco'],
            elemento: 'Fuego',
            cualidades: 'C√°lido + Seco',
            angulos: 'm√∫ltiples 0¬∞',
            descripcionElemental: 'Fuego (expansi√≥n tensa) - concentraci√≥n √≠gnea de energ√≠as en un punto'
        },
        'KITE': { 
            nombre: 'Cometa', icono: '‚óá', color: '#27ae60', 
            keywords: ['Direcci√≥n', 'Prop√≥sito', 'Logro'],
            elemento: 'Agua/Fuego',
            cualidades: 'H√∫medo / Seco',
            angulos: '3√ó 120¬∞ + 2√ó 60¬∞ + 1√ó 180¬∞',
            descripcionElemental: 'Agua+Fuego (fluido+tenso) - flujo acu√°tico canalizado por la tensi√≥n del fuego'
        },
        'MYSTIC_RECTANGLE': { 
            nombre: 'Rect√°ngulo M√≠stico', icono: '‚ñ≠', color: '#3498db', 
            keywords: ['Equilibrio', 'S√≠ntesis'],
            elemento: 'Agua/Fuego',
            cualidades: 'H√∫medo / Seco',
            angulos: '2√ó 180¬∞ + 2√ó 60¬∞ + 2√ó 120¬∞',
            descripcionElemental: 'Agua+Fuego (fluido+tenso) - s√≠ntesis h√∫meda equilibrada por ejes secos'
        },
        'GOLDEN_RECTANGLE': { 
            nombre: 'Rect√°ngulo √Åureo', icono: '‚¨°', color: '#daa520', 
            keywords: ['Creatividad', 'Proporci√≥n √°urea'],
            elemento: 'Aire',
            cualidades: 'C√°lido + H√∫medo',
            angulos: '2√ó 72¬∞ + 2√ó 108¬∞',
            descripcionElemental: 'Aire (expansi√≥n fluida) - proporci√≥n √°urea mental y creatividad expansiva'
        },
        'EARTH_TRIANGLE': { 
            nombre: 'Tri√°ngulo de Tierra', icono: '‚ñ≤', color: '#32cd32', 
            keywords: ['Estructura', 'Manifestaci√≥n'],
            elemento: 'Tierra',
            cualidades: 'Fr√≠o + Seco',
            angulos: '2√ó 135¬∞ + 1√ó 90¬∞',
            descripcionElemental: 'Tierra (contracci√≥n tensa) - base s√≥lida para materializar con fricci√≥n'
        },
        'CONJUNCTION_EXACT': { 
            nombre: 'Conjunci√≥n Exacta', icono: '‚òå', color: '#667eea', 
            keywords: ['Activaci√≥n', 'Intensidad'],
            elemento: 'Fuego',
            cualidades: 'C√°lido + Seco',
            angulos: '0¬∞',
            descripcionElemental: 'Fuego (expansi√≥n tensa) - punto de ignici√≥n donde las energ√≠as se fusionan'
        }
    };
    
    // Significados de los planetas
    // Cualidades de los elementos (tradici√≥n cl√°sica)
    const CUALIDADES_ELEMENTOS = {
        'Fuego': { 
            icono: 'üî•', 
            temperatura: 'C√°lido', 
            humedad: 'Seco',
            accion: 'Expansivo + Tenso',
            descripcion: 'Energ√≠a expansiva y tensa que enciende e inicia'
        },
        'Agua': { 
            icono: 'üíß', 
            temperatura: 'Fr√≠o', 
            humedad: 'H√∫medo',
            accion: 'Contractivo + Fluido',
            descripcion: 'Energ√≠a receptiva y fluida que nutre y conecta'
        },
        'Aire': { 
            icono: 'üí®', 
            temperatura: 'C√°lido', 
            humedad: 'H√∫medo',
            accion: 'Expansivo + Fluido',
            descripcion: 'Energ√≠a expansiva y fluida que comunica y relaciona'
        },
        'Tierra': { 
            icono: 'üåç', 
            temperatura: 'Fr√≠o', 
            humedad: 'Seco',
            accion: 'Contractivo + Tenso',
            descripcion: 'Energ√≠a concentrada y tensa que materializa y estructura'
        }
    };

    const SIGNIFICADOS_PLANETAS = {
        'Sol': { esencia: 'voluntad, vitalidad, ego, prop√≥sito', verbo: 'ilumina', area: 'identidad y expresi√≥n personal' },
        'Luna': { esencia: 'emociones, intuici√≥n, necesidades, hogar', verbo: 'nutre', area: 'vida emocional y dom√©stica' },
        'Mercurio': { esencia: 'comunicaci√≥n, pensamiento, aprendizaje', verbo: 'conecta', area: 'mente y comunicaciones' },
        'Venus': { esencia: 'amor, belleza, valores, armon√≠a', verbo: 'armoniza', area: 'relaciones y placeres' },
        'Marte': { esencia: 'acci√≥n, energ√≠a, deseo, coraje', verbo: 'impulsa', area: 'voluntad y acci√≥n' },
        'J√∫piter': { esencia: 'expansi√≥n, sabidur√≠a, suerte, crecimiento', verbo: 'expande', area: 'crecimiento y oportunidades' },
        'Saturno': { esencia: 'estructura, disciplina, tiempo, l√≠mites', verbo: 'consolida', area: 'responsabilidades y logros' }
    };
    
    // Sistema de colores planetarios seg√∫n posici√≥n zodiacal
    // Basado en la longitud ecl√≠ptica: 150¬∞-330¬∞ (Virgo-Piscis) vs resto (Aries-Leo)
    const COLORES_PLANETARIOS = {
        'SOL_ROJO': { color: '#e74c3c', nombre: 'Sol Rojo', funcion: 'Inteligencia', descripcion: 'El Sol como principio de inteligencia activa' },
        'SOL_VERDE': { color: '#27ae60', nombre: 'Sol Verde', funcion: 'Une el √ìrgano del Sustento con el Objeto de la Relaci√≥n', descripcion: 'El Sol como mediador entre nutrici√≥n y v√≠nculos' },
        'LUNA_AMARILLO': { color: '#f1c40f', nombre: 'Luna Amarilla', funcion: 'Une el Objeto del Sustento con el √ìrgano de la Relaci√≥n', descripcion: 'La Luna conectando recursos con capacidad vincular' },
        'LUNA_AZUL': { color: '#3498db', nombre: 'Luna Azul', funcion: 'Mente', descripcion: 'La Luna como principio mental receptivo' },
        'MERCURIO_GREEN': { color: '#2ecc71', nombre: 'Mercurio Verde', funcion: 'Objeto de la Mente', descripcion: 'Mercurio como contenido del pensamiento' },
        'MERCURIO_YELLOW': { color: '#f39c12', nombre: 'Mercurio Amarillo', funcion: 'Inteligencia', descripcion: 'Mercurio como inteligencia comunicativa' },
        'VENUS_YELLOW': { color: '#f1c40f', nombre: 'Venus Amarillo', funcion: 'Objeto de la Relaci√≥n', descripcion: 'Venus como aquello que se desea vincular' },
        'VENUS_GREEN': { color: '#27ae60', nombre: 'Venus Verde', funcion: 'Objeto del Sustento', descripcion: 'Venus como aquello que nutre y sustenta' },
        'MARTE_BLUE': { color: '#2980b9', nombre: 'Marte Azul', funcion: '√ìrgano de la Mente', descripcion: 'Marte como capacidad de acci√≥n mental' },
        'MARTE_RED': { color: '#c0392b', nombre: 'Marte Rojo', funcion: '√ìrgano de la Inteligencia', descripcion: 'Marte como ejecutor de la inteligencia' },
        'JUPITER_BLUE': { color: '#3498db', nombre: 'J√∫piter Azul', funcion: '√ìrgano del Sustento', descripcion: 'J√∫piter como capacidad de nutrir y expandir recursos' },
        'JUPITER_RED': { color: '#e74c3c', nombre: 'J√∫piter Rojo', funcion: '√ìrgano de la Relaci√≥n', descripcion: 'J√∫piter como capacidad de expandir v√≠nculos' },
        'SATURNO_YELLOW': { color: '#f39c12', nombre: 'Saturno Amarillo', funcion: 'Conciencia', descripcion: 'Saturno como principio de conciencia y l√≠mite' }
    };
    
    // Funci√≥n para obtener el color de un planeta seg√∫n su longitud
    function getColorPlanetario(nombre, lon) {
        lon = parseFloat(lon) % 360;
        const enZonaSur = lon > 150 && lon <= 330; // Virgo a Piscis
        
        switch(nombre) {
            case 'Sol':
                return enZonaSur ? 'SOL_VERDE' : 'SOL_ROJO';
            case 'Luna':
                return enZonaSur ? 'LUNA_AMARILLO' : 'LUNA_AZUL';
            case 'Mercurio':
                return enZonaSur ? 'MERCURIO_GREEN' : 'MERCURIO_YELLOW';
            case 'Venus':
                return enZonaSur ? 'VENUS_YELLOW' : 'VENUS_GREEN';
            case 'Marte':
                return enZonaSur ? 'MARTE_BLUE' : 'MARTE_RED';
            case 'J√∫piter':
                // J√∫piter tiene l√≥gica inversa: lon <= 150 OR lon >= 306
                return (lon <= 150 || lon >= 306) ? 'JUPITER_BLUE' : 'JUPITER_RED';
            case 'Saturno':
                return 'SATURNO_YELLOW'; // Siempre amarillo
            default:
                return null;
        }
    }
    
    // Obtener informaci√≥n completa del color planetario
    function getInfoColorPlanetario(nombre, lon) {
        const colorKey = getColorPlanetario(nombre, lon);
        if (!colorKey) return null;
        return { key: colorKey, ...COLORES_PLANETARIOS[colorKey] };
    }
    
    // Significados de los aspectos
    const SIGNIFICADOS_ASPECTOS = {
        'conjuncion': { 
            esencia: 'fusi√≥n de energ√≠as', 
            efecto: 'Las energ√≠as se fusionan intensamente',
            elemento: 'Fuego',
            cualidades: 'C√°lido (Expansivo) + Seco (Tenso)',
            fraccion: '0¬∞ (2/1 de 180¬∞)',
            descripcionElemental: 'Fuego: expansi√≥n tensa - ignici√≥n donde las energ√≠as se encienden y fusionan'
        },
        'sextil': { 
            esencia: 'oportunidad armoniosa', 
            efecto: 'Oportunidades fluidas y creativas',
            elemento: 'Agua',
            cualidades: 'Fr√≠o (Contractivo) + H√∫medo (Fluido)',
            fraccion: '60¬∞ (1/3 de 180¬∞)',
            descripcionElemental: 'Agua: contracci√≥n fluida - flujo arm√≥nico y receptivo entre signos compatibles'
        },
        'cuadratura': { 
            esencia: 'tensi√≥n creativa', 
            efecto: 'Tensi√≥n que impulsa a la acci√≥n',
            elemento: 'Tierra',
            cualidades: 'Fr√≠o (Contractivo) + Seco (Tenso)',
            fraccion: '90¬∞ (1/2 de 180¬∞)',
            descripcionElemental: 'Tierra: contracci√≥n tensa - fricci√≥n que exige manifestaci√≥n concreta'
        },
        'trigono': { 
            esencia: 'flujo natural', 
            efecto: 'Armon√≠a natural y talentos',
            elemento: 'Agua',
            cualidades: 'Fr√≠o (Contractivo) + H√∫medo (Fluido)',
            fraccion: '120¬∞ (2/3 de 180¬∞)',
            descripcionElemental: 'Agua: contracci√≥n fluida - las energ√≠as fluyen sin resistencia'
        },
        'oposicion': { 
            esencia: 'polaridad y equilibrio', 
            efecto: 'Necesidad de integrar opuestos',
            elemento: 'Fuego',
            cualidades: 'C√°lido (Expansivo) + Seco (Tenso)',
            fraccion: '180¬∞ (1/1 de 180¬∞)',
            descripcionElemental: 'Fuego: expansi√≥n tensa - tensi√≥n m√°xima entre polos opuestos'
        },
        'quintil': {
            esencia: 'creatividad especial',
            efecto: 'Talento creativo √∫nico',
            elemento: 'Aire',
            cualidades: 'C√°lido (Expansivo) + H√∫medo (Fluido)',
            fraccion: '72¬∞ (2/5 de 180¬∞)',
            descripcionElemental: 'Aire: expansi√≥n fluida - conexi√≥n mental creativa y talentos especiales'
        },
        'sesquiquintil': {
            esencia: 'creatividad aplicada',
            efecto: 'Expresi√≥n del talento creativo',
            elemento: 'Aire',
            cualidades: 'C√°lido (Expansivo) + H√∫medo (Fluido)',
            fraccion: '108¬∞ (3/5 de 180¬∞)',
            descripcionElemental: 'Aire: expansi√≥n fluida - manifestaci√≥n de la creatividad mental'
        },
        'sesquicuadratura': {
            esencia: 'fricci√≥n persistente',
            efecto: 'Tensi√≥n que requiere ajustes',
            elemento: 'Tierra',
            cualidades: 'Fr√≠o (Contractivo) + Seco (Tenso)',
            fraccion: '135¬∞ (3/4 de 180¬∞)',
            descripcionElemental: 'Tierra: contracci√≥n tensa - fricci√≥n menor que exige ajustes pr√°cticos'
        }
    };
    
    // Generar interpretaci√≥n de una figura
    function interpretarFigura(patron, posiciones) {
        const def = PATRONES_DEF[patron.tipo];
        if (!def) return '';
        
        // Icono del elemento
        const iconoElemento = {
            'Fuego': 'üî•', 'Agua': 'üíß', 'Aire': 'üí®', 'Tierra': 'üåç', 
            'Fuego/Agua': 'üî•üíß', 'Tierra/Fuego': 'üåçüî•', 'Agua/Fuego': 'üíßüî•'
        };
        
        let texto = `<strong>${def.icono} ${def.nombre}</strong>`;
        if (patron.elemento) texto += ` de ${patron.elemento}`;
        if (def.elemento) texto += ` <span style="opacity:0.8">(${iconoElemento[def.elemento] || ''} ${def.elemento})</span>`;
        if (def.angulos) texto += ` <span style="opacity:0.6;font-size:0.85em">[${def.angulos}]</span>`;
        texto += '<br>';
        
        // Cualidades elementales
        if (def.cualidades) {
            texto += `<span style="font-size:0.85em;color:var(--text-dim);">${def.cualidades}</span><br>`;
        }
        
        // Planetas involucrados
        const planetasInfo = patron.planetas.map(p => {
            const sig = SIGNIFICADOS_PLANETAS[p];
            return sig ? `${PLANET_SYMBOLS[p]} ${p} (${sig.esencia})` : `${PLANET_SYMBOLS[p]} ${p}`;
        });
        texto += `<span class="figura-planetas">${planetasInfo.join(' ‚Ä¢ ')}</span><br>`;
        
        // Interpretaci√≥n seg√∫n tipo
        switch(patron.tipo) {
            case 'GRAND_TRINE':
                texto += `<em>Flujo armonioso entre ${patron.planetas.join(', ')}. Talento natural en el √°rea de ${patron.elemento || 'energ√≠as mixtas'}.</em>`;
                break;
            case 'T_SQUARE':
                const apex = patron.apex || patron.planetas[2];
                const sigApex = SIGNIFICADOS_PLANETAS[apex];
                texto += `<em>Tensi√≥n din√°mica con √°pex en ${PLANET_SYMBOLS[apex]} ${apex}. El punto de resoluci√≥n est√° en ${sigApex?.area || 'esta energ√≠a'}.</em>`;
                break;
            case 'GRAND_CROSS':
                texto += `<em>M√°xima tensi√≥n creativa. Crisis que fuerza transformaci√≥n en todas las √°reas involucradas.</em>`;
                break;
            case 'STELLIUM':
                texto += `<em>Concentraci√≥n intensa en ${patron.signo || 'un signo'}. Foco poderoso en el √°rea de ${patron.elemento || 'estas energ√≠as'}.</em>`;
                break;
            default:
                texto += `<em>${def.keywords.join(', ')}.</em>`;
        }
        
        // A√±adir descripci√≥n elemental si existe
        if (def.descripcionElemental) {
            texto += `<br><small style="color:var(--gold);opacity:0.85;">${def.descripcionElemental}</small>`;
        }
        
        return texto;
    }
    
    // Generar interpretaci√≥n de un aspecto con colores planetarios
    function interpretarAspecto(aspecto, posiciones) {
        const sig = SIGNIFICADOS_ASPECTOS[aspecto.tipo];
        const p1 = SIGNIFICADOS_PLANETAS[aspecto.planeta1];
        const p2 = SIGNIFICADOS_PLANETAS[aspecto.planeta2];
        
        // Obtener colores si tenemos posiciones
        let color1Info = null, color2Info = null;
        if (posiciones) {
            const pos1 = posiciones[aspecto.planeta1];
            const pos2 = posiciones[aspecto.planeta2];
            if (pos1) color1Info = getInfoColorPlanetario(aspecto.planeta1, pos1.lon);
            if (pos2) color2Info = getInfoColorPlanetario(aspecto.planeta2, pos2.lon);
        }
        
        if (!sig) return '';
        
        const func1 = color1Info ? color1Info.funcion : (p1 ? p1.esencia : aspecto.planeta1);
        const func2 = color2Info ? color2Info.funcion : (p2 ? p2.esencia : aspecto.planeta2);
        
        return `${PLANET_SYMBOLS[aspecto.planeta1]}${aspecto.simbolo}${PLANET_SYMBOLS[aspecto.planeta2]}: ${func1} ${sig.esencia} ${func2}`;
    }
    
    // Generar interpretaci√≥n de un aspecto (versi√≥n simple sin posiciones)
    function interpretarAspectoSimple(aspecto) {
        const sig = SIGNIFICADOS_ASPECTOS[aspecto.tipo];
        const p1 = SIGNIFICADOS_PLANETAS[aspecto.planeta1];
        const p2 = SIGNIFICADOS_PLANETAS[aspecto.planeta2];
        
        if (!sig || !p1 || !p2) return '';
        
        return `${PLANET_SYMBOLS[aspecto.planeta1]}${aspecto.simbolo}${PLANET_SYMBOLS[aspecto.planeta2]}: ${p1.esencia} ${sig.esencia} ${p2.esencia}`;
    }
    
    const ELEMENTOS_SIGNOS = {
        'ARIES': 'Fuego', 'LEO': 'Fuego', 'SAGITARIO': 'Fuego',
        'TAURO': 'Tierra', 'VIRGO': 'Tierra', 'CAPRICORNIO': 'Tierra',
        'G√âMINIS': 'Aire', 'GEMINIS': 'Aire', 'LIBRA': 'Aire', 'ACUARIO': 'Aire',
        'C√ÅNCER': 'Agua', 'CANCER': 'Agua', 'ESCORPIO': 'Agua', 'PISCIS': 'Agua',
        'OFIUCO': 'Agua', 'PEGASO': 'Aire'
    };
    
    function getAspectoAngulo(lon1, lon2) {
        let diff = Math.abs(lon1 - lon2);
        if (diff > 180) diff = 360 - diff;
        return diff;
    }
    
    function tieneAspecto(lon1, lon2, angulo, orbe) {
        const diff = getAspectoAngulo(lon1, lon2);
        return Math.abs(diff - angulo) <= orbe;
    }
    
    function getElementoTrigono(s1, s2, s3) {
        const e1 = ELEMENTOS_SIGNOS[s1?.toUpperCase()];
        const e2 = ELEMENTOS_SIGNOS[s2?.toUpperCase()];
        const e3 = ELEMENTOS_SIGNOS[s3?.toUpperCase()];
        if (e1 === e2 && e2 === e3) return e1;
        return 'Mixto';
    }
    
    function calcularAspectos(posiciones) {
        const aspectos = [];
        const planetas = Object.entries(posiciones).filter(([n]) => !['ASC','MC'].includes(n));
        
        for (let i = 0; i < planetas.length; i++) {
            for (let j = i + 1; j < planetas.length; j++) {
                const [nom1, pos1] = planetas[i];
                const [nom2, pos2] = planetas[j];
                
                for (const [tipo, asp] of Object.entries(ASPECTOS)) {
                    if (tieneAspecto(pos1.lon, pos2.lon, asp.angulo, asp.orbe)) {
                        const orbeExacto = Math.abs(getAspectoAngulo(pos1.lon, pos2.lon) - asp.angulo);
                        aspectos.push({
                            tipo,
                            planeta1: nom1,
                            planeta2: nom2,
                            simbolo: asp.simbolo,
                            nombre: asp.nombre,
                            color: asp.color,
                            orbe: orbeExacto.toFixed(1),
                            fuerza: orbeExacto < 1 ? 'exacto' : orbeExacto < 3 ? 'fuerte' : 'aplicativo'
                        });
                        break;
                    }
                }
            }
        }
        return aspectos;
    }
    
    function detectarPatrones(posiciones) {
        const patrones = [];
        const planetas = Object.entries(posiciones)
            .map(([nombre, pos]) => ({ nombre, lon: pos.lon, signo: pos.signo }));
        
        const orbe = 6; // Orbe uniforme de 6¬∞
        
        // Detectar Stelliums (3+ planetas en conjunci√≥n en mismo signo)
        const signoCounts = {};
        planetas.forEach(p => {
            if (!signoCounts[p.signo]) signoCounts[p.signo] = [];
            signoCounts[p.signo].push(p.nombre);
        });
        Object.entries(signoCounts).forEach(([signo, ps]) => {
            if (ps.length >= 3) {
                patrones.push({ 
                    tipo: 'STELLIUM', 
                    planetas: ps, 
                    signo,
                    elemento: ELEMENTOS_SIGNOS[signo?.toUpperCase()] || 'Desconocido'
                });
            }
        });
        
        // Detectar Gran Tr√≠gono (3 tr√≠gonos mutuos = 120¬∞)
        for (let i = 0; i < planetas.length - 2; i++) {
            for (let j = i + 1; j < planetas.length - 1; j++) {
                for (let k = j + 1; k < planetas.length; k++) {
                    const p1 = planetas[i], p2 = planetas[j], p3 = planetas[k];
                    if (tieneAspecto(p1.lon, p2.lon, 120, orbe) &&
                        tieneAspecto(p2.lon, p3.lon, 120, orbe) &&
                        tieneAspecto(p1.lon, p3.lon, 120, orbe)) {
                        const elemento = getElementoTrigono(p1.signo, p2.signo, p3.signo);
                        patrones.push({ 
                            tipo: 'GRAND_TRINE', 
                            planetas: [p1.nombre, p2.nombre, p3.nombre],
                            elemento
                        });
                    }
                }
            }
        }
        
        // Detectar T-Cuadrada (oposici√≥n + 2 cuadraturas)
        for (let i = 0; i < planetas.length - 2; i++) {
            for (let j = i + 1; j < planetas.length - 1; j++) {
                if (tieneAspecto(planetas[i].lon, planetas[j].lon, 180, orbe)) {
                    for (let k = 0; k < planetas.length; k++) {
                        if (k === i || k === j) continue;
                        if (tieneAspecto(planetas[k].lon, planetas[i].lon, 90, orbe) &&
                            tieneAspecto(planetas[k].lon, planetas[j].lon, 90, orbe)) {
                            patrones.push({ 
                                tipo: 'T_SQUARE', 
                                planetas: [planetas[i].nombre, planetas[j].nombre, planetas[k].nombre],
                                apex: planetas[k].nombre
                            });
                        }
                    }
                }
            }
        }
        
        // Detectar Gran Cruz (2 oposiciones + 4 cuadraturas)
        for (let i = 0; i < planetas.length - 3; i++) {
            for (let j = i + 1; j < planetas.length - 2; j++) {
                for (let k = j + 1; k < planetas.length - 1; k++) {
                    for (let l = k + 1; l < planetas.length; l++) {
                        const p = [planetas[i], planetas[j], planetas[k], planetas[l]];
                        let opos = 0, cuad = 0;
                        for (let a = 0; a < 4; a++) {
                            for (let b = a + 1; b < 4; b++) {
                                if (tieneAspecto(p[a].lon, p[b].lon, 180, orbe)) opos++;
                                if (tieneAspecto(p[a].lon, p[b].lon, 90, orbe)) cuad++;
                            }
                        }
                        if (opos === 2 && cuad === 4) {
                            patrones.push({ tipo: 'GRAND_CROSS', planetas: p.map(x => x.nombre) });
                        }
                    }
                }
            }
        }
        
        // Detectar Cometa (Kite) - Gran Tr√≠gono + oposici√≥n al v√©rtice
        const grandTrines = patrones.filter(p => p.tipo === 'GRAND_TRINE');
        grandTrines.forEach(gt => {
            const gtPlanets = planetas.filter(p => gt.planetas.includes(p.nombre));
            planetas.forEach(p => {
                if (gt.planetas.includes(p.nombre)) return;
                gtPlanets.forEach(gtp => {
                    if (tieneAspecto(p.lon, gtp.lon, 180, orbe)) {
                        const others = gtPlanets.filter(x => x.nombre !== gtp.nombre);
                        if (tieneAspecto(p.lon, others[0].lon, 60, orbe) &&
                            tieneAspecto(p.lon, others[1].lon, 60, orbe)) {
                            patrones.push({
                                tipo: 'KITE',
                                planetas: [...gt.planetas, p.nombre],
                                apex: p.nombre,
                                elemento: gt.elemento
                            });
                        }
                    }
                });
            });
        });
        
        // Detectar Rect√°ngulo M√≠stico (2 oposiciones + 2 tr√≠gonos + 2 sextiles)
        for (let i = 0; i < planetas.length - 3; i++) {
            for (let j = i + 1; j < planetas.length - 2; j++) {
                for (let k = j + 1; k < planetas.length - 1; k++) {
                    for (let l = k + 1; l < planetas.length; l++) {
                        const p = [planetas[i], planetas[j], planetas[k], planetas[l]];
                        let opos = 0, trin = 0, sext = 0;
                        for (let a = 0; a < 4; a++) {
                            for (let b = a + 1; b < 4; b++) {
                                if (tieneAspecto(p[a].lon, p[b].lon, 180, orbe)) opos++;
                                if (tieneAspecto(p[a].lon, p[b].lon, 120, orbe)) trin++;
                                if (tieneAspecto(p[a].lon, p[b].lon, 60, orbe)) sext++;
                            }
                        }
                        if (opos === 2 && trin === 2 && sext === 2) {
                            patrones.push({ tipo: 'MYSTIC_RECTANGLE', planetas: p.map(x => x.nombre) });
                        }
                    }
                }
            }
        }
        
        // Detectar Rect√°ngulo √Åureo (72¬∞-108¬∞-72¬∞-108¬∞)
        for (let i = 0; i < planetas.length - 3; i++) {
            for (let j = i + 1; j < planetas.length - 2; j++) {
                for (let k = j + 1; k < planetas.length - 1; k++) {
                    for (let l = k + 1; l < planetas.length; l++) {
                        const p = [planetas[i], planetas[j], planetas[k], planetas[l]];
                        let quintiles = 0, biquintiles = 0;
                        for (let a = 0; a < 4; a++) {
                            for (let b = a + 1; b < 4; b++) {
                                if (tieneAspecto(p[a].lon, p[b].lon, 72, orbe)) quintiles++;
                                if (tieneAspecto(p[a].lon, p[b].lon, 108, orbe)) biquintiles++;
                            }
                        }
                        if (quintiles === 2 && biquintiles === 2) {
                            patrones.push({ tipo: 'GOLDEN_RECTANGLE', planetas: p.map(x => x.nombre) });
                        }
                    }
                }
            }
        }
        
        // Detectar Tri√°ngulo de Tierra (135¬∞-135¬∞-90¬∞)
        for (let i = 0; i < planetas.length - 2; i++) {
            for (let j = i + 1; j < planetas.length - 1; j++) {
                for (let k = j + 1; k < planetas.length; k++) {
                    const p = [planetas[i], planetas[j], planetas[k]];
                    let sesqui = 0, cuad = 0;
                    for (let a = 0; a < 3; a++) {
                        for (let b = a + 1; b < 3; b++) {
                            if (tieneAspecto(p[a].lon, p[b].lon, 135, orbe)) sesqui++;
                            if (tieneAspecto(p[a].lon, p[b].lon, 90, orbe)) cuad++;
                        }
                    }
                    if (sesqui === 2 && cuad === 1) {
                        patrones.push({ tipo: 'EARTH_TRIANGLE', planetas: p.map(x => x.nombre) });
                    }
                }
            }
        }
        
        // Eliminar duplicados
        return patrones.filter((p, idx, arr) => 
            arr.findIndex(x => x.tipo === p.tipo && x.planetas.sort().join() === p.planetas.sort().join()) === idx
        );
    }
    
    function renderAspectosYPatrones(fecha) {
        const posiciones = getPosicionesPlanetarias(fecha);
        const aspectos = calcularAspectos(posiciones);
        const patrones = detectarPatrones(posiciones);
        
        // Solo aspectos mayores
        const aspectosMayores = ['conjuncion', 'sextil', 'cuadratura', 'trigono', 'oposicion'];
        const aspectosFiltrados = aspectos.filter(a => aspectosMayores.includes(a.tipo));
        
        let html = '';
        
        // ===== FIGURAS DEL D√çA (TR√ÅNSITOS) =====
        if (patrones.length > 0) {
            html += '<div class="patrones-section">';
            html += '<div class="section-title">‚ú° Figuras del D√≠a</div>';
            patrones.forEach(p => {
                const def = PATRONES_DEF[p.tipo] || { nombre: p.tipo, icono: '‚óà', color: '#888', keywords: [] };
                html += `
                    <div class="patron-badge" style="background:${def.color}22;border-left:3px solid ${def.color}">
                        <span class="patron-icono">${def.icono}</span>
                        <div class="patron-info">
                            <span class="patron-nombre">${def.nombre}</span>
                            ${p.elemento ? `<span class="patron-elemento">${p.elemento}</span>` : ''}
                            <span class="patron-planetas">${p.planetas.map(n => PLANET_SYMBOLS[n] || n).join(' ')}</span>
                            ${p.apex ? `<span class="patron-apex">√Åpex: ${PLANET_SYMBOLS[p.apex] || p.apex}</span>` : ''}
                        </div>
                    </div>`;
            });
            html += '</div>';
        }
        
        // ===== ASPECTOS DEL D√çA (TR√ÅNSITOS) =====
        if (aspectosFiltrados.length > 0) {
            html += '<div class="aspectos-section">';
            html += '<div class="section-title">‚òç Aspectos del D√≠a</div>';
            html += '<div class="aspectos-grid">';
            aspectosFiltrados.slice(0, 8).forEach(a => {
                html += `
                    <div class="aspecto-item" style="border-color:${a.color}">
                        <span class="aspecto-simbolo" style="color:${a.color}">${a.simbolo}</span>
                        <span class="aspecto-planetas">${PLANET_SYMBOLS[a.planeta1]}${PLANET_SYMBOLS[a.planeta2]}</span>
                        <span class="aspecto-orbe">${a.orbe}¬∞</span>
                    </div>`;
            });
            html += '</div></div>';
        }
        
        // ===== TR√ÅNSITOS SOBRE CARTA NATAL (si hay perfil) =====
        if (typeof perfilState !== 'undefined' && perfilState.cartaNatal && perfilState.cartaNatal.posiciones) {
            const aspectosNatal = calcularAspectosTransitoNatalModal(posiciones, perfilState.cartaNatal);
            const patronesNatal = detectarPatronesTransitoNatalModal(posiciones, perfilState.cartaNatal);
            
            // Figuras tr√°nsito-natal
            if (patronesNatal.length > 0) {
                html += '<div class="patrones-section" style="border-color:#667eea">';
                html += '<div class="section-title" style="color:#667eea">üåü Figuras Tr√°nsito-Natal</div>';
                patronesNatal.forEach(p => {
                    const def = PATRONES_DEF[p.tipo] || { nombre: p.tipo, icono: '‚óà', color: '#667eea' };
                    html += `
                        <div class="patron-badge" style="background:${def.color}22;border-left:3px solid ${def.color}">
                            <span class="patron-icono">${def.icono}</span>
                            <div class="patron-info">
                                <span class="patron-nombre">${def.nombre}</span>
                                <span class="patron-planetas">${p.descripcion || p.planetas.map(n => PLANET_SYMBOLS[n] || n).join(' ')}</span>
                            </div>
                        </div>`;
                });
                html += '</div>';
            }
            
            // Aspectos tr√°nsito-natal
            if (aspectosNatal.length > 0) {
                html += '<div class="aspectos-section" style="border-color:#667eea">';
                html += '<div class="section-title" style="color:#667eea">üîÆ Aspectos Tr√°nsito-Natal</div>';
                html += '<div class="aspectos-grid">';
                aspectosNatal.slice(0, 10).forEach(a => {
                    html += `
                        <div class="aspecto-item" style="border-color:${a.color}">
                            <span class="aspecto-simbolo" style="color:${a.color}">${a.simbolo}</span>
                            <span class="aspecto-planetas">${PLANET_SYMBOLS[a.planetaTransito]}‚Üí${PLANET_SYMBOLS[a.planetaNatal]}‚Åø</span>
                            <span class="aspecto-orbe">${a.orbe}¬∞</span>
                        </div>`;
                });
                html += '</div></div>';
            }
        }
        
        return html;
    }
    
    // Calcular aspectos tr√°nsito-natal para el modal
    function calcularAspectosTransitoNatalModal(transitosPos, cartaNatal) {
        const aspectos = [];
        const aspectosMayores = {
            conjuncion: { angulo: 0, orbe: 6, simbolo: '‚òå', color: '#e74c3c' },
            sextil: { angulo: 60, orbe: 4, simbolo: '‚öπ', color: '#3498db' },
            cuadratura: { angulo: 90, orbe: 6, simbolo: '‚ñ°', color: '#27ae60' },
            trigono: { angulo: 120, orbe: 6, simbolo: '‚ñ≥', color: '#3498db' },
            oposicion: { angulo: 180, orbe: 6, simbolo: '‚òç', color: '#e74c3c' }
        };
        
        const transitos = Object.entries(transitosPos).filter(([n]) => !['ASC','MC','Parte de Fortuna'].includes(n));
        
        // Obtener planetas natales - la carta natal usa 'posiciones', no 'planetas'
        let natales = [];
        if (cartaNatal.posiciones) {
            natales = Object.entries(cartaNatal.posiciones).filter(([n]) => !['ASC','MC','Parte de Fortuna'].includes(n));
        } else if (cartaNatal.planetas) {
            natales = Object.entries(cartaNatal.planetas).filter(([n]) => !['ASC','MC','Parte de Fortuna'].includes(n));
        }
        
        for (const [nomT, posT] of transitos) {
            for (const [nomN, posN] of natales) {
                const lonN = typeof posN === 'object' ? posN.lon : posN;
                if (lonN === undefined) continue;
                
                for (const [tipo, asp] of Object.entries(aspectosMayores)) {
                    if (tieneAspecto(posT.lon, lonN, asp.angulo, asp.orbe)) {
                        const orbeExacto = Math.abs(getAspectoAngulo(posT.lon, lonN) - asp.angulo);
                        aspectos.push({
                            tipo,
                            planetaTransito: nomT,
                            planetaNatal: nomN,
                            lonTransito: posT.lon,
                            lonNatal: lonN,
                            simbolo: asp.simbolo,
                            color: asp.color,
                            orbe: orbeExacto.toFixed(1)
                        });
                        break;
                    }
                }
            }
        }
        
        // Ordenar por importancia (Sol, Luna primero)
        const orden = ['Sol', 'Luna', 'Mercurio', 'Venus', 'Marte', 'J√∫piter', 'Saturno'];
        aspectos.sort((a, b) => orden.indexOf(a.planetaTransito) - orden.indexOf(b.planetaTransito));
        
        return aspectos;
    }
    
    // Detectar patrones tr√°nsito-natal (mismas figuras que tr√°nsitos pero mixtas)
    function detectarPatronesTransitoNatalModal(transitosPos, cartaNatal) {
        const patrones = [];
        const orbe = 6;
        
        const transitos = Object.entries(transitosPos)
            .filter(([n]) => !['ASC','MC','Parte de Fortuna'].includes(n))
            .map(([nombre, pos]) => ({ nombre, lon: pos.lon, signo: pos.signo, tipo: 'T' }));
        
        let natalesArr = [];
        if (cartaNatal.posiciones) {
            natalesArr = Object.entries(cartaNatal.posiciones)
                .filter(([n]) => !['ASC','MC','Parte de Fortuna'].includes(n))
                .map(([nombre, pos]) => ({ nombre, lon: pos.lon, signo: pos.signo, tipo: 'N' }));
        }
        
        if (natalesArr.length === 0) return patrones;
        
        // Combinar todos los planetas
        const todos = [...transitos, ...natalesArr];
        
        // Funci√≥n para verificar si un patr√≥n es mixto (tiene al menos 1 tr√°nsito y 1 natal)
        const esMixto = (planetas) => {
            const tipos = planetas.map(p => p.tipo);
            return tipos.includes('T') && tipos.includes('N');
        };
        
        // Funci√≥n para formatear nombres con ‚Åø para natales
        const formatearNombres = (grupo) => {
            const nombresT = grupo.filter(p => p.tipo === 'T').map(p => PLANET_SYMBOLS[p.nombre]).join('');
            const nombresN = grupo.filter(p => p.tipo === 'N').map(p => PLANET_SYMBOLS[p.nombre] + '‚Åø').join('');
            return `${nombresT} ${nombresN}`.trim();
        };
        
        // Funci√≥n para obtener elemento del grupo
        const getElementoGrupo = (grupo) => {
            const elementos = grupo.map(p => ELEMENTOS_SIGNOS[p.signo?.toUpperCase()]).filter(Boolean);
            const conteo = {};
            elementos.forEach(e => conteo[e] = (conteo[e] || 0) + 1);
            const max = Object.entries(conteo).sort((a, b) => b[1] - a[1])[0];
            return max ? max[0] : 'Mixto';
        };
        
        // ===== STELLIUM MIXTO (3+ planetas en mismo signo) =====
        const signoCounts = {};
        todos.forEach(p => {
            if (!signoCounts[p.signo]) signoCounts[p.signo] = [];
            signoCounts[p.signo].push(p);
        });
        Object.entries(signoCounts).forEach(([signo, ps]) => {
		const amplitud = Math.abs(ps[ps.length - 1].longitud - ps[0].longitud);
            if (ps.length >= 3 && amplitud <= 6 && esMixto(ps)) {
                patrones.push({ 
                    tipo: 'STELLIUM', 
                    planetas: ps.map(p => p.nombre),
                    signo,
                    elemento: ELEMENTOS_SIGNOS[signo?.toUpperCase()] || 'Desconocido',
                    descripcion: `Stellium en ${signo}: ${formatearNombres(ps)}`
                });
            }
        });
        
        // ===== GRAN TR√çGONO MIXTO (3 tr√≠gonos 120¬∞) =====
        for (let i = 0; i < todos.length - 2; i++) {
            for (let j = i + 1; j < todos.length - 1; j++) {
                for (let k = j + 1; k < todos.length; k++) {
                    const grupo = [todos[i], todos[j], todos[k]];
                    if (tieneAspecto(grupo[0].lon, grupo[1].lon, 120, orbe) &&
                        tieneAspecto(grupo[1].lon, grupo[2].lon, 120, orbe) &&
                        tieneAspecto(grupo[0].lon, grupo[2].lon, 120, orbe) &&
                        esMixto(grupo)) {
                        const elemento = getElementoGrupo(grupo);
                        patrones.push({
                            tipo: 'GRAND_TRINE',
                            planetas: grupo.map(p => p.nombre),
                            elemento,
                            descripcion: `Gran Tr√≠gono de ${elemento}: ${formatearNombres(grupo)}`
                        });
                    }
                }
            }
        }
        
        // ===== T-CUADRADA MIXTA (oposici√≥n + 2 cuadraturas) =====
        for (let i = 0; i < todos.length - 2; i++) {
            for (let j = i + 1; j < todos.length - 1; j++) {
                if (tieneAspecto(todos[i].lon, todos[j].lon, 180, orbe)) {
                    for (let k = 0; k < todos.length; k++) {
                        if (k === i || k === j) continue;
                        if (tieneAspecto(todos[k].lon, todos[i].lon, 90, orbe) &&
                            tieneAspecto(todos[k].lon, todos[j].lon, 90, orbe)) {
                            const grupo = [todos[i], todos[j], todos[k]];
                            if (esMixto(grupo)) {
                                const apex = todos[k];
                                patrones.push({
                                    tipo: 'T_SQUARE',
                                    planetas: grupo.map(p => p.nombre),
                                    apex: apex.nombre,
                                    descripcion: `T-Cuadrada: ${formatearNombres(grupo)} (√°pex: ${PLANET_SYMBOLS[apex.nombre]}${apex.tipo === 'N' ? '‚Åø' : ''})`
                                });
                            }
                        }
                    }
                }
            }
        }
        
        // ===== GRAN CRUZ MIXTA (2 oposiciones + 4 cuadraturas) =====
        for (let i = 0; i < todos.length - 3; i++) {
            for (let j = i + 1; j < todos.length - 2; j++) {
                for (let k = j + 1; k < todos.length - 1; k++) {
                    for (let l = k + 1; l < todos.length; l++) {
                        const grupo = [todos[i], todos[j], todos[k], todos[l]];
                        let opos = 0, cuad = 0;
                        for (let a = 0; a < 4; a++) {
                            for (let b = a + 1; b < 4; b++) {
                                if (tieneAspecto(grupo[a].lon, grupo[b].lon, 180, orbe)) opos++;
                                if (tieneAspecto(grupo[a].lon, grupo[b].lon, 90, orbe)) cuad++;
                            }
                        }
                        if (opos === 2 && cuad === 4 && esMixto(grupo)) {
                            patrones.push({
                                tipo: 'GRAND_CROSS',
                                planetas: grupo.map(p => p.nombre),
                                descripcion: `Gran Cruz: ${formatearNombres(grupo)}`
                            });
                        }
                    }
                }
            }
        }
        
        // ===== COMETA MIXTA (Gran Tr√≠gono + oposici√≥n con sextiles) =====
        const grandTrinesMixtos = patrones.filter(p => p.tipo === 'GRAND_TRINE');
        grandTrinesMixtos.forEach(gt => {
            const gtPlanets = todos.filter(p => gt.planetas.includes(p.nombre));
            todos.forEach(p => {
                if (gt.planetas.includes(p.nombre)) return;
                gtPlanets.forEach(gtp => {
                    if (tieneAspecto(p.lon, gtp.lon, 180, orbe)) {
                        const others = gtPlanets.filter(x => x.nombre !== gtp.nombre);
                        if (tieneAspecto(p.lon, others[0].lon, 60, orbe) &&
                            tieneAspecto(p.lon, others[1].lon, 60, orbe)) {
                            const grupo = [...gtPlanets, p];
                            if (esMixto(grupo)) {
                                patrones.push({
                                    tipo: 'KITE',
                                    planetas: grupo.map(x => x.nombre),
                                    apex: p.nombre,
                                    elemento: gt.elemento,
                                    descripcion: `Cometa de ${gt.elemento}: ${formatearNombres(grupo)}`
                                });
                            }
                        }
                    }
                });
            });
        });
        
        // ===== RECT√ÅNGULO M√çSTICO MIXTO (2 oposiciones + 2 tr√≠gonos + 2 sextiles) =====
        for (let i = 0; i < todos.length - 3; i++) {
            for (let j = i + 1; j < todos.length - 2; j++) {
                for (let k = j + 1; k < todos.length - 1; k++) {
                    for (let l = k + 1; l < todos.length; l++) {
                        const grupo = [todos[i], todos[j], todos[k], todos[l]];
                        let opos = 0, trin = 0, sext = 0;
                        for (let a = 0; a < 4; a++) {
                            for (let b = a + 1; b < 4; b++) {
                                if (tieneAspecto(grupo[a].lon, grupo[b].lon, 180, orbe)) opos++;
                                if (tieneAspecto(grupo[a].lon, grupo[b].lon, 120, orbe)) trin++;
                                if (tieneAspecto(grupo[a].lon, grupo[b].lon, 60, orbe)) sext++;
                            }
                        }
                        if (opos === 2 && trin === 2 && sext === 2 && esMixto(grupo)) {
                            patrones.push({
                                tipo: 'MYSTIC_RECTANGLE',
                                planetas: grupo.map(p => p.nombre),
                                descripcion: `Rect√°ngulo M√≠stico: ${formatearNombres(grupo)}`
                            });
                        }
                    }
                }
            }
        }
        
        // ===== RECT√ÅNGULO √ÅUREO MIXTO (72¬∞-108¬∞-72¬∞-108¬∞) =====
        for (let i = 0; i < todos.length - 3; i++) {
            for (let j = i + 1; j < todos.length - 2; j++) {
                for (let k = j + 1; k < todos.length - 1; k++) {
                    for (let l = k + 1; l < todos.length; l++) {
                        const grupo = [todos[i], todos[j], todos[k], todos[l]];
                        let quintiles = 0, biquintiles = 0;
                        for (let a = 0; a < 4; a++) {
                            for (let b = a + 1; b < 4; b++) {
                                if (tieneAspecto(grupo[a].lon, grupo[b].lon, 72, orbe)) quintiles++;
                                if (tieneAspecto(grupo[a].lon, grupo[b].lon, 108, orbe)) biquintiles++;
                            }
                        }
                        if (quintiles === 2 && biquintiles === 2 && esMixto(grupo)) {
                            patrones.push({
                                tipo: 'GOLDEN_RECTANGLE',
                                planetas: grupo.map(p => p.nombre),
                                descripcion: `Rect√°ngulo √Åureo: ${formatearNombres(grupo)}`
                            });
                        }
                    }
                }
            }
        }
        
        // ===== TRI√ÅNGULO DE TIERRA MIXTO (135¬∞-135¬∞-90¬∞) =====
        for (let i = 0; i < todos.length - 2; i++) {
            for (let j = i + 1; j < todos.length - 1; j++) {
                for (let k = j + 1; k < todos.length; k++) {
                    const grupo = [todos[i], todos[j], todos[k]];
                    let sesqui = 0, cuad = 0;
                    for (let a = 0; a < 3; a++) {
                        for (let b = a + 1; b < 3; b++) {
                            if (tieneAspecto(grupo[a].lon, grupo[b].lon, 135, orbe)) sesqui++;
                            if (tieneAspecto(grupo[a].lon, grupo[b].lon, 90, orbe)) cuad++;
                        }
                    }
                    if (sesqui === 2 && cuad === 1 && esMixto(grupo)) {
                        patrones.push({
                            tipo: 'EARTH_TRIANGLE',
                            planetas: grupo.map(p => p.nombre),
                            descripcion: `Tri√°ngulo de Tierra: ${formatearNombres(grupo)}`
                        });
                    }
                }
            }
        }
        
        // ===== CONJUNCIONES EXACTAS (orbe < 2¬∞) =====
        for (const t of transitos) {
            for (const n of natalesArr) {
                const diff = getAspectoAngulo(t.lon, n.lon);
                if (diff < 2) {
                    patrones.push({
                        tipo: 'CONJUNCTION_EXACT',
                        planetas: [t.nombre, n.nombre],
                        descripcion: `${PLANET_SYMBOLS[t.nombre]} sobre ${PLANET_SYMBOLS[n.nombre]}‚Åø natal (${diff.toFixed(1)}¬∞)`
                    });
                }
            }
        }
        
        // Eliminar duplicados
        const unicos = [];
        const vistos = new Set();
        for (const p of patrones) {
            const key = p.tipo + '-' + [...p.planetas].sort().join(',');
            if (!vistos.has(key)) {
                vistos.add(key);
                unicos.push(p);
            }
        }
        
        return unicos;
    }

    
    // ===================== FUNCI√ìN PRINCIPAL - ASTRONOMY ENGINE =====================
    function getPosicionesPlanetarias(fecha, tzOffset) {
        const posiciones = {};
        
        // Extraer a√±o, mes, d√≠a, hora - acepta Date o {year, month, day, hour, minute}
        let year, month, day, hour;
        if (fecha.year !== undefined) {
            year = fecha.year;
            month = fecha.month;
            day = fecha.day;
            // Convertir hora local a UTC usando tzOffset
            hour = (fecha.hour + (fecha.minute || 0) / 60) - (tzOffset || 0);
            // Ajustar d√≠a si la hora se sale del rango
            if (hour < 0) { hour += 24; day--; }
            if (hour >= 24) { hour -= 24; day++; }
        } else {
            year = fecha.getUTCFullYear();
            month = fecha.getUTCMonth() + 1;
            day = fecha.getUTCDate();
            hour = fecha.getUTCHours() + fecha.getUTCMinutes() / 60;
        }
        
        // Si tenemos efem√©rides pre-calculadas de Swiss Ephemeris, usarlas
        if (typeof EPHEMERIS_DATA !== 'undefined') {
            const hoy = EPHEMERIS_DATA[year]?.[month]?.[day];
            
            if (hoy) {
                // Orden: Sol, Luna, Mercurio, Venus, Marte, Jupiter, Saturno
                const planetOrder = ['Sol', 'Luna', 'Mercurio', 'Venus', 'Marte', 'J√∫piter', 'Saturno'];
                const planetKeys = ['Sol', 'Luna', 'Mercurio', 'Venus', 'Marte', 'Jupiter', 'Saturno'];
                
                // Obtener datos del d√≠a siguiente para interpolaci√≥n
                let manana = null;
                const lastDay = new Date(year, month, 0).getDate();
                if (day < lastDay) {
                    manana = EPHEMERIS_DATA[year]?.[month]?.[day + 1];
                } else {
                    const nextMonth = month < 12 ? month + 1 : 1;
                    const nextYear = month < 12 ? year : year + 1;
                    manana = EPHEMERIS_DATA[nextYear]?.[nextMonth]?.[1];
                }
                
                // Fracci√≥n del d√≠a (datos son a las 12:00 UTC)
                const t = (hour - 12) / 24;
                
                planetKeys.forEach((nombre, idx) => {
                    let lon = hoy[idx];
                    
                    // Interpolar si tenemos datos de ma√±ana
                    if (manana && Math.abs(t) > 0.01) {
                        let diff = manana[idx] - hoy[idx];
                        if (diff > 180) diff -= 360;
                        if (diff < -180) diff += 360;
                        lon = norm360(hoy[idx] + diff * t);
                    }
                    
                    const signo = getSignoDesdeLongitud(lon);
                    const nombreDisplay = nombre === 'Jupiter' ? 'J√∫piter' : nombre;
                    
                    posiciones[nombreDisplay] = {
                        lon: lon,
                        longitud: lon.toFixed(2),
                        signo: signo,
                        dignidad: calcularDignidad(nombreDisplay, signo),
                        simbolo: PLANET_SYMBOLS[nombreDisplay],
                        signoSimbolo: SIGN_SYMBOLS[signo]
                    };
                });
                
                return posiciones;
            }
        }
        
        // Fallback: c√°lculos simplificados si no hay efem√©rides
        const jd = fechaAJuliano(fecha);
        const T = (jd - 2451545.0) / 36525;
        
        // Sol
        const L0 = norm360(280.46646 + 36000.76983 * T);
        const M = norm360(357.52911 + 35999.05029 * T);
        const Mr = M * DEG;
        const C = (1.914602 - 0.004817 * T) * Math.sin(Mr) + 0.019993 * Math.sin(2 * Mr);
        let lon = norm360(L0 + C);
        let signo = getSignoDesdeLongitud(lon);
        posiciones['Sol'] = {
            lon: lon, longitud: lon.toFixed(2), signo,
            dignidad: calcularDignidad('Sol', signo),
            simbolo: PLANET_SYMBOLS['Sol'],
            signoSimbolo: SIGN_SYMBOLS[signo]
        };
        
        // Luna
        const Lp = norm360(218.3164477 + 481267.88123421 * T);
        const Mp = norm360(134.9633964 + 477198.8675055 * T);
        lon = norm360(Lp + 6.289 * Math.sin(Mp * DEG));
        signo = getSignoDesdeLongitud(lon);
        posiciones['Luna'] = {
            lon: lon, longitud: lon.toFixed(2), signo,
            dignidad: calcularDignidad('Luna', signo),
            simbolo: PLANET_SYMBOLS['Luna'],
            signoSimbolo: SIGN_SYMBOLS[signo]
        };
        
        // Otros planetas (aproximaci√≥n)
        const planetData = [
            { nombre: 'Mercurio', L0: 252.25084, Ldot: 149472.6746 },
            { nombre: 'Venus', L0: 181.97973, Ldot: 58517.8157 },
            { nombre: 'Marte', L0: 355.45332, Ldot: 19140.3, a: 1.5237, e: 0.0934 },
            { nombre: 'J√∫piter', L0: 34.40438, Ldot: 3034.9, a: 5.2026, e: 0.0485 },
            { nombre: 'Saturno', L0: 49.94432, Ldot: 1222.1, a: 9.5547, e: 0.0556 },
            { nombre: 'Urano', L0: 314.055, Ldot: 428.5, a: 19.2184, e: 0.0472 },
            { nombre: 'Neptuno', L0: 304.349, Ldot: 218.5, a: 30.1104, e: 0.0086 },
            { nombre: 'Plut√≥n', L0: 238.929, Ldot: 145.2, a: 39.5446, e: 0.2488 }
        ];
        
        planetData.forEach(p => {
            lon = calcularPlanetaGeo(jd, p.nombre);
            signo = getSignoDesdeLongitud(lon);
            posiciones[p.nombre] = {
                lon: lon, longitud: lon.toFixed(2), signo,
                dignidad: calcularDignidad(p.nombre, signo),
                simbolo: PLANET_SYMBOLS[p.nombre],
                signoSimbolo: SIGN_SYMBOLS[signo]
            };
        });
        
        // Calcular Nodo Norte Lunar (aproximaci√≥n del nodo medio)
        // N = 125.04 - 1934.136 * T (grados, T = siglos julianos desde J2000.0)
        const Tnodos = (jd - 2451545.0) / 36525;
        let nodoNorteLon = 125.04 - 1934.136 * Tnodos;
        nodoNorteLon = ((nodoNorteLon % 360) + 360) % 360; // Normalizar 0-360
        const signoNodoNorte = getSignoDesdeLongitud(nodoNorteLon);
        posiciones['Nodo Norte'] = {
            lon: nodoNorteLon,
            longitud: nodoNorteLon.toFixed(2),
            signo: signoNodoNorte,
            dignidad: { tipo: 'peregrino', fuerza: 0 },
            simbolo: '‚òä',
            signoSimbolo: SIGN_SYMBOLS[signoNodoNorte]
        };
        
        // Nodo Sur (opuesto al Norte)
        const nodoSurLon = (nodoNorteLon + 180) % 360;
        const signoNodoSur = getSignoDesdeLongitud(nodoSurLon);
        posiciones['Nodo Sur'] = {
            lon: nodoSurLon,
            longitud: nodoSurLon.toFixed(2),
            signo: signoNodoSur,
            dignidad: { tipo: 'peregrino', fuerza: 0 },
            simbolo: '‚òã',
            signoSimbolo: SIGN_SYMBOLS[signoNodoSur]
        };
        
        return posiciones;
    }

    function getCartaDia(diaLunar) {
        // Obtener la exaltaci√≥n del d√≠a
        const exalt = getExaltacionDia(diaLunar);
        // Buscar la carta que coincida con planeta y signo de la exaltaci√≥n
        const carta = ARCANOS.find(c => c.planeta === exalt.planeta && c.signo === exalt.signo);
        if (carta) return carta;
        // Fallback al √≠ndice si no encuentra coincidencia
        const index = (diaLunar - 1) % 28;
        return ARCANOS[index];
    }
    
    // Obtener imagen de carta (base64 si disponible, o ruta original)
    function getImagenCarta(carta) {
        if (typeof TAROT_IMAGES_BASE64 !== 'undefined' && TAROT_IMAGES_BASE64[carta.imagen]) {
            return TAROT_IMAGES_BASE64[carta.imagen];
        }
        return carta.imagen;
    }

    // Cualidad de cada signo/casa
    const CUALIDAD_SIGNO = {
        'Aries': '√ìrgano de la Inteligencia',           // Casa 1
        'Tauro': 'Objeto del Sustento',                  // Casa 2
        'G√©minis': 'Objeto de la Inteligencia',          // Casa 3
        'C√°ncer': 'Mente',                               // Casa 4
        'Leo': 'Inteligencia',                           // Casa 5
        'Virgo': 'Objeto de la Mente',                   // Casa 6
        'Libra': 'Objeto de la Relaci√≥n',                // Casa 7
        'Escorpio': '√ìrgano de la Mente',                // Casa 8
        'Sagitario': '√ìrgano de la Relaci√≥n',            // Casa 9
        'Capricornio': 'Une el √ìrgano del Sustento con el Objeto de la Relaci√≥n',  // Casa 10
        'Acuario': 'Une el Objeto del Sustento con el √ìrgano de la Relaci√≥n',      // Casa 11
        'Piscis': '√ìrgano del Sustento',                 // Casa 12
        'Ofiuco': 'Conciencia',
        'Pegaso': '√ìrgano del Sustento'
    };

    // Funci√≥n del d√≠a de la semana
    const FUNCION_DIA = {
        'Sol': { funcion: 'la Inteligencia', verbo: 'ilumina' },
        'Luna': { funcion: 'la Mente', verbo: 'nutre' },
        'Marte': { funcion: 'la Acci√≥n', verbo: 'impulsa' },
        'Mercurio': { funcion: 'la Comunicaci√≥n', verbo: 'articula' },
        'J√∫piter': { funcion: 'la Expansi√≥n', verbo: 'amplifica' },
        'Venus': { funcion: 'el Sustento', verbo: 'armoniza' },
        'Saturno': { funcion: 'la Estructura', verbo: 'da forma a' }
    };

    // Generar interpretaci√≥n combinando d√≠a de la semana con exaltaci√≥n
    function getInterpretacionDia(exaltacion, diaSemana, fecha) {
        const planetaDia = DIAS_SEMANA[diaSemana];
        const planetaExalt = exaltacion.planeta;
        
        // Cualidad del signo de la exaltaci√≥n lunar
        const cualidadSignoExalt = CUALIDAD_SIGNO[exaltacion.signo] || exaltacion.signo;
        
        // Determinar art√≠culo seg√∫n la cualidad
        const getArticulo = (cualidad) => {
            if (!cualidad) return '';
            if (cualidad.startsWith('Une')) return '';
            if (cualidad === 'Mente' || cualidad === 'Inteligencia' || cualidad === 'Conciencia') return 'la ';
            return 'el ';
        };
        
        // Obtener posici√≥n REAL del planeta del d√≠a
        const posiciones = getPosicionesPlanetarias(fecha);
        const posPlanetaDia = posiciones[planetaDia.planeta];
        
        // Obtener el color/funci√≥n del planeta seg√∫n su posici√≥n
        const colorInfo = getInfoColorPlanetario(planetaDia.planeta, posPlanetaDia.lon);
        const funcionPlaneta = colorInfo ? colorInfo.funcion : planetaDia.planeta;
        const articuloFuncion = getArticulo(funcionPlaneta);
        const articuloCualidad = getArticulo(cualidadSignoExalt);
        
        let interpretacion = '';
        
        // Si coinciden los planetas del d√≠a y la exaltaci√≥n - m√°ximo poder
        if (planetaDia.planeta === planetaExalt) {
            interpretacion = `‚ú® D√≠a de m√°ximo poder de ${planetaExalt}. `;
            interpretacion += `<strong style="color:${colorInfo?.color || '#d4a853'}">${articuloFuncion}${funcionPlaneta}</strong> `;
            interpretacion += `(${planetaDia.simbolo} ${planetaDia.planeta} en ${posPlanetaDia.signoSimbolo} ${posPlanetaDia.signo}) `;
            interpretacion += `act√∫a sobre ${articuloCualidad}${cualidadSignoExalt}. `;
            interpretacion += `${exaltacion.esencia}`;
        } else {
            // Interpretaci√≥n combinando planeta del d√≠a con exaltaci√≥n lunar
            interpretacion = `<strong style="color:${colorInfo?.color || '#d4a853'}">${articuloFuncion}${funcionPlaneta}</strong> `;
            interpretacion += `(${planetaDia.simbolo} ${planetaDia.planeta} en ${posPlanetaDia.signoSimbolo} ${posPlanetaDia.signo}, ${posPlanetaDia.dignidad.tipo}) `;
            interpretacion += `act√∫a sobre ${articuloCualidad}${cualidadSignoExalt}. `;
            interpretacion += `${exaltacion.esencia}`;
        }
        
        return interpretacion;
    }

    function barajarMazo() {
        const mazo = [...ARCANOS];
        for (let i = mazo.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [mazo[i], mazo[j]] = [mazo[j], mazo[i]];
        }
        return mazo.map(c => ({...c, invertida: Math.random() < 0.3}));
    }

    function formatFecha(fecha) {
        const dias = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
        return `${dias[fecha.getDay()]} ${fecha.getDate()} de ${MESES[fecha.getMonth()]}`;
    }

    // ========================================================================
    // NAVEGACI√ìN
    // ========================================================================
    
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const screen = btn.dataset.screen;
            showScreen(screen);
        });
    });

    function showScreen(screenId) {
        state.currentScreen = screenId;
        
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`[data-screen="${screenId}"]`).classList.add('active');
        
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(`screen-${screenId}`).classList.add('active');
        
        if (screenId === 'hoy') renderHoy();
        if (screenId === 'tiradas') renderTiradas();
        if (screenId === 'calendario') renderCalendario();
        if (screenId === 'personal') renderPersonal();
    }

    // ========================================================================
    // PANTALLA HOY
    // ========================================================================
    
    function renderHoy() {
        const container = document.getElementById('hoy-content');
        const loading = document.getElementById('hoy-loading');
        
        // Cargar perfil si existe
        if (typeof cargarPerfil === 'function') {
            cargarPerfil();
        }
        
        const hoy = new Date();
        const diaLunar = getDiaLunar(hoy);
        const fase = getFaseLunar(diaLunar);
        const exalt = getExaltacionDia(diaLunar);
        const diaSemana = DIAS_SEMANA[hoy.getDay()];
        const interpretacion = getInterpretacionDia(exalt, hoy.getDay(), hoy);
        const posiciones = getPosicionesPlanetarias(hoy);
        
        // Calcular aspectos y patrones
        const aspectos = calcularAspectos(posiciones);
        const patrones = detectarPatrones(posiciones);
        const aspectosMayores = ['conjuncion', 'sextil', 'cuadratura', 'trigono', 'oposicion'];
        const aspectosFiltrados = aspectos.filter(a => aspectosMayores.includes(a.tipo));
        
        // Tr√°nsitos-natal si hay perfil
        let aspectosNatal = [];
        let patronesNatal = [];
        let tienePerfilNatal = false;
        
        if (typeof perfilState !== 'undefined' && perfilState.cartaNatal && perfilState.cartaNatal.posiciones) {
            console.log('üìä Calculando tr√°nsitos-natal. Carta natal:', perfilState.cartaNatal);
            aspectosNatal = calcularAspectosTransitoNatalModal(posiciones, perfilState.cartaNatal);
            patronesNatal = detectarPatronesTransitoNatalModal(posiciones, perfilState.cartaNatal);
            tienePerfilNatal = true;
            console.log('üìä Aspectos natal:', aspectosNatal.length, 'Patrones natal:', patronesNatal.length);
        } else {
            console.log('‚ö†Ô∏è No hay carta natal cargada. perfilState:', typeof perfilState !== 'undefined' ? perfilState : 'undefined');
        }
        
        // Generar HTML de posiciones planetarias con colores
        const posicionesHTML = Object.entries(posiciones).map(([planeta, pos]) => {
            const sig = SIGNIFICADOS_PLANETAS[planeta];
            const colorInfo = getInfoColorPlanetario(planeta, pos.lon);
            let tooltip = `${planeta}: ${pos.signo} (${pos.dignidad.tipo})`;
            if (colorInfo) tooltip += ` - ${colorInfo.funcion}`;
            else if (sig) tooltip += ` - ${sig.esencia}`;
            
            const borderColor = colorInfo ? colorInfo.color : 'transparent';
            return `<span class="hoy-planeta-pos" title="${tooltip}" style="border-bottom: 2px solid ${borderColor}">${pos.simbolo}${pos.signoSimbolo}</span>`;
        }).join(' ');
        
        // Generar HTML de colores planetarios (funciones)
        const planetasPrincipales = ['Sol', 'Luna', 'Mercurio', 'Venus', 'Marte', 'J√∫piter', 'Saturno'];
        const coloresHTML = `
            <div class="hoy-colores">
                <div class="hoy-section-title">üé® Funciones Planetarias</div>
                <div class="hoy-colores-grid">
                    ${planetasPrincipales.map(planeta => {
                        const pos = posiciones[planeta];
                        if (!pos) return '';
                        const colorInfo = getInfoColorPlanetario(planeta, pos.lon);
                        if (!colorInfo) return '';
                        return `
                            <div class="hoy-color-item" style="border-left: 3px solid ${colorInfo.color}">
                                <span class="color-planeta" style="color: ${colorInfo.color}">${pos.simbolo}</span>
                                <span class="color-funcion">${colorInfo.funcion}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
        
        // Generar HTML de figuras del d√≠a con explicaciones
        let figurasHTML = '';
        if (patrones.length > 0) {
            figurasHTML = `
                <div class="hoy-figuras">
                    <div class="hoy-section-title">‚ú° Figuras del D√≠a</div>
                    ${patrones.map(p => `
                        <div class="hoy-figura-item" style="border-left: 3px solid ${PATRONES_DEF[p.tipo]?.color || '#888'}">
                            ${interpretarFigura(p, posiciones)}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Generar HTML de aspectos del d√≠a
        let aspectosHTML = '';
        if (aspectosFiltrados.length > 0) {
            // Iconos de elementos
            const iconoElemento = {
                'Fuego': 'üî•', 'Agua': 'üíß', 'Aire': 'üí®', 'Tierra': 'üåç',
                'Fuego/Agua': 'üî•üíß', 'Tierra/Fuego': 'üåçüî•', 'Agua/Fuego': 'üíßüî•'
            };
            
            aspectosHTML = `
                <div class="hoy-aspectos">
                    <div class="hoy-section-title">‚òç Aspectos del D√≠a</div>
                    <div class="hoy-aspectos-grid">
                        ${aspectosFiltrados.slice(0, 8).map(a => `
                            <div class="hoy-aspecto-item" title="${interpretarAspecto(a, posiciones)}" style="border-color: ${a.color}">
                                <span style="color: ${a.color}">${a.simbolo}</span>
                                ${PLANET_SYMBOLS[a.planeta1]}${PLANET_SYMBOLS[a.planeta2]}
                                <small>${a.orbe}¬∞</small>
                            </div>
                        `).join('')}
                    </div>
                    <div class="hoy-aspectos-detalle">
                        ${aspectosFiltrados.slice(0, 4).map(a => {
                            const pos1 = posiciones[a.planeta1];
                            const pos2 = posiciones[a.planeta2];
                            const color1 = pos1 ? getInfoColorPlanetario(a.planeta1, pos1.lon) : null;
                            const color2 = pos2 ? getInfoColorPlanetario(a.planeta2, pos2.lon) : null;
                            const func1 = color1 ? color1.funcion : (SIGNIFICADOS_PLANETAS[a.planeta1]?.verbo || a.planeta1);
                            const func2 = color2 ? color2.funcion : (SIGNIFICADOS_PLANETAS[a.planeta2]?.verbo || a.planeta2);
                            const sigAsp = SIGNIFICADOS_ASPECTOS[a.tipo];
                            const elemIcon = sigAsp?.elemento ? iconoElemento[sigAsp.elemento] : '';
                            return `
                            <div class="aspecto-explicacion">
                                <span style="color: ${a.color}">${PLANET_SYMBOLS[a.planeta1]}${a.simbolo}${PLANET_SYMBOLS[a.planeta2]}</span>
                                <strong style="color:${color1?.color || '#d4a853'}">${func1}</strong> 
                                ${sigAsp?.esencia || ''} ${elemIcon}
                                <strong style="color:${color2?.color || '#d4a853'}">${func2}</strong>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        // Generar HTML de tr√°nsitos-natal
        let transitosNatalHTML = '';
        if (tienePerfilNatal && (aspectosNatal.length > 0 || patronesNatal.length > 0)) {
            transitosNatalHTML = `
                <div class="hoy-transitos-natal">
                    <div class="hoy-section-title" style="color: #667eea">üåü Tr√°nsitos sobre tu Carta Natal</div>
                    ${patronesNatal.length > 0 ? `
                        <div class="hoy-figuras-natal">
                            ${patronesNatal.map(p => `
                                <div class="hoy-figura-item" style="border-left: 3px solid #667eea">
                                    <strong>‚òå ${p.descripcion || 'Conjunci√≥n exacta'}</strong><br>
                                    <em>Activaci√≥n intensa de tu ${SIGNIFICADOS_PLANETAS[p.planetas[1]]?.area || 'energ√≠a'} natal</em>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    ${aspectosNatal.length > 0 ? `
                        <div class="hoy-aspectos-grid">
                            ${aspectosNatal.slice(0, 8).map(a => `
                                <div class="hoy-aspecto-item" style="border-color: ${a.color}">
                                    <span style="color: ${a.color}">${a.simbolo}</span>
                                    ${PLANET_SYMBOLS[a.planetaTransito]}‚Üí${PLANET_SYMBOLS[a.planetaNatal]}‚Åø
                                    <small>${a.orbe}¬∞</small>
                                </div>
                            `).join('')}
                        </div>
                        <div class="hoy-aspectos-detalle">
                            ${aspectosNatal.slice(0, 3).map(a => {
                                const infoTransito = getInfoColorPlanetario(a.planetaTransito, a.lonTransito);
                                const infoNatal = getInfoColorPlanetario(a.planetaNatal, a.lonNatal);
                                const funcionTransito = infoTransito ? infoTransito.funcion : a.planetaTransito;
                                const funcionNatal = infoNatal ? infoNatal.funcion : a.planetaNatal;
                                const sigAsp = SIGNIFICADOS_ASPECTOS[a.tipo];
                                const iconoElem = {
                                    'Fuego': 'üî•', 'Agua': 'üíß', 'Aire': 'üí®', 'Tierra': 'üåç',
                                    'Fuego/Agua': 'üî•üíß', 'Tierra/Fuego': 'üåçüî•', 'Agua/Fuego': 'üíßüî•'
                                };
                                const elemIcon = sigAsp?.elemento ? iconoElem[sigAsp.elemento] : '';
                                return `
                                <div class="aspecto-explicacion">
                                    <span style="color: ${a.color}">${PLANET_SYMBOLS[a.planetaTransito]}${a.simbolo}${PLANET_SYMBOLS[a.planetaNatal]}‚Åø</span>
                                    <span style="color:${infoTransito?.color || '#ccc'}">${funcionTransito}</span> 
                                    ${sigAsp?.esencia || 'aspecta'} ${elemIcon}
                                    <span style="color:${infoNatal?.color || '#ccc'}">${funcionNatal}</span> natal
                                </div>
                            `}).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        } else if (!tienePerfilNatal) {
            transitosNatalHTML = `
                <div class="hoy-transitos-natal" style="text-align:center; opacity: 0.7;">
                    <div class="hoy-section-title" style="color: #667eea">üåü Tr√°nsitos sobre tu Carta Natal</div>
                    <p style="font-size: 0.9rem; color: var(--text-dim); padding: 10px;">
                        Para ver los tr√°nsitos sobre tu carta natal, guarda tus datos de nacimiento en la secci√≥n <strong>Personal</strong>.
                    </p>
                </div>
            `;
        }
        
        if (!state.cartaDia) {
            const carta = getCartaDia(diaLunar);
            state.cartaDia = {...carta, invertida: Math.random() < 0.3};
        }
        
        loading.style.display = 'none';
        
        container.innerHTML = `
            <div class="hoy-card">
                <div class="hoy-date">${formatFecha(hoy)}</div>
                
                <div class="hoy-posiciones">
                    <div class="hoy-posiciones-titulo">‚òø Posiciones Planetarias</div>
                    <div class="hoy-posiciones-grid">${posicionesHTML}</div>
                </div>
                
                ${coloresHTML}
                
                <div class="hoy-exaltacion">
                    <div class="hoy-exaltacion-simbolos">
                        ${PLANET_SYMBOLS[exalt.planeta]} ${SIGN_SYMBOLS[exalt.signo]}
                    </div>
                    <div class="hoy-exaltacion-texto">
                        ${exalt.planeta} en ${exalt.signo}
                    </div>
                    <div class="hoy-exaltacion-subtitulo">Exaltaci√≥n del Ciclo Lunar</div>
                </div>
                
                <div class="hoy-interpretacion">${interpretacion}</div>
                
                ${figurasHTML}
                
                ${aspectosHTML}
                
                ${transitosNatalHTML}
                
                <div class="hoy-fase">
                    <span class="hoy-fase-emoji">${fase.emoji}</span>
                    <div class="hoy-fase-info">
                        <div class="hoy-fase-nombre">${fase.nombre}</div>
                        <div class="hoy-fase-dia">D√≠a lunar ${diaLunar} ‚Ä¢ ${diaSemana.simbolo} ${diaSemana.nombre}</div>
                    </div>
                </div>
                
                <div class="hoy-mito">
                    <div class="hoy-mito-titulo">üìú ${exalt.titulo}</div>
                    <div class="hoy-mito-texto">${exalt.texto}</div>
                </div>
            </div>
            
            <div class="hoy-card">
                <div class="hoy-date">‚ú¶ Carta del D√≠a ‚ú¶</div>
                <div class="carta-dia-container">
                    <div class="carta-dia ${state.cartaDiaRevelada ? 'revelada' : ''} ${state.cartaDia.invertida ? 'invertida' : ''}" id="carta-dia">
                        <div class="carta-dia-inner">
                            <div class="carta-dia-front"></div>
                            <div class="carta-dia-back">
                                <img src="${getImagenCarta(state.cartaDia)}" alt="${state.cartaDia.nombreEs}" onerror="this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;background:linear-gradient(135deg,#1a1a4e,#2a2a6e);color:#d4a853;font-size:3rem;font-family:Cinzel,serif\\'>${state.cartaDia.numero}</div>'">
                            </div>
                        </div>
                    </div>
                    <div class="carta-dia-info ${state.cartaDiaRevelada ? 'visible' : ''}" id="carta-dia-info">
                        <div class="carta-dia-nombre">${state.cartaDia.numero} - ${state.cartaDia.nombreEs}</div>
                        <div class="carta-dia-estado ${state.cartaDia.invertida ? 'invertida' : 'normal'}">
                            ${state.cartaDia.invertida ? '‚Üì Invertida' : '‚Üë Normal'}
                        </div>
                        <div class="carta-dia-significado">
                            ${state.cartaDia.invertida ? state.cartaDia.significado.invertida : state.cartaDia.significado.normal}
                        </div>
                        <button class="btn-nueva-carta" id="btn-nueva-carta">üîÑ Otra carta</button>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('carta-dia').addEventListener('click', () => {
            if (!state.cartaDiaRevelada) {
                state.cartaDiaRevelada = true;
                document.getElementById('carta-dia').classList.add('revelada');
                setTimeout(() => {
                    document.getElementById('carta-dia-info').classList.add('visible');
                }, 500);
            }
        });
        
        document.getElementById('btn-nueva-carta')?.addEventListener('click', () => {
            const mazo = barajarMazo();
            state.cartaDia = mazo[0];
            state.cartaDiaRevelada = false;
            renderHoy();
        });
    }

    // ========================================================================
    // PANTALLA TIRADAS
    // ========================================================================
    
    function renderTiradas() {
        const listContainer = document.getElementById('tiradas-list');
        const activaContainer = document.getElementById('tirada-activa');
        
        if (state.tiradaActiva) {
            listContainer.style.display = 'none';
            activaContainer.style.display = 'block';
            renderTiradaActiva();
            return;
        }
        
        listContainer.style.display = 'block';
        activaContainer.style.display = 'none';
        
        const tiradas = Object.entries(TIRADAS);
        
        listContainer.innerHTML = `
            <div class="tiradas-grid">
                ${tiradas.map(([key, t]) => `
                    <div class="tirada-card ${t.cartas >= 28 ? 'especial' : ''}" data-tirada="${key}">
                        <div class="tirada-num">${t.cartas}</div>
                        <div class="tirada-nombre">${t.nombre}</div>
                        <div class="tirada-desc">${t.descripcion}</div>
                    </div>
                `).join('')}
            </div>
        `;
        
        listContainer.querySelectorAll('.tirada-card').forEach(card => {
            card.addEventListener('click', () => {
                const key = card.dataset.tirada;
                iniciarTirada(key);
            });
        });
    }

    function iniciarTirada(tiradaKey) {
        const tirada = TIRADAS[tiradaKey];
        state.tiradaActiva = tiradaKey;
        
        const mazo = barajarMazo();
        state.cartasSeleccionadas = mazo.slice(0, tirada.cartas);
        state.cartasReveladas = new Array(tirada.cartas).fill(false);
        
        renderTiradas();
    }

    function renderTiradaActiva() {
        const container = document.getElementById('tirada-activa');
        const tirada = TIRADAS[state.tiradaActiva];
        const todasReveladas = state.cartasReveladas.every(r => r);
        
        // Determinar tama√±o de cartas seg√∫n cantidad
        let sizeClass = '';
        if (tirada.cartas > 20) sizeClass = 'tiny';
        else if (tirada.cartas > 10) sizeClass = 'small';
        
        container.innerHTML = `
            <div class="tirada-activa">
                <div class="tirada-titulo">${tirada.nombre}</div>
                <div class="tirada-subtitulo">${tirada.descripcion}</div>
                
                <div class="cartas-container">
                    ${state.cartasSeleccionadas.map((carta, i) => `
                        <div class="carta-mini-wrapper">
                            <div class="carta-mini ${sizeClass} ${state.cartasReveladas[i] ? 'revelada' : ''} ${carta.invertida ? 'invertida' : ''}" data-index="${i}">
                                <div class="carta-mini-inner">
                                    <div class="carta-mini-front"></div>
                                    <div class="carta-mini-back">
                                        <img src="${getImagenCarta(carta)}" alt="${carta.nombreEs}" onerror="this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;background:#1a1a2e;color:#d4a853;font-size:${sizeClass==='tiny'?'0.6rem':'0.8rem'}\\'>${carta.numero}</div>'">
                                    </div>
                                </div>
                            </div>
                            <div class="carta-mini-pos" style="font-size:${sizeClass==='tiny'?'0.5rem':'0.65rem'};max-width:${sizeClass==='tiny'?'38px':sizeClass==='small'?'46px':'62px'}">${tirada.posiciones[i]}</div>
                        </div>
                    `).join('')}
                </div>
                
                ${!todasReveladas ? `
                    <button class="btn-revelar-todas" id="btn-revelar">‚ú® Revelar todas</button>
                ` : ''}
                
                ${todasReveladas ? `
                    <div class="lectura-container">
                        ${state.cartasSeleccionadas.map((carta, i) => `
                            <div class="lectura-item">
                                <div class="lectura-img ${carta.invertida ? 'invertida' : ''}">
                                    <img src="${getImagenCarta(carta)}" alt="${carta.nombreEs}" onerror="this.style.display='none'">
                                </div>
                                <div class="lectura-content">
                                    <div class="lectura-pos">${tirada.posiciones[i]}</div>
                                    <div class="lectura-nombre">${carta.numero} - ${carta.nombreEs}</div>
                                    <div class="lectura-estado ${carta.invertida ? 'invertida' : 'normal'}">
                                        ${carta.invertida ? '‚Üì Invertida' : '‚Üë Normal'}
                                    </div>
                                    <div class="lectura-tags">
                                        ${carta.palabrasClave.map(p => `<span class="lectura-tag">${p}</span>`).join('')}
                                    </div>
                                    <div class="lectura-sig">
                                        ${carta.invertida ? carta.significado.invertida : carta.significado.normal}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <button class="btn-volver" id="btn-volver">‚Üê Volver a tiradas</button>
            </div>
        `;
        
        container.querySelectorAll('.carta-mini').forEach(card => {
            card.addEventListener('click', () => {
                const index = parseInt(card.dataset.index);
                if (!state.cartasReveladas[index]) {
                    state.cartasReveladas[index] = true;
                    renderTiradaActiva();
                }
            });
        });
        
        document.getElementById('btn-revelar')?.addEventListener('click', () => {
            let delay = 0;
            state.cartasReveladas.forEach((_, i) => {
                setTimeout(() => {
                    state.cartasReveladas[i] = true;
                    if (i === state.cartasReveladas.length - 1) {
                        renderTiradaActiva();
                    } else {
                        document.querySelectorAll('.carta-mini')[i]?.classList.add('revelada');
                    }
                }, delay);
                delay += 200;
            });
        });
        
        document.getElementById('btn-volver')?.addEventListener('click', () => {
            state.tiradaActiva = null;
            state.cartasSeleccionadas = [];
            state.cartasReveladas = [];
            renderTiradas();
        });
    }

    // ========================================================================
    // PANTALLA CALENDARIO
    // ========================================================================
    
    function renderCalendario() {
        const container = document.getElementById('calendario-content');
        const hoy = new Date();
        
        // Si estamos en el mes actual, usar la fecha de HOY
        // Si no, usar el d√≠a 15 del mes seleccionado
        const mesActualReal = hoy.getMonth();
        const yearActualReal = hoy.getFullYear();
        const estamosEnMesActual = (state.mesActual === mesActualReal && state.yearActual === yearActualReal);
        
        const fecha = estamosEnMesActual ? new Date() : new Date(state.yearActual, state.mesActual, 15);
        const lunaNueva = getLunaNuevaAnterior(fecha);
        const sigLunaNueva = getSiguienteLunaNueva(lunaNueva);
        // Calcular d√≠as del ciclo - m√≠nimo 29, m√°ximo 30 (ciclo lunar real)
        let diasCiclo = sigLunaNueva ? Math.ceil(diasEntre(lunaNueva, sigLunaNueva)) : 30;
        if (diasCiclo < 29) diasCiclo = 29;
        if (diasCiclo > 30) diasCiclo = 30;
        
        console.log('üìÖ Ciclo lunar:', { 
            desde: lunaNueva.toLocaleDateString(), 
            hasta: sigLunaNueva?.toLocaleDateString(), 
            diasCiclo 
        });
        
        // Generar TODOS los d√≠as del ciclo real
        const dias = [];
        for (let i = 0; i < diasCiclo; i++) {
            const diaFecha = new Date(lunaNueva);
            diaFecha.setDate(diaFecha.getDate() + i);
            // Cada exaltaci√≥n dura diasCiclo/28 d√≠as (~1.05)
            // As√≠ las 28 exaltaciones se distribuyen en todos los d√≠as del ciclo
            const diaLunar28 = Math.floor((i * 28) / diasCiclo) + 1;
            dias.push({
                fecha: diaFecha,
                diaLunar: i + 1,
                diaLunar28: Math.min(diaLunar28, 28), // Asegurar que no pase de 28
                fase: getFaseLunar(Math.min(diaLunar28, 28)),
                exalt: getExaltacionDia(Math.min(diaLunar28, 28)),
                esHoy: diaFecha.toDateString() === hoy.toDateString()
            });
        }
        
        // Calcular celdas vac√≠as
        const primerDiaSemana = lunaNueva.getDay();
        const offset = primerDiaSemana === 0 ? 6 : primerDiaSemana - 1;
        
        container.innerHTML = `
            <div class="calendario-year-selector">
                <span class="year-label">A√±o:</span>
                <input type="number" class="year-input" id="year-input" value="${state.yearActual}" min="1" max="3000">
                <button class="year-btn" id="year-go">Calcular</button>
            </div>
            
            <div class="calendario-tools">
                <button class="tool-btn" id="btn-buscar">üîç Buscar</button>
                <button class="tool-btn" id="btn-pronostico">üìÖ Pron√≥stico</button>
                <button class="tool-btn" id="btn-ayuda">‚ùì Ayuda</button>
            </div>
            
            <div class="calendario-header">
                <button class="calendario-nav-btn" id="cal-prev">‚Üê</button>
                <div>
                    <div class="calendario-mes-titulo">üåë Ciclo de ${MESES[lunaNueva.getMonth()]}</div>
                    <div class="calendario-ciclo">${lunaNueva.getDate()}/${lunaNueva.getMonth()+1}/${lunaNueva.getFullYear()} - ${dias[dias.length-1].fecha.getDate()}/${dias[dias.length-1].fecha.getMonth()+1}/${dias[dias.length-1].fecha.getFullYear()}</div>
                </div>
                <button class="calendario-nav-btn" id="cal-next">‚Üí</button>
            </div>
            
            <div class="calendario-dias-semana">
                <div class="dia-semana-header">L</div>
                <div class="dia-semana-header">M</div>
                <div class="dia-semana-header">X</div>
                <div class="dia-semana-header">J</div>
                <div class="dia-semana-header">V</div>
                <div class="dia-semana-header">S</div>
                <div class="dia-semana-header">D</div>
            </div>
            
            <div class="calendario-grid">
                ${Array(offset).fill('<div class="cal-dia vacio"></div>').join('')}
                ${dias.map((d, idx) => {
                    const numEventos = getEventosPorFecha(d.fecha).length;
                    return `
                    <div class="cal-dia ${d.esHoy ? 'hoy' : ''} ${numEventos > 0 ? 'has-event' : ''}" data-dia="${idx}">
                        <div class="cal-dia-fecha">${d.fecha.getDate()}</div>
                        <div class="cal-dia-fase">${d.fase.emoji}</div>
                        <div class="cal-dia-planeta">${PLANET_SYMBOLS[d.exalt.planeta]}</div>
                        ${numEventos > 0 ? `<div class="cal-dia-eventos">${numEventos}</div>` : ''}
                    </div>
                `}).join('')}
            </div>
            
            <div class="events-section">
                <div class="events-section-title">üìã Eventos de hoy</div>
                <p style="color:var(--text-dim);text-align:center;padding:16px;">Selecciona un d√≠a para ver sus eventos</p>
            </div>
            
            ${renderProximosEventos()}
        `;
        
        // Event listener para input de a√±o
        const yearInput = document.getElementById('year-input');
        const yearGo = document.getElementById('year-go');
        
        yearGo.addEventListener('click', () => {
            const year = parseInt(yearInput.value);
            if (year && year > 0 && year < 3001) {
                state.yearActual = year;
                state.mesActual = 0;
                renderCalendario();
            }
        });
        
        yearInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                yearGo.click();
            }
        });
        
        document.getElementById('cal-prev').addEventListener('click', () => {
            state.mesActual--;
            if (state.mesActual < 0) {
                state.mesActual = 11;
                state.yearActual--;
            }
            renderCalendario();
        });
        
        document.getElementById('cal-next').addEventListener('click', () => {
            state.mesActual++;
            if (state.mesActual > 11) {
                state.mesActual = 0;
                state.yearActual++;
            }
            renderCalendario();
        });
        
        container.querySelectorAll('.cal-dia:not(.vacio)').forEach(cell => {
            cell.addEventListener('click', () => {
                const idx = parseInt(cell.dataset.dia);
                const dia = dias[idx];
                showDiaModal(dia);
                if (typeof renderEventosDelDia === 'function') {
                    renderEventosDelDia(dia.fecha);
                }
            });
        });
        
        // Mostrar eventos de hoy por defecto
        const diaHoy = dias.find(d => d.esHoy);
        if (diaHoy && typeof renderEventosDelDia === 'function') {
            renderEventosDelDia(diaHoy.fecha);
        }
        
        // Botones de herramientas
        document.getElementById('btn-buscar').onclick = mostrarBusquedaEventos;
        document.getElementById('btn-pronostico').onclick = mostrarPronostico;
        document.getElementById('btn-ayuda').onclick = mostrarAyuda;
    }

    function showDiaModal(dia) {
        // Cargar perfil si existe para mostrar tr√°nsitos-natal
        if (typeof cargarPerfil === 'function') {
            cargarPerfil();
        }
        
        const carta = getCartaDia(dia.diaLunar28 || dia.diaLunar);
        const modal = document.getElementById('modal');
        const diaSemana = dia.fecha.getDay();
        const infoDia = DIAS_SEMANA[diaSemana];
        const interpretacion = getInterpretacionDia(dia.exalt, diaSemana, dia.fecha);
        const posiciones = getPosicionesPlanetarias(dia.fecha);
        
        // Generar HTML de posiciones planetarias
        const posicionesHTML = Object.entries(posiciones).map(([planeta, pos]) => {
            return `<span class="planeta-pos" title="${planeta}: ${pos.signo} (${pos.dignidad.tipo})">${pos.simbolo}${pos.signoSimbolo}</span>`;
        }).join(' ');
        
        // Generar HTML de aspectos y patrones
        const aspectosPatronesHTML = renderAspectosYPatrones(dia.fecha);
        
        document.getElementById('modal-title').innerHTML = `${PLANET_SYMBOLS[dia.exalt.planeta]} ${dia.exalt.planeta} en ${SIGN_SYMBOLS[dia.exalt.signo]} ${dia.exalt.signo}`;
        document.getElementById('modal-subtitle').textContent = `${infoDia.simbolo} ${infoDia.nombre} ${dia.fecha.getDate()} de ${MESES[dia.fecha.getMonth()]} ‚Ä¢ ${dia.fase.emoji} ${dia.fase.nombre}`;
        
        document.getElementById('modal-body').innerHTML = `
            <div class="modal-posiciones">
                <div class="modal-posiciones-titulo">Posiciones Planetarias</div>
                <div class="modal-posiciones-grid">${posicionesHTML}</div>
            </div>
            
            ${aspectosPatronesHTML}
            
            <div class="modal-interpretacion">${interpretacion}</div>
            
            <div class="modal-carta">
                <img src="${getImagenCarta(carta)}" alt="${carta.nombreEs}" onerror="this.outerHTML='<div style=\\'width:100px;height:194px;background:linear-gradient(135deg,#1a1a4e,#2a2a6e);border-radius:8px;display:flex;align-items:center;justify-content:center;color:#d4a853;font-size:2rem;font-family:Cinzel,serif\\'>${carta.numero}</div>'">
                <div class="modal-carta-info">
                    <div class="modal-carta-nombre">${carta.numero} - ${carta.nombreEs}</div>
                    <div class="lectura-tags" style="margin-top:8px">
                        ${carta.palabrasClave.map(p => `<span class="lectura-tag">${p}</span>`).join('')}
                    </div>
                </div>
            </div>
            
            <div class="modal-mito">
                <div class="modal-mito-titulo">üìú ${dia.exalt.titulo}</div>
                <div class="modal-mito-texto">${dia.exalt.texto}</div>
            </div>
            
            ${renderEventosDiaModal(dia.fecha)}
            
            <button onclick="abrirModalEventoDia();document.getElementById('modal').classList.remove('active');" style="width:100%;padding:14px;margin-top:16px;background:linear-gradient(135deg,var(--gold),#c49b38);border:none;border-radius:12px;color:var(--bg-deep);font-family:'Cinzel',serif;font-size:1rem;font-weight:600;cursor:pointer;">üìù A√±adir Evento a este d√≠a</button>
            
            <div style="display:flex;gap:10px;margin-top:12px;">
                <button onclick="descargarImagenDia()" style="flex:1;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);border:none;border-radius:12px;color:white;font-family:'Cinzel',serif;font-size:0.9rem;font-weight:600;cursor:pointer;">üñºÔ∏è PNG</button>
                <button onclick="descargarPDFDia()" style="flex:1;padding:14px;background:linear-gradient(135deg,#e74c3c,#c0392b);border:none;border-radius:12px;color:white;font-family:'Cinzel',serif;font-size:0.9rem;font-weight:600;cursor:pointer;">üìÑ PDF</button>
            </div>
        `;
        
        // Guardar fecha y d√≠a lunar seleccionados
        state.fechaSeleccionada = dia.fecha;
        state.diaLunar28Seleccionado = dia.diaLunar28 || dia.diaLunar;
        
        modal.classList.add('active');
    }
    
    // Renderizar eventos del d√≠a dentro del modal
    function renderEventosDiaModal(fecha) {
        const eventos = getEventosPorFecha(fecha);
        if (eventos.length === 0) return '';
        
        return `
            <div style="margin-top:16px;padding:16px;background:var(--bg-elevated);border-radius:12px;border-left:4px solid var(--gold);">
                <div style="font-family:'Cinzel',serif;font-size:1rem;color:var(--gold);margin-bottom:12px;">üìã Eventos de este d√≠a (${eventos.length})</div>
                ${eventos.map(e => {
                    const cat = CATEGORIAS_EVENTOS[e.categoria] || CATEGORIAS_EVENTOS.otro;
                    return `
                        <div onclick="verEvento(${e.id});document.getElementById('modal').classList.remove('active');" style="display:flex;align-items:center;gap:10px;padding:10px;margin-bottom:8px;background:var(--bg-card);border-radius:8px;cursor:pointer;border-left:3px solid ${cat.color};">
                            <span style="font-size:1.2rem;">${cat.icon}</span>
                            <div style="flex:1;">
                                <div style="font-weight:600;font-size:0.9rem;">${e.titulo}</div>
                                <div style="font-size:0.75rem;color:var(--text-dim);">${e.hora || 'Sin hora'}</div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    // Renderizar pr√≥ximos eventos
    function renderProximosEventos() {
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        
        // Filtrar eventos futuros y ordenar por fecha
        const eventosFuturos = state.eventos
            .filter(e => {
                const fechaEvento = new Date(e.fecha);
                fechaEvento.setHours(0, 0, 0, 0);
                return fechaEvento >= hoy;
            })
            .sort((a, b) => new Date(a.fecha) - new Date(b.fecha))
            .slice(0, 15); // M√°ximo 15 eventos
        
        if (eventosFuturos.length === 0 && state.eventos.length === 0) {
            return `
                <div class="proximos-eventos-section">
                    <div class="proximos-eventos-title">üìÖ Pr√≥ximos Eventos</div>
                    <p style="color:var(--text-dim);text-align:center;padding:16px;font-size:0.9rem;">No tienes eventos programados</p>
                </div>
            `;
        }
        
        // Agrupar por fecha
        const eventosPorFecha = {};
        eventosFuturos.forEach(e => {
            if (!eventosPorFecha[e.fecha]) eventosPorFecha[e.fecha] = [];
            eventosPorFecha[e.fecha].push(e);
        });
        
        let html = `
            <div class="proximos-eventos-section">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                    <div class="proximos-eventos-title">üìÖ Eventos (${state.eventos.length} total)</div>
                    <button onclick="toggleSeleccionEventos()" style="padding:6px 12px;background:var(--bg-elevated);border:1px solid var(--gold);border-radius:6px;color:var(--gold);font-size:0.75rem;cursor:pointer;" id="btn-toggle-seleccion">‚òëÔ∏è Seleccionar</button>
                </div>
                
                <div id="eventos-seleccion-tools" style="display:none;margin-top:12px;padding:12px;background:var(--bg-elevated);border-radius:8px;">
                    <div style="display:flex;gap:8px;margin-bottom:10px;">
                        <button onclick="seleccionarTodosEventos(true)" style="flex:1;padding:8px;background:var(--bg-card);border:1px solid rgba(212,168,83,0.3);border-radius:6px;color:var(--text);font-size:0.8rem;cursor:pointer;">‚úÖ Todos</button>
                        <button onclick="seleccionarTodosEventos(false)" style="flex:1;padding:8px;background:var(--bg-card);border:1px solid rgba(212,168,83,0.3);border-radius:6px;color:var(--text);font-size:0.8rem;cursor:pointer;">‚ùå Ninguno</button>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                        <label style="display:flex;align-items:center;gap:6px;font-size:0.8rem;cursor:pointer;">
                            <input type="checkbox" id="export-selected-images" checked style="width:16px;height:16px;accent-color:var(--gold);">
                            <span>Incluir im√°genes</span>
                        </label>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button onclick="exportarEventosSeleccionados('word')" style="flex:1;padding:10px;background:linear-gradient(135deg,#2b5797,#1e3f6f);border:none;border-radius:8px;color:white;font-size:0.8rem;cursor:pointer;">üìù Word</button>
                        <button onclick="exportarEventosSeleccionados('ics')" style="flex:1;padding:10px;background:linear-gradient(135deg,#27ae60,#1e8449);border:none;border-radius:8px;color:white;font-size:0.8rem;cursor:pointer;">üìÖ .ics</button>
                    </div>
                    <div id="eventos-seleccionados-count" style="text-align:center;font-size:0.75rem;color:var(--text-dim);margin-top:8px;">0 eventos seleccionados</div>
                </div>
        `;
        
        if (eventosFuturos.length === 0) {
            html += `<p style="color:var(--text-dim);text-align:center;padding:16px;font-size:0.85rem;">No hay eventos pr√≥ximos</p>`;
        }
        
        for (const [fecha, eventos] of Object.entries(eventosPorFecha)) {
            const fechaObj = new Date(fecha);
            const esHoy = fechaObj.toDateString() === new Date().toDateString();
            const esMa√±ana = fechaObj.toDateString() === new Date(Date.now() + 86400000).toDateString();
            
            let etiquetaFecha;
            if (esHoy) {
                etiquetaFecha = 'üî¥ Hoy';
            } else if (esMa√±ana) {
                etiquetaFecha = 'üü° Ma√±ana';
            } else {
                etiquetaFecha = fechaObj.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
            }
            
            html += `<div class="proximos-eventos-fecha">${etiquetaFecha}</div>`;
            
            eventos.forEach(e => {
                const cat = CATEGORIAS_EVENTOS[e.categoria] || CATEGORIAS_EVENTOS.otro;
                html += `
                    <div class="proximo-evento-item" style="border-left-color:${cat.color};">
                        <input type="checkbox" class="evento-checkbox" data-id="${e.id}" style="display:none;width:18px;height:18px;accent-color:var(--gold);flex-shrink:0;" onchange="actualizarConteoSeleccion()">
                        <div class="proximo-evento-hora">${e.hora || '--:--'}</div>
                        <div class="proximo-evento-info" onclick="verEvento(${e.id})" style="cursor:pointer;flex:1;">
                            <div class="proximo-evento-titulo">${e.titulo}</div>
                            <div class="proximo-evento-cat">${cat.icon} ${cat.nombre}</div>
                        </div>
                    </div>
                `;
            });
        }
        
        html += `</div>`;
        return html;
    }
    
    // Toggle modo selecci√≥n
    window.toggleSeleccionEventos = function() {
        const tools = document.getElementById('eventos-seleccion-tools');
        const checkboxes = document.querySelectorAll('.evento-checkbox');
        const btn = document.getElementById('btn-toggle-seleccion');
        
        if (tools.style.display === 'none') {
            tools.style.display = 'block';
            checkboxes.forEach(cb => cb.style.display = 'block');
            btn.textContent = '‚úñÔ∏è Cancelar';
            btn.style.borderColor = '#e74c3c';
            btn.style.color = '#e74c3c';
        } else {
            tools.style.display = 'none';
            checkboxes.forEach(cb => {
                cb.style.display = 'none';
                cb.checked = false;
            });
            btn.textContent = '‚òëÔ∏è Seleccionar';
            btn.style.borderColor = 'var(--gold)';
            btn.style.color = 'var(--gold)';
        }
    };
    
    // Seleccionar todos/ninguno
    window.seleccionarTodosEventos = function(seleccionar) {
        document.querySelectorAll('.evento-checkbox').forEach(cb => cb.checked = seleccionar);
        actualizarConteoSeleccion();
    };
    
    // Actualizar conteo
    window.actualizarConteoSeleccion = function() {
        const seleccionados = document.querySelectorAll('.evento-checkbox:checked').length;
        const counter = document.getElementById('eventos-seleccionados-count');
        if (counter) counter.textContent = `${seleccionados} evento${seleccionados !== 1 ? 's' : ''} seleccionado${seleccionados !== 1 ? 's' : ''}`;
    };
    
    // Exportar eventos seleccionados
    window.exportarEventosSeleccionados = function(formato) {
        const ids = Array.from(document.querySelectorAll('.evento-checkbox:checked')).map(cb => parseInt(cb.dataset.id));
        
        if (ids.length === 0) {
            alert('Selecciona al menos un evento para exportar');
            return;
        }
        
        const eventosSeleccionados = state.eventos.filter(e => ids.includes(e.id));
        const incluirImagenes = document.getElementById('export-selected-images')?.checked ?? true;
        
        if (formato === 'word') {
            const contenido = generarHTMLWord(eventosSeleccionados, incluirImagenes, `Eventos Seleccionados (${eventosSeleccionados.length})`);
            descargarWord(contenido, `eventos_${new Date().toISOString().split('T')[0]}.doc`);
        } else if (formato === 'ics') {
            exportarEventosComoICS(eventosSeleccionados);
        }
    };
    
    // Exportar array de eventos como ICS
    function exportarEventosComoICS(eventos) {
        let ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Tarot 28 Arcanos//ES
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;
        
        eventos.forEach(evento => {
            const dtstart = formatDateForICS(evento.fecha, evento.hora);
            let dtend;
            if (evento.hora) {
                const [h, m] = evento.hora.split(':').map(Number);
                const endH = h + 1;
                dtend = formatDateForICS(evento.fecha, `${endH}:${String(m).padStart(2, '0')}`);
            } else {
                dtend = dtstart;
            }
            
            const cat = CATEGORIAS_EVENTOS[evento.categoria] || CATEGORIAS_EVENTOS.otro;
            
            ics += `BEGIN:VEVENT
DTSTART:${dtstart}
DTEND:${dtend}
SUMMARY:${cat.icon} ${evento.titulo}
DESCRIPTION:${(evento.notas || '').replace(/\n/g, '\\n')}
BEGIN:VALARM
TRIGGER:-PT30M
ACTION:DISPLAY
DESCRIPTION:Recordatorio
END:VALARM
END:VEVENT
`;
        });
        
        ics += `END:VCALENDAR`;
        
        const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `eventos_${new Date().toISOString().split('T')[0]}.ics`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    document.getElementById('modal-close').addEventListener('click', () => {
        document.getElementById('modal').classList.remove('active');
    });

    document.getElementById('modal').addEventListener('click', (e) => {
        if (e.target.id === 'modal') {
            document.getElementById('modal').classList.remove('active');
        }
    });

    // ========================================================================
    // PWA INSTALL
    // ========================================================================
    
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('install-prompt').classList.add('show');
    });

    document.getElementById('install-now')?.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const result = await deferredPrompt.userChoice;
            deferredPrompt = null;
        }
        document.getElementById('install-prompt').classList.remove('show');
    });

    document.getElementById('install-later')?.addEventListener('click', () => {
        document.getElementById('install-prompt').classList.remove('show');
    });

    // ========================================================================
    // AYUDA Y EXPLICACIONES
    // ========================================================================
    
    function mostrarAyuda() {
        document.getElementById('modal-title').innerHTML = '‚ùì Gu√≠a del Sistema';
        document.getElementById('modal-body').innerHTML = `
            <div style="max-height:500px;overflow-y:auto;font-size:0.9rem;line-height:1.6;">
                
                <div style="margin-bottom:20px;">
                    <h3 style="color:var(--gold);font-family:'Cinzel',serif;margin-bottom:8px;">üåô Ciclo Lunar de 28 D√≠as</h3>
                    <p style="color:var(--text-dim);">El calendario sigue el ciclo lunar real. Cada d√≠a corresponde a una de las 28 exaltaciones planetarias, cada una con su carta del tarot asociada.</p>
                </div>
                
                <div style="margin-bottom:20px;">
                    <h3 style="color:var(--gold);font-family:'Cinzel',serif;margin-bottom:8px;">üåì Fases Lunares</h3>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;color:var(--text-dim);">
                        <div>üåë Nueva (1-3)</div>
                        <div>üåí Creciente (4-7)</div>
                        <div>üåì Cuarto Creciente (8-10)</div>
                        <div>üåî Gibosa Creciente (11-14)</div>
                        <div>üåï Llena (15-17)</div>
                        <div>üåñ Gibosa Menguante (18-21)</div>
                        <div>üåó Cuarto Menguante (22-24)</div>
                        <div>üåò Bals√°mica (25-28)</div>
                    </div>
                </div>
                
                <div style="margin-bottom:20px;">
                    <h3 style="color:var(--gold);font-family:'Cinzel',serif;margin-bottom:8px;">‚òç Aspectos Planetarios</h3>
                    <p style="color:var(--text-dim);margin-bottom:8px;">Los aspectos son √°ngulos entre planetas que indican c√≥mo interact√∫an sus energ√≠as:</p>
                    <div style="color:var(--text-dim);">
                        <div style="margin-bottom:6px;"><strong style="color:#e74c3c;">‚òå Conjunci√≥n (0¬∞)</strong> - üî• Fuego - Fusi√≥n, inicio, intensidad</div>
                        <div style="margin-bottom:6px;"><strong style="color:#3498db;">‚öπ Sextil (60¬∞)</strong> - üíß Agua - Oportunidad, fluidez suave</div>
                        <div style="margin-bottom:6px;"><strong style="color:#27ae60;">‚ñ° Cuadratura (90¬∞)</strong> - üåç Tierra - Tensi√≥n, fricci√≥n, acci√≥n forzada</div>
                        <div style="margin-bottom:6px;"><strong style="color:#3498db;">‚ñ≥ Tr√≠gono (120¬∞)</strong> - üíß Agua - Armon√≠a, fluidez natural</div>
                        <div style="margin-bottom:6px;"><strong style="color:#e74c3c;">‚òç Oposici√≥n (180¬∞)</strong> - üî• Fuego - Polaridad, confrontaci√≥n, equilibrio</div>
                    </div>
                </div>
                
                <div style="margin-bottom:20px;">
                    <h3 style="color:var(--gold);font-family:'Cinzel',serif;margin-bottom:8px;">üî•üíßüí®üåç Los 4 Elementos</h3>
                    <div style="color:var(--text-dim);">
                        <div style="margin-bottom:6px;"><strong>üî• Fuego</strong> - C√°lido + Seco ‚Üí Expansivo y tenso (ignici√≥n, inicio)</div>
                        <div style="margin-bottom:6px;"><strong>üíß Agua</strong> - Fr√≠o + H√∫medo ‚Üí Contractivo y fluido (nutrici√≥n, conexi√≥n)</div>
                        <div style="margin-bottom:6px;"><strong>üí® Aire</strong> - C√°lido + H√∫medo ‚Üí Expansivo y fluido (ideas, comunicaci√≥n)</div>
                        <div style="margin-bottom:6px;"><strong>üåç Tierra</strong> - Fr√≠o + Seco ‚Üí Contractivo y tenso (materia, estructura)</div>
                    </div>
                </div>
                
                <div style="margin-bottom:20px;">
                    <h3 style="color:var(--gold);font-family:'Cinzel',serif;margin-bottom:8px;">‚ú° Figuras Astrol√≥gicas</h3>
                    <div style="color:var(--text-dim);">
                        <div style="margin-bottom:6px;"><strong>‚ñ≥ Gran Tr√≠gono</strong> - üíß Agua - 3 planetas en armon√≠a perfecta, talento natural</div>
                        <div style="margin-bottom:6px;"><strong>‚ä§ T-Cuadrada</strong> - üåçüî• Tierra+Fuego - Tensi√≥n que impulsa a la acci√≥n</div>
                        <div style="margin-bottom:6px;"><strong>‚úö Gran Cruz</strong> - üåçüî• Tierra+Fuego - M√°xima tensi√≥n, grandes desaf√≠os</div>
                        <div style="margin-bottom:6px;"><strong>‚òå Stellium</strong> - üî• Fuego - 3+ planetas juntos, foco intenso</div>
                        <div style="margin-bottom:6px;"><strong>‚¨† Rect√°ngulo √Åureo</strong> - üí® Aire - Proporci√≥n √°urea, equilibrio mental</div>
                    </div>
                </div>
                
                <div style="margin-bottom:20px;">
                    <h3 style="color:var(--gold);font-family:'Cinzel',serif;margin-bottom:8px;">üìÖ Pron√≥stico</h3>
                    <p style="color:var(--text-dim);margin-bottom:8px;">Los indicadores muestran la energ√≠a del d√≠a:</p>
                    <div style="color:var(--text-dim);">
                        <div style="margin-bottom:6px;"><span style="color:#e74c3c;">‚óè‚óè‚óè</span> <strong>Tensi√≥n</strong> - Cuadraturas y oposiciones (desaf√≠os, fricci√≥n)</div>
                        <div style="margin-bottom:6px;"><span style="color:#27ae60;">‚óè‚óè‚óè</span> <strong>Armon√≠a</strong> - Conjunciones y tr√≠gonos (fluidez, facilidad)</div>
                    </div>
                    <p style="color:var(--text-dim);margin-top:8px;font-size:0.85rem;">M√°s puntos = m√°s aspectos de ese tipo. Un d√≠a puede tener ambos.</p>
                </div>
                
                <div style="margin-bottom:20px;">
                    <h3 style="color:var(--gold);font-family:'Cinzel',serif;margin-bottom:8px;">üé® Funciones Planetarias</h3>
                    <p style="color:var(--text-dim);margin-bottom:8px;">Cada planeta tiene una funci√≥n seg√∫n el signo donde se encuentra:</p>
                    <div style="color:var(--text-dim);font-size:0.85rem;">
                        <div style="margin-bottom:4px;">‚Ä¢ <strong style="color:#27ae60;">Exaltaci√≥n</strong> - El planeta est√° fuerte y expresa su mejor cualidad</div>
                        <div style="margin-bottom:4px;">‚Ä¢ <strong style="color:#f39c12;">Domicilio/Exilio</strong> - El planeta est√° debilitado o distorsionado</div>
                        <div style="margin-bottom:4px;">‚Ä¢ <strong>Ca√≠da</strong> - El planeta act√∫a de forma neutral</div>
                    </div>
                </div>
                
                <div style="margin-bottom:20px;">
                    <h3 style="color:var(--gold);font-family:'Cinzel',serif;margin-bottom:8px;">üîÆ Tr√°nsitos sobre Carta Natal</h3>
                    <p style="color:var(--text-dim);">Si has configurado tu perfil natal, ver√°s c√≥mo los planetas actuales (tr√°nsitos) aspectan a los planetas de tu carta de nacimiento. Esto personaliza la interpretaci√≥n del d√≠a para ti.</p>
                </div>
                
            </div>
        `;
        
        document.getElementById('modal').classList.add('active');
    }

    // ========================================================================
    // B√öSQUEDA DE EVENTOS
    // ========================================================================
    
    let busquedaState = {
        texto: '',
        categoria: 'todas',
        fechaDesde: '',
        fechaHasta: ''
    };
    
    function mostrarBusquedaEventos() {
        const categorias = [
            { id: 'todas', icon: 'üìã', nombre: 'Todas' },
            { id: 'cumple', icon: 'üéÇ', nombre: 'Cumplea√±os' },
            { id: 'cita', icon: 'üìÖ', nombre: 'Citas' },
            { id: 'trabajo', icon: 'üíº', nombre: 'Trabajo' },
            { id: 'salud', icon: '‚ù§Ô∏è', nombre: 'Salud' },
            { id: 'social', icon: 'üë•', nombre: 'Social' },
            { id: 'viaje', icon: '‚úàÔ∏è', nombre: 'Viajes' },
            { id: 'finanzas', icon: 'üí∞', nombre: 'Finanzas' },
            { id: 'otro', icon: 'üìù', nombre: 'Otros' }
        ];
        
        document.getElementById('modal-title').innerHTML = 'üîç Buscar Eventos';
        document.getElementById('modal-body').innerHTML = `
            <div class="search-filters">
                <input type="text" id="search-texto" class="form-input-event" placeholder="Buscar por t√≠tulo o notas..." value="${busquedaState.texto}">
                
                <div class="search-categories">
                    ${categorias.map(c => `
                        <button class="search-cat-btn ${busquedaState.categoria === c.id ? 'active' : ''}" data-cat="${c.id}">
                            ${c.icon} ${c.nombre}
                        </button>
                    `).join('')}
                </div>
                
                <div class="search-row">
                    <div>
                        <span class="form-label-event">Desde</span>
                        <input type="date" id="search-desde" class="form-input-event" value="${busquedaState.fechaDesde}">
                    </div>
                    <div>
                        <span class="form-label-event">Hasta</span>
                        <input type="date" id="search-hasta" class="form-input-event" value="${busquedaState.fechaHasta}">
                    </div>
                </div>
            </div>
            
            <div class="search-results" id="search-results">
                ${renderResultadosBusqueda()}
            </div>
        `;
        
        document.getElementById('modal').classList.add('active');
        
        // Event listeners
        document.getElementById('search-texto').addEventListener('input', (e) => {
            busquedaState.texto = e.target.value;
            actualizarBusqueda();
        });
        
        document.querySelectorAll('.search-cat-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.search-cat-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                busquedaState.categoria = btn.dataset.cat;
                actualizarBusqueda();
            });
        });
        
        document.getElementById('search-desde').addEventListener('change', (e) => {
            busquedaState.fechaDesde = e.target.value;
            actualizarBusqueda();
        });
        
        document.getElementById('search-hasta').addEventListener('change', (e) => {
            busquedaState.fechaHasta = e.target.value;
            actualizarBusqueda();
        });
    }
    
    function actualizarBusqueda() {
        document.getElementById('search-results').innerHTML = renderResultadosBusqueda();
    }
    
    function renderResultadosBusqueda() {
        let resultados = [...state.eventos];
        
        // Filtrar por texto
        if (busquedaState.texto) {
            const texto = busquedaState.texto.toLowerCase();
            resultados = resultados.filter(e => 
                e.titulo.toLowerCase().includes(texto) || 
                (e.notas && e.notas.toLowerCase().includes(texto))
            );
        }
        
        // Filtrar por categor√≠a
        if (busquedaState.categoria !== 'todas') {
            resultados = resultados.filter(e => e.categoria === busquedaState.categoria);
        }
        
        // Filtrar por fechas
        if (busquedaState.fechaDesde) {
            resultados = resultados.filter(e => e.fecha >= busquedaState.fechaDesde);
        }
        if (busquedaState.fechaHasta) {
            resultados = resultados.filter(e => e.fecha <= busquedaState.fechaHasta);
        }
        
        // Ordenar por fecha
        resultados.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
        
        if (resultados.length === 0) {
            return `<div class="search-empty">No se encontraron eventos</div>`;
        }
        
        const recurrenciaTexto = {
            'daily': 'üîÑ Diario',
            'weekly': 'üîÑ Semanal',
            'monthly': 'üîÑ Mensual',
            'yearly': 'üéÇ Anual'
        };
        
        return resultados.map(e => {
            const cat = CATEGORIAS_EVENTOS[e.categoria] || CATEGORIAS_EVENTOS.otro;
            const fechaStr = new Date(e.fecha + 'T00:00:00').toLocaleDateString('es-ES', {
                weekday: 'short', day: 'numeric', month: 'short', year: 'numeric'
            });
            const recTxt = e.recurrencia && e.recurrencia !== 'none' ? recurrenciaTexto[e.recurrencia] : '';
            
            return `
                <div class="search-result-item" onclick="irAEvento('${e.id}', '${e.fecha}')">
                    <div class="search-result-icon">${cat.icon}</div>
                    <div class="search-result-info">
                        <div class="search-result-title">${e.titulo}</div>
                        <div class="search-result-date">${fechaStr}${e.hora ? ' ‚Ä¢ ' + e.hora : ''}</div>
                        ${recTxt ? `<div class="search-result-rec">${recTxt}</div>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    window.irAEvento = function(id, fecha) {
        document.getElementById('modal').classList.remove('active');
        const fechaObj = new Date(fecha + 'T12:00:00');
        state.mesActual = fechaObj.getMonth();
        state.yearActual = fechaObj.getFullYear();
        renderCalendario();
        
        // Mostrar evento
        setTimeout(() => {
            verEvento(id);
        }, 300);
    };
    
    // ========================================================================
    // PRON√ìSTICO SEMANAL/MENSUAL
    // ========================================================================
    
    let pronosticoState = {
        periodo: 'semana' // 'semana' o 'mes'
    };
    
    function mostrarPronostico() {
        document.getElementById('modal-title').innerHTML = 'üìÖ Pron√≥stico';
        document.getElementById('modal-body').innerHTML = `
            <div class="pronostico-tabs">
                <button class="pronostico-tab ${pronosticoState.periodo === 'semana' ? 'active' : ''}" data-periodo="semana">7 d√≠as</button>
                <button class="pronostico-tab ${pronosticoState.periodo === 'mes' ? 'active' : ''}" data-periodo="mes">30 d√≠as</button>
            </div>
            
            <div style="display:flex;justify-content:center;gap:16px;margin-bottom:12px;font-size:0.8rem;color:var(--text-dim);">
                <span><span style="color:#e74c3c;">‚óè‚óè‚óè</span> Tensi√≥n (‚ñ°‚òç)</span>
                <span><span style="color:#27ae60;">‚óè‚óè‚óè</span> Armon√≠a (‚òå‚ñ≥)</span>
            </div>
            
            <div class="pronostico-list" id="pronostico-list">
                ${renderPronostico()}
            </div>
        `;
        
        document.getElementById('modal').classList.add('active');
        
        document.querySelectorAll('.pronostico-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.pronostico-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                pronosticoState.periodo = tab.dataset.periodo;
                document.getElementById('pronostico-list').innerHTML = renderPronostico();
                agregarListenersPronostico();
            });
        });
        
        agregarListenersPronostico();
    }
    
    function agregarListenersPronostico() {
        document.querySelectorAll('.pronostico-dia-header').forEach(header => {
            header.addEventListener('click', () => {
                header.parentElement.classList.toggle('expanded');
            });
        });
    }
    
    function renderPronostico() {
        const hoy = new Date();
        const dias = pronosticoState.periodo === 'semana' ? 7 : 30;
        let html = '';
        
        for (let i = 0; i < dias; i++) {
            const fecha = new Date(hoy);
            fecha.setDate(fecha.getDate() + i);
            html += renderDiaPronostico(fecha, i === 0);
        }
        
        return html;
    }
    
    function renderDiaPronostico(fecha, esHoy) {
        // Obtener posiciones
        const posiciones = getPosicionesPlanetarias(fecha, 0);
        
        // Calcular aspectos
        const aspectos = [];
        const planetas = Object.entries(posiciones).filter(([n]) => !['ASC','MC','Parte de Fortuna'].includes(n));
        const aspectosDef = {
            conjuncion: { angulo: 0, orbe: 6, simbolo: '‚òå', color: '#e74c3c' },
            cuadratura: { angulo: 90, orbe: 6, simbolo: '‚ñ°', color: '#27ae60' },
            trigono: { angulo: 120, orbe: 6, simbolo: '‚ñ≥', color: '#3498db' },
            oposicion: { angulo: 180, orbe: 6, simbolo: '‚òç', color: '#e74c3c' }
        };
        
        for (let i = 0; i < planetas.length; i++) {
            for (let j = i + 1; j < planetas.length; j++) {
                const [n1, p1] = planetas[i];
                const [n2, p2] = planetas[j];
                for (const [tipo, asp] of Object.entries(aspectosDef)) {
                    if (tieneAspecto(p1.lon, p2.lon, asp.angulo, asp.orbe)) {
                        aspectos.push({
                            tipo, simbolo: asp.simbolo, color: asp.color,
                            p1: PLANET_SYMBOLS[n1], p2: PLANET_SYMBOLS[n2]
                        });
                        break;
                    }
                }
            }
        }
        
        // Contar tensi√≥n vs armon√≠a
        const tension = aspectos.filter(a => a.tipo === 'cuadratura' || a.tipo === 'oposicion').length;
        const armonia = aspectos.filter(a => a.tipo === 'trigono' || a.tipo === 'conjuncion').length;
        
        // Eventos del d√≠a
        const eventos = getEventosPorFecha(fecha);
        
        // Fase lunar
        const diaLunar = getDiaLunar(fecha);
        const fase = getFaseLunar(diaLunar);
        
        // D√≠a de la semana
        const diasSemana = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
        const fechaStr = `${diasSemana[fecha.getDay()]} ${fecha.getDate()}/${fecha.getMonth() + 1}`;
        
        return `
            <div class="pronostico-dia ${esHoy ? 'expanded' : ''}">
                <div class="pronostico-dia-header">
                    <div>
                        <div class="pronostico-dia-fecha ${esHoy ? 'es-hoy' : ''}">${fechaStr} ${esHoy ? '(Hoy)' : ''}</div>
                        <div class="pronostico-intensidad">
                            ${Array(Math.min(tension, 3)).fill('<span class="intensidad-dot active tension"></span>').join('')}
                            ${Array(Math.max(0, 3 - tension)).fill('<span class="intensidad-dot"></span>').join('')}
                            <span style="margin: 0 4px; opacity: 0.3;">|</span>
                            ${Array(Math.min(armonia, 3)).fill('<span class="intensidad-dot active armonia"></span>').join('')}
                            ${Array(Math.max(0, 3 - armonia)).fill('<span class="intensidad-dot"></span>').join('')}
                        </div>
                    </div>
                    <div class="pronostico-dia-iconos">
                        ${fase.emoji}
                        ${eventos.length > 0 ? `<span style="font-size:0.8rem;background:var(--gold);color:#000;padding:2px 6px;border-radius:10px;">${eventos.length}</span>` : ''}
                    </div>
                </div>
                <div class="pronostico-dia-content">
                    <div style="font-size:0.85rem;color:var(--text-dim);margin-bottom:8px;">
                        ${fase.nombre} ‚Ä¢ D√≠a lunar ${diaLunar}
                    </div>
                    
                    ${aspectos.length > 0 ? `
                        <div class="pronostico-aspectos">
                            ${aspectos.slice(0, 6).map(a => `
                                <span class="pronostico-aspecto" style="border-left: 3px solid ${a.color};">
                                    ${a.p1}${a.simbolo}${a.p2}
                                </span>
                            `).join('')}
                        </div>
                    ` : '<div style="font-size:0.85rem;color:var(--text-dim);">Sin aspectos mayores</div>'}
                    
                    ${eventos.length > 0 ? `
                        <div class="pronostico-eventos">
                            ${eventos.slice(0, 3).map(e => {
                                const cat = CATEGORIAS_EVENTOS[e.categoria] || CATEGORIAS_EVENTOS.otro;
                                return `<div class="pronostico-evento">${cat.icon} ${e.titulo}</div>`;
                            }).join('')}
                            ${eventos.length > 3 ? `<div class="pronostico-evento" style="color:var(--text-dim);">+${eventos.length - 3} m√°s</div>` : ''}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    // ========================================================================
    // SECCI√ìN PERSONAL - PERFIL NATAL Y AN√ÅLISIS
    // ========================================================================
    
    // Estado del perfil
    let perfilState = {
        perfil: null,
        cartaNatal: null
    };
    
    // Cargar perfil guardado
    function cargarPerfil() {
        const saved = localStorage.getItem('tarot28_perfil');
        if (saved) {
            const datos = JSON.parse(saved);
            perfilState.perfil = datos.perfil;
            
            // Siempre recalcular carta natal para tener los √∫ltimos c√°lculos
            if (datos.perfil) {
                const p = datos.perfil;
                const [year, month, day] = p.birthDate.split('-').map(Number);
                const [hour, minute] = p.birthTime.split(':').map(Number);
                const fechaNac = { year, month, day, hour, minute };
                
                // Recalcular TZ si tenemos countryCode
                let tz = p.tz;
                if (p.countryCode && (!tz || tz === 0)) {
                    tz = calcularTZ(p.countryCode, year, month, day);
                    perfilState.perfil.tz = tz; // Actualizar el perfil
                }
                if (!tz && tz !== 0) {
                    tz = getTZFromLongitude(p.lon);
                }
                
                console.log('üìÇ Cargando perfil:', { fechaNac, tz, countryCode: p.countryCode });
                
                perfilState.cartaNatal = calcularCartaNatal(fechaNac, p.lat, p.lon, tz);
                guardarPerfil();
            }
            return true;
        }
        return false;
    }
    
    function guardarPerfil() {
        localStorage.setItem('tarot28_perfil', JSON.stringify(perfilState));
    }
    
    // Mapa de pa√≠ses a timezone principal
    const COUNTRY_TIMEZONES = {
        'ES': 'Europe/Madrid', 'FR': 'Europe/Paris', 'PT': 'Europe/Lisbon',
        'GB': 'Europe/London', 'IE': 'Europe/Dublin', 'DE': 'Europe/Berlin',
        'IT': 'Europe/Rome', 'NL': 'Europe/Amsterdam', 'BE': 'Europe/Brussels',
        'AT': 'Europe/Vienna', 'CH': 'Europe/Zurich', 'PL': 'Europe/Warsaw',
        'CZ': 'Europe/Prague', 'GR': 'Europe/Athens', 'SE': 'Europe/Stockholm',
        'NO': 'Europe/Oslo', 'DK': 'Europe/Copenhagen', 'FI': 'Europe/Helsinki',
        'RU': 'Europe/Moscow', 'UA': 'Europe/Kiev',
        'US': 'America/New_York', 'CA': 'America/Toronto', 'MX': 'America/Mexico_City',
        'BR': 'America/Sao_Paulo', 'AR': 'America/Buenos_Aires', 'CL': 'America/Santiago',
        'CO': 'America/Bogota', 'PE': 'America/Lima', 'VE': 'America/Caracas',
        'CN': 'Asia/Shanghai', 'JP': 'Asia/Tokyo', 'KR': 'Asia/Seoul',
        'IN': 'Asia/Kolkata', 'AU': 'Australia/Sydney', 'NZ': 'Pacific/Auckland',
        'ZA': 'Africa/Johannesburg', 'EG': 'Africa/Cairo', 'MA': 'Africa/Casablanca',
        'IL': 'Asia/Jerusalem', 'TR': 'Europe/Istanbul', 'SA': 'Asia/Riyadh',
        'AE': 'Asia/Dubai', 'TH': 'Asia/Bangkok', 'SG': 'Asia/Singapore',
        'PH': 'Asia/Manila', 'ID': 'Asia/Jakarta', 'MY': 'Asia/Kuala_Lumpur'
    };
    
    // Obtener offset en horas desde timezone name y fecha espec√≠fica
    function getTimezoneOffset(timezoneName, year, month, day, hour = 12) {
        try {
            // Crear fecha UTC espec√≠fica
            const utcDate = new Date(Date.UTC(year, month - 1, day, hour, 0, 0));
            
            // Obtener la hora en la zona horaria objetivo
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: timezoneName,
                hour: 'numeric',
                hour12: false
            });
            
            let tzHour = parseInt(formatter.format(utcDate));
            if (tzHour === 24) tzHour = 0; // Medianoche
            
            // Calcular offset
            let offset = tzHour - hour;
            
            // Ajustar si cruza medianoche
            if (offset < -12) offset += 24;
            if (offset > 12) offset -= 24;
            
            return offset;
        } catch (e) {
            console.warn('Timezone no v√°lida:', timezoneName, e);
            return 0;
        }
    }
    
    // Obtener timezone desde c√≥digo de pa√≠s
    function getTimezoneFromCountry(countryCode) {
        return COUNTRY_TIMEZONES[countryCode] || 'UTC';
    }
    
    // Calcular TZ offset para una fecha y ubicaci√≥n
    function calcularTZ(countryCode, year, month, day) {
        const tz = getTimezoneFromCountry(countryCode);
        return getTimezoneOffset(tz, year, month, day);
    }
    
    // Fallback: calcular TZ aproximada desde longitud (para pa√≠ses desconocidos)
    function getTZFromLongitude(lon) {
        return Math.round(lon / 15);
    }
    
    // B√∫squeda de ciudades (Nominatim/OpenStreetMap)
    let citySearchTimeout = null;
    
    async function searchCities(query, target = 'birth') {
        const containerId = target === 'birth' ? 'city-results' : 'city-results-res';
        const container = document.getElementById(containerId);
        
        if (query.length < 3) {
            container?.classList.remove('show');
            return;
        }
        
        try {
            // Usar Netlify Function (se ejecuta en el servidor, sin CORS)
            const response = await fetch(
                `/.netlify/functions/geocode?q=${encodeURIComponent(query)}`
            );
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const results = await response.json();
            
            if (results.length === 0) {
                container.innerHTML = '<div class="city-result-item">No se encontraron resultados</div>';
            } else {
                container.innerHTML = results.map(r => {
                    const countryCode = r.address?.country_code?.toUpperCase() || '';
                    const cityName = r.display_name?.split(',')[0] || r.name || '';
                    const region = r.display_name?.split(',').slice(1, 3).join(',') || '';
                    
                    return `
                    <div class="city-result-item" 
                         data-lat="${r.lat}" 
                         data-lon="${r.lon}" 
                         data-name="${cityName}"
                         data-country="${countryCode}"
                         data-target="${target}">
                        <div class="city-name">${cityName}</div>
                        <div class="city-country">${region}</div>
                    </div>
                `}).join('');
            }
            container.classList.add('show');
        } catch (error) {
            console.error('Error buscando ciudades:', error);
            container.innerHTML = '<div class="city-result-item">Error al buscar. Intenta de nuevo.</div>';
            container.classList.add('show');
        }
    }
    
    // Calcular ASC y MC
    // =====================================================
    // C√ÅLCULO CORRECTO DE ASC Y MC (Meeus)
    // =====================================================
    
    function calcularGST(jd) {
        // Greenwich Sidereal Time en grados
        const T = (jd - 2451545.0) / 36525;
        let theta0 = 280.46061837 
                   + 360.98564736629 * (jd - 2451545.0) 
                   + 0.000387933 * T * T 
                   - T * T * T / 38710000;
        return norm360(theta0);
    }
    
    function calcularLST(jd, lon) {
        // Local Sidereal Time en grados
        return norm360(calcularGST(jd) + lon);
    }
    
    function calcularMC(jd, lon) {
        // El MC es el punto donde el meridiano local corta la ecl√≠ptica
        // MC = atan(tan(LST) / cos(Œµ))
        const LST = calcularLST(jd, lon);
        const obliquity = 23.4393; // Oblicuidad media en grados
        const LSTr = LST * DEG;
        const eps = obliquity * DEG;
        
        let MC = Math.atan2(Math.sin(LSTr), Math.cos(LSTr) * Math.cos(eps)) / DEG;
        MC = norm360(MC);
        
        // Ajuste de cuadrante: MC debe estar en el hemisferio superior
        // Si LST est√° entre 0-180¬∞, MC debe estar entre 0-180¬∞
        // Si LST est√° entre 180-360¬∞, MC debe estar entre 180-360¬∞
        if (LST >= 0 && LST < 180) {
            if (MC >= 180) MC = MC - 180;
        } else {
            if (MC < 180) MC = MC + 180;
        }
        
        return norm360(MC);
    }
    
    function calcularASC(jd, lat, lon) {
        // F√≥rmula del Ascendente (Meeus, cap. 13)
        // ASC = atan2(-cos(LST), sin(LST)*cos(Œµ) + tan(œÜ)*sin(Œµ))
        const LST = calcularLST(jd, lon);
        const obliquity = 23.4393;
        const LSTr = LST * DEG;
        const eps = obliquity * DEG;
        const phi = lat * DEG;
        
        const y = -Math.cos(LSTr);
        const x = Math.sin(LSTr) * Math.cos(eps) + Math.tan(phi) * Math.sin(eps);
        let ASC = Math.atan2(y, x) / DEG;
        ASC = norm360(ASC);
        
        // El ASC siempre debe estar en el cuadrante correcto
        // basado en el LST (debe subir por el horizonte este)
        return ASC;
    }
    
    // Versi√≥n corregida con f√≥rmulas de Meeus
    function calcularASCMC(fecha, lat, lon, tzOffset) {
        // F√≥rmula exacta de server.py (calculate_asc_mc_skyfield)
        const jd = fechaAJuliano(fecha, tzOffset);
        
        // GST en horas
        const T = (jd - 2451545.0) / 36525;
        let theta0 = 280.46061837 + 360.98564736629 * (jd - 2451545.0) 
                   + 0.000387933 * T * T - T * T * T / 38710000;
        const gst = norm360(theta0) / 15; // en horas
        
        // LST en grados
        const lst = norm360(gst * 15 + lon);
        
        // MC = LST convertido a longitud ecl√≠ptica
        const obliquity = 23.4367;
        const eps = obliquity * DEG;
        let MC = Math.atan(Math.tan(lst * DEG) / Math.cos(eps)) / DEG;
        if (lst > 90 && lst <= 270) MC += 180;
        else if (lst > 270) MC += 360;
        MC = norm360(MC);
        
        // ASC - F√≥rmula exacta del server.py
        const lat_rad = lat * DEG;
        const ra_rad = lst * DEG;
        const eps_rad = obliquity * DEG;
        
        const tan_asc = Math.cos(ra_rad) / (Math.sin(ra_rad) * Math.cos(eps_rad) + Math.tan(lat_rad) * Math.sin(eps_rad));
        let ASC = Math.atan(-tan_asc) / DEG;
        
        // Ajuste de cuadrante (exacto del server.py)
        if (lst >= 0 && lst <= 180) {
            if (Math.cos(ra_rad) > 0) {
                ASC = norm360(ASC + 180);
            }
        } else {
            if (Math.cos(ra_rad) < 0) {
                ASC = norm360(ASC + 180);
            }
        }
        ASC = norm360(ASC);
        
        return { asc: ASC, mc: MC };
    }
    
    // Calcular carta natal completa
    function calcularCartaNatal(fecha, lat, lon, tzOffset) {
        // Posiciones planetarias de efem√©rides Swiss Ephemeris
        const posiciones = getPosicionesPlanetarias(fecha, tzOffset);
        
        // ASC y MC con f√≥rmula del server.py
        const ascmc = calcularASCMC(fecha, lat, lon, tzOffset);
        const ascLon = ascmc.asc;
        const mcLon = ascmc.mc;
        
        posiciones['ASC'] = { lon: ascLon, signo: getSignoDesdeLongitud(ascLon) };
        posiciones['MC'] = { lon: mcLon, signo: getSignoDesdeLongitud(mcLon) };
        
        // Casas (sistema de casas iguales 30¬∞ desde ASC)
        const casas = [];
        for (let i = 0; i < 12; i++) {
            const cuspide = norm360(ascLon + i * 30);
            casas.push({
                numero: i + 1,
                cuspide: cuspide,
                signo: getSignoDesdeLongitud(cuspide)
            });
        }
        
        // Asignar planetas a casas
        for (const [planeta, data] of Object.entries(posiciones)) {
            if (planeta === 'ASC' || planeta === 'MC') continue;
            for (let i = 0; i < 12; i++) {
                const inicio = casas[i].cuspide;
                const fin = casas[(i + 1) % 12].cuspide;
                let enCasa = fin > inicio ? 
                    (data.lon >= inicio && data.lon < fin) : 
                    (data.lon >= inicio || data.lon < fin);
                if (enCasa) {
                    data.casa = i + 1;
                    break;
                }
            }
        }
        
        // Determinar si es nacimiento diurno (seco) o nocturno (h√∫medo)
        // Es DIURNO si el Sol est√° en casas 7-12 (sobre el horizonte)
        const solLon = posiciones['Sol'].lon;
        const lunaLon = posiciones['Luna'].lon;
        const diffSolAsc = ((solLon - ascLon) % 360 + 360) % 360;
        const casaSol = 1 + Math.floor(diffSolAsc / 30);
        const isDiurno = casaSol >= 7 && casaSol <= 12;
        
        // Calcular Parte de Fortuna
        // Diurno: ASC + Luna - Sol
        // Nocturno: ASC + Sol - Luna
        let parteFortunaLon;
        if (isDiurno) {
            parteFortunaLon = ((ascLon + lunaLon - solLon) % 360 + 360) % 360;
        } else {
            parteFortunaLon = ((ascLon + solLon - lunaLon) % 360 + 360) % 360;
        }
        const parteFortunaSigno = getSignoDesdeLongitud(parteFortunaLon);
        
        // Determinar casa de Parte de Fortuna
        let parteFortuaCasa = 1;
        for (let i = 0; i < 12; i++) {
            const inicio = casas[i].cuspide;
            const fin = casas[(i + 1) % 12].cuspide;
            let enCasa = fin > inicio ? 
                (parteFortunaLon >= inicio && parteFortunaLon < fin) : 
                (parteFortunaLon >= inicio || parteFortunaLon < fin);
            if (enCasa) {
                parteFortuaCasa = i + 1;
                break;
            }
        }
        
        const parteFortuna = {
            lon: parteFortunaLon,
            signo: parteFortunaSigno,
            casa: parteFortuaCasa
        };
        
        // A√±adir Parte de Fortuna a posiciones para que aparezca en el an√°lisis
        posiciones['Parte de Fortuna'] = {
            lon: parteFortunaLon,
            signo: parteFortunaSigno,
            casa: parteFortuaCasa,
            simbolo: '‚äï',
            signoSimbolo: SIGN_SYMBOLS[parteFortunaSigno]
        };
        
        return { posiciones, casas, ascLon, mcLon, isDiurno, parteFortuna };
    }
    
    // Elementos y Regentes (usados en vocaci√≥n y finanzas)
    const ELEMENTOS = {
        'Aries': 'Fuego', 'Tauro': 'Tierra', 'G√©minis': 'Aire', 'C√°ncer': 'Agua',
        'Leo': 'Fuego', 'Virgo': 'Tierra', 'Libra': 'Aire', 'Escorpio': 'Agua',
        'Ofiuco': 'Aire', 'Sagitario': 'Fuego', 'Capricornio': 'Tierra',
        'Acuario': 'Aire', 'Pegaso': 'Agua', 'Piscis': 'Agua'
    };
    
    const REGENTES = {
        'Aries': 'Marte', 'Tauro': 'Venus', 'G√©minis': 'Mercurio', 'C√°ncer': 'Luna',
        'Leo': 'Sol', 'Virgo': 'Mercurio', 'Libra': 'Venus', 'Escorpio': 'Marte',
        'Ofiuco': 'Saturno', 'Sagitario': 'J√∫piter', 'Capricornio': 'Sol',
        'Acuario': 'Luna', 'Pegaso': 'J√∫piter', 'Piscis': 'J√∫piter'
    };
    
    function calcularEdad(fechaNac) {
        const hoy = new Date();
        let edad = hoy.getFullYear() - fechaNac.getFullYear();
        const m = hoy.getMonth() - fechaNac.getMonth();
        if (m < 0 || (m === 0 && hoy.getDate() < fechaNac.getDate())) edad--;
        return edad;
    }
    
    // Interpretaciones por √°rea
    const MC_VOCACION = {
        'Aries': { areas: ['Emprendimiento', 'Deportes', 'Liderazgo', 'Militar'], cualidades: ['Iniciativa', 'Valent√≠a', 'Competitividad'] },
        'Tauro': { areas: ['Finanzas', 'Arte', 'Gastronom√≠a', 'Agricultura'], cualidades: ['Estabilidad', 'Persistencia', 'Sensorialidad'] },
        'G√©minis': { areas: ['Comunicaci√≥n', 'Comercio', 'Ense√±anza', 'Escritura'], cualidades: ['Versatilidad', 'Ingenio', 'Adaptabilidad'] },
        'C√°ncer': { areas: ['Hogar', 'Nutrici√≥n', 'Cuidados', 'Historia'], cualidades: ['Protecci√≥n', 'Empat√≠a', 'Intuici√≥n'] },
        'Leo': { areas: ['Entretenimiento', 'Direcci√≥n', 'Creatividad', 'Pol√≠tica'], cualidades: ['Carisma', 'Generosidad', 'Autoridad'] },
        'Virgo': { areas: ['Salud', 'An√°lisis', 'Servicio', 'Artesan√≠a'], cualidades: ['Precisi√≥n', 'Dedicaci√≥n', 'Eficiencia'] },
        'Libra': { areas: ['Derecho', 'Diplomacia', 'Dise√±o', 'Relaciones'], cualidades: ['Equilibrio', 'Est√©tica', 'Justicia'] },
        'Escorpio': { areas: ['Investigaci√≥n', 'Psicolog√≠a', 'Finanzas ocultas', 'Transformaci√≥n'], cualidades: ['Profundidad', 'Intensidad', 'Poder'] },
        'Ofiuco': { areas: ['Medicina', 'Sanaci√≥n', 'Conocimiento oculto', 'Alquimia'], cualidades: ['Sabidur√≠a', 'Regeneraci√≥n', 'Misterio'] },
        'Sagitario': { areas: ['Educaci√≥n superior', 'Viajes', 'Filosof√≠a', 'Derecho'], cualidades: ['Expansi√≥n', 'Optimismo', 'Visi√≥n'] },
        'Capricornio': { areas: ['Administraci√≥n', 'Pol√≠tica', 'Estructuras', 'Tradici√≥n'], cualidades: ['Ambici√≥n', 'Disciplina', 'Autoridad'] },
        'Acuario': { areas: ['Tecnolog√≠a', 'Ciencia', 'Humanitarismo', 'Innovaci√≥n'], cualidades: ['Originalidad', 'Independencia', 'Visi√≥n'] },
        'Pegaso': { areas: ['Arte visionario', 'M√∫sica', 'Poes√≠a', 'Inspiraci√≥n'], cualidades: ['Imaginaci√≥n', 'Trascendencia', 'Libertad'] },
        'Piscis': { areas: ['Artes', 'Espiritualidad', 'Sanaci√≥n', 'Servicio'], cualidades: ['Compasi√≥n', 'Intuici√≥n', 'Creatividad'] }
    };
    
    const CASA2_FINANZAS = {
        'Aries': 'Dinero por iniciativa propia. Gastos impulsivos. Capacidad de generar recursos r√°pidamente.',
        'Tauro': 'Excelente posici√≥n. Talento natural para atraer y mantener riqueza. Valores materiales s√≥lidos.',
        'G√©minis': 'M√∫ltiples fuentes de ingreso. Dinero por comunicaci√≥n, comercio o intermediaci√≥n.',
        'C√°ncer': 'Dinero ligado a la familia y el hogar. Tendencia al ahorro y la seguridad financiera.',
        'Leo': 'Necesitas brillar para ganar bien. Dinero por creatividad, liderazgo o espect√°culo.',
        'Virgo': 'Dinero por trabajo detallado y servicio. Administraci√≥n cuidadosa de recursos.',
        'Libra': 'Dinero por asociaciones, arte o diplomacia. B√∫squeda de equilibrio financiero.',
        'Escorpio': 'Potencial para grandes ganancias o p√©rdidas. Recursos compartidos, herencias.',
        'Ofiuco': 'Ganancias por sanaci√≥n, conocimiento oculto o transformaci√≥n de otros.',
        'Sagitario': 'Optimismo financiero. Dinero del extranjero, educaci√≥n o publicaciones.',
        'Capricornio': 'Construcci√≥n lenta pero muy s√≥lida de recursos. √âxito financiero a largo plazo.',
        'Acuario': 'Ingresos por tecnolog√≠a, innovaci√≥n o trabajo con grupos. Finanzas no convencionales.',
        'Pegaso': 'Ganancias por inspiraci√≥n art√≠stica o espiritual. Relaci√≥n et√©rea con el dinero.',
        'Piscis': 'Relaci√≥n difusa con el dinero. Ganancias por arte, espiritualidad o servicio compasivo.'
    };
    
    const CASA9_ESPIRITUAL = {
        'Aries': 'B√∫squeda espiritual activa y pionera. Filosof√≠a de acci√≥n y valent√≠a.',
        'Tauro': 'Espiritualidad sensorial y conectada con la naturaleza. Fe pr√°ctica.',
        'G√©minis': 'Mente curiosa en asuntos filos√≥ficos. M√∫ltiples caminos espirituales.',
        'C√°ncer': 'Fe emocional y protectora. Espiritualidad ligada a las ra√≠ces familiares.',
        'Leo': 'Expresi√≥n radiante de la fe. Espiritualidad creativa y generosa.',
        'Virgo': 'Espiritualidad de servicio y purificaci√≥n. Camino del trabajo consciente.',
        'Libra': 'B√∫squeda de equilibrio espiritual. Fe en la justicia y la armon√≠a.',
        'Escorpio': 'Transformaci√≥n espiritual profunda. Conexi√≥n con los misterios de la muerte y renacimiento.',
        'Ofiuco': 'Camino del sanador y conocedor de secretos. Sabidur√≠a oculta y regeneraci√≥n.',
        'Sagitario': 'Posici√≥n ideal. Expansi√≥n espiritual, viajes del alma, maestros significativos.',
        'Capricornio': 'Fe estructurada y tradicional. Disciplina espiritual que da frutos con el tiempo.',
        'Acuario': 'Espiritualidad humanitaria e innovadora. Conexi√≥n con la conciencia colectiva.',
        'Pegaso': 'Inspiraci√≥n divina y vuelo del esp√≠ritu. Conexi√≥n con reinos superiores.',
        'Piscis': 'Misticismo natural. Disoluci√≥n del ego y uni√≥n con el todo. Compasi√≥n universal.'
    };
    
    // Render secci√≥n Personal
    function renderPersonal() {
        if (cargarPerfil() && perfilState.perfil && perfilState.cartaNatal) {
            document.getElementById('personal-setup').style.display = 'none';
            document.getElementById('personal-content').style.display = 'block';
            renderPerfilResumen();
            renderVocacion();
        } else {
            document.getElementById('personal-setup').style.display = 'block';
            document.getElementById('personal-content').style.display = 'none';
        }
    }
    
    function renderPerfilResumen() {
        const p = perfilState.perfil;
        const c = perfilState.cartaNatal;
        const fecha = new Date(p.birthDate + 'T' + p.birthTime);
        const edad = calcularEdad(fecha);
        
        // Info del TZ
        let tzInfo = `UTC${p.tz >= 0 ? '+' : ''}${p.tz}`;
        if (p.countryCode) {
            const tzIANA = getTimezoneFromCountry(p.countryCode);
            const [year, month] = p.birthDate.split('-').map(Number);
            const tzInvierno = getTimezoneOffset(tzIANA, year, 1, 15);
            const esVerano = p.tz > tzInvierno;
            tzInfo = `${esVerano ? '‚òÄÔ∏è' : '‚ùÑÔ∏è'} UTC${p.tz >= 0 ? '+' : ''}${p.tz}`;
        }
        
        document.getElementById('perfil-resumen').innerHTML = `
            <div class="perfil-nombre">${p.name}</div>
            <div class="perfil-fecha">${fecha.toLocaleDateString('es-ES', {day:'numeric',month:'long',year:'numeric'})} ‚Ä¢ ${p.birthTime} <span style="font-size:0.8rem;color:var(--text-dim);">(${tzInfo})</span></div>
            <div class="perfil-ciudad">üìç ${p.city}</div>
            <div class="perfil-edad" style="color:var(--gold-light);margin-top:5px;">${edad} a√±os</div>
            <div class="perfil-signos">
                <div class="perfil-signo">
                    <span class="perfil-signo-symbol">${SIGN_SYMBOLS[c.posiciones['Sol'].signo]}</span>
                    <span class="perfil-signo-label">Sol</span>
                </div>
                <div class="perfil-signo">
                    <span class="perfil-signo-symbol">${SIGN_SYMBOLS[c.posiciones['Luna'].signo]}</span>
                    <span class="perfil-signo-label">Luna</span>
                </div>
                <div class="perfil-signo">
                    <span class="perfil-signo-symbol">${SIGN_SYMBOLS[c.posiciones['ASC'].signo]}</span>
                    <span class="perfil-signo-label">ASC</span>
                </div>
                <div class="perfil-signo">
                    <span class="perfil-signo-symbol">${SIGN_SYMBOLS[c.posiciones['MC'].signo]}</span>
                    <span class="perfil-signo-label">MC</span>
                </div>
            </div>
        `;
    }
    
    
    function renderVocacion() {
        try {
        const c = perfilState.cartaNatal;
        const signoMC = c.posiciones['MC'].signo;
        const signoCasa6 = c.casas[5].signo;
        const signoCasa2 = c.casas[1].signo;
        const info = MC_VOCACION[signoMC] || MC_VOCACION['Aries'];
        const regenteMC = REGENTES[signoMC];
        const posRegente = c.posiciones[regenteMC];
        const dignidadRegente = posRegente ? calcularDignidad(regenteMC, posRegente.signo) : null;
        
        // Debug
        console.log('üéØ Vocaci√≥n Debug:', { signoMC, regenteMC, posRegente, signoCasa6 });
        console.log('üéØ S√≠mbolos:', { 
            mcSymbol: SIGN_SYMBOLS[signoMC], 
            regenteSymbol: PLANET_SYMBOLS[regenteMC],
            casa6Symbol: SIGN_SYMBOLS[signoCasa6]
        });
        
        // Buscar planetas en Casa 10 y Casa 6
        const excluir = ['ASC', 'MC', 'Parte de Fortuna'];
        const planetasEnCasa10 = Object.entries(c.posiciones)
            .filter(([nombre, data]) => data.casa === 10 && !excluir.includes(nombre));
        const planetasEnCasa6 = Object.entries(c.posiciones)
            .filter(([nombre, data]) => data.casa === 6 && !excluir.includes(nombre));
        
        // Elemento del MC
        const ELEMENTOS_MC = {
            'Aries': 'Fuego', 'Leo': 'Fuego', 'Sagitario': 'Fuego',
            'Tauro': 'Tierra', 'Virgo': 'Tierra', 'Capricornio': 'Tierra',
            'G√©minis': 'Aire', 'Libra': 'Aire', 'Acuario': 'Aire', 'Pegaso': 'Aire',
            'C√°ncer': 'Agua', 'Escorpio': 'Agua', 'Piscis': 'Agua', 'Ofiuco': 'Agua'
        };
        const elementoMC = ELEMENTOS_MC[signoMC] || 'Fuego';
        
        const ELEMENTOS_VOCACION = {
            'Fuego': { descripcion: 'Busca posibilidades futuras, se aburre con la seguridad', fortalezas: ['Visi√≥n de futuro', 'Entusiasmo', 'Liderazgo', 'Iniciativa'], debilidades: ['Impaciencia', 'Riesgo excesivo'], ambiente: 'Necesita cambio, alicientes, espect√°culo' },
            'Tierra': { descripcion: 'Busca seguridad, estabilidad y resultados tangibles', fortalezas: ['Realismo', 'Constancia', 'Fiabilidad', 'M√©todo'], debilidades: ['Rigidez', 'Lentitud'], ambiente: 'Necesita estabilidad, rutinas claras, resultados medibles' },
            'Aire': { descripcion: 'Mental, l√≥gico, comunicativo, orientado a informaci√≥n', fortalezas: ['Intelecto', 'Comunicaci√≥n', 'Versatilidad', 'An√°lisis'], debilidades: ['Ansiedad', 'Demasiado mental'], ambiente: 'Necesita datos, informaci√≥n, conexiones sociales' },
            'Agua': { descripcion: 'Empatiza, conecta emocionalmente, intuitivo', fortalezas: ['Intuici√≥n', 'Empat√≠a', 'Profundidad', 'Conexi√≥n emocional'], debilidades: ['Escapismo', 'Absorbe emociones ajenas'], ambiente: 'Necesita conexi√≥n emocional, ambiente arm√≥nico' }
        };
        const infoElemento = ELEMENTOS_VOCACION[elementoMC];
        
        // Calcular indicador vocacional
        let puntuacion = 0;
        const factores = [];
        
        const sol = c.posiciones['Sol'];
        if (sol?.casa === 10) { factores.push({ texto: 'Sol en Casa 10', puntos: 5, tipo: 'positivo' }); puntuacion += 5; }
        if (sol?.casa === 1) { factores.push({ texto: 'Sol en Casa 1', puntos: 3, tipo: 'positivo' }); puntuacion += 3; }
        
        const jupiter = c.posiciones['J√∫piter'];
        if (jupiter?.casa === 10) { factores.push({ texto: 'J√∫piter en Casa 10', puntos: 5, tipo: 'positivo' }); puntuacion += 5; }
        if (jupiter?.casa === 1) { factores.push({ texto: 'J√∫piter en Casa 1', puntos: 3, tipo: 'positivo' }); puntuacion += 3; }
        
        const saturno = c.posiciones['Saturno'];
        if (saturno?.casa === 10) { factores.push({ texto: 'Saturno en Casa 10', puntos: 4, tipo: 'positivo' }); puntuacion += 4; }
        
        const marte = c.posiciones['Marte'];
        if (marte?.casa === 10) { factores.push({ texto: 'Marte en Casa 10', puntos: 3, tipo: 'positivo' }); puntuacion += 3; }
        
        const venus = c.posiciones['Venus'];
        if (venus?.casa === 10) { factores.push({ texto: 'Venus en Casa 10', puntos: 3, tipo: 'positivo' }); puntuacion += 3; }
        
        if (['Leo', 'Capricornio', 'Aries'].includes(signoMC)) { 
            factores.push({ texto: `MC en ${signoMC}`, puntos: 2, tipo: 'positivo' }); 
            puntuacion += 2; 
        }
        
        if (dignidadRegente === 'exaltaci√≥n' || dignidadRegente === 'domicilio') {
            factores.push({ texto: `Regente MC en ${dignidadRegente}`, puntos: 3, tipo: 'positivo' }); 
            puntuacion += 3;
        } else if (dignidadRegente === 'exilio' || dignidadRegente === 'ca√≠da') {
            factores.push({ texto: `Regente MC en ${dignidadRegente}`, puntos: -2, tipo: 'negativo' }); 
            puntuacion -= 2;
        }
        
        const nivel = puntuacion >= 12 ? 'Muy Elevado' : puntuacion >= 8 ? 'Elevado' : puntuacion >= 4 ? 'Favorable' : puntuacion >= 0 ? 'Moderado' : 'Desafiante';
        const nivelColor = puntuacion >= 12 ? '#e74c3c' : puntuacion >= 8 ? '#e67e22' : puntuacion >= 4 ? '#f1c40f' : puntuacion >= 0 ? '#3498db' : '#7f8c8d';
        
        // Descripciones largas del MC por signo
        const MC_DESCRIPCION = {
            'Aries': 'Tu vocaci√≥n te llama a ser pionero, a abrir caminos donde otros no se atreven. Necesitas autonom√≠a, acci√≥n directa y la libertad de hacer las cosas a tu manera. El reconocimiento viene cuando lideras con valent√≠a. Carreras que permitan iniciativa y competencia.',
            'Tauro': 'Tu vocaci√≥n est√° en construir valor tangible y duradero. Eres llamado a crear cosas bellas, estables y √∫tiles. El √©xito viene lentamente pero permanece. Necesitas seguridad para brillar. Trabajo con recursos, dinero, belleza o naturaleza.',
            'G√©minis': 'Tu vocaci√≥n involucra el intercambio de ideas, la comunicaci√≥n y la conexi√≥n. Puedes tener m√∫ltiples carreras o roles que se complementan. Tu mente vers√°til es tu mayor activo profesional. Necesitas variedad y estimulaci√≥n mental constante.',
            'C√°ncer': 'Tu vocaci√≥n est√° en nutrir, proteger y crear espacios de pertenencia. Puedes destacar en campos relacionados con el hogar, la alimentaci√≥n, el cuidado o la historia. El trabajo debe sentirse como familia. Intuici√≥n como gu√≠a profesional.',
            'Leo': 'Tu vocaci√≥n te llama a brillar, crear y liderar desde el coraz√≥n. Necesitas reconocimiento y un escenario donde mostrar tus talentos. El √©xito viene cuando te permites ser visible y generoso. Carreras donde puedas expresar tu creatividad y liderazgo.',
            'Virgo': 'Tu vocaci√≥n est√° en perfeccionar, analizar y servir con excelencia. Eres llamado a mejorar sistemas, ayudar a otros y prestar atenci√≥n a los detalles que otros ignoran. La humildad es tu fortaleza. Trabajo que requiera precisi√≥n y servicio.',
            'Libra': 'Tu vocaci√≥n involucra crear equilibrio, belleza y justicia. Puedes destacar en campos diplom√°ticos, art√≠sticos o legales. Las asociaciones son clave para tu √©xito profesional. Necesitas armon√≠a en el ambiente de trabajo.',
            'Escorpio': 'Tu vocaci√≥n te llama a las profundidades: investigar, transformar, manejar crisis y recursos. No temes lo que otros evitan. El poder viene de tu capacidad de regenerar situaciones. Trabajo con misterios, finanzas o psicolog√≠a.',
            'Ofiuco': 'Tu vocaci√≥n est√° en la sanaci√≥n profunda y el conocimiento oculto. Eres un puente entre lo visible y lo invisible. Campos de medicina, psicolog√≠a profunda, terapias alternativas o trabajo transformacional te llaman.',
            'Sagitario': 'Tu vocaci√≥n es expandir horizontes, ense√±ar y buscar verdades superiores. Viajes, educaci√≥n, filosof√≠a o leyes internacionales pueden ser tu campo. Necesitas libertad y significado en lo que haces.',
            'Capricornio': 'Tu vocaci√≥n es construir estructuras que perduren y alcanzar posiciones de autoridad. El tiempo es tu aliado; tu carrera mejora con los a√±os. La paciencia estrat√©gica te lleva a la cima. Disciplina como clave del √©xito.',
            'Acuario': 'Tu vocaci√≥n es innovar, revolucionar y servir a la humanidad. No encajas en moldes tradicionales y eso es tu fuerza. Tecnolog√≠a, ciencia o causas humanitarias pueden ser tu campo. Independencia profesional.',
            'Pegaso': 'Tu vocaci√≥n est√° en canalizar visiones e inspiraci√≥n elevada. El arte visionario, la m√∫sica o campos que conecten lo terrenal con lo celestial son tu territorio natural. Romper barreras y explorar nuevos territorios.',
            'Piscis': 'Tu vocaci√≥n te llama a servir, sanar y conectar con lo trascendente. Arte, espiritualidad, trabajo hospitalario o cualquier campo donde puedas ayudar con compasi√≥n es tu camino. Intuici√≥n como gu√≠a.'
        };
        
        // Interpretaciones del regente del MC por casa
        const REGENTE_MC_CASAS = {
            1: 'Ganas reconocimiento por ti mismo, tu personalidad e imagen. Eres autosuficiente profesionalmente. Tu presencia f√≠sica y carisma impulsan tu carrera. La iniciativa personal es clave.',
            2: 'Tu carrera est√° ligada a generar recursos y desarrollar talentos. El dinero y los valores personales gu√≠an tus decisiones profesionales. √âxito a trav√©s de lo que produces.',
            3: 'Tu carrera involucra comunicaci√≥n, escritura, comercio o ense√±anza. Hermanos pueden influir en tu profesi√≥n. Viajes cortos y networking son importantes.',
            4: 'Tu carrera est√° basada en el hogar, familia o bienes ra√≠ces. Negocios familiares favorecidos. Puedes trabajar desde casa. Las ra√≠ces sustentan tu √©xito.',
            5: 'Tu carrera involucra creatividad, entretenimiento o trabajo con ni√±os. El placer y la expresi√≥n personal impulsan tu profesi√≥n. Riesgo creativo puede dar frutos.',
            6: 'Tu carrera se construye a trav√©s del trabajo diario y el servicio constante. La salud y rutinas son importantes. Empleados o subordinados influyen en tu √©xito.',
            7: 'Tu carrera depende de socios, pareja o clientes. Las asociaciones son clave. El matrimonio afecta tu profesi√≥n. Negociaciones y contratos importantes.',
            8: 'Tu carrera involucra recursos de otros, transformaciones o crisis. Herencias, inversiones o pr√©stamos pueden impulsar tu profesi√≥n. Poder compartido.',
            9: 'Tu carrera se expande a trav√©s de educaci√≥n superior, viajes o el extranjero. Ense√±anza y filosof√≠a como camino. Publicaciones favorecidas. Visi√≥n amplia.',
            10: '¬°Posici√≥n muy poderosa! Tu carrera tiene fuerza propia. El regente en su propia casa amplifica el √©xito. Autoridad y reconocimiento naturales.',
            11: 'Tu carrera prospera a trav√©s de amigos, grupos y redes. Contactos que benefician. Metas colectivas impulsan tu profesi√≥n. Tecnolog√≠a y comunidad.',
            12: 'Tu carrera opera tras bambalinas o en instituciones. Trabajo espiritual o de sacrificio. Posibles obst√°culos ocultos. Karma profesional que trabajar.'
        };
        
        // Interpretaciones planetas en Casa 10
        const PLANETAS_CASA10 = {
            'Sol': 'Tu identidad brilla en la esfera p√∫blica. Est√°s destinado a ser reconocido y liderar. Naci√≥ para ser figura p√∫blica. La carrera es absolutamente central en la vida. Fama y prestigio alcanzables.',
            'Luna': 'Tu carrera conecta emocionalmente con el p√∫blico. Popularidad y trabajo con necesidades b√°sicas o mujeres. Altibajos seg√∫n ciclos. Intuici√≥n profesional desarrollada.',
            'Mercurio': 'Tu carrera involucra comunicaci√≥n, escritura, comercio o ense√±anza. Versatilidad profesional notable. Habilidad para negociar y adaptar. Mente orientada al √©xito.',
            'Venus': 'Atracci√≥n hacia carreras art√≠sticas, de belleza o diplomacia. Eres agradable en tu rol p√∫blico. El encanto personal abre puertas. √âxito a trav√©s de relaciones.',
            'Marte': 'Ambici√≥n fuerte y competitividad. Carreras que requieren acci√≥n, valent√≠a o liderazgo activo. Energ√≠a para conquistar metas. Posibles conflictos profesionales.',
            'J√∫piter': '¬°Excelente! Expansi√≥n profesional, suerte en la carrera, reconocimiento. Posiciones de ense√±anza o gu√≠a favorecidas. Optimismo que atrae oportunidades.',
            'Saturno': '√âxito que llega con tiempo y esfuerzo. Posiciones de autoridad ganadas con disciplina. La carrera es estructura de vida. Reconocimiento tard√≠o pero duradero.',
            'Urano': 'Carrera innovadora, tecnol√≥gica o poco convencional. Cambios profesionales s√∫bitos. Independencia como requisito. Genialidad que destaca.',
            'Neptuno': 'Carrera art√≠stica, espiritual o de sanaci√≥n. Vocaci√≥n de servicio compasivo. Imagen p√∫blica idealizada. Confusi√≥n vocacional posible pero inspiraci√≥n tambi√©n.',
            'Plut√≥n': 'Poder en la carrera. Transformaci√≥n profesional profunda. Liderazgo regenerador. Capacidad de resurgir de crisis laborales. Influencia magn√©tica.'
        };
        
        // Interpretaciones de signos en Casa 6
        const SIGNOS_CASA6 = {
            'Aries': 'Trabajo con energ√≠a, iniciativa y acci√≥n directa. Necesitas autonom√≠a en tu rutina. Posibles conflictos con compa√±eros pero tambi√©n liderazgo.',
            'Tauro': 'Trabajo constante, paciente y productivo. Rutinas estables que dan resultados. Buen ambiente laboral importante. Lentitud pero solidez.',
            'G√©minis': 'Trabajo variado, comunicativo y mental. Necesitas estimulaci√≥n y cambio. M√∫ltiples tareas simult√°neas. Networking laboral.',
            'C√°ncer': 'Trabajo conectado emocionalmente. Ambiente laboral como segunda familia. Cuidado de otros. Intuici√≥n en el trabajo diario.',
            'Leo': 'Trabajo donde puedas brillar y liderar. Necesitas reconocimiento diario. Creatividad en las rutinas. Generosidad con compa√±eros.',
            'Virgo': '¬°Posici√≥n ideal! Trabajo meticuloso, anal√≠tico y de servicio. Rutinas ordenadas y eficientes. Atenci√≥n al detalle. Perfeccionismo √∫til.',
            'Libra': 'Trabajo en equipo y con colaboraciones. Ambiente arm√≥nico necesario. Diplomacia laboral. Est√©tica en el lugar de trabajo.',
            'Escorpio': 'Trabajo intenso y transformador. Investigaci√≥n y profundidad. Posibles luchas de poder. Capacidad de regenerar situaciones laborales.',
            'Ofiuco': 'Trabajo de sanaci√≥n, investigaci√≥n o transformaci√≥n. Conocimiento oculto aplicado. Rutinas de regeneraci√≥n personal.',
            'Sagitario': 'Trabajo expansivo y con significado. Necesitas libertad en tu rutina. Viajes laborales. Optimismo en el d√≠a a d√≠a.',
            'Capricornio': 'Trabajo disciplinado, estructurado y responsable. Rutinas que construyen a largo plazo. Autoridad en el ambiente laboral.',
            'Acuario': 'Trabajo innovador y poco convencional. M√©todos originales. Tecnolog√≠a en las rutinas. Independencia laboral.',
            'Pegaso': 'Trabajo inspirado y visionario. Rutinas que elevan. Creatividad en el servicio. Conexi√≥n con lo trascendente.',
            'Piscis': 'Trabajo compasivo y de servicio. Intuici√≥n laboral. Ambiente sensible. Posible confusi√≥n pero tambi√©n inspiraci√≥n.'
        };
        
        document.getElementById('tab-vocacion').innerHTML = `
            <!-- Indicador Vocacional -->
            <div class="analysis-card" style="background:linear-gradient(135deg, rgba(230,126,34,0.15), rgba(241,196,15,0.1));">
                <div class="analysis-title">‚≠ê Indicador Vocacional</div>
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:12px;">
                    <div>
                        <div style="font-size:2.5rem;font-weight:700;color:${nivelColor};">${puntuacion >= 0 ? '+' : ''}${puntuacion}</div>
                        <div style="display:inline-block;padding:4px 12px;border-radius:20px;background:${nivelColor};color:white;font-size:0.8rem;font-weight:600;">${nivel}</div>
                    </div>
                    <div style="flex:1;min-width:200px;">
                        <div style="display:flex;flex-wrap:wrap;gap:6px;">
                            ${factores.map(f => `
                                <span style="padding:3px 8px;border-radius:12px;font-size:0.75rem;
                                    background:${f.tipo === 'positivo' ? 'rgba(230,126,34,0.15)' : 'rgba(231,76,60,0.15)'};
                                    color:${f.tipo === 'positivo' ? '#e67e22' : '#e74c3c'};">
                                    ${f.tipo === 'positivo' ? '+' : ''}${f.puntos} ${f.texto}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Medio Cielo -->
            <div class="analysis-card" style="border-left:4px solid #e67e22;">
                <div class="analysis-title">üéØ Tu Medio Cielo: ${SIGN_SYMBOLS[signoMC]} ${signoMC}</div>
                <div class="analysis-content">
                    <div class="analysis-highlight">
                        <p style="margin:0;">${MC_DESCRIPCION[signoMC] || ''}</p>
                    </div>
                </div>
            </div>
            
            <!-- Elemento del MC -->
            <div class="analysis-card">
                <div class="analysis-title">üî• Elemento Vocacional: ${elementoMC}</div>
                <div style="background:var(--bg-elevated);padding:15px;border-radius:10px;">
                    <p style="margin:0 0 10px 0;font-style:italic;color:var(--gold-light);">"${infoElemento.descripcion}"</p>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                        <div>
                            <div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:4px;">‚úì Fortalezas</div>
                            <div style="font-size:0.85rem;">${infoElemento.fortalezas.join(', ')}</div>
                        </div>
                        <div>
                            <div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:4px;">‚ö† Debilidades</div>
                            <div style="font-size:0.85rem;">${infoElemento.debilidades.join(', ')}</div>
                        </div>
                    </div>
                    <div style="margin-top:10px;font-size:0.85rem;color:var(--text-dim);">
                        <strong>Ambiente ideal:</strong> ${infoElemento.ambiente}
                    </div>
                </div>
            </div>
            
            <!-- √Åreas Profesionales -->
            <div class="analysis-card">
                <div class="analysis-title">üíº √Åreas Profesionales Favorables</div>
                <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;">
                    ${info.areas.map(a => `<span style="background:var(--bg-elevated);padding:6px 12px;border-radius:15px;font-size:0.85rem;">${a}</span>`).join('')}
                </div>
                <p><strong>Cualidades a cultivar:</strong></p>
                <p style="color:var(--gold-light);">${info.cualidades.join(' ‚Ä¢ ')}</p>
            </div>
            
            <!-- Regente del MC -->
            <div class="analysis-card">
                <div class="analysis-title">üîë Regente de tu Carrera: ${PLANET_SYMBOLS[regenteMC]} ${regenteMC}</div>
                ${posRegente ? `
                    <div style="background:var(--bg-elevated);padding:15px;border-radius:10px;">
                        <p style="margin:0 0 8px 0;">
                            <strong>${PLANET_SYMBOLS[regenteMC]} ${regenteMC}</strong> est√° en 
                            <strong>Casa ${posRegente.casa}</strong> en 
                            <strong>${SIGN_SYMBOLS[posRegente.signo]} ${posRegente.signo}</strong>
                            ${dignidadRegente ? `<span class="dignidad-badge dignidad-${dignidadRegente}">${dignidadRegente}</span>` : ''}
                        </p>
                        <p style="margin:0;color:var(--text-dim);font-size:0.9rem;">
                            ${REGENTE_MC_CASAS[posRegente.casa] || ''}
                        </p>
                    </div>
                ` : ''}
            </div>
            
            ${planetasEnCasa10.length > 0 ? `
                <div class="analysis-card">
                    <div class="analysis-title">‚≠ê Planetas en tu Casa 10 (Carrera)</div>
                    ${planetasEnCasa10.map(([nombre, data]) => {
                        const dignidad = calcularDignidad(nombre, data.signo);
                        return `
                            <div style="background:var(--bg-elevated);padding:12px;border-radius:10px;margin-bottom:8px;">
                                <p style="margin:0 0 4px 0;">
                                    <strong>${PLANET_SYMBOLS[nombre]} ${nombre}</strong> en ${SIGN_SYMBOLS[data.signo]} ${data.signo}
                                    ${dignidad ? `<span class="dignidad-badge dignidad-${dignidad}">${dignidad}</span>` : ''}
                                </p>
                                <p style="margin:0;color:var(--text-dim);font-size:0.85rem;">${PLANETAS_CASA10[nombre] || ''}</p>
                            </div>
                        `;
                    }).join('')}
                </div>
            ` : ''}
            
            <!-- Casa 6: Trabajo Diario -->
            <div class="analysis-card">
                <div class="analysis-title">‚öôÔ∏è Casa 6: Tu Trabajo Diario - ${SIGN_SYMBOLS[signoCasa6]} ${signoCasa6}</div>
                <div style="background:var(--bg-elevated);padding:15px;border-radius:10px;">
                    <p style="margin:0;font-size:0.9rem;">${SIGNOS_CASA6[signoCasa6] || ''}</p>
                </div>
                ${planetasEnCasa6.length > 0 ? `
                    <div style="margin-top:10px;">
                        <div style="font-size:0.85rem;color:var(--text-dim);margin-bottom:6px;">Planetas en Casa 6:</div>
                        ${planetasEnCasa6.map(([nombre, data]) => `
                            <span style="display:inline-block;padding:4px 10px;background:var(--bg-card);border-radius:15px;margin:3px;font-size:0.85rem;">
                                ${PLANET_SYMBOLS[nombre]} ${nombre} en ${SIGN_SYMBOLS[data.signo]}
                            </span>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
            
            <!-- Fases Empresariales -->
            <div class="analysis-card">
                <div class="analysis-title">üöÄ Fases de un Proyecto/Empresa</div>
                <p style="color:var(--text-dim);font-size:0.85rem;margin-bottom:12px;">
                    Todo proyecto pasa por tres fases planetarias:
                </p>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
                    <div style="background:rgba(231,76,60,0.1);padding:12px;border-radius:10px;text-align:center;border:1px solid rgba(231,76,60,0.3);">
                        <div style="font-size:1.8rem;">‚ôÇ</div>
                        <div style="font-weight:600;color:#e74c3c;">Marte</div>
                        <div style="font-size:0.85rem;">0-3 a√±os</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:4px;">
                            <strong>INICIO</strong><br>
                            Acci√≥n, energ√≠a, competir
                        </div>
                    </div>
                    <div style="background:rgba(155,89,182,0.1);padding:12px;border-radius:10px;text-align:center;border:1px solid rgba(155,89,182,0.3);">
                        <div style="font-size:1.8rem;">‚ôÉ</div>
                        <div style="font-weight:600;color:#9b59b6;">J√∫piter</div>
                        <div style="font-size:0.85rem;">3-7 a√±os</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:4px;">
                            <strong>EXPANSI√ìN</strong><br>
                            Crecimiento, oportunidades
                        </div>
                    </div>
                    <div style="background:rgba(52,73,94,0.2);padding:12px;border-radius:10px;text-align:center;border:1px solid rgba(52,73,94,0.5);">
                        <div style="font-size:1.8rem;">‚ôÑ</div>
                        <div style="font-weight:600;color:#7f8c8d;">Saturno</div>
                        <div style="font-size:0.85rem;">7+ a√±os</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:4px;">
                            <strong>CONSOLIDACI√ìN</strong><br>
                            Estructura, madurez
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- S√≠ntesis -->
            <div class="analysis-card" style="background:linear-gradient(135deg, rgba(230,126,34,0.1), rgba(241,196,15,0.05));">
                <div class="analysis-title">‚ú® S√≠ntesis Vocacional</div>
                <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:10px;">
                    <div style="background:var(--bg-card);padding:10px;border-radius:8px;">
                        <div style="font-size:0.75rem;color:var(--text-dim);">üéØ MC</div>
                        <div style="font-weight:600;">${SIGN_SYMBOLS[signoMC] || '?'} ${signoMC || 'N/A'}</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:4px;">${MC_DESCRIPCION[signoMC]?.substring(0, 80) || ''}...</div>
                    </div>
                    <div style="background:var(--bg-card);padding:10px;border-radius:8px;">
                        <div style="font-size:0.75rem;color:var(--text-dim);">üî• Elemento</div>
                        <div style="font-weight:600;">${elementoMC || 'N/A'}</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:4px;">${infoElemento?.descripcion?.substring(0, 60) || ''}...</div>
                    </div>
                    <div style="background:var(--bg-card);padding:10px;border-radius:8px;">
                        <div style="font-size:0.75rem;color:var(--text-dim);">üîë Regente</div>
                        <div style="font-weight:600;">${PLANET_SYMBOLS[regenteMC] || regenteMC || '?'} en Casa ${posRegente?.casa || '?'}</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:4px;">${REGENTE_MC_CASAS[posRegente?.casa]?.substring(0, 60) || ''}...</div>
                    </div>
                    <div style="background:var(--bg-card);padding:10px;border-radius:8px;">
                        <div style="font-size:0.75rem;color:var(--text-dim);">‚öôÔ∏è Casa 6</div>
                        <div style="font-weight:600;">${SIGN_SYMBOLS[signoCasa6] || '?'} ${signoCasa6 || 'N/A'}</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:4px;">${SIGNOS_CASA6[signoCasa6]?.substring(0, 60) || ''}...</div>
                    </div>
                </div>
                <div style="margin-top:12px;padding:10px;background:var(--bg-elevated);border-radius:8px;">
                    <div style="font-size:0.85rem;"><strong>Puntuaci√≥n:</strong> <span style="color:${nivelColor};">${puntuacion >= 0 ? '+' : ''}${puntuacion} (${nivel})</span></div>
                    ${planetasEnCasa10.length > 0 ? `<div style="font-size:0.85rem;margin-top:4px;"><strong>En Casa 10:</strong> ${planetasEnCasa10.map(([n]) => PLANET_SYMBOLS[n] + ' ' + n).join(', ')}</div>` : ''}
                </div>
            </div>
        `;
        } catch (error) {
            console.error('‚ùå Error en renderVocacion:', error);
            document.getElementById('tab-vocacion').innerHTML = `
                <div class="analysis-card" style="background:rgba(231,76,60,0.1);border:1px solid #e74c3c;">
                    <div class="analysis-title">‚ùå Error al cargar Vocaci√≥n</div>
                    <p>${error.message}</p>
                    <pre style="font-size:0.7rem;overflow:auto;">${error.stack}</pre>
                </div>
            `;
        }
    }
    
    function renderFinanzas() {
        try {
        const c = perfilState.cartaNatal;
        
        // Debug: verificar que parteFortuna existe
        console.log('üìä Finanzas - parteFortuna:', c.parteFortuna);
        console.log('üìä Finanzas - isDiurno:', c.isDiurno);
        
        const signoCasa2 = c.casas[1].signo;
        const signoCasa5 = c.casas[4].signo;
        const signoCasa8 = c.casas[7].signo;
        const signoCasa11 = c.casas[10].signo;
        const regenteCasa2 = REGENTES[signoCasa2];
        const posRegenteCasa2 = c.posiciones[regenteCasa2];
        
        // Planetas del dinero
        const jupiter = c.posiciones['J√∫piter'];
        const venus = c.posiciones['Venus'];
        const saturno = c.posiciones['Saturno'];
        const marte = c.posiciones['Marte'];
        
        // Planetas en casas financieras (excluir puntos ficticios)
        const excluir = ['ASC', 'MC', 'Parte de Fortuna'];
        const planetasEnCasa2 = Object.entries(c.posiciones)
            .filter(([nombre, data]) => data.casa === 2 && !excluir.includes(nombre));
        const planetasEnCasa5 = Object.entries(c.posiciones)
            .filter(([nombre, data]) => data.casa === 5 && !excluir.includes(nombre));
        const planetasEnCasa8 = Object.entries(c.posiciones)
            .filter(([nombre, data]) => data.casa === 8 && !excluir.includes(nombre));
        const planetasEnCasa11 = Object.entries(c.posiciones)
            .filter(([nombre, data]) => data.casa === 11 && !excluir.includes(nombre));
        
        // Interpretaciones ampliadas de signos en Casa 2
        const SIGNOS_CASA2 = {
            'Aries': 'Dinero por iniciativa propia y acci√≥n r√°pida. Tendencia a gastos impulsivos. Capacidad de generar recursos r√°pidamente cuando te lo propones.',
            'Tauro': '¬°Excelente posici√≥n! Talento natural para atraer y mantener riqueza. Valores materiales s√≥lidos y estables. El dinero fluye hacia ti.',
            'G√©minis': 'M√∫ltiples fuentes de ingreso. Dinero por comunicaci√≥n, comercio, escritura o intermediaci√≥n. Versatilidad financiera.',
            'C√°ncer': 'Dinero ligado a la familia y el hogar. Fuerte tendencia al ahorro y la seguridad financiera. Instinto protector con recursos.',
            'Leo': 'Necesitas brillar para ganar bien. Dinero por creatividad, liderazgo o espect√°culo. Generosidad que debe equilibrarse.',
            'Virgo': 'Dinero por trabajo detallado, an√°lisis y servicio. Administraci√≥n muy cuidadosa de recursos. Eficiencia y orden.',
            'Libra': 'Dinero por asociaciones, arte, dise√±o o diplomacia. B√∫squeda de equilibrio financiero. Las relaciones pueden ser fuente de recursos.',
            'Escorpio': 'Potencial para grandes ganancias o p√©rdidas intensas. Recursos ocultos y herencias. Capacidad de regenerarte financieramente.',
            'Ofiuco': 'Ganancias por sanaci√≥n, conocimiento oculto o transformaci√≥n de otros. Recursos en lugares inesperados.',
            'Sagitario': 'Optimismo financiero que atrae abundancia. Dinero del extranjero, educaci√≥n o viajes. Generosidad natural.',
            'Capricornio': 'Construcci√≥n lenta pero muy s√≥lida de recursos. √âxito financiero a largo plazo garantizado con disciplina.',
            'Acuario': 'Ingresos por tecnolog√≠a, innovaci√≥n o trabajo con grupos. Finanzas no convencionales. Cambios s√∫bitos posibles.',
            'Pegaso': 'Ganancias por inspiraci√≥n art√≠stica, m√∫sica o visi√≥n espiritual. Relaci√≥n et√©rea con el dinero.',
            'Piscis': 'Relaci√≥n difusa con el dinero. Ganancias por arte, espiritualidad o servicio compasivo. Necesitas l√≠mites financieros.'
        };
        
        // Talentos financieros por signo
        const TALENTOS = {
            'Aries': ['Emprendimiento', 'Startups', 'Ventas', 'Deportes'],
            'Tauro': ['Inversiones', 'Bienes ra√≠ces', 'Gastronom√≠a', 'Lujo'],
            'G√©minis': ['Comunicaci√≥n', 'Comercio', 'Marketing', 'Escritura'],
            'C√°ncer': ['Hogar', 'Alimentaci√≥n', 'Cuidados', 'Propiedades'],
            'Leo': ['Entretenimiento', 'Liderazgo', 'Creatividad', 'Moda'],
            'Virgo': ['Servicio', 'Salud', 'An√°lisis', 'Contabilidad'],
            'Libra': ['Arte', 'Dise√±o', 'Diplomacia', 'Asociaciones'],
            'Escorpio': ['Investigaci√≥n', 'Psicolog√≠a', 'Finanzas', 'Crisis'],
            'Ofiuco': ['Sanaci√≥n', 'Medicina alternativa', 'Transformaci√≥n'],
            'Sagitario': ['Educaci√≥n', 'Viajes', 'Publicaciones', 'Internacional'],
            'Capricornio': ['Negocios', 'Administraci√≥n', 'Gobierno', 'Construcci√≥n'],
            'Acuario': ['Tecnolog√≠a', 'Innovaci√≥n', 'Redes', 'Humanitario'],
            'Pegaso': ['Arte visionario', 'M√∫sica', 'Inspiraci√≥n'],
            'Piscis': ['Arte', 'M√∫sica', 'Sanaci√≥n', 'Espiritualidad']
        };
        
        // Planetas en casas financieras - interpretaciones
        const PLANETAS_EN_CASA = {
            2: {
                'Sol': 'Tu identidad est√° ligada a tus recursos. El padre puede influir en tu situaci√≥n financiera.',
                'Luna': 'Fluctuaciones econ√≥micas seg√∫n tu estado emocional. La madre influye en tu relaci√≥n con el dinero.',
                'Mercurio': 'Mente pr√°ctica para los negocios. Ingresos por comunicaci√≥n, comercio o ense√±anza.',
                'Venus': '¬°Excelente! Atracci√≥n natural del dinero. Ganancias por arte, belleza o relaciones.',
                'Marte': 'Gran energ√≠a para generar dinero. Tendencia a gastos impulsivos que debes controlar.',
                'J√∫piter': '¬°Muy favorable! Abundancia financiera natural. La generosidad atrae m√°s recursos.',
                'Saturno': 'Construcci√≥n lenta pero muy s√≥lida del patrimonio. El √©xito financiero llega con la madurez.'
            },
            5: {
                'Sol': 'Brillo en especulaciones e inversiones. Suerte en proyectos creativos.',
                'Luna': 'Intuici√≥n para inversiones. Fluctuaciones en propiedades.',
                'Mercurio': 'M√∫ltiples inversiones y proyectos. Informaci√≥n como activo.',
                'Venus': '¬°Excelente! Suerte en especulaciones y arte. Ganancias de propiedades.',
                'Marte': 'Especulaciones arriesgadas. Gran energ√≠a pero cuidado con impulsividad.',
                'J√∫piter': '¬°Gran suerte! Expansi√≥n de propiedades y ganancias especulativas.',
                'Saturno': 'Especulaciones conservadoras pero s√≥lidas. Propiedades tard√≠as.'
            },
            8: {
                'Sol': 'Identidad ligada a recursos de otros. Herencias del padre.',
                'Luna': 'Intuici√≥n sobre recursos ajenos. Herencias de la familia materna.',
                'Mercurio': 'Informaci√≥n sobre recursos ajenos. Talento para finanzas.',
                'Venus': 'Atracci√≥n de recursos de pareja. Herencias favorables.',
                'Marte': 'Lucha por herencias. Intensidad en recursos compartidos.',
                'J√∫piter': '¬°Excelente! Gran suerte con herencias e inversiones.',
                'Saturno': 'Herencias tard√≠as pero s√≥lidas. Responsabilidades con recursos de otros.'
            },
            11: {
                'Sol': 'Brillas en grupos y redes. Tus metas son importantes para tu identidad.',
                'Luna': 'Conexi√≥n emocional con tus metas. Grupos que se sienten como familia.',
                'Mercurio': 'Comunicaci√≥n clave para tus ganancias. Red de contactos valiosos.',
                'Venus': 'Ganancias por belleza, arte o relaciones. Amistades beneficiosas.',
                'Marte': 'Acci√≥n decidida para conseguir tus metas. Puede haber conflictos en grupos.',
                'J√∫piter': '¬°Excelente! Abundancia de ganancias empresariales. Gran suerte con grupos.',
                'Saturno': 'Ganancias lentas pero muy s√≥lidas. Pocos amigos pero leales.'
            }
        };
        
        // Calcular indicadores de riqueza
        let puntuacion = 0;
        const factores = [];
        
        if (jupiter?.casa === 2) { factores.push({ texto: 'J√∫piter en Casa 2', puntos: 5, tipo: 'positivo' }); puntuacion += 5; }
        if (jupiter?.casa === 11) { factores.push({ texto: 'J√∫piter en Casa 11', puntos: 5, tipo: 'positivo' }); puntuacion += 5; }
        if (jupiter?.casa === 5) { factores.push({ texto: 'J√∫piter en Casa 5', puntos: 3, tipo: 'positivo' }); puntuacion += 3; }
        if (jupiter?.casa === 8) { factores.push({ texto: 'J√∫piter en Casa 8', puntos: 3, tipo: 'positivo' }); puntuacion += 3; }
        
        if (venus?.casa === 2) { factores.push({ texto: 'Venus en Casa 2', puntos: 4, tipo: 'positivo' }); puntuacion += 4; }
        if (venus?.casa === 11) { factores.push({ texto: 'Venus en Casa 11', puntos: 3, tipo: 'positivo' }); puntuacion += 3; }
        
        if (saturno?.casa === 10) { factores.push({ texto: 'Saturno en Casa 10', puntos: 3, tipo: 'positivo' }); puntuacion += 3; }
        if (saturno?.casa === 2) { factores.push({ texto: 'Saturno en Casa 2 (restricci√≥n)', puntos: -2, tipo: 'negativo' }); puntuacion -= 2; }
        
        const neptuno = c.posiciones['Neptuno'];
        if (neptuno?.casa === 2) { factores.push({ texto: 'Neptuno en Casa 2 (confusi√≥n)', puntos: -3, tipo: 'negativo' }); puntuacion -= 3; }
        
        // Parte de Fortuna en casas financieras
        if (c.parteFortuna?.casa === 2) { factores.push({ texto: 'Fortuna en Casa 2', puntos: 4, tipo: 'positivo' }); puntuacion += 4; }
        if (c.parteFortuna?.casa === 11) { factores.push({ texto: 'Fortuna en Casa 11', puntos: 4, tipo: 'positivo' }); puntuacion += 4; }
        if (c.parteFortuna?.casa === 5) { factores.push({ texto: 'Fortuna en Casa 5', puntos: 3, tipo: 'positivo' }); puntuacion += 3; }
        if (c.parteFortuna?.casa === 8) { factores.push({ texto: 'Fortuna en Casa 8', puntos: 3, tipo: 'positivo' }); puntuacion += 3; }
        
        // Parte de Fortuna en signos favorables para el dinero
        // Signos de Venus (Tauro, Libra) = atracci√≥n del dinero
        // Signos de J√∫piter (Sagitario, Piscis, Pegaso) = abundancia
        // Signos de Tierra = materialidad
        if (c.parteFortuna?.signo) {
            const signoFortuna = c.parteFortuna.signo;
            if (['Tauro', 'Libra'].includes(signoFortuna)) { 
                factores.push({ texto: `Fortuna en ${signoFortuna} (Venus)`, puntos: 3, tipo: 'positivo' }); 
                puntuacion += 3; 
            }
            if (['Sagitario', 'Piscis', 'Pegaso'].includes(signoFortuna)) { 
                factores.push({ texto: `Fortuna en ${signoFortuna} (J√∫piter)`, puntos: 2, tipo: 'positivo' }); 
                puntuacion += 2; 
            }
            if (['Capricornio', 'Virgo'].includes(signoFortuna) && signoFortuna !== 'Tauro') { 
                factores.push({ texto: `Fortuna en ${signoFortuna} (Tierra)`, puntos: 2, tipo: 'positivo' }); 
                puntuacion += 2; 
            }
        }
        
        if (['Tauro', 'Virgo', 'Capricornio'].includes(signoCasa2)) { 
            factores.push({ texto: 'Casa 2 en Tierra', puntos: 2, tipo: 'positivo' }); 
            puntuacion += 2; 
        }
        
        const nivel = puntuacion >= 15 ? 'Muy Alto' : puntuacion >= 10 ? 'Alto' : puntuacion >= 5 ? 'Favorable' : puntuacion >= 0 ? 'Moderado' : puntuacion >= -5 ? 'Desafiante' : 'Muy Desafiante';
        const nivelColor = puntuacion >= 10 ? '#27ae60' : puntuacion >= 5 ? '#8bc34a' : puntuacion >= 0 ? '#f39c12' : '#e74c3c';
        
        const talentos = TALENTOS[signoCasa2] || [];
        
        document.getElementById('tab-finanzas').innerHTML = `
            <!-- Indicadores de Riqueza -->
            <div class="analysis-card" style="background:linear-gradient(135deg, rgba(212,168,83,0.15), rgba(212,168,83,0.05));">
                <div class="analysis-title">üìä Indicadores de Prosperidad</div>
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:12px;">
                    <div>
                        <div style="font-size:2.5rem;font-weight:700;color:${nivelColor};">${puntuacion >= 0 ? '+' : ''}${puntuacion}</div>
                        <div style="display:inline-block;padding:4px 12px;border-radius:20px;background:${nivelColor};color:white;font-size:0.8rem;font-weight:600;">${nivel}</div>
                    </div>
                    <div style="flex:1;min-width:200px;">
                        <div style="display:flex;flex-wrap:wrap;gap:6px;">
                            ${factores.map(f => `
                                <span style="padding:3px 8px;border-radius:12px;font-size:0.75rem;
                                    background:${f.tipo === 'positivo' ? 'rgba(39,174,96,0.15)' : 'rgba(231,76,60,0.15)'};
                                    color:${f.tipo === 'positivo' ? '#27ae60' : '#e74c3c'};">
                                    ${f.tipo === 'positivo' ? '+' : ''}${f.puntos} ${f.texto}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Talentos Financieros -->
            ${talentos.length > 0 ? `
                <div class="analysis-card">
                    <div class="analysis-title">üíº Tus Talentos Financieros</div>
                    <div style="display:flex;flex-wrap:wrap;gap:8px;">
                        ${talentos.map(t => `<span style="padding:6px 12px;background:var(--bg-elevated);border-radius:20px;font-size:0.85rem;">${t}</span>`).join('')}
                    </div>
                    <p style="margin-top:12px;color:var(--text-dim);font-size:0.85rem;">
                        Con ${SIGN_SYMBOLS[signoCasa2]} ${signoCasa2} en tu Casa 2, estas son tus √°reas de mayor potencial financiero.
                    </p>
                </div>
            ` : ''}
            
            <!-- Fases Empresariales -->
            <div class="analysis-card" style="background:linear-gradient(135deg, rgba(155,89,182,0.1), rgba(52,152,219,0.1));">
                <div class="analysis-title">üöÄ Fases Empresariales</div>
                <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:10px;">
                    <div style="background:var(--bg-card);padding:12px;border-radius:10px;text-align:center;">
                        <div style="font-size:1.5rem;">‚ôÇ</div>
                        <div style="font-weight:600;font-size:0.9rem;">Fase Marte</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);">0-3 a√±os</div>
                        <div style="font-size:0.7rem;color:var(--gold-light);margin-top:4px;">Inicio, acci√≥n, emprendimiento</div>
                    </div>
                    <div style="background:var(--bg-card);padding:12px;border-radius:10px;text-align:center;">
                        <div style="font-size:1.5rem;">‚ôÉ</div>
                        <div style="font-weight:600;font-size:0.9rem;">Fase J√∫piter</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);">3-7 a√±os</div>
                        <div style="font-size:0.7rem;color:var(--gold-light);margin-top:4px;">Expansi√≥n, crecimiento</div>
                    </div>
                    <div style="background:var(--bg-card);padding:12px;border-radius:10px;text-align:center;">
                        <div style="font-size:1.5rem;">‚ôÑ</div>
                        <div style="font-weight:600;font-size:0.9rem;">Fase Saturno</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);">7+ a√±os</div>
                        <div style="font-size:0.7rem;color:var(--gold-light);margin-top:4px;">Consolidaci√≥n, estructura</div>
                    </div>
                </div>
            </div>
            
            <!-- Casa 2: Dinero Personal -->
            <div class="analysis-card">
                <div class="analysis-title">üí∞ Casa 2: Dinero Personal</div>
                <div style="background:var(--bg-elevated);padding:12px;border-radius:10px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                        <span style="font-size:1.8rem;">${SIGN_SYMBOLS[signoCasa2]}</span>
                        <div>
                            <div style="font-weight:600;">${signoCasa2}</div>
                            <div style="font-size:0.75rem;color:var(--text-dim);">Regente: ${PLANET_SYMBOLS[regenteCasa2]} ${regenteCasa2} ${posRegenteCasa2 ? `en Casa ${posRegenteCasa2.casa}` : ''}</div>
                        </div>
                    </div>
                    <p style="margin:0;font-size:0.85rem;color:var(--text-dim);">${SIGNOS_CASA2[signoCasa2] || ''}</p>
                </div>
                ${planetasEnCasa2.length > 0 ? `
                    <div style="border-top:1px solid rgba(212,168,83,0.2);padding-top:12px;">
                        <div style="font-weight:600;margin-bottom:8px;font-size:0.9rem;">‚≠ê Planetas en tu Casa 2:</div>
                        ${planetasEnCasa2.map(([nombre, data]) => `
                            <div style="background:var(--bg-elevated);padding:10px;border-radius:8px;margin-bottom:6px;">
                                <strong>${PLANET_SYMBOLS[nombre]} ${nombre}</strong>
                                <span style="font-size:0.75rem;color:var(--text-dim);"> en ${SIGN_SYMBOLS[data.signo]} ${data.signo}</span>
                                <p style="margin:4px 0 0 0;font-size:0.8rem;color:var(--text-dim);">${PLANETAS_EN_CASA[2]?.[nombre] || ''}</p>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
            
            <!-- Casa 5: Dinero de Propiedades -->
            <div class="analysis-card">
                <div class="analysis-title">üè† Casa 5: Especulaciones y Propiedades</div>
                <div style="background:var(--bg-elevated);padding:12px;border-radius:10px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span style="font-size:1.8rem;">${SIGN_SYMBOLS[signoCasa5]}</span>
                        <div>
                            <div style="font-weight:600;">${signoCasa5}</div>
                            <div style="font-size:0.75rem;color:var(--text-dim);">Ganancias de propiedades, especulaciones, inversiones</div>
                        </div>
                    </div>
                </div>
                ${planetasEnCasa5.length > 0 ? `
                    <div style="font-size:0.85rem;">
                        ${planetasEnCasa5.map(([nombre, data]) => `
                            <span style="display:inline-block;padding:4px 10px;background:var(--bg-elevated);border-radius:15px;margin:3px;">
                                ${PLANET_SYMBOLS[nombre]} ${nombre}
                            </span>
                        `).join('')}
                    </div>
                ` : '<p style="font-size:0.85rem;color:var(--text-dim);">Sin planetas en esta casa.</p>'}
            </div>
            
            <!-- Casa 8: Recursos Compartidos -->
            <div class="analysis-card">
                <div class="analysis-title">üíé Casa 8: Recursos de Otros</div>
                <div style="background:var(--bg-elevated);padding:12px;border-radius:10px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span style="font-size:1.8rem;">${SIGN_SYMBOLS[signoCasa8]}</span>
                        <div>
                            <div style="font-weight:600;">${signoCasa8}</div>
                            <div style="font-size:0.75rem;color:var(--text-dim);">Herencias, pareja, socios, pr√©stamos, seguros</div>
                        </div>
                    </div>
                </div>
                ${planetasEnCasa8.length > 0 ? `
                    <div style="font-size:0.85rem;">
                        ${planetasEnCasa8.map(([nombre, data]) => `
                            <span style="display:inline-block;padding:4px 10px;background:var(--bg-elevated);border-radius:15px;margin:3px;">
                                ${PLANET_SYMBOLS[nombre]} ${nombre}
                            </span>
                        `).join('')}
                    </div>
                ` : '<p style="font-size:0.85rem;color:var(--text-dim);">Sin planetas en esta casa.</p>'}
            </div>
            
            <!-- Casa 11: Ganancias Empresariales -->
            <div class="analysis-card">
                <div class="analysis-title">üìà Casa 11: Ganancias Empresariales</div>
                <div style="background:var(--bg-elevated);padding:12px;border-radius:10px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span style="font-size:1.8rem;">${SIGN_SYMBOLS[signoCasa11]}</span>
                        <div>
                            <div style="font-weight:600;">${signoCasa11}</div>
                            <div style="font-size:0.75rem;color:var(--text-dim);">Frutos de tu carrera, amigos, grupos, metas</div>
                        </div>
                    </div>
                </div>
                ${planetasEnCasa11.length > 0 ? `
                    <div style="font-size:0.85rem;">
                        ${planetasEnCasa11.map(([nombre, data]) => `
                            <span style="display:inline-block;padding:4px 10px;background:var(--bg-elevated);border-radius:15px;margin:3px;">
                                ${PLANET_SYMBOLS[nombre]} ${nombre}
                            </span>
                        `).join('')}
                    </div>
                ` : '<p style="font-size:0.85rem;color:var(--text-dim);">Sin planetas en esta casa.</p>'}
            </div>
            
            <!-- Planetas del Dinero -->
            <div class="analysis-card">
                <div class="analysis-title">üåü Tus Planetas del Dinero</div>
                <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:10px;">
                    ${jupiter ? `
                        <div style="background:var(--bg-elevated);padding:12px;border-radius:10px;border-left:3px solid #f39c12;">
                            <div style="font-size:1.2rem;margin-bottom:4px;">‚ôÉ J√∫piter</div>
                            <div style="font-size:0.85rem;">Casa ${jupiter.casa} ‚Ä¢ ${SIGN_SYMBOLS[jupiter.signo]} ${jupiter.signo}</div>
                            <div style="font-size:0.75rem;color:var(--gold-light);margin-top:4px;">Abundancia y expansi√≥n</div>
                        </div>
                    ` : ''}
                    ${venus ? `
                        <div style="background:var(--bg-elevated);padding:12px;border-radius:10px;border-left:3px solid #e91e63;">
                            <div style="font-size:1.2rem;margin-bottom:4px;">‚ôÄ Venus</div>
                            <div style="font-size:0.85rem;">Casa ${venus.casa} ‚Ä¢ ${SIGN_SYMBOLS[venus.signo]} ${venus.signo}</div>
                            <div style="font-size:0.75rem;color:var(--gold-light);margin-top:4px;">Atracci√≥n financiera</div>
                        </div>
                    ` : ''}
                    ${saturno ? `
                        <div style="background:var(--bg-elevated);padding:12px;border-radius:10px;border-left:3px solid #607d8b;">
                            <div style="font-size:1.2rem;margin-bottom:4px;">‚ôÑ Saturno</div>
                            <div style="font-size:0.85rem;">Casa ${saturno.casa} ‚Ä¢ ${SIGN_SYMBOLS[saturno.signo]} ${saturno.signo}</div>
                            <div style="font-size:0.75rem;color:var(--gold-light);margin-top:4px;">Estructura y consolidaci√≥n</div>
                        </div>
                    ` : ''}
                    ${marte ? `
                        <div style="background:var(--bg-elevated);padding:12px;border-radius:10px;border-left:3px solid #f44336;">
                            <div style="font-size:1.2rem;margin-bottom:4px;">‚ôÇ Marte</div>
                            <div style="font-size:0.85rem;">Casa ${marte.casa} ‚Ä¢ ${SIGN_SYMBOLS[marte.signo]} ${marte.signo}</div>
                            <div style="font-size:0.75rem;color:var(--gold-light);margin-top:4px;">Iniciativa y acci√≥n</div>
                        </div>
                    ` : ''}
                </div>
            </div>
            
            <!-- Parte de Fortuna -->
            ${c.parteFortuna ? `
                <div class="analysis-card" style="background:linear-gradient(135deg, rgba(52,152,219,0.15), rgba(155,89,182,0.1));">
                    <div class="analysis-title">‚äï Parte de Fortuna</div>
                    <div class="analysis-content">
                        <p style="color:var(--text-dim);font-size:0.85rem;margin-bottom:12px;">
                            La Parte de Fortuna es un punto calculado que indica d√≥nde fluye la suerte y la prosperidad natural en tu vida.
                            F√≥rmula: ${c.isDiurno ? 'ASC + Luna - Sol (diurno)' : 'ASC + Sol - Luna (nocturno)'}
                        </p>
                        <div style="display:flex;align-items:center;gap:15px;background:var(--bg-elevated);padding:15px;border-radius:12px;">
                            <div style="font-size:2.5rem;">‚äï</div>
                            <div>
                                <div style="font-size:1.1rem;font-weight:600;">
                                    Casa ${c.parteFortuna.casa} ‚Ä¢ ${SIGN_SYMBOLS[c.parteFortuna.signo]} ${c.parteFortuna.signo}
                                </div>
                                <div style="font-size:0.85rem;color:var(--gold-light);margin-top:4px;">
                                    ${c.parteFortuna.casa === 1 ? 'Fortuna por tu personalidad y presencia.' :
                                      c.parteFortuna.casa === 2 ? '¬°Excelente! Fortuna de tus propios recursos y talentos.' :
                                      c.parteFortuna.casa === 3 ? 'Fortuna por comunicaci√≥n, comercio y hermanos.' :
                                      c.parteFortuna.casa === 4 ? 'Fortuna del hogar, familia y propiedades.' :
                                      c.parteFortuna.casa === 5 ? 'Fortuna por creatividad, hijos y especulaciones.' :
                                      c.parteFortuna.casa === 6 ? 'Fortuna del trabajo diario y servicio.' :
                                      c.parteFortuna.casa === 7 ? 'Fortuna por socios, pareja y contratos.' :
                                      c.parteFortuna.casa === 8 ? 'Fortuna por herencias y recursos compartidos.' :
                                      c.parteFortuna.casa === 9 ? 'Fortuna por viajes, educaci√≥n y extranjero.' :
                                      c.parteFortuna.casa === 10 ? 'Fortuna por carrera y reconocimiento p√∫blico.' :
                                      c.parteFortuna.casa === 11 ? '¬°Excelente! Fortuna por amigos, grupos y metas.' :
                                      'Fortuna oculta, karma positivo, protecci√≥n espiritual.'}
                                </div>
                            </div>
                        </div>
                        <p style="margin-top:12px;font-size:0.8rem;color:var(--text-dim);">
                            ${c.parteFortuna.signo === 'Aries' ? 'Fortuna por iniciativa y acci√≥n.' :
                              c.parteFortuna.signo === 'Tauro' ? 'Fortuna por paciencia y constancia.' :
                              c.parteFortuna.signo === 'G√©minis' ? 'Fortuna por comunicaci√≥n y versatilidad.' :
                              c.parteFortuna.signo === 'C√°ncer' ? 'Fortuna por cuidado y hogar.' :
                              c.parteFortuna.signo === 'Leo' ? 'Fortuna por liderazgo y creatividad.' :
                              c.parteFortuna.signo === 'Virgo' ? 'Fortuna por trabajo detallado y servicio.' :
                              c.parteFortuna.signo === 'Libra' ? 'Fortuna por asociaciones y equilibrio.' :
                              c.parteFortuna.signo === 'Escorpio' ? 'Fortuna por transformaci√≥n e intensidad.' :
                              c.parteFortuna.signo === 'Ofiuco' ? 'Fortuna por sanaci√≥n y conocimiento oculto.' :
                              c.parteFortuna.signo === 'Sagitario' ? 'Fortuna por expansi√≥n y viajes.' :
                              c.parteFortuna.signo === 'Capricornio' ? 'Fortuna por disciplina y estructura.' :
                              c.parteFortuna.signo === 'Acuario' ? 'Fortuna por innovaci√≥n y originalidad.' :
                              c.parteFortuna.signo === 'Pegaso' ? 'Fortuna por inspiraci√≥n y visi√≥n.' :
                              'Fortuna por intuici√≥n y espiritualidad.'}
                        </p>
                    </div>
                </div>
            ` : ''}
            
            <!-- Regente Casa 2 -->
            ${posRegenteCasa2 ? `
                <div class="analysis-card">
                    <div class="analysis-title">üîó Tu Regente del Dinero</div>
                    <div style="background:var(--bg-elevated);padding:12px;border-radius:10px;">
                        <p style="margin:0 0 8px 0;">
                            <strong>${PLANET_SYMBOLS[regenteCasa2]} ${regenteCasa2}</strong> (regente de Casa 2) 
                            est√° en <strong>Casa ${posRegenteCasa2.casa}</strong>
                        </p>
                        <p style="margin:0;font-size:0.85rem;color:var(--gold-light);">
                            ${posRegenteCasa2.casa === 1 ? 'Ganas dinero por ti mismo, tu imagen y personalidad.' :
                              posRegenteCasa2.casa === 2 ? '¬°Muy favorable! Estabilidad financiera natural.' :
                              posRegenteCasa2.casa === 3 ? 'Dinero por comunicaci√≥n, comercio o hermanos.' :
                              posRegenteCasa2.casa === 4 ? 'Dinero desde el hogar o negocios familiares.' :
                              posRegenteCasa2.casa === 5 ? 'Dinero por creatividad, especulaciones o hijos.' :
                              posRegenteCasa2.casa === 6 ? 'Dinero por trabajo diario y servicio.' :
                              posRegenteCasa2.casa === 7 ? 'Dinero a trav√©s de socios o pareja.' :
                              posRegenteCasa2.casa === 8 ? 'Dinero por herencias o recursos de otros.' :
                              posRegenteCasa2.casa === 9 ? 'Dinero del extranjero, educaci√≥n o viajes.' :
                              posRegenteCasa2.casa === 10 ? 'Dinero por tu carrera y reputaci√≥n.' :
                              posRegenteCasa2.casa === 11 ? 'Dinero por amigos, grupos y redes.' :
                              'Dinero de forma oculta o por trabajo espiritual.'}
                        </p>
                    </div>
                </div>
            ` : ''}
            
            <!-- S√≠ntesis Financiera -->
            <div class="analysis-card" style="background:linear-gradient(135deg, rgba(39,174,96,0.1), rgba(52,152,219,0.05));">
                <div class="analysis-title">‚ú® S√≠ntesis Financiera</div>
                <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:10px;">
                    <div style="background:var(--bg-card);padding:10px;border-radius:8px;">
                        <div style="font-size:0.75rem;color:var(--text-dim);">üí∞ Casa 2</div>
                        <div style="font-weight:600;">${SIGN_SYMBOLS[signoCasa2] || '?'} ${signoCasa2}</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:4px;">Recursos propios</div>
                    </div>
                    <div style="background:var(--bg-card);padding:10px;border-radius:8px;">
                        <div style="font-size:0.75rem;color:var(--text-dim);">‚äï Parte Fortuna</div>
                        <div style="font-weight:600;">${c.parteFortuna ? SIGN_SYMBOLS[c.parteFortuna.signo] + ' Casa ' + c.parteFortuna.casa : 'N/A'}</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:4px;">Donde fluye la suerte</div>
                    </div>
                    <div style="background:var(--bg-card);padding:10px;border-radius:8px;">
                        <div style="font-size:0.75rem;color:var(--text-dim);">üîë Regente Casa 2</div>
                        <div style="font-weight:600;">${PLANET_SYMBOLS[regenteCasa2] || '?'} en Casa ${posRegenteCasa2?.casa || '?'}</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:4px;">C√≥mo generas dinero</div>
                    </div>
                    <div style="background:var(--bg-card);padding:10px;border-radius:8px;">
                        <div style="font-size:0.75rem;color:var(--text-dim);">‚ôÉ J√∫piter</div>
                        <div style="font-weight:600;">${jupiter ? SIGN_SYMBOLS[jupiter.signo] + ' Casa ' + jupiter.casa : 'N/A'}</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:4px;">Expansi√≥n financiera</div>
                    </div>
                </div>
                <div style="margin-top:12px;padding:10px;background:var(--bg-elevated);border-radius:8px;">
                    <div style="font-size:0.85rem;"><strong>Indicador:</strong> <span style="color:${nivelColor};">${puntuacion >= 0 ? '+' : ''}${puntuacion} (${nivel})</span></div>
                </div>
            </div>
        `;
        } catch (error) {
            console.error('‚ùå Error en renderFinanzas:', error);
            document.getElementById('tab-finanzas').innerHTML = `
                <div class="analysis-card" style="background:rgba(231,76,60,0.1);border:1px solid #e74c3c;">
                    <div class="analysis-title">‚ùå Error al cargar Finanzas</div>
                    <p>${error.message}</p>
                    <pre style="font-size:0.7rem;overflow:auto;">${error.stack}</pre>
                </div>
            `;
        }
    }
    
    function renderEspiritual() {
        try {
            const c = perfilState.cartaNatal;
            if (!c || !c.casas) {
                document.getElementById('tab-espiritual').innerHTML = '<div class="analysis-card"><p>Calcula tu carta primero.</p></div>';
                return;
            }
            
            // PARCHE: Si la carta no tiene nodos, calcularlos sobre la marcha
            if (!c.posiciones['Nodo Norte']) {
                console.log('üßò Recalculando nodos...');
                // Necesitamos recalcular los nodos bas√°ndonos en la fecha de nacimiento guardada
                const perfil = JSON.parse(localStorage.getItem('tarot28_perfil') || '{}');
                if (perfil.fechaNacimiento) {
                    const fecha = new Date(perfil.fechaNacimiento);
                    const jd = fechaAJuliano(fecha, 0);
                    const T = (jd - 2451545.0) / 36525;
                    let nodoNorteLon = 125.04 - 1934.136 * T;
                    nodoNorteLon = ((nodoNorteLon % 360) + 360) % 360;
                    const signoNN = getSignoDesdeLongitud(nodoNorteLon);
                    
                    // Calcular casa del Nodo Norte
                    let casaNN = 1;
                    for (let i = 0; i < 12; i++) {
                        const inicio = c.casas[i].cuspide;
                        const fin = c.casas[(i + 1) % 12].cuspide;
                        let enCasa = fin > inicio ? 
                            (nodoNorteLon >= inicio && nodoNorteLon < fin) : 
                            (nodoNorteLon >= inicio || nodoNorteLon < fin);
                        if (enCasa) { casaNN = i + 1; break; }
                    }
                    
                    c.posiciones['Nodo Norte'] = { lon: nodoNorteLon, signo: signoNN, casa: casaNN, simbolo: '‚òä' };
                    
                    const nodoSurLon = (nodoNorteLon + 180) % 360;
                    const signoNS = getSignoDesdeLongitud(nodoSurLon);
                    const casaNS = casaNN <= 6 ? casaNN + 6 : casaNN - 6;
                    c.posiciones['Nodo Sur'] = { lon: nodoSurLon, signo: signoNS, casa: casaNS, simbolo: '‚òã' };
                }
            }
            
            // PARCHE: Recalcular casas de planetas si alguno no tiene .casa
            const planetasParaVerificar = ['Neptuno', 'Plut√≥n', 'J√∫piter', 'Saturno', 'Luna', 'Sol', 'Mercurio', 'Venus', 'Marte', 'Urano'];
            for (const nombrePlaneta of planetasParaVerificar) {
                const planeta = c.posiciones[nombrePlaneta];
                if (planeta && planeta.casa === undefined && planeta.lon !== undefined) {
                    console.log(`üßò Recalculando casa para ${nombrePlaneta}...`);
                    for (let i = 0; i < 12; i++) {
                        const inicio = c.casas[i].cuspide;
                        const fin = c.casas[(i + 1) % 12].cuspide;
                        let enCasa = fin > inicio ? 
                            (planeta.lon >= inicio && planeta.lon < fin) : 
                            (planeta.lon >= inicio || planeta.lon < fin);
                        if (enCasa) { planeta.casa = i + 1; break; }
                    }
                }
            }
            
            // DEBUG - ver qu√© hay en posiciones
            console.log('üßò Espiritual Debug - posiciones:', Object.keys(c.posiciones));
            console.log('üßò Neptuno:', c.posiciones['Neptuno']);
            console.log('üßò Plut√≥n:', c.posiciones['Plut√≥n']);
            console.log('üßò Nodo Norte:', c.posiciones['Nodo Norte']);
            
            const signoCasa4 = c.casas[3]?.signo || 'Aries';
            const signoCasa8 = c.casas[7]?.signo || 'Aries';
            const signoCasa9 = c.casas[8]?.signo || 'Aries';
            const signoCasa12 = c.casas[11]?.signo || 'Aries';
            
            // Regentes
            const regenteCasa4 = REGENTES[signoCasa4];
            const regenteCasa8 = REGENTES[signoCasa8];
            const regenteCasa9 = REGENTES[signoCasa9];
            const regenteCasa12 = REGENTES[signoCasa12];
            const posRegenteCasa4 = c.posiciones[regenteCasa4];
            const posRegenteCasa8 = c.posiciones[regenteCasa8];
            const posRegenteCasa9 = c.posiciones[regenteCasa9];
            const posRegenteCasa12 = c.posiciones[regenteCasa12];
            
            // Planetas espirituales
            const neptuno = c.posiciones['Neptuno'];
            const jupiter = c.posiciones['J√∫piter'];
            const pluton = c.posiciones['Plut√≥n'];
            const saturno = c.posiciones['Saturno'];
            const luna = c.posiciones['Luna'];
            
            // NODOS REALES - buscar en posiciones
            const nodoNorte = c.posiciones['Nodo Norte'] || c.posiciones['Nodo Lunar'] || c.posiciones['NodoNorte'];
            const nodoSur = c.posiciones['Nodo Sur'] || c.posiciones['NodoSur'];
            
            // Parte del Esp√≠ritu
            const parteEspiritu = c.posiciones['Parte de Esp√≠ritu'] || c.posiciones['Parte Esp√≠ritu'];
            
            // Elementos
            const ELEMENTOS = {
                'Aries': 'Fuego', 'Tauro': 'Tierra', 'G√©minis': 'Aire', 'C√°ncer': 'Agua',
                'Leo': 'Fuego', 'Virgo': 'Tierra', 'Libra': 'Aire', 'Escorpio': 'Agua',
                'Ofiuco': 'Agua', 'Sagitario': 'Fuego', 'Capricornio': 'Tierra',
                'Acuario': 'Aire', 'Pegaso': 'Agua', 'Piscis': 'Agua'
            };
            
            // NODO NORTE por SIGNO
            const NN_SIGNO = {
                'Aries': { cualidades: 'Coraje, iniciativa, independencia, liderazgo.', desafio: 'Dejar de complacer a otros, actuar.' },
                'Tauro': { cualidades: 'Paciencia, sensualidad sana, construcci√≥n material, autoestima.', desafio: 'Soltar lo ajeno, valorar lo propio.' },
                'G√©minis': { cualidades: 'Curiosidad, comunicaci√≥n, versatilidad, aprendizaje.', desafio: 'Escuchar m√°s, hablar de todo un poco.' },
                'C√°ncer': { cualidades: 'Nutrici√≥n, empat√≠a, hogar, sensibilidad.', desafio: 'Abrirse emocionalmente, crear familia.' },
                'Leo': { cualidades: 'Creatividad, autoexpresi√≥n, generosidad, brillo personal.', desafio: 'Brillar sin miedo, liderar con el coraz√≥n.' },
                'Virgo': { cualidades: 'Servicio, an√°lisis, perfeccionamiento, humildad.', desafio: 'Servir sin perderse, orden pr√°ctico.' },
                'Libra': { cualidades: 'Equilibrio, diplomacia, belleza, cooperaci√≥n.', desafio: 'Relacionarse sin perderse en el otro.' },
                'Escorpio': { cualidades: 'Profundidad emocional, investigaci√≥n, regeneraci√≥n.', desafio: 'Soltar el control, confiar.' },
                'Ofiuco': { cualidades: 'Sanaci√≥n, transformaci√≥n, alquimia espiritual.', desafio: 'Integrar luz y sombra.' },
                'Sagitario': { cualidades: 'Fe, optimismo, aventura, filosof√≠a, ense√±anza.', desafio: 'Encontrar tu verdad, expandirte.' },
                'Capricornio': { cualidades: 'Responsabilidad, madurez, logro, estructura.', desafio: 'Asumir autoridad, dejar legado.' },
                'Acuario': { cualidades: 'Originalidad, humanitarismo, innovaci√≥n, libertad.', desafio: 'Servir a la humanidad, ser √∫nico.' },
                'Pegaso': { cualidades: 'Inspiraci√≥n, elevaci√≥n, visi√≥n, libertad espiritual.', desafio: 'Volar sin perder ra√≠ces.' },
                'Piscis': { cualidades: 'Compasi√≥n, espiritualidad, arte, conexi√≥n divina.', desafio: 'Disolver ego, confiar en lo invisible.' }
            };
            
            // NODO NORTE por CASA
            const NN_CASA = {
                1: { area: 'Tu identidad y presencia f√≠sica', proposito: 'Desarrollar tu individualidad', leccion: 'Aprender a ponerte primero sin culpa.', desafio: 'Superar la dependencia de aprobaci√≥n.', regalo: 'Liderazgo natural.' },
                2: { area: 'Recursos propios y autoestima', proposito: 'Construir tus propios recursos', leccion: 'Valorarte y generar tu propia seguridad.', desafio: 'Soltar dependencia de recursos ajenos.', regalo: 'Abundancia autogenerada.' },
                3: { area: 'Comunicaci√≥n y entorno cercano', proposito: 'Comunicar y aprender', leccion: 'Desarrollar tu mente y conexi√≥n con el entorno.', desafio: 'Bajar de lo abstracto a lo cotidiano.', regalo: 'Claridad mental y habilidad de ense√±ar.' },
                4: { area: 'Hogar y ra√≠ces', proposito: 'Crear tu hogar interior', leccion: 'Construir bases emocionales s√≥lidas.', desafio: 'Soltar obsesi√≥n por √©xito externo.', regalo: 'Paz interior y pertenencia.' },
                5: { area: 'Creatividad y autoexpresi√≥n', proposito: 'Expresar tu creatividad', leccion: 'Permitirte jugar, crear y amar.', desafio: 'Superar miedo a brillar.', regalo: 'Alegr√≠a de vivir.' },
                6: { area: 'Servicio y salud', proposito: 'Servir y perfeccionar', leccion: 'Encontrar lo sagrado en lo cotidiano.', desafio: 'Soltar escapismo y victimizaci√≥n.', regalo: 'Maestr√≠a pr√°ctica.' },
                7: { area: 'Relaciones y asociaciones', proposito: 'Aprender a relacionarte', leccion: 'Desarrollar relaciones equilibradas.', desafio: 'Superar exceso de independencia.', regalo: 'Amor maduro.' },
                8: { area: 'Transformaci√≥n y recursos compartidos', proposito: 'Transformarte profundamente', leccion: 'Abrazar la muerte del ego para renacer.', desafio: 'Soltar apego a seguridad material.', regalo: 'Poder de transformaci√≥n.' },
                9: { area: 'Filosof√≠a y expansi√≥n', proposito: 'Expandir tu conciencia', leccion: 'Buscar la verdad, viajar, desarrollar filosof√≠a.', desafio: 'Superar la dispersi√≥n mental y el chisme.', regalo: 'Sabidur√≠a y fe inquebrantable.' },
                10: { area: 'Carrera y vocaci√≥n', proposito: 'Cumplir tu misi√≥n p√∫blica', leccion: 'Asumir responsabilidad y liderazgo.', desafio: 'Soltar comodidad del hogar.', regalo: 'Reconocimiento por tu contribuci√≥n.' },
                11: { area: 'Grupos y humanidad', proposito: 'Servir a la humanidad', leccion: 'Conectar con grupos y causas mayores.', desafio: 'Superar ego y drama personal.', regalo: 'Amistad verdadera.' },
                12: { area: 'Espiritualidad y trascendencia', proposito: 'Disolver el ego', leccion: 'Conectar con lo trascendente. Servir sin reconocimiento.', desafio: 'Superar cr√≠tica excesiva.', regalo: 'Paz espiritual.' }
            };
            
            // NODO SUR por SIGNO
            const NS_SIGNO = {
                'Aries': { talento: 'Valent√≠a, acci√≥n r√°pida, liderazgo', soltar: 'Impulsividad, egocentrismo, agresi√≥n' },
                'Tauro': { talento: 'Estabilidad, sensualidad, paciencia', soltar: 'Posesividad, terquedad, materialismo' },
                'G√©minis': { talento: 'Inteligencia, comunicaci√≥n, versatilidad', soltar: 'Dispersi√≥n, superficialidad, chisme' },
                'C√°ncer': { talento: 'Nutrici√≥n, intuici√≥n, cuidado', soltar: 'Dependencia emocional, apego al pasado' },
                'Leo': { talento: 'Creatividad, generosidad, carisma', soltar: 'Necesidad de atenci√≥n, drama, ego' },
                'Virgo': { talento: 'An√°lisis, servicio, perfeccionismo √∫til', soltar: 'Cr√≠tica excesiva, preocupaci√≥n, rigidez' },
                'Libra': { talento: 'Diplomacia, est√©tica, cooperaci√≥n', soltar: 'Indecisi√≥n, dependencia del otro, evitar conflictos' },
                'Escorpio': { talento: 'Profundidad emocional, investigaci√≥n, regeneraci√≥n', soltar: 'Control, manipulaci√≥n, obsesi√≥n, resentimiento, secretos' },
                'Ofiuco': { talento: 'Sanaci√≥n, alquimia, transformaci√≥n', soltar: 'Cargar heridas ajenas, obsesi√≥n con sanar' },
                'Sagitario': { talento: 'Fe, visi√≥n amplia, ense√±anza', soltar: 'Dogmatismo, escapar en lo abstracto, exceso' },
                'Capricornio': { talento: 'Responsabilidad, estructura, logro', soltar: 'Frialdad, rigidez, obsesi√≥n con estatus' },
                'Acuario': { talento: 'Originalidad, visi√≥n de futuro', soltar: 'Frialdad emocional, rebeld√≠a vac√≠a' },
                'Pegaso': { talento: 'Inspiraci√≥n, visi√≥n elevada', soltar: 'Desconexi√≥n de la realidad' },
                'Piscis': { talento: 'Intuici√≥n, compasi√≥n, conexi√≥n espiritual', soltar: 'Escapismo, victimizaci√≥n, confusi√≥n, adicciones' }
            };
            
            // NODO SUR por CASA
            const NS_CASA = {
                1: { area: 'Tu identidad', talento: 'Liderazgo, iniciativa, independencia', soltar: 'Egocentrismo, impulsividad' },
                2: { area: 'Recursos propios', talento: 'Generar dinero, estabilidad', soltar: 'Apego material excesivo' },
                3: { area: 'Comunicaci√≥n y entorno cercano', talento: 'Inteligencia, facilidad de palabra, aprendizaje r√°pido', soltar: 'Dispersi√≥n mental, chisme, superficialidad intelectual' },
                4: { area: 'Hogar y familia', talento: 'Crear ambientes seguros, intuici√≥n', soltar: 'Dependencia familiar, vivir en el pasado' },
                5: { area: 'Creatividad', talento: 'Expresi√≥n art√≠stica, carisma', soltar: 'Drama, necesidad de atenci√≥n' },
                6: { area: 'Servicio', talento: 'Servicio, an√°lisis, detalle', soltar: 'Cr√≠tica excesiva, victimismo' },
                7: { area: 'Relaciones', talento: 'Diplomacia, cooperaci√≥n', soltar: 'Dependencia de otros' },
                8: { area: 'Transformaci√≥n', talento: 'Poder de regeneraci√≥n', soltar: 'Control, manipulaci√≥n' },
                9: { area: 'Filosof√≠a', talento: 'Visi√≥n amplia, fe, ense√±anza', soltar: 'Dogmatismo, escapar en lo abstracto' },
                10: { area: 'Carrera', talento: 'Ambici√≥n, responsabilidad', soltar: 'Obsesi√≥n con √©xito, frialdad' },
                11: { area: 'Grupos', talento: 'Visi√≥n de futuro, trabajo en equipo', soltar: 'Perderse en el colectivo' },
                12: { area: 'Espiritualidad', talento: 'Conexi√≥n espiritual, intuici√≥n', soltar: 'Escapismo, victimizaci√≥n, confusi√≥n' }
            };
            
            // Casas espirituales descripciones
            const CASA4_DESC = {
                'Aries': 'Ra√≠ces guerreras. Hogar activo. Ancestros pioneros.', 'Tauro': 'Ra√≠ces estables. Hogar como santuario. Ancestros conectados a la tierra.',
                'G√©minis': 'Ra√≠ces comunicativas. Hogar mental. Ancestros intelectuales.', 'C√°ncer': 'Ra√≠ces muy profundas. Hogar sagrado. Conexi√≥n ancestral fuerte.',
                'Leo': 'Ra√≠ces orgullosas. Hogar creativo. Ancestros de linaje.', 'Virgo': 'Ra√≠ces serviciales. Hogar ordenado. Ancestros trabajadores.',
                'Libra': 'Ra√≠ces armoniosas. Hogar bello. Ancestros diplom√°ticos.', 'Escorpio': 'Ra√≠ces intensas. Secretos familiares. Poder de regeneraci√≥n emocional.',
                'Ofiuco': 'Ra√≠ces sanadoras. Hogar como lugar de curaci√≥n. Ancestros sanadores o cham√°nicos. Renacimiento familiar.',
                'Sagitario': 'Ra√≠ces filos√≥ficas. Hogar expansivo. Ancestros viajeros.', 'Capricornio': 'Ra√≠ces tradicionales. Hogar estructurado. Ancestros de autoridad.',
                'Acuario': 'Ra√≠ces originales. Hogar poco convencional. Ancestros innovadores.', 'Pegaso': 'Ra√≠ces inspiradas. Hogar elevado. Ancestros visionarios.',
                'Piscis': 'Ra√≠ces m√≠sticas. Memorias de vidas pasadas. Hogar como refugio espiritual.'
            };
            
            const CASA8_DESC = {
                'Aries': 'Transformaci√≥n a trav√©s de la acci√≥n. Crisis que fortalecen. Renacimiento del guerrero interior.',
                'Tauro': 'Transformaci√≥n de valores. Crisis materiales que liberan. Renacimiento sensorial.',
                'G√©minis': 'Transformaci√≥n mental. Crisis de comunicaci√≥n. Renacimiento intelectual.',
                'C√°ncer': 'Transformaci√≥n emocional profunda. Crisis familiares inici√°ticas.',
                'Leo': 'Transformaci√≥n del ego. Crisis creativas. Renacimiento del coraz√≥n.',
                'Virgo': 'Transformaci√≥n del servicio. Crisis de salud que despiertan.',
                'Libra': 'Transformaci√≥n relacional. Crisis de pareja que evolucionan.',
                'Escorpio': 'Posici√≥n muy poderosa. Dominio de la transformaci√≥n. Conexi√≥n con muerte y renacimiento.',
                'Ofiuco': 'Sanaci√≥n profunda. Alquimia de las crisis. Cham√°n interior.',
                'Sagitario': 'Transformaci√≥n filos√≥fica. Crisis de fe que expanden.',
                'Capricornio': 'Transformaci√≥n estructural. Crisis de autoridad.',
                'Acuario': 'Transformaci√≥n colectiva. Crisis que liberan de lo convencional.',
                'Pegaso': 'Transformaci√≥n inspirada. Crisis que elevan el esp√≠ritu.',
                'Piscis': 'Transformaci√≥n m√≠stica. Crisis que disuelven. Renacimiento espiritual.'
            };
            
            const CASA9_DESC = {
                'Aries': 'Filosof√≠a de acci√≥n. Fe en el coraje. Viajes de aventura.',
                'Tauro': 'Filosof√≠a pr√°ctica. Fe en la naturaleza. Viajes de placer.',
                'G√©minis': 'Filosof√≠a de la mente. Fe en el conocimiento. Muchos viajes.',
                'C√°ncer': 'Filosof√≠a del coraz√≥n. Fe en la familia. Viajes al hogar ancestral.',
                'Leo': 'Filosof√≠a creativa. Fe en uno mismo. Viajes que transforman.',
                'Virgo': 'Filosof√≠a de servicio. Fe en el trabajo. Viajes de aprendizaje.',
                'Libra': 'Filosof√≠a del equilibrio. Fe en la justicia. Viajes en pareja.',
                'Escorpio': 'Filosof√≠a profunda. Fe en la transformaci√≥n. Viajes inici√°ticos.',
                'Ofiuco': 'Filosof√≠a de sanaci√≥n. Fe en el renacimiento. Viajes de curaci√≥n.',
                'Sagitario': '¬°Posici√≥n ideal! Filosof√≠a expansiva. Fe natural. Muchos viajes.',
                'Capricornio': 'Filosof√≠a pr√°ctica. Fe disciplinada. Viajes de trabajo.',
                'Acuario': 'Filosof√≠a revolucionaria. Fe en la humanidad. Viajes √∫nicos.',
                'Pegaso': 'Filosof√≠a inspirada. Fe visionaria. Viajes del alma.',
                'Piscis': 'Filosof√≠a m√≠stica. Fe intuitiva. Viajes espirituales.'
            };
            
            const CASA12_DESC = {
                'Aries': 'Karma de individualismo. Acci√≥n en soledad te regenera.',
                'Tauro': 'Karma de apegos materiales. Retiros en naturaleza.',
                'G√©minis': 'Karma de palabras. Escritura como sanaci√≥n.',
                'C√°ncer': 'Karma familiar. Hogar interior es tu templo.',
                'Leo': 'Karma de ego. Orgullo de vidas pasadas. Retiros creativos.',
                'Virgo': 'Karma de cr√≠tica. Purificaci√≥n es tu camino.',
                'Libra': 'Karma relacional. Equilibrio interno primero.',
                'Escorpio': 'Karma intenso pero regenerador. Gran poder oculto.',
                'Ofiuco': 'Karma de sanador. Alquimia espiritual profunda.',
                'Sagitario': 'Fe oculta pero poderosa. Maestros en sue√±os.',
                'Capricornio': 'Karma de autoridad. Disciplina espiritual seria.',
                'Acuario': 'Conexi√≥n con inconsciente colectivo. Innovaci√≥n espiritual.',
                'Pegaso': 'Visiones frecuentes. Inspiraci√≥n divina accesible.',
                'Piscis': '¬°Muy espiritual! Conexi√≥n directa con lo divino.'
            };
            
            // Neptuno en casas
            const NEPTUNO_CASAS = {
                1: 'Personalidad m√≠stica. Aura especial. Puede haber confusi√≥n de identidad.',
                2: 'Relaci√≥n difusa con el dinero. Ganancias por arte/espiritualidad.',
                3: 'Comunicaci√≥n intuitiva. Percepci√≥n extrasensorial. Hermanos espirituales.',
                4: 'Hogar como santuario. Familia con dones ps√≠quicos. Confusi√≥n sobre ra√≠ces.',
                5: 'Creatividad inspirada. Romances idealizados. Hijos especiales.',
                6: 'Sanaci√≥n como servicio. Sensibilidad a enfermedades. Trabajo espiritual.',
                7: 'Parejas art√≠sticas/espirituales. Idealizaci√≥n del otro.',
                8: 'Experiencias m√≠sticas profundas. Mediumnidad. Transformaci√≥n espiritual.',
                9: 'Filosof√≠a m√≠stica. Viajes espirituales. Maestros invisibles.',
                10: 'Vocaci√≥n art√≠stica/espiritual. Carrera difusa pero inspirada.',
                11: 'Amigos art√≠sticos/espirituales. Grupos de meditaci√≥n.',
                12: '¬°Posici√≥n muy poderosa! Conexi√≥n directa con lo divino. Dones ps√≠quicos fuertes.'
            };
            
            // Planetas en Casa 4, 8, 9, 12
            const planetasEnCasa4 = Object.entries(c.posiciones).filter(([n,p]) => p?.casa === 4 && !['ASC','MC','IC','DSC','Parte de Fortuna'].includes(n));
            const planetasEnCasa8 = Object.entries(c.posiciones).filter(([n,p]) => p?.casa === 8 && !['ASC','MC','IC','DSC','Parte de Fortuna'].includes(n));
            const planetasEnCasa9 = Object.entries(c.posiciones).filter(([n,p]) => p?.casa === 9 && !['ASC','MC','IC','DSC','Parte de Fortuna'].includes(n));
            const planetasEnCasa12 = Object.entries(c.posiciones).filter(([n,p]) => p?.casa === 12 && !['ASC','MC','IC','DSC','Parte de Fortuna'].includes(n));
            
            // Calcular indicador espiritual
            let puntuacion = 0;
            const factores = [];
            
            // Debug
            console.log('üßò Debug puntuaci√≥n:');
            console.log('  nodoNorte:', nodoNorte);
            console.log('  neptuno:', neptuno);
            console.log('  jupiter:', jupiter);
            console.log('  saturno:', saturno);
            console.log('  luna:', luna);
            
            // Nodo Norte en casas espirituales
            const nnCasaNum = nodoNorte?.casa;
            if (nnCasaNum === 9 || nnCasaNum === '9') { factores.push({ texto: 'Nodo Norte en Casa 9', puntos: 3 }); puntuacion += 3; }
            if (nnCasaNum === 12 || nnCasaNum === '12') { factores.push({ texto: 'Nodo Norte en Casa 12', puntos: 3 }); puntuacion += 3; }
            if (nnCasaNum === 8 || nnCasaNum === '8') { factores.push({ texto: 'Nodo Norte en Casa 8', puntos: 2 }); puntuacion += 2; }
            if (nnCasaNum === 4 || nnCasaNum === '4') { factores.push({ texto: 'Nodo Norte en Casa 4', puntos: 2 }); puntuacion += 2; }
            
            // Neptuno
            if (neptuno && neptuno.casa) {
                if ([9, 12].includes(neptuno.casa)) { factores.push({ texto: `Neptuno en Casa ${neptuno.casa}`, puntos: 5 }); puntuacion += 5; }
                else if ([3, 4, 8].includes(neptuno.casa)) { factores.push({ texto: `Neptuno en Casa ${neptuno.casa}`, puntos: 3 }); puntuacion += 3; }
            }
            
            // J√∫piter
            if (jupiter && jupiter.casa) {
                if (jupiter.casa === 9) { factores.push({ texto: 'J√∫piter en Casa 9', puntos: 5 }); puntuacion += 5; }
                else if (jupiter.casa === 12) { factores.push({ texto: 'J√∫piter en Casa 12', puntos: 4 }); puntuacion += 4; }
                else if (jupiter.casa === 4) { factores.push({ texto: 'J√∫piter en Casa 4', puntos: 2 }); puntuacion += 2; }
            }
            
            // Plut√≥n
            if (pluton && pluton.casa && [8, 12, 4].includes(pluton.casa)) { 
                factores.push({ texto: `Plut√≥n en Casa ${pluton.casa}`, puntos: 3 }); puntuacion += 3; 
            }
            
            // Saturno en casas k√°rmicas
            if (saturno && saturno.casa) {
                if ([8, 12].includes(saturno.casa)) { factores.push({ texto: `Saturno en Casa ${saturno.casa}`, puntos: 2 }); puntuacion += 2; }
            }
            
            // Luna
            if (luna) {
                if (luna.signo && ['Piscis', 'C√°ncer', 'Escorpio'].includes(luna.signo)) { 
                    factores.push({ texto: `Luna en ${luna.signo}`, puntos: 2 }); puntuacion += 2; 
                }
                if (luna.casa && [4, 8, 9, 12].includes(luna.casa)) {
                    factores.push({ texto: `Luna en Casa ${luna.casa}`, puntos: 2 }); puntuacion += 2;
                }
            }
            
            // Signos en casas espirituales
            if (['Sagitario', 'Piscis', 'Escorpio', 'C√°ncer'].includes(signoCasa9)) { 
                factores.push({ texto: `Casa 9 en ${signoCasa9}`, puntos: 2 }); puntuacion += 2; 
            }
            if (['Piscis', 'Escorpio', 'C√°ncer'].includes(signoCasa12)) { 
                factores.push({ texto: `Casa 12 en ${signoCasa12}`, puntos: 2 }); puntuacion += 2; 
            }
            if (['C√°ncer', 'Piscis', 'Escorpio'].includes(signoCasa4)) {
                factores.push({ texto: `Casa 4 en ${signoCasa4}`, puntos: 1 }); puntuacion += 1;
            }
            if (['Escorpio', 'Piscis', 'C√°ncer'].includes(signoCasa8)) {
                factores.push({ texto: `Casa 8 en ${signoCasa8}`, puntos: 1 }); puntuacion += 1;
            }
            
            const nivel = puntuacion >= 15 ? 'Muy Elevado' : puntuacion >= 10 ? 'Elevado' : puntuacion >= 5 ? 'Desarrollado' : 'En Desarrollo';
            const nivelColor = puntuacion >= 15 ? '#9b59b6' : puntuacion >= 10 ? '#8e44ad' : puntuacion >= 5 ? '#3498db' : '#7f8c8d';
            
            // Detectar dones espirituales
            const dones = [];
            if (neptuno && [3].includes(neptuno.casa)) dones.push({ icono: 'üì°', nombre: 'Canalizaci√≥n', desc: 'Capacidad de recibir mensajes de lo alto.', planeta: `Neptuno en Casa ${neptuno.casa}` });
            if (neptuno && [8, 12].includes(neptuno.casa)) dones.push({ icono: 'üëÅÔ∏è', nombre: 'Clarividencia', desc: 'Ver m√°s all√° del velo.', planeta: `Neptuno en Casa ${neptuno.casa}` });
            if (luna && [8, 12, 4].includes(luna.casa)) dones.push({ icono: 'üåô', nombre: 'Sensibilidad Ps√≠quica', desc: 'Percepci√≥n emocional profunda.', planeta: `Luna en Casa ${luna.casa}` });
            if (neptuno && [6, 12].includes(neptuno.casa)) dones.push({ icono: 'üôå', nombre: 'Sanaci√≥n', desc: 'Capacidad de canalizar energ√≠a sanadora.', planeta: `Neptuno en Casa ${neptuno.casa}` });
            if (jupiter && [9, 12].includes(jupiter.casa)) dones.push({ icono: 'üìñ', nombre: 'Ense√±anza', desc: 'Transmitir sabidur√≠a espiritual.', planeta: `J√∫piter en Casa ${jupiter.casa}` });
            if (luna?.signo === 'Piscis') dones.push({ icono: 'üíó', nombre: 'Compasi√≥n Profunda', desc: 'Empat√≠a universal.', planeta: 'Luna en Piscis' });
            if (pluton && [8, 12].includes(pluton.casa)) dones.push({ icono: 'ü¶ã', nombre: 'Transformaci√≥n', desc: 'Renacer de las cenizas.', planeta: `Plut√≥n en Casa ${pluton.casa}` });
            
            // Pr√°cticas recomendadas seg√∫n Neptuno
            const NEPTUNO_PRACTICAS = {
                1: 'Meditaci√≥n con movimiento. Yoga. Danza consciente.',
                2: 'Gratitud. Visualizaci√≥n de abundancia.',
                3: 'Escritura autom√°tica. Oraci√≥n. Mantras.',
                4: 'Altares en el hogar. Conexi√≥n con ancestros.',
                5: 'Arte como meditaci√≥n. Creatividad sagrada.',
                6: 'Servicio. Rituales de purificaci√≥n.',
                7: 'Meditaci√≥n en pareja. Tantra.',
                8: 'Respiraci√≥n transformadora. Trabajo con sombras.',
                9: 'Estudio filos√≥fico. Peregrinajes.',
                10: 'Dharma. Vocaci√≥n como servicio.',
                11: 'Meditaci√≥n grupal. C√≠rculos espirituales.',
                12: 'Retiros de silencio. Contemplaci√≥n. Sue√±os l√∫cidos.'
            };
            
            // Obtener info de nodos
            const nnCasa = nodoNorte?.casa || 9;
            const nnSigno = nodoNorte?.signo || signoCasa9;
            const nsCasa = nodoSur?.casa || 3;
            const nsSigno = nodoSur?.signo || 'Escorpio';
            
            console.log('üßò Nodos para mostrar:', { nnCasa, nnSigno, nsCasa, nsSigno });
            console.log('üßò Puntuaci√≥n final:', puntuacion, 'Factores:', factores);
            const infoNNCasa = NN_CASA[nnCasa] || NN_CASA[9];
            const infoNNSigno = NN_SIGNO[nnSigno] || NN_SIGNO['Tauro'];
            const infoNSCasa = NS_CASA[nsCasa] || NS_CASA[3];
            const infoNSSigno = NS_SIGNO[nsSigno] || NS_SIGNO['Escorpio'];
            
            // Construir HTML
            let html = `
                <!-- Indicador Espiritual -->
                <div class="analysis-card" style="background:linear-gradient(135deg, rgba(155,89,182,0.15), rgba(52,152,219,0.1));">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                        <div class="analysis-title" style="margin:0;">‚ú® Indicador de Desarrollo Espiritual</div>
                        <div style="display:flex;align-items:center;gap:10px;">
                            <div style="display:inline-block;padding:4px 12px;border-radius:20px;background:${nivelColor};color:white;font-size:0.8rem;font-weight:600;">${nivel}</div>
                            <div style="font-size:1.5rem;font-weight:700;color:${nivelColor};">+${puntuacion}</div>
                        </div>
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;">
                        ${factores.map(f => `<span style="padding:3px 8px;border-radius:12px;font-size:0.7rem;background:rgba(155,89,182,0.15);color:#9b59b6;">+${f.puntos} ${f.texto}</span>`).join('')}
                    </div>
                </div>
                
                <!-- NODOS LUNARES -->
                <div class="analysis-card" style="border-left:4px solid #9b59b6;">
                    <div class="analysis-title">‚òä‚òã Nodos Lunares - Camino del Alma</div>
                    
                    <!-- Nodo Norte -->
                    <div style="background:linear-gradient(135deg, rgba(155,89,182,0.1), rgba(155,89,182,0.05));padding:15px;border-radius:12px;margin-bottom:15px;">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                            <div style="font-size:1.8rem;">‚òä</div>
                            <div>
                                <div style="font-size:0.75rem;color:var(--text-dim);">NODO NORTE - Tu Destino</div>
                                <div style="font-weight:700;color:#9b59b6;">${SIGN_SYMBOLS[nnSigno] || '?'} ${nnSigno.toUpperCase()} en Casa ${nnCasa}</div>
                            </div>
                        </div>
                        <div style="font-size:0.85rem;margin-bottom:8px;"><strong>Prop√≥sito:</strong> ${infoNNCasa.proposito}</div>
                        <div style="font-size:0.85rem;margin-bottom:8px;"><strong>Lecci√≥n:</strong> ${infoNNCasa.leccion}</div>
                        <div style="font-size:0.85rem;margin-bottom:8px;"><strong>Desaf√≠o:</strong> ${infoNNSigno.desafio}</div>
                        <div style="font-size:0.85rem;color:var(--gold-light);"><strong>Regalo:</strong> ${infoNNCasa.regalo}</div>
                        <div style="font-size:0.8rem;margin-top:10px;padding:8px;background:var(--bg-elevated);border-radius:8px;">
                            <strong>Cualidades a desarrollar:</strong> ${infoNNSigno.cualidades}
                        </div>
                    </div>
                    
                    <!-- Nodo Sur -->
                    <div style="background:var(--bg-elevated);padding:15px;border-radius:12px;">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                            <div style="font-size:1.8rem;">‚òã</div>
                            <div>
                                <div style="font-size:0.75rem;color:var(--text-dim);">NODO SUR - Tu Pasado</div>
                                <div style="font-weight:700;color:#7f8c8d;">${SIGN_SYMBOLS[nsSigno] || '?'} ${nsSigno.toUpperCase()} en Casa ${nsCasa}</div>
                            </div>
                        </div>
                        <div style="font-size:0.85rem;margin-bottom:6px;"><strong>√Årea de vida:</strong> ${infoNSCasa.area}</div>
                        <div style="font-size:0.85rem;margin-bottom:6px;"><strong>Traes del pasado (casa):</strong> ${infoNSCasa.talento}</div>
                        <div style="font-size:0.85rem;margin-bottom:6px;"><strong>Traes del pasado (signo):</strong> ${infoNSSigno.talento}</div>
                        <div style="font-size:0.85rem;color:#e67e22;margin-bottom:4px;"><strong>A soltar (casa):</strong> ${infoNSCasa.soltar}</div>
                        <div style="font-size:0.85rem;color:#e74c3c;"><strong>A soltar (signo):</strong> ${infoNSSigno.soltar}</div>
                    </div>
                </div>`;
            
            // Parte del Esp√≠ritu
            if (parteEspiritu || c.parteFortuna) {
                const peSigno = parteEspiritu?.signo || c.casas[((c.parteFortuna?.casa || 1) + 5) % 12]?.signo || 'Aries';
                const peCasa = parteEspiritu?.casa || ((c.parteFortuna?.casa || 1) + 6) % 12 || 11;
                html += `
                <div class="analysis-card">
                    <div style="display:flex;align-items:center;gap:12px;background:linear-gradient(135deg, rgba(241,196,15,0.1), rgba(241,196,15,0.05));padding:15px;border-radius:12px;">
                        <div style="font-size:2rem;">‚òÄ</div>
                        <div style="flex:1;">
                            <div style="font-size:0.75rem;color:var(--text-dim);">Parte del Esp√≠ritu</div>
                            <div style="font-weight:700;color:var(--gold-light);">${SIGN_SYMBOLS[peSigno] || '?'} ${peSigno.toUpperCase()} en Casa ${peCasa}</div>
                            <div style="font-size:0.8rem;margin-top:6px;color:var(--text-dim);">
                                ${peCasa === 11 ? 'Tu esp√≠ritu sirve a la humanidad. Los grupos son tu sangha.' : 
                                  peCasa === 9 ? 'Tu esp√≠ritu busca la verdad. La filosof√≠a es tu camino.' :
                                  peCasa === 12 ? 'Tu esp√≠ritu busca la trascendencia. La meditaci√≥n es tu hogar.' :
                                  `Por casa ${peCasa}: Tu esp√≠ritu se expresa en esta √°rea de vida.`}
                            </div>
                        </div>
                    </div>
                </div>`;
            }
            
            // Dones Espirituales
            if (dones.length > 0) {
                html += `
                <div class="analysis-card">
                    <div class="analysis-title">üéÅ Tus Dones Espirituales</div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:10px;">
                        ${dones.map(d => `
                            <div style="background:var(--bg-elevated);padding:12px;border-radius:10px;text-align:center;">
                                <div style="font-size:1.5rem;">${d.icono}</div>
                                <div style="font-weight:600;font-size:0.85rem;">${d.nombre}</div>
                                <div style="font-size:0.7rem;color:var(--text-dim);">${d.desc}</div>
                                <div style="font-size:0.65rem;color:#9b59b6;margin-top:4px;">${d.planeta}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }
            
            // Recomendaciones
            html += `
                <div class="analysis-card" style="background:linear-gradient(135deg, rgba(46,204,113,0.1), rgba(46,204,113,0.05));">
                    <div class="analysis-title">üìã Recomendaciones para tu Desarrollo</div>
                    <div style="display:grid;gap:10px;">
                        <div style="background:var(--bg-elevated);padding:10px;border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-dim);">‚òä Tu Prop√≥sito de Vida</div>
                            <div style="font-weight:600;">${infoNNCasa.proposito}</div>
                        </div>
                        ${neptuno ? `
                        <div style="background:var(--bg-elevated);padding:10px;border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-dim);">‚ôÜ Pr√°cticas para tu Neptuno</div>
                            <div style="font-weight:600;">${NEPTUNO_PRACTICAS[neptuno.casa] || 'Meditaci√≥n diaria.'}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>`;
            
            // Planetas Espirituales
            html += `
                <div class="analysis-card">
                    <div class="analysis-title">üåü Planetas Espirituales</div>
                    <div style="display:grid;gap:12px;">
                        ${neptuno ? `
                        <div style="background:var(--bg-elevated);padding:15px;border-radius:12px;border-left:3px solid #3498db;">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:1.8rem;">‚ôÜ</div>
                                <div>
                                    <div style="font-weight:600;">Neptuno - El M√≠stico</div>
                                    <div style="font-size:0.8rem;color:#3498db;">Conexi√≥n Divina</div>
                                </div>
                            </div>
                            <div style="font-size:0.85rem;margin-bottom:6px;">Casa ${neptuno.casa} en ${SIGN_SYMBOLS[neptuno.signo]} ${neptuno.signo.toUpperCase()}</div>
                            <div style="font-size:0.8rem;color:var(--text-dim);">${NEPTUNO_CASAS[neptuno.casa] || ''}</div>
                        </div>
                        ` : ''}
                        ${jupiter ? `
                        <div style="background:var(--bg-elevated);padding:15px;border-radius:12px;border-left:3px solid #9b59b6;">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:1.8rem;">‚ôÉ</div>
                                <div>
                                    <div style="font-weight:600;">J√∫piter - El Maestro</div>
                                    <div style="font-size:0.8rem;color:#9b59b6;">Expansi√≥n Espiritual</div>
                                </div>
                            </div>
                            <div style="font-size:0.85rem;margin-bottom:6px;">Casa ${jupiter.casa} en ${SIGN_SYMBOLS[jupiter.signo]} ${jupiter.signo.toUpperCase()}</div>
                            <div style="font-size:0.8rem;color:var(--text-dim);">${jupiter.casa === 9 ? 'Amigos benefactores. Grupos de crecimiento. Metas elevadas.' : jupiter.casa === 12 ? '√Ångel guardi√°n fuerte. Protecci√≥n invisible.' : 'Expansi√≥n a trav√©s de esta √°rea de vida.'}</div>
                        </div>
                        ` : ''}
                        ${pluton ? `
                        <div style="background:var(--bg-elevated);padding:15px;border-radius:12px;border-left:3px solid #8e44ad;">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:1.8rem;">‚ôá</div>
                                <div>
                                    <div style="font-weight:600;">Plut√≥n - El Transformador</div>
                                    <div style="font-size:0.8rem;color:#8e44ad;">Muerte y Renacimiento</div>
                                </div>
                            </div>
                            <div style="font-size:0.85rem;margin-bottom:6px;">Casa ${pluton.casa} en ${SIGN_SYMBOLS[pluton.signo]} ${pluton.signo.toUpperCase()}</div>
                            <div style="font-size:0.8rem;color:var(--text-dim);">${pluton.casa === 1 ? 'Presencia magn√©tica. Poder de transformaci√≥n personal. Renacimientos constantes.' : pluton.casa === 8 ? 'Posici√≥n muy poderosa. Dominio de la muerte y renacimiento.' : 'Transformaci√≥n profunda en esta √°rea.'}</div>
                        </div>
                        ` : ''}
                        ${saturno ? `
                        <div style="background:var(--bg-elevated);padding:15px;border-radius:12px;border-left:3px solid #7f8c8d;">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:1.8rem;">‚ôÑ</div>
                                <div>
                                    <div style="font-weight:600;">Saturno - El Maestro K√°rmico</div>
                                    <div style="font-size:0.8rem;color:#7f8c8d;">Lecciones del Alma</div>
                                </div>
                            </div>
                            <div style="font-size:0.85rem;margin-bottom:6px;">Casa ${saturno.casa} en ${SIGN_SYMBOLS[saturno.signo]} ${saturno.signo.toUpperCase()}</div>
                            <div style="font-size:0.8rem;color:var(--text-dim);">${saturno.casa === 8 ? 'Transformaci√≥n lenta pero profunda. Herencias con responsabilidad.' : saturno.casa === 12 ? 'Karma pesado pero liberador. Maestr√≠a espiritual tard√≠a.' : 'Lecciones k√°rmicas en esta √°rea de vida.'}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>`;
            
            // Casas Espirituales
            html += `
                <div class="analysis-card">
                    <div class="analysis-title">üèõÔ∏è Casas de Espiritualidad</div>
                    <div style="display:grid;gap:15px;">
                        <!-- Casa 4 -->
                        <div style="background:var(--bg-elevated);padding:15px;border-radius:12px;">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                                <div style="font-size:1.5rem;">üè†</div>
                                <div>
                                    <div style="font-weight:600;">Casa del Alma</div>
                                    <div style="font-size:0.75rem;color:var(--text-dim);">Ra√≠ces del Ser</div>
                                </div>
                            </div>
                            <div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:8px;">üí° Fundamento emocional, conexi√≥n ancestral, el hogar interior, memorias del alma.</div>
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                                <span style="font-size:1.3rem;">${SIGN_SYMBOLS[signoCasa4] || '?'}</span>
                                <span style="font-weight:600;">${signoCasa4.toUpperCase()}</span>
                                <span style="font-size:0.75rem;color:var(--text-dim);">${ELEMENTOS[signoCasa4]}</span>
                            </div>
                            <div style="font-size:0.8rem;color:var(--text-dim);">${CASA4_DESC[signoCasa4] || ''}</div>
                            ${posRegenteCasa4 ? `<div style="font-size:0.75rem;margin-top:8px;color:#9b59b6;">Regente: ${PLANET_SYMBOLS[regenteCasa4] || '?'} ${regenteCasa4.toUpperCase()} ‚Üí Casa ${posRegenteCasa4.casa} en ${SIGN_SYMBOLS[posRegenteCasa4.signo]} ${posRegenteCasa4.signo}</div>` : ''}
                            ${planetasEnCasa4.length > 0 ? `<div style="font-size:0.75rem;margin-top:6px;">ü™ê Planetas: ${planetasEnCasa4.map(([n,p]) => `${PLANET_SYMBOLS[n]||'?'} ${n} ${SIGN_SYMBOLS[p.signo]||''}`).join(', ')}</div>` : ''}
                        </div>
                        
                        <!-- Casa 8 -->
                        <div style="background:var(--bg-elevated);padding:15px;border-radius:12px;">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                                <div style="font-size:1.5rem;">ü¶ã</div>
                                <div>
                                    <div style="font-weight:600;">Casa de la Transformaci√≥n</div>
                                    <div style="font-size:0.75rem;color:var(--text-dim);">Muerte y Renacimiento</div>
                                </div>
                            </div>
                            <div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:8px;">üí° Transformaci√≥n profunda, crisis espirituales, poder interior, sexualidad sagrada, misterios ocultos.</div>
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                                <span style="font-size:1.3rem;">${SIGN_SYMBOLS[signoCasa8] || '?'}</span>
                                <span style="font-weight:600;">${signoCasa8.toUpperCase()}</span>
                                <span style="font-size:0.75rem;color:var(--text-dim);">${ELEMENTOS[signoCasa8]}</span>
                            </div>
                            <div style="font-size:0.8rem;color:var(--text-dim);">${CASA8_DESC[signoCasa8] || ''}</div>
                            ${posRegenteCasa8 ? `<div style="font-size:0.75rem;margin-top:8px;color:#9b59b6;">Regente: ${PLANET_SYMBOLS[regenteCasa8] || '?'} ${regenteCasa8.toUpperCase()} ‚Üí Casa ${posRegenteCasa8.casa} en ${SIGN_SYMBOLS[posRegenteCasa8.signo]} ${posRegenteCasa8.signo}</div>` : ''}
                            ${planetasEnCasa8.length > 0 ? `<div style="font-size:0.75rem;margin-top:6px;">ü™ê Planetas: ${planetasEnCasa8.map(([n,p]) => `${PLANET_SYMBOLS[n]||'?'} ${n} ${SIGN_SYMBOLS[p.signo]||''}`).join(', ')}</div>` : ''}
                        </div>
                        
                        <!-- Casa 9 -->
                        <div style="background:var(--bg-elevated);padding:15px;border-radius:12px;">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                                <div style="font-size:1.5rem;">üîÆ</div>
                                <div>
                                    <div style="font-weight:600;">Casa de la Filosof√≠a</div>
                                    <div style="font-size:0.75rem;color:var(--text-dim);">B√∫squeda de Sentido</div>
                                </div>
                            </div>
                            <div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:8px;">üí° Creencias, filosof√≠a de vida, maestros espirituales, viajes del alma, educaci√≥n superior, expansi√≥n de conciencia.</div>
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                                <span style="font-size:1.3rem;">${SIGN_SYMBOLS[signoCasa9] || '?'}</span>
                                <span style="font-weight:600;">${signoCasa9.toUpperCase()}</span>
                                <span style="font-size:0.75rem;color:var(--text-dim);">${ELEMENTOS[signoCasa9]}</span>
                            </div>
                            <div style="font-size:0.8rem;color:var(--text-dim);">${CASA9_DESC[signoCasa9] || ''}</div>
                            ${posRegenteCasa9 ? `<div style="font-size:0.75rem;margin-top:8px;color:#9b59b6;">Regente: ${PLANET_SYMBOLS[regenteCasa9] || '?'} ${regenteCasa9.toUpperCase()} ‚Üí Casa ${posRegenteCasa9.casa} en ${SIGN_SYMBOLS[posRegenteCasa9.signo]} ${posRegenteCasa9.signo}</div>` : ''}
                            ${planetasEnCasa9.length > 0 ? `<div style="font-size:0.75rem;margin-top:6px;">ü™ê Planetas: ${planetasEnCasa9.map(([n,p]) => `${PLANET_SYMBOLS[n]||'?'} ${n} ${SIGN_SYMBOLS[p.signo]||''}`).join(', ')}</div>` : ''}
                        </div>
                        
                        <!-- Casa 12 -->
                        <div style="background:var(--bg-elevated);padding:15px;border-radius:12px;">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                                <div style="font-size:1.5rem;">üåå</div>
                                <div>
                                    <div style="font-weight:600;">Casa de la Espiritualidad</div>
                                    <div style="font-size:0.75rem;color:var(--text-dim);">Lo Trascendente</div>
                                </div>
                            </div>
                            <div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:8px;">üí° Conexi√≥n con lo divino, karma, vida pasada, retiros, meditaci√≥n, sacrificio, el inconsciente colectivo.</div>
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                                <span style="font-size:1.3rem;">${SIGN_SYMBOLS[signoCasa12] || '?'}</span>
                                <span style="font-weight:600;">${signoCasa12.toUpperCase()}</span>
                                <span style="font-size:0.75rem;color:var(--text-dim);">${ELEMENTOS[signoCasa12]}</span>
                            </div>
                            <div style="font-size:0.8rem;color:var(--text-dim);">${CASA12_DESC[signoCasa12] || ''}</div>
                            ${posRegenteCasa12 ? `<div style="font-size:0.75rem;margin-top:8px;color:#9b59b6;">Regente: ${PLANET_SYMBOLS[regenteCasa12] || '?'} ${regenteCasa12.toUpperCase()} ‚Üí Casa ${posRegenteCasa12.casa} en ${SIGN_SYMBOLS[posRegenteCasa12.signo]} ${posRegenteCasa12.signo}</div>` : ''}
                            ${planetasEnCasa12.length > 0 ? `<div style="font-size:0.75rem;margin-top:6px;">ü™ê Planetas: ${planetasEnCasa12.map(([n,p]) => `${PLANET_SYMBOLS[n]||'?'} ${n} ${SIGN_SYMBOLS[p.signo]||''}`).join(', ')}</div>` : ''}
                        </div>
                    </div>
                </div>`;
            
            // S√≠ntesis
            html += `
                <div class="analysis-card" style="background:linear-gradient(135deg, rgba(155,89,182,0.1), rgba(52,152,219,0.05));">
                    <div class="analysis-title">üîÆ S√≠ntesis Espiritual</div>
                    <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:10px;">
                        <div style="background:var(--bg-card);padding:10px;border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-dim);">‚òä Prop√≥sito del Alma</div>
                            <div style="font-weight:600;">${infoNNCasa.proposito}</div>
                        </div>
                        <div style="background:var(--bg-card);padding:10px;border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-dim);">üè† Casa 4 (Alma)</div>
                            <div style="font-weight:600;">${SIGN_SYMBOLS[signoCasa4]} ${signoCasa4.toUpperCase()}</div>
                        </div>
                        <div style="background:var(--bg-card);padding:10px;border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-dim);">ü¶ã Casa 8 (Transformaci√≥n)</div>
                            <div style="font-weight:600;">${SIGN_SYMBOLS[signoCasa8]} ${signoCasa8.toUpperCase()}</div>
                        </div>
                        <div style="background:var(--bg-card);padding:10px;border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-dim);">üîÆ Casa 9 (Filosof√≠a)</div>
                            <div style="font-weight:600;">${SIGN_SYMBOLS[signoCasa9]} ${signoCasa9.toUpperCase()}</div>
                        </div>
                        <div style="background:var(--bg-card);padding:10px;border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-dim);">üåå Casa 12 (Esp√≠ritu)</div>
                            <div style="font-weight:600;">${SIGN_SYMBOLS[signoCasa12]} ${signoCasa12.toUpperCase()}</div>
                        </div>
                        <div style="background:var(--bg-card);padding:10px;border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-dim);">‚ú® Nivel Espiritual</div>
                            <div style="font-weight:600;color:${nivelColor};">+${puntuacion} (${nivel})</div>
                        </div>
                        <div style="background:var(--bg-card);padding:10px;border-radius:8px;grid-column:span 2;">
                            <div style="font-size:0.75rem;color:var(--text-dim);">üéÅ Dones Detectados</div>
                            <div style="font-weight:600;">${dones.length} ${dones.length === 1 ? 'don' : 'dones'}</div>
                        </div>
                    </div>
                </div>`;
            
            document.getElementById('tab-espiritual').innerHTML = html;
            console.log('üßò Espiritual renderizado OK');
            
        } catch (error) {
            console.error('‚ùå Error en renderEspiritual:', error);
            document.getElementById('tab-espiritual').innerHTML = `
                <div class="analysis-card" style="background:rgba(231,76,60,0.1);border:1px solid #e74c3c;">
                    <div class="analysis-title">‚ùå Error</div>
                    <p>${error.message}</p>
                </div>`;
        }
    }
    
    // ========================================================================
    // HOGAR - Bienes Ra√≠ces (Casa 4)
    // ========================================================================
    
    function renderHogar() {
        try {
            const c = perfilState.cartaNatal;
            if (!c || !c.casas) {
                document.getElementById('tab-hogar').innerHTML = '<div class="analysis-card"><p>Error: Calcula tu carta primero.</p></div>';
                return;
            }
            
            // El IC es el punto opuesto al MC (MC + 180¬∞)
            const icLon = (c.mcLon + 180) % 360;
            const signoIC = getSignoDesdeLongitud(icLon);
            
            console.log('üè† Hogar renderizado OK');
            console.log('  MC:', c.mcLon?.toFixed(2), '‚Üí', c.posiciones['MC']?.signo);
            console.log('  IC:', icLon.toFixed(2), '‚Üí', signoIC);
            
            // Datos b√°sicos
            const signoCasa3 = c.casas[2]?.signo || 'Aries';
            const signoCasa5 = c.casas[4]?.signo || 'Aries';
            const regenteIC = REGENTES[signoIC] || 'Marte';
            const posRegenteIC = c.posiciones[regenteIC];
            const regenteCasa3 = REGENTES[signoCasa3] || 'Marte';
            const regenteCasa5 = REGENTES[signoCasa5] || 'Sol';
            const luna = c.posiciones['Luna'] || {signo: 'Aries', casa: 1};
            const saturno = c.posiciones['Saturno'] || {signo: 'Aries', casa: 1};
            
            // Elemento del signo
            const ELEMENTOS = {
                'Aries': 'Fuego', 'Tauro': 'Tierra', 'G√©minis': 'Aire', 'C√°ncer': 'Agua',
                'Leo': 'Fuego', 'Virgo': 'Tierra', 'Libra': 'Aire', 'Escorpio': 'Agua',
                'Ofiuco': 'Agua', 'Sagitario': 'Fuego', 'Capricornio': 'Tierra',
                'Acuario': 'Aire', 'Pegaso': 'Agua', 'Piscis': 'Agua'
            };
            
            // IC completo por signo
            const IC_INFO = {
                'Aries': { desc: 'Hogar activo, din√°mico, a veces conflictivo. Las ra√≠ces est√°n en la independencia y la acci√≥n. Posible competencia o conflictos familiares.', tipo: 'Propiedades nuevas, en construcci√≥n, que necesitan reforma. Terrenos v√≠rgenes.', ubicacion: 'Zonas nuevas, en desarrollo, cerca de gimnasios o instalaciones deportivas', consejo: 'Buscar propiedades donde puedas ser pionero. Evitar vecinos conflictivos.', padre: 'Padre activo, emprendedor, posiblemente ausente o conflictivo', herencia: 'Herencias que requieren acci√≥n inmediata o est√°n en disputa' },
                'Tauro': { desc: 'Hogar estable, confortable, con √©nfasis en lo material. Las ra√≠ces est√°n en la seguridad y los placeres. Patrimonio familiar s√≥lido.', tipo: 'Propiedades s√≥lidas, de buena construcci√≥n, con jard√≠n. Fincas r√∫sticas, tierras de cultivo.', ubicacion: 'Zonas residenciales estables, cerca de naturaleza, √°reas rurales', consejo: 'Invertir en propiedades que aumenten de valor con el tiempo. Priorizar calidad.', padre: 'Padre proveedor, estable, posiblemente materialista', herencia: 'Herencias de tierras, propiedades o valores tangibles' },
                'G√©minis': { desc: 'Hogar comunicativo, con movimiento, posibles mudanzas frecuentes. Las ra√≠ces est√°n en el intercambio y la versatilidad.', tipo: 'Apartamentos, propiedades peque√±as y vers√°tiles, locales comerciales, d√∫plex.', ubicacion: 'Zonas urbanas, cerca de transporte, escuelas, comercios', consejo: 'Considerar propiedades que puedan alquilarse o tener usos m√∫ltiples.', padre: 'Padre comunicativo, intelectual, posiblemente ausente o distante', herencia: 'Herencias divididas, documentos, propiedades peque√±as' },
                'C√°ncer': { desc: 'El hogar es absolutamente central. Profundo apego a la familia y las ra√≠ces. Propiedades heredadas o con historia emocional.', tipo: 'Casas familiares, propiedades antiguas con historia, cerca del agua, cocinas grandes.', ubicacion: 'Cerca de agua (mar, r√≠o, lago), barrios familiares, zonas tradicionales', consejo: 'El factor emocional es clave en la compra. Buscar propiedades que "sientas" como hogar.', padre: 'Madre muy influyente en el hogar, figura paterna puede ser emocional o ausente', herencia: 'Herencias familiares importantes, propiedades de generaci√≥n en generaci√≥n' },
                'Leo': { desc: 'Hogar como expresi√≥n del ego, lugar de orgullo y creatividad. Las ra√≠ces est√°n en el reconocimiento y la generosidad.', tipo: 'Propiedades grandes, lujosas, con presencia. Casas con espacio para entretener.', ubicacion: 'Zonas prestigiosas, barrios exclusivos, propiedades con vistas', consejo: 'El prestigio de la ubicaci√≥n importa. Buscar propiedades que impresionen.', padre: 'Padre orgulloso, generoso, posiblemente dominante o ausente', herencia: 'Herencias generosas o conflictos de ego por la herencia' },
                'Virgo': { desc: 'Hogar ordenado, funcional, modesto. Las ra√≠ces est√°n en el servicio y la utilidad. Propiedades que requieren mantenimiento detallado.', tipo: 'Propiedades pr√°cticas, bien mantenidas, con espacio para trabajo. Huertos.', ubicacion: 'Zonas tranquilas, cerca de servicios de salud, √°reas ordenadas', consejo: 'Inspeccionar minuciosamente antes de comprar. Buscar propiedades bien mantenidas.', padre: 'Padre trabajador, servicial, posiblemente cr√≠tico o preocupado', herencia: 'Herencias modestas pero bien administradas, documentos en orden' },
                'Libra': { desc: 'Hogar armonioso, bello, lugar de encuentro social. Las ra√≠ces est√°n en el equilibrio y las relaciones.', tipo: 'Propiedades elegantes, bien decoradas, con buen dise√±o. Espacios para socializar.', ubicacion: 'Zonas elegantes, cerca de arte, cultura, lugares bonitos', consejo: 'La est√©tica y la armon√≠a son importantes. Considerar la opini√≥n de la pareja.', padre: 'Padre diplom√°tico, elegante, posiblemente ausente o indeciso', herencia: 'Herencias que requieren negociaci√≥n o se comparten con socios' },
                'Escorpio': { desc: 'Hogar intenso, privado, posibles secretos familiares. Las ra√≠ces est√°n en el poder y la transformaci√≥n. Propiedades con historia oculta.', tipo: 'Propiedades con s√≥tanos, espacios privados, ocultas de la vista. Casas antiguas con historia.', ubicacion: 'Zonas apartadas, privadas, posiblemente cerca de cementerios o lugares con historia', consejo: 'Investigar bien la historia de la propiedad. Puede haber secretos o cargas ocultas.', padre: 'Padre intenso, controlador, posibles secretos o ausencia significativa', herencia: 'Herencias complejas, posibles disputas de poder, recursos ocultos' },
                'Ofiuco': { desc: 'Hogar como lugar de transformaci√≥n y sanaci√≥n. Las ra√≠ces est√°n en la regeneraci√≥n.', tipo: 'Propiedades renovadas, transformadas, con potencial de regeneraci√≥n.', ubicacion: 'Zonas en proceso de transformaci√≥n, cerca de centros de sanaci√≥n', consejo: 'Buscar propiedades con potencial de transformaci√≥n. Puede requerir trabajo profundo.', padre: 'Figura paterna sanadora o ausente por circunstancias intensas', herencia: 'Herencias que transforman la vida, posibles cargas k√°rmicas' },
                'Sagitario': { desc: 'Hogar expansivo, filos√≥fico, posiblemente en el extranjero. Las ra√≠ces est√°n en la libertad y el conocimiento.', tipo: 'Propiedades grandes, con terreno, casas de campo, propiedades en el extranjero.', ubicacion: 'Zonas rurales amplias, cerca de universidades, en el extranjero', consejo: 'Considerar propiedades lejos de donde naciste. Espacio y libertad son clave.', padre: 'Padre filos√≥fico, viajero, posiblemente ausente o extranjero', herencia: 'Herencias de tierras, propiedades en el extranjero, legados filos√≥ficos' },
                'Capricornio': { desc: 'Hogar estructurado, tradicional, con √©nfasis en el estatus. Las ra√≠ces est√°n en la ambici√≥n y la responsabilidad.', tipo: 'Propiedades antiguas, de piedra, s√≥lidas. Edificios hist√≥ricos, fincas tradicionales.', ubicacion: 'Zonas tradicionales, barrios establecidos, cerca de monta√±as', consejo: 'Invertir a largo plazo. Propiedades que ganan valor con el tiempo.', padre: 'Padre autoritario, trabajador, posiblemente fr√≠o o muy exigente', herencia: 'Herencias que vienen con responsabilidades, patrimonio familiar tradicional' },
                'Acuario': { desc: 'Hogar poco convencional, moderno, comunitario. Las ra√≠ces est√°n en la independencia y los ideales.', tipo: 'Propiedades modernas, tecnol√≥gicas, lofts, co-housing, eco-viviendas.', ubicacion: 'Zonas innovadoras, barrios alternativos, cerca de tecnolog√≠a', consejo: 'Buscar propiedades √∫nicas o poco convencionales. Considerar comunidades.', padre: 'Padre original, distante, posiblemente ausente o poco convencional', herencia: 'Herencias inesperadas, propiedades inusuales, legados a comunidades' },
                'Pegaso': { desc: 'Hogar inspirador, elevado, conectado con lo sublime. Las ra√≠ces est√°n en la inspiraci√≥n y la libertad.', tipo: 'Propiedades con vistas elevadas, lugares inspiradores, cerca de espacios abiertos.', ubicacion: 'Zonas elevadas, con vistas panor√°micas, lugares inspiradores', consejo: 'Buscar propiedades que eleven el esp√≠ritu. La inspiraci√≥n del lugar es clave.', padre: 'Figura paterna inspiradora o ausente', herencia: 'Herencias que elevan o inspiran' },
                'Piscis': { desc: 'Hogar espiritual, art√≠stico, posiblemente confuso o idealizado. Las ra√≠ces est√°n en la compasi√≥n y lo trascendente.', tipo: 'Propiedades cerca del agua, casas art√≠sticas, retiros espirituales.', ubicacion: 'Cerca del mar, lagos, zonas tranquilas, retiros', consejo: 'Cuidado con idealizar propiedades. Verificar bien estado real. Confiar en la intuici√≥n.', padre: 'Padre art√≠stico, espiritual, posiblemente ausente, adicto o idealizado', herencia: 'Herencias confusas, posibles deudas ocultas, legados espirituales' }
            };
            
            // Regente del IC en casas
            const REGENTE_CASAS = {
                1: 'Tu identidad est√° profundamente conectada con tu hogar y ra√≠ces. Llevas tu casa contigo. Las propiedades reflejan qui√©n eres.',
                2: 'Las propiedades son fuente importante de ingresos. Bienes ra√≠ces como negocio natural. El patrimonio familiar afecta tus finanzas.',
                3: 'Propiedades cerca de donde naciste o en tu entorno cercano. Hermanos pueden influir en temas de propiedad. Documentos y contratos importantes. M√∫ltiples propiedades peque√±as.',
                4: 'El regente en su propia casa. Muy fuerte conexi√≥n con el hogar. Propiedades como tema central de vida. Herencias inmobiliarias importantes.',
                5: 'Propiedades como inversi√≥n especulativa. Ganancias (o p√©rdidas) por inmuebles. Hijos influyen en decisiones de vivienda.',
                6: 'Propiedades conectadas con el trabajo. Vivir cerca del trabajo o trabajar desde casa. Propiedades que requieren mantenimiento constante.',
                7: 'La pareja influye significativamente en temas de propiedad. Comprar con socios. Propiedades a trav√©s del matrimonio.',
                8: 'Propiedades a trav√©s de herencias, pr√©stamos o recursos de otros. Hipotecas importantes. Transformaciones profundas del hogar.',
                9: 'Propiedades en el extranjero o lejos de donde naciste. Inmuebles a trav√©s de educaci√≥n o filosof√≠a. Expandir patrimonio inmobiliario.',
                10: 'El hogar afecta tu carrera o viceversa. Propiedades prestigiosas. Trabajar en bienes ra√≠ces como profesi√≥n.',
                11: 'Amigos influyen en decisiones de propiedad. Comprar en comunidad o co-housing. Propiedades poco convencionales.',
                12: 'Propiedades ocultas, secretas o en lugares aislados. Posibles p√©rdidas inmobiliarias que vigilar. Retiros espirituales.'
            };
            
            // Luna en casas - residencia
            const LUNA_CASAS = {
                1: 'Identificaci√≥n emocional con el hogar. Cambias de casa seg√∫n cambias t√∫.',
                2: 'Seguridad emocional ligada a poseer propiedades. Cambios por motivos econ√≥micos.',
                3: 'Muchos cambios de residencia, especialmente en la juventud. Vivir cerca de hermanos.',
                4: 'Fuert√≠sima necesidad de hogar. Muchos cambios pero siempre buscando ra√≠ces.',
                5: 'Cambios de residencia por hijos o creatividad. El hogar como lugar de expresi√≥n.',
                6: 'Cambios de residencia por trabajo o salud. Necesidad de orden en el hogar.',
                7: 'Cambios de residencia por pareja o matrimonio. El otro influye en d√≥nde vives.',
                8: 'Cambios de residencia por crisis o transformaciones. Herencias que cambian tu vivienda.',
                9: 'Cambios de residencia al extranjero. Vivir lejos de donde naciste. Mudanzas por estudios.',
                10: 'Cambios de residencia por carrera. El hogar afecta tu imagen p√∫blica.',
                11: 'Cambios de residencia por amigos o ideales. Vivir en comunidad.',
                12: 'Cambios de residencia forzados o por circunstancias ocultas. Necesidad de retiro.'
            };
            
            // Dignidades
            function calcDignidad(planeta, signo) {
                const DIGNIDADES = {
                    'Sol': { exalt: ['Leo','Aries','Capricornio','Virgo'], dom: ['Escorpio','G√©minis','Pegaso'], exilio: ['Tauro','Sagitario'], caida: ['C√°ncer','Piscis','Libra','Acuario','Ofiuco'] },
                    'Luna': { exalt: ['C√°ncer','Piscis','Libra','Acuario','Ofiuco'], dom: ['Tauro','Sagitario'], exilio: ['Escorpio','G√©minis','Pegaso'], caida: ['Leo','Aries','Capricornio','Virgo'] },
                    'Mercurio': { exalt: ['G√©minis','Capricornio','Virgo'], dom: ['Leo','Aries','Escorpio','Pegaso'], exilio: ['C√°ncer','Piscis','Sagitario'], caida: ['Tauro','Libra','Acuario','Ofiuco'] },
                    'Venus': { exalt: ['Tauro','Libra','Acuario','Ofiuco'], dom: ['C√°ncer','Piscis','Sagitario'], exilio: ['Leo','Aries','Escorpio','Pegaso'], caida: ['G√©minis','Capricornio','Virgo'] },
                    'Marte': { exalt: ['Leo','Aries','Escorpio','Pegaso'], dom: ['G√©minis','Capricornio','Virgo'], exilio: ['Tauro','Libra','Acuario','Ofiuco'], caida: ['C√°ncer','Piscis','Sagitario'] },
                    'J√∫piter': { exalt: ['C√°ncer','Piscis','Sagitario','Pegaso'], dom: ['Tauro','Libra','Acuario','Ofiuco'], exilio: ['G√©minis','Capricornio','Virgo'], caida: ['Leo','Aries','Escorpio'] },
                    'Saturno': { exalt: ['Ofiuco','G√©minis','Libra','Acuario'], dom: ['Leo','Aries','Sagitario'], exilio: ['C√°ncer','Piscis','Escorpio','Pegaso'], caida: ['Tauro','Capricornio','Virgo'] }
                };
                const d = DIGNIDADES[planeta];
                if (!d) return null;
                if (d.exalt?.includes(signo)) return { tipo: 'exaltacion', texto: 'Exaltaci√≥n', color: '#4caf50' };
                if (d.dom?.includes(signo)) return { tipo: 'domicilio', texto: 'Domicilio', color: '#2196f3' };
                if (d.exilio?.includes(signo)) return { tipo: 'exilio', texto: 'Exilio', color: '#ff9800' };
                if (d.caida?.includes(signo)) return { tipo: 'caida', texto: 'Ca√≠da', color: '#f44336' };
                return null;
            }
            
            // Planetas en Casa 4
            const excluir = ['ASC', 'MC', 'Parte de Fortuna'];
            const planetasEnCasa4 = Object.entries(c.posiciones)
                .filter(([nombre, data]) => data && data.casa === 4 && !excluir.includes(nombre));
            
            // Planetas en Casa 3 y 5
            const planetasEnCasa3 = Object.entries(c.posiciones)
                .filter(([nombre, data]) => data && data.casa === 3 && !excluir.includes(nombre));
            const planetasEnCasa5 = Object.entries(c.posiciones)
                .filter(([nombre, data]) => data && data.casa === 5 && !excluir.includes(nombre));
            
            const info = IC_INFO[signoIC] || IC_INFO['Aries'];
            const elemento = ELEMENTOS[signoIC] || 'Fuego';
            const dignidadRegente = posRegenteIC ? calcDignidad(regenteIC, posRegenteIC.signo) : null;
            const dignidadLuna = calcDignidad('Luna', luna.signo);
            
            // Construir HTML
            let html = `
                <div class="analysis-card" style="background:linear-gradient(135deg, rgba(121,85,72,0.15), rgba(93,64,55,0.1));border-left:4px solid #795548;">
                    <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;">
                        <div style="font-size:3rem;">${SIGN_SYMBOLS[signoIC] || '?'}</div>
                        <div>
                            <div class="analysis-title" style="margin:0;">IC en ${signoIC.toUpperCase()}</div>
                            <div style="font-size:0.85rem;color:var(--text-dim);">Fondo del Cielo ‚Ä¢ Casa 4 ‚Ä¢ ${elemento}</div>
                        </div>
                    </div>
                    <div class="analysis-highlight"><p style="margin:0;">${info.desc}</p></div>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px;">
                        <div style="background:var(--bg-elevated);padding:10px;border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-dim);">üèóÔ∏è Tipo de Propiedad</div>
                            <div style="font-size:0.85rem;">${info.tipo}</div>
                        </div>
                        <div style="background:var(--bg-elevated);padding:10px;border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-dim);">üìç Ubicaci√≥n Ideal</div>
                            <div style="font-size:0.85rem;">${info.ubicacion}</div>
                        </div>
                    </div>
                    <div style="margin-top:10px;padding:10px;background:rgba(121,85,72,0.1);border-radius:8px;border-left:3px solid #795548;">
                        <strong>üí° Consejo:</strong> ${info.consejo}
                    </div>
                    <div style="margin-top:10px;padding:10px;background:var(--bg-elevated);border-radius:8px;">
                        <div style="font-size:0.75rem;color:var(--text-dim);">üë® Padre/Herencia</div>
                        <div style="font-size:0.85rem;">${info.herencia}</div>
                    </div>
                </div>`;
            
            // Regente del IC
            if (posRegenteIC) {
                html += `
                <div class="analysis-card">
                    <div class="analysis-title">${PLANET_SYMBOLS[regenteIC] || '?'}</div>
                    <div style="font-size:1.1rem;font-weight:600;margin:-10px 0 10px 0;">
                        Regente del IC: ${regenteIC.toUpperCase()} en Casa ${posRegenteIC.casa} (${posRegenteIC.signo.toUpperCase()})
                        ${dignidadRegente ? `<span style="display:inline-block;padding:2px 8px;border-radius:10px;font-size:0.75rem;background:${dignidadRegente.color}22;color:${dignidadRegente.color};margin-left:8px;">${dignidadRegente.texto}</span>` : ''}
                    </div>
                    <div style="background:var(--bg-elevated);padding:12px;border-radius:10px;font-size:0.9rem;color:var(--text-dim);">
                        ${REGENTE_CASAS[posRegenteIC.casa] || ''}
                    </div>
                </div>`;
            }
            
            // Luna - Cambios de Residencia
            html += `
                <div class="analysis-card" style="border-left:4px solid #5c6bc0;">
                    <div class="analysis-title">‚òΩ Luna - Cambios de Residencia</div>
                    <div style="display:flex;align-items:center;gap:15px;background:var(--bg-elevated);padding:15px;border-radius:12px;">
                        <div style="font-size:2.5rem;">‚òΩ</div>
                        <div>
                            <div style="font-weight:600;">Luna en ${luna.signo.toUpperCase()}
                                ${dignidadLuna ? `<span style="display:inline-block;padding:2px 8px;border-radius:10px;font-size:0.7rem;background:${dignidadLuna.color}22;color:${dignidadLuna.color};margin-left:8px;">${dignidadLuna.texto}</span>` : ''}
                            </div>
                            <div style="font-size:0.85rem;color:#5c6bc0;">Casa ${luna.casa}</div>
                            <div style="font-size:0.85rem;color:var(--text-dim);margin-top:4px;">
                                ${LUNA_CASAS[luna.casa] || 'Tu vida emocional afecta tus decisiones de vivienda.'}
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // Econom√≠a de las Propiedades
            html += `
                <div class="analysis-card">
                    <div class="analysis-title">üí∞ Econom√≠a de las Propiedades</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                        <div style="background:linear-gradient(135deg, rgba(46,125,50,0.1), rgba(76,175,80,0.05));padding:15px;border-radius:10px;border:1px solid rgba(46,125,50,0.3);">
                            <div style="font-weight:600;color:#2e7d32;margin-bottom:8px;">
                                <span style="font-size:1.5rem;margin-right:8px;">${SIGN_SYMBOLS[signoCasa5] || '?'}</span>Casa 5 - Ganancias
                            </div>
                            <div style="font-size:0.9rem;margin-bottom:4px;"><strong>${signoCasa5.toUpperCase()}</strong> ‚Ä¢ Regente: ${regenteCasa5}</div>
                            <div style="font-size:0.8rem;color:var(--text-dim);">Dinero que generan las propiedades: plusval√≠a, alquileres, especulaci√≥n inmobiliaria.</div>
                            ${planetasEnCasa5.length > 0 ? `<div style="font-size:0.8rem;margin-top:8px;"><strong>Planetas:</strong> ${planetasEnCasa5.map(([n,d]) => `${PLANET_SYMBOLS[n]||'ü™ê'} ${n}`).join(', ')}</div>` : ''}
                        </div>
                        <div style="background:linear-gradient(135deg, rgba(198,40,40,0.1), rgba(244,67,54,0.05));padding:15px;border-radius:10px;border:1px solid rgba(198,40,40,0.3);">
                            <div style="font-weight:600;color:#c62828;margin-bottom:8px;">
                                <span style="font-size:1.5rem;margin-right:8px;">${SIGN_SYMBOLS[signoCasa3] || '?'}</span>Casa 3 - Gastos/P√©rdidas
                            </div>
                            <div style="font-size:0.9rem;margin-bottom:4px;"><strong>${signoCasa3.toUpperCase()}</strong> ‚Ä¢ Regente: ${regenteCasa3}</div>
                            <div style="font-size:0.8rem;color:var(--text-dim);">Gastos de propiedades: mantenimiento, reparaciones, problemas con vecinos.</div>
                            ${planetasEnCasa3.length > 0 ? `<div style="font-size:0.8rem;margin-top:8px;"><strong>Planetas:</strong> ${planetasEnCasa3.map(([n,d]) => `${PLANET_SYMBOLS[n]||'ü™ê'} ${n}`).join(', ')}</div>` : ''}
                        </div>
                    </div>
                </div>`;
            
            // Planetas en Casa 4
            if (planetasEnCasa4.length > 0) {
                html += `
                <div class="analysis-card">
                    <div class="analysis-title">‚≠ê Planetas en Casa 4</div>
                    <div style="display:flex;flex-wrap:wrap;gap:10px;">
                        ${planetasEnCasa4.map(([nombre, data]) => {
                            const dig = calcDignidad(nombre, data.signo);
                            return `<div style="background:var(--bg-elevated);padding:10px 15px;border-radius:10px;">
                                <strong>${PLANET_SYMBOLS[nombre]||'ü™ê'} ${nombre}</strong> en ${SIGN_SYMBOLS[data.signo]||'?'} ${data.signo}
                                ${dig ? `<span style="display:inline-block;padding:2px 6px;border-radius:8px;font-size:0.65rem;background:${dig.color}22;color:${dig.color};margin-left:6px;">${dig.texto}</span>` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
            }
            
            // S√≠ntesis
            html += `
                <div class="analysis-card" style="background:linear-gradient(135deg, rgba(121,85,72,0.1), rgba(188,170,164,0.05));">
                    <div class="analysis-title">üè° S√≠ntesis Inmobiliaria</div>
                    <div style="font-size:0.9rem;line-height:1.7;color:var(--text-secondary);">
                        Con el <strong>IC en ${signoIC.toUpperCase()}</strong>, tu relaci√≥n con el hogar y las propiedades tiene las caracter√≠sticas de ese signo.
                        ${posRegenteIC ? `El regente <strong>${regenteIC.toUpperCase()}</strong> en Casa ${posRegenteIC.casa} indica d√≥nde y c√≥mo se manifiestan tus asuntos inmobiliarios.` : ''}
                        Tu <strong>Luna en Casa ${luna.casa}</strong> habla de los cambios de residencia y el componente emocional del hogar.
                        ${planetasEnCasa4.length > 0 ? `Los planetas en tu Casa 4 (${planetasEnCasa4.map(([n]) => n).join(', ')}) a√±aden energ√≠as espec√≠ficas a tu experiencia del hogar.` : ''}
                    </div>
                </div>`;
            
            document.getElementById('tab-hogar').innerHTML = html;
            console.log('üè† Hogar renderizado OK');
            
        } catch (error) {
            console.error('‚ùå Error en renderHogar:', error);
            document.getElementById('tab-hogar').innerHTML = `
                <div class="analysis-card" style="background:rgba(231,76,60,0.1);border:1px solid #e74c3c;">
                    <div class="analysis-title">‚ùå Error al cargar Hogar</div>
                    <p>${error.message}</p>
                </div>`;
        }
    }
    
    // ========================================================================
    // RELACIONES - Pareja y V√≠nculos (Casa 7)
    // ========================================================================
    
    function renderRelaciones() {
        try {
            const c = perfilState.cartaNatal;
            if (!c || !c.casas) {
                document.getElementById('tab-relaciones').innerHTML = '<div class="analysis-card"><p>Error: Calcula tu carta primero.</p></div>';
                return;
            }
            
            // Datos b√°sicos
            const signoDesc = c.casas[6]?.signo || 'Aries';
            const signoCasa5 = c.casas[4]?.signo || 'Aries';
            const signoCasa8 = c.casas[7]?.signo || 'Aries';
            const regenteDesc = REGENTES[signoDesc] || 'Marte';
            const posRegenteDesc = c.posiciones[regenteDesc];
            const venus = c.posiciones['Venus'] || {signo: 'Aries', casa: 1};
            const marte = c.posiciones['Marte'] || {signo: 'Aries', casa: 1};
            const luna = c.posiciones['Luna'] || {signo: 'Aries', casa: 1};
            
            // Elemento del signo
            const ELEMENTOS = {
                'Aries': 'Fuego', 'Tauro': 'Tierra', 'G√©minis': 'Aire', 'C√°ncer': 'Agua',
                'Leo': 'Fuego', 'Virgo': 'Tierra', 'Libra': 'Aire', 'Escorpio': 'Agua',
                'Ofiuco': 'Agua', 'Sagitario': 'Fuego', 'Capricornio': 'Tierra',
                'Acuario': 'Aire', 'Pegaso': 'Agua', 'Piscis': 'Agua'
            };
            
            // Descendente completo por signo
            const DESC_INFO = {
                'Aries': { desc: 'Buscas una pareja activa, independiente, pionera y con iniciativa. Te atraen personas directas, competitivas y con fuego interior.', atrae: 'Personas en√©rgicas, deportistas, emprendedoras, l√≠deres, guerreras', necesita: 'Acci√≥n, independencia, competencia sana, pasi√≥n, novedad constante', desafio: 'Evitar relaciones basadas solo en conflicto o competencia', tipo: 'Marte: activa, directa, impulsiva' },
                'Tauro': { desc: 'Buscas una pareja estable, sensual, confiable y con los pies en la tierra. Te atraen personas que ofrecen seguridad material y emocional.', atrae: 'Personas sensuales, estables, pr√°cticas, art√≠sticas, amantes de la buena vida', necesita: 'Estabilidad, contacto f√≠sico, lealtad, seguridad material, placeres sensoriales', desafio: 'Evitar relaciones por seguridad material', tipo: 'Venus: sensual, estable, leal, posesiva' },
                'G√©minis': { desc: 'Buscas una pareja comunicativa, inteligente, vers√°til y estimulante mentalmente. Te atraen personas curiosas.', atrae: 'Personas inteligentes, comunicativas, j√≥venes de esp√≠ritu, vers√°tiles, ingeniosas', necesita: 'Comunicaci√≥n constante, variedad, est√≠mulo mental, libertad, amistad', desafio: 'Evitar superficialidad. Profundizar m√°s all√° de la conexi√≥n mental', tipo: 'Mercurio: comunicativa, juvenil, dual, inquieta' },
                'C√°ncer': { desc: 'Buscas una pareja nutritiva, protectora, emocional y hogare√±a. Te atraen personas maternales/paternales que ofrecen seguridad emocional.', atrae: 'Personas sensibles, familiares, protectoras, nutritivas, con instinto maternal/paternal', necesita: 'Seguridad emocional, hogar compartido, familia, cuidado, intimidad profunda', desafio: 'Evitar dependencia emocional. No buscar padre/madre en la pareja', tipo: 'Luna: emocional, hogare√±a, protectora, cambiante' },
                'Leo': { desc: 'Buscas una pareja brillante, generosa, creativa y que te admire. Te atraen personas carism√°ticas, divertidas y con presencia.', atrae: 'Personas carism√°ticas, creativas, generosas, dram√°ticas, l√≠deres naturales', necesita: 'Admiraci√≥n, romance, diversi√≥n, creatividad compartida, lealtad', desafio: 'Evitar relaciones basadas en el ego. Equilibrar dar y recibir atenci√≥n', tipo: 'Sol: brillante, generosa, orgullosa, necesitada de atenci√≥n' },
                'Virgo': { desc: 'Buscas una pareja pr√°ctica, servicial, inteligente y que mejore tu vida. Te atraen personas organizadas, saludables y trabajadoras.', atrae: 'Personas trabajadoras, anal√≠ticas, serviciales, saludables, perfeccionistas', necesita: 'Orden, utilidad pr√°ctica, mejora mutua, servicio, rutinas saludables', desafio: 'Evitar criticar excesivamente. No buscar perfecci√≥n en la pareja', tipo: 'Mercurio: pr√°ctica, servicial, cr√≠tica, detallista' },
                'Libra': { desc: 'Buscas una pareja armoniosa, elegante, justa y equilibrada. Te atraen personas refinadas, art√≠sticas y diplom√°ticas.', atrae: 'Personas elegantes, art√≠sticas, diplom√°ticas, justas, socialmente h√°biles', necesita: 'Armon√≠a, belleza, equilibrio, justicia, vida social activa', desafio: 'Evitar depender del otro para sentirte completo. Tomar decisiones propias', tipo: 'Venus: elegante, armoniosa, indecisa, necesitada de pareja' },
                'Escorpio': { desc: 'Buscas una pareja intensa, profunda, transformadora y apasionada. Te atraen personas misteriosas, poderosas y emocionalmente profundas.', atrae: 'Personas intensas, misteriosas, poderosas, magn√©ticas, transformadoras', necesita: 'Profundidad emocional, lealtad absoluta, transformaci√≥n, pasi√≥n intensa', desafio: 'Evitar relaciones t√≥xicas o de poder. No confundir celos con amor', tipo: 'Plut√≥n: intensa, celosa, transformadora, secreta' },
                'Ofiuco': { desc: 'Buscas una pareja sanadora, transformadora y conectada con lo profundo. Te atraen personas con capacidad de sanar y regenerar.', atrae: 'Personas sanadoras, cham√°nicas, transformadoras, conectadas con lo oculto', necesita: 'Transformaci√≥n profunda, sanaci√≥n mutua, conexi√≥n con lo invisible', desafio: 'Evitar relaciones basadas solo en sanar al otro', tipo: 'Sanador: transformadora, intensa, regenerativa' },
                'Sagitario': { desc: 'Buscas una pareja aventurera, filos√≥fica, optimista y libre. Te atraen personas extranjeras, viajeras y con visi√≥n amplia.', atrae: 'Personas aventureras, filos√≥ficas, extranjeras, optimistas, libres de esp√≠ritu', necesita: 'Libertad, aventura, viajes, filosof√≠a compartida, crecimiento', desafio: 'Evitar huir del compromiso. Equilibrar libertad con intimidad', tipo: 'J√∫piter: expansiva, optimista, filos√≥fica, inquieta' },
                'Capricornio': { desc: 'Buscas una pareja madura, responsable, ambiciosa y estructurada. Te atraen personas con autoridad, estatus y solidez.', atrae: 'Personas maduras, responsables, ambiciosas, con autoridad, tradicionales', necesita: 'Estructura, metas compartidas, respeto, construcci√≥n a largo plazo, estatus', desafio: 'Evitar relaciones por estatus. No reprimir emociones por mantener control', tipo: 'Saturno: seria, responsable, mayor, estructurada' },
                'Acuario': { desc: 'Buscas una pareja original, libre, intelectual y poco convencional. Te atraen personas √∫nicas, innovadoras y con ideales humanitarios.', atrae: 'Personas originales, independientes, intelectuales, humanitarias, exc√©ntricas', necesita: 'Libertad, amistad, espacio personal, ideales compartidos, innovaci√≥n', desafio: 'Evitar frialdad emocional. Conectar emocionalmente, no solo intelectualmente', tipo: 'Urano: original, impredecible, libre, distante' },
                'Pegaso': { desc: 'Buscas una pareja inspiradora, elevada, libre y conectada con lo sublime.', atrae: 'Personas inspiradoras, libres, creativas, conectadas con lo elevado', necesita: 'Inspiraci√≥n, elevaci√≥n espiritual, libertad, creatividad sublime', desafio: 'Mantener los pies en la tierra sin perder la capacidad de so√±ar', tipo: 'J√∫piter elevado: inspiradora, libre, sublime' },
                'Piscis': { desc: 'Buscas una pareja espiritual, compasiva, art√≠stica y sensible. Te atraen personas m√≠sticas, art√≠sticas y emocionalmente profundas.', atrae: 'Personas sensibles, art√≠sticas, espirituales, compasivas, so√±adoras', necesita: 'Conexi√≥n espiritual, compasi√≥n, arte, sue√±os compartidos, trascendencia', desafio: 'Evitar idealizar a la pareja. No sacrificarse perdiendo identidad propia', tipo: 'Neptuno: espiritual, art√≠stica, evasiva, idealista' }
            };
            
            // Venus completo por signo
            const VENUS_INFO = {
                'Aries': { ama: 'Ama con pasi√≥n directa e impulsiva. El amor es una conquista, un fuego que necesita avivarse constantemente.', atrae: 'Atrae siendo valiente, directa y apasionada. La acci√≥n es su magnetismo.', problemas: 'Impaciencia, aburrimiento r√°pido, conflictos por independencia' },
                'Tauro': { ama: 'Ama con sensualidad, constancia y devoci√≥n. El amor es f√≠sico, tangible, placentero.', atrae: 'Atrae siendo sensual, estable y presente. La belleza f√≠sica es su magnetismo.', problemas: 'Posesividad, terquedad, dificultad para cambiar' },
                'G√©minis': { ama: 'Ama con palabras, curiosidad y variedad. El amor es una conversaci√≥n interminable.', atrae: 'Atrae siendo ingeniosa, comunicativa y vers√°til. El ingenio es su magnetismo.', problemas: 'Superficialidad, inconstancia, dificultad para profundizar' },
                'C√°ncer': { ama: 'Ama con cuidado, protecci√≥n y profundidad emocional. El amor es cuidar y ser cuidado.', atrae: 'Atrae siendo nutritiva, protectora y emocionalmente disponible.', problemas: 'Dependencia, cambios de humor, manipulaci√≥n emocional' },
                'Leo': { ama: 'Ama con generosidad, drama y romance grandioso. El amor es un espect√°culo, una celebraci√≥n.', atrae: 'Atrae siendo brillante, generosa y magn√©tica. El carisma es su magnetismo.', problemas: 'Necesidad excesiva de atenci√≥n, drama, ego herido' },
                'Virgo': { ama: 'Ama con actos de servicio y mejora pr√°ctica. El amor es mejorar la vida del otro.', atrae: 'Atrae siendo √∫til, organizada y atenta a los detalles.', problemas: 'Cr√≠tica excesiva, dificultad para relajarse, perfeccionismo' },
                'Libra': { ama: 'Ama con armon√≠a, equilibrio y refinamiento. El amor es una danza, un espejo, una obra de arte.', atrae: 'Atrae siendo elegante, diplom√°tica y encantadora. La gracia es su magnetismo.', problemas: 'Dependencia de la pareja, indecisi√≥n, evitar conflictos' },
                'Escorpio': { ama: 'Ama con intensidad total, profundidad y transformaci√≥n. El amor es fusi√≥n, muerte y renacimiento.', atrae: 'Atrae siendo magn√©tica, misteriosa e intensa. El poder emocional es su magnetismo.', problemas: 'Celos, posesividad, manipulaci√≥n, dificultad para perdonar' },
                'Ofiuco': { ama: 'Ama con capacidad de sanar y transformar. El amor es un proceso de sanaci√≥n mutua.', atrae: 'Atrae siendo sanadora, profunda y regenerativa.', problemas: 'Cargar con heridas ajenas, obsesi√≥n con sanar al otro' },
                'Sagitario': { ama: 'Ama con libertad, aventura y optimismo. El amor es un viaje, una expansi√≥n.', atrae: 'Atrae siendo aventurera, optimista y libre. El entusiasmo es su magnetismo.', problemas: 'Compromiso dif√≠cil, exceso de optimismo, huir de la intimidad' },
                'Capricornio': { ama: 'Ama con compromiso, responsabilidad y construcci√≥n a largo plazo. El amor madura con el tiempo.', atrae: 'Atrae siendo seria, responsable y con metas claras. La solidez es su magnetismo.', problemas: 'Frialdad, anteponer el deber al amor, control excesivo' },
                'Acuario': { ama: 'Ama con libertad, amistad e ideales. El amor es una conexi√≥n mental, una causa compartida.', atrae: 'Atrae siendo original, independiente e intelectual. La unicidad es su magnetismo.', problemas: 'Distancia emocional, frialdad, dificultad para la intimidad' },
                'Pegaso': { ama: 'Ama con inspiraci√≥n, elevaci√≥n y conexi√≥n sublime. El amor es un vuelo compartido.', atrae: 'Atrae siendo inspiradora, elevada y libre.', problemas: 'Dificultad para aterrizar, idealismo excesivo' },
                'Piscis': { ama: 'Ama con compasi√≥n, entrega total y conexi√≥n espiritual. El amor es fusi√≥n del alma.', atrae: 'Atrae siendo compasiva, art√≠stica y espiritualmente profunda.', problemas: 'Idealizaci√≥n excesiva, sacrificio de uno mismo, confusi√≥n' }
            };
            
            // Marte completo por signo
            const MARTE_INFO = {
                'Aries': { deseo: 'Deseo directo, urgente, impaciente. Quiere lo que quiere y lo quiere ahora.', conquista: 'Conquista siendo directo, valiente y tomando la iniciativa. No espera, act√∫a.', intimidad: 'Intenso, apasionado, f√≠sico, r√°pido. Necesita acci√≥n y novedad.' },
                'Tauro': { deseo: 'Deseo lento, sensual, persistente. Construye el deseo con paciencia.', conquista: 'Conquista con paciencia, sensualidad y presencia f√≠sica. Seduce los sentidos.', intimidad: 'Lento, sensual, t√°ctil, resistente. Disfruta los placeres prolongados.' },
                'G√©minis': { deseo: 'Deseo mental, curioso, variable. La mente es la zona er√≥gena principal.', conquista: 'Conquista con palabras, ingenio y variedad. Seduce la mente.', intimidad: 'Mental, comunicativo, experimental. Necesita hablar y probar cosas nuevas.' },
                'C√°ncer': { deseo: 'Deseo emocional, protector, fluctuante seg√∫n el humor.', conquista: 'Conquista cuidando, protegiendo y creando seguridad emocional.', intimidad: 'Emocional, nutritivo, sensible. Necesita intimidad emocional profunda.' },
                'Leo': { deseo: 'Deseo dram√°tico, generoso, necesitado de admiraci√≥n. Quiere ser adorado.', conquista: 'Conquista brillando, siendo generoso y haciendo sentir especial al otro.', intimidad: 'Apasionado, generoso, dram√°tico. Quiere ser el mejor amante.' },
                'Virgo': { deseo: 'Deseo detallista, servicial, refinado. Analiza antes de actuar.', conquista: 'Conquista siendo √∫til, atento a los detalles y mejorando la vida del otro.', intimidad: 'T√©cnico, servicial, atento al detalle, puede ser inhibido inicialmente.' },
                'Libra': { deseo: 'Deseo equilibrado, est√©tico, dependiente del otro.', conquista: 'Conquista con encanto, diplomacia y creando armon√≠a.', intimidad: 'Refinado, equilibrado, atento al placer del otro, est√©tico.' },
                'Escorpio': { deseo: 'Deseo intenso, profundo, transformador. Todo o nada. Quiere fusi√≥n total.', conquista: 'Conquista con intensidad, magnetismo y profundidad emocional.', intimidad: 'Intenso, profundo, transformador. Experiencias que cambian la vida.' },
                'Ofiuco': { deseo: 'Deseo transformador, sanador, conectado con lo profundo.', conquista: 'Conquista sanando, transformando, tocando las profundidades.', intimidad: 'Transformador, sanador, intenso, regenerativo.' },
                'Sagitario': { deseo: 'Deseo aventurero, optimista, expansivo. La conquista es una aventura.', conquista: 'Conquista con optimismo, aventura y promesas de horizontes amplios.', intimidad: 'Aventurero, optimista, juguet√≥n. Necesita variedad y espacio.' },
                'Capricornio': { deseo: 'Deseo controlado, ambicioso, resistente. La paciencia es estrategia.', conquista: 'Conquista con persistencia, ambici√≥n y demostrando solidez.', intimidad: 'Controlado inicialmente, muy resistente, mejora con el tiempo.' },
                'Acuario': { deseo: 'Deseo mental, experimental, impredecible. Necesita libertad para desear.', conquista: 'Conquista siendo original, dando espacio y estimulando la mente.', intimidad: 'Experimental, original, necesita espacio, puede ser distante.' },
                'Pegaso': { deseo: 'Deseo elevado, inspirador, conectado con lo sublime.', conquista: 'Conquista inspirando, elevando, conectando con lo m√°s alto.', intimidad: 'Inspirador, libre, conectado con lo sublime.' },
                'Piscis': { deseo: 'Deseo difuso, rom√°ntico, espiritual. Necesita conexi√≥n del alma.', conquista: 'Conquista con romanticismo, sensibilidad y conexi√≥n espiritual.', intimidad: 'Rom√°ntico, sensible, adaptable. Puede perderse en el otro.' }
            };
            
            // Luna - necesidades emocionales
            const LUNA_INFO = {
                'Aries': { necesidad: 'Necesita independencia, acci√≥n y emoci√≥n para sentirse segura.', enPareja: 'Pareja emocionalmente independiente, directa.', miedos: 'Miedo a la dependencia, a sentirse atrapada' },
                'Tauro': { necesidad: 'Necesita seguridad, contacto f√≠sico y estabilidad.', enPareja: 'Pareja emocionalmente estable, f√≠sica.', miedos: 'Miedo a la inseguridad, a los cambios bruscos' },
                'G√©minis': { necesidad: 'Necesita comunicaci√≥n, variedad e intercambio.', enPareja: 'Pareja emocionalmente comunicativa, curiosa.', miedos: 'Miedo al aburrimiento, al silencio' },
                'C√°ncer': { necesidad: 'Necesita seguridad emocional profunda, hogar y protecci√≥n.', enPareja: 'Pareja muy emocional, protectora.', miedos: 'Miedo al abandono, a la inseguridad emocional' },
                'Leo': { necesidad: 'Necesita admiraci√≥n, reconocimiento y expresi√≥n.', enPareja: 'Pareja que admira y hace sentir especial.', miedos: 'Miedo a ser ignorada, a no ser especial' },
                'Virgo': { necesidad: 'Necesita orden, utilidad y mejora.', enPareja: 'Pareja pr√°ctica, organizada.', miedos: 'Miedo al caos, a no ser √∫til' },
                'Libra': { necesidad: 'Necesita armon√≠a, belleza y compa√±√≠a.', enPareja: 'Pareja armoniosa, equilibrada.', miedos: 'Miedo a la soledad, al conflicto' },
                'Escorpio': { necesidad: 'Necesita profundidad, intensidad y control.', enPareja: 'Pareja intensa, leal.', miedos: 'Miedo a la traici√≥n, a la vulnerabilidad' },
                'Ofiuco': { necesidad: 'Necesita transformaci√≥n, sanaci√≥n y profundidad.', enPareja: 'Pareja sanadora, transformadora.', miedos: 'Miedo a no poder sanar, a las heridas sin resolver' },
                'Sagitario': { necesidad: 'Necesita libertad, aventura y sentido.', enPareja: 'Pareja libre, aventurera.', miedos: 'Miedo a la limitaci√≥n, al encierro' },
                'Capricornio': { necesidad: 'Necesita estructura, logros y respeto.', enPareja: 'Pareja responsable, madura.', miedos: 'Miedo al fracaso, a no ser respetada' },
                'Acuario': { necesidad: 'Necesita libertad, espacio y originalidad.', enPareja: 'Pareja original, independiente.', miedos: 'Miedo a perder la libertad, a la rutina' },
                'Pegaso': { necesidad: 'Necesita inspiraci√≥n, elevaci√≥n y conexi√≥n sublime.', enPareja: 'Pareja inspiradora, elevada.', miedos: 'Miedo a perder la capacidad de volar' },
                'Piscis': { necesidad: 'Necesita compasi√≥n, arte y conexi√≥n espiritual.', enPareja: 'Pareja compasiva, art√≠stica.', miedos: 'Miedo a la dureza del mundo, a perder la magia' }
            };
            
            // Regente Casa 7 en casas
            const REGENTE_CASAS = {
                1: 'Atraes parejas que reflejan tu personalidad. La relaci√≥n te define.',
                2: 'Las parejas afectan tus finanzas. Puede haber beneficio econ√≥mico del matrimonio.',
                3: 'Parejas comunicativas. Hermanos pueden presentarte parejas.',
                4: 'El hogar y la familia son centrales en la relaci√≥n.',
                5: 'Romance, diversi√≥n y creatividad en la pareja. Hijos pueden unir.',
                6: 'Parejas conectadas con el trabajo. Servicio mutuo importante.',
                7: '¬°Muy fuerte! La pareja y las asociaciones son centrales en tu vida.',
                8: 'Relaciones intensas, transformadoras. Recursos compartidos importantes.',
                9: 'Parejas extranjeras o conocidas en viajes. Filosof√≠a compartida.',
                10: 'La pareja afecta tu carrera. Matrimonio p√∫blico o de estatus.',
                11: 'Parejas que son amigos. Grupos y redes traen relaciones.',
                12: 'Relaciones secretas posibles. Sacrificio en el amor.'
            };
            
            // Dignidades
            function calcDignidad(planeta, signo) {
                const DIGNIDADES = {
                    'Venus': { exalt: ['Tauro','Libra','Acuario','Ofiuco'], dom: ['C√°ncer','Piscis','Sagitario'], exilio: ['Leo','Aries','Escorpio','Pegaso'], caida: ['G√©minis','Capricornio','Virgo'] },
                    'Marte': { exalt: ['Leo','Aries','Escorpio','Pegaso'], dom: ['G√©minis','Capricornio','Virgo'], exilio: ['Tauro','Libra','Acuario','Ofiuco'], caida: ['C√°ncer','Piscis','Sagitario'] },
                    'Luna': { exalt: ['C√°ncer','Piscis','Libra','Acuario','Ofiuco'], dom: ['Tauro','Sagitario'], exilio: ['Escorpio','G√©minis','Pegaso'], caida: ['Leo','Aries','Capricornio','Virgo'] }
                };
                const d = DIGNIDADES[planeta];
                if (!d) return null;
                if (d.exalt?.includes(signo)) return { tipo: 'exaltacion', texto: 'Exaltaci√≥n', color: '#4caf50' };
                if (d.dom?.includes(signo)) return { tipo: 'domicilio', texto: 'Domicilio', color: '#2196f3' };
                if (d.exilio?.includes(signo)) return { tipo: 'exilio', texto: 'Exilio', color: '#ff9800' };
                if (d.caida?.includes(signo)) return { tipo: 'caida', texto: 'Ca√≠da', color: '#f44336' };
                return null;
            }
            
            // Planetas en Casa 7
            const excluir = ['ASC', 'MC', 'Parte de Fortuna'];
            const planetasEnCasa7 = Object.entries(c.posiciones)
                .filter(([nombre, data]) => data && data.casa === 7 && !excluir.includes(nombre));
            
            const infoDesc = DESC_INFO[signoDesc] || DESC_INFO['Aries'];
            const infoVenus = VENUS_INFO[venus.signo] || VENUS_INFO['Aries'];
            const infoMarte = MARTE_INFO[marte.signo] || MARTE_INFO['Aries'];
            const infoLuna = LUNA_INFO[luna.signo] || LUNA_INFO['Aries'];
            const elemento = ELEMENTOS[signoDesc] || 'Fuego';
            const dignidadRegente = posRegenteDesc ? calcDignidad(regenteDesc, posRegenteDesc.signo) : null;
            const dignidadVenus = calcDignidad('Venus', venus.signo);
            const dignidadMarte = calcDignidad('Marte', marte.signo);
            const dignidadLuna = calcDignidad('Luna', luna.signo);
            
            // Construir HTML
            let html = `
                <div class="analysis-card" style="background:linear-gradient(135deg, rgba(233,30,99,0.15), rgba(156,39,176,0.1));border-left:4px solid #e91e63;">
                    <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;">
                        <div style="font-size:3rem;">${SIGN_SYMBOLS[signoDesc] || '?'}</div>
                        <div>
                            <div class="analysis-title" style="margin:0;">Descendente en ${signoDesc.toUpperCase()}</div>
                            <div style="font-size:0.85rem;color:var(--text-dim);">Casa 7 ‚Ä¢ ${elemento} ‚Ä¢ ${infoDesc.tipo}</div>
                        </div>
                    </div>
                    <div class="analysis-highlight"><p style="margin:0;">${infoDesc.desc}</p></div>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px;">
                        <div style="background:var(--bg-elevated);padding:10px;border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-dim);">üíò Te atrae</div>
                            <div style="font-size:0.85rem;">${infoDesc.atrae}</div>
                        </div>
                        <div style="background:var(--bg-elevated);padding:10px;border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-dim);">üíù Necesitas</div>
                            <div style="font-size:0.85rem;">${infoDesc.necesita}</div>
                        </div>
                    </div>
                    <div style="margin-top:10px;padding:10px;background:rgba(233,30,99,0.1);border-radius:8px;border-left:3px solid #e91e63;">
                        <strong>‚ö†Ô∏è Desaf√≠o:</strong> ${infoDesc.desafio}
                    </div>
                </div>`;
            
            // Regente del Descendente
            if (posRegenteDesc) {
                html += `
                <div class="analysis-card">
                    <div class="analysis-title">${PLANET_SYMBOLS[regenteDesc] || '?'}</div>
                    <div style="font-size:1.1rem;font-weight:600;margin:-10px 0 10px 0;">
                        Regente de Casa 7: ${regenteDesc.toUpperCase()} en Casa ${posRegenteDesc.casa} (${posRegenteDesc.signo.toUpperCase()})
                        ${dignidadRegente ? `<span style="display:inline-block;padding:2px 8px;border-radius:10px;font-size:0.75rem;background:${dignidadRegente.color}22;color:${dignidadRegente.color};margin-left:8px;">${dignidadRegente.texto}</span>` : ''}
                    </div>
                    <div style="background:var(--bg-elevated);padding:12px;border-radius:10px;font-size:0.9rem;color:var(--text-dim);">
                        ${REGENTE_CASAS[posRegenteDesc.casa] || ''}
                    </div>
                </div>`;
            }
            
            // Venus
            html += `
                <div class="analysis-card" style="border-left:4px solid #ff69b4;">
                    <div class="analysis-title">‚ôÄ Venus - C√≥mo Amas</div>
                    <div style="display:flex;align-items:flex-start;gap:15px;background:var(--bg-elevated);padding:15px;border-radius:12px;">
                        <div style="font-size:2.5rem;color:#ff69b4;">‚ôÄ</div>
                        <div style="flex:1;">
                            <div style="font-weight:600;">Venus en ${venus.signo.toUpperCase()}
                                ${dignidadVenus ? `<span style="display:inline-block;padding:2px 8px;border-radius:10px;font-size:0.7rem;background:${dignidadVenus.color}22;color:${dignidadVenus.color};margin-left:8px;">${dignidadVenus.texto}</span>` : ''}
                            </div>
                            <div style="font-size:0.85rem;color:#ff69b4;">Casa ${venus.casa}</div>
                            <div style="font-size:0.85rem;color:var(--text-dim);margin-top:8px;">${infoVenus.ama}</div>
                            <div style="font-size:0.85rem;color:var(--gold-light);margin-top:4px;">${infoVenus.atrae}</div>
                            <div style="font-size:0.8rem;color:#e91e63;margin-top:4px;">‚ö†Ô∏è ${infoVenus.problemas}</div>
                        </div>
                    </div>
                </div>`;
            
            // Marte
            html += `
                <div class="analysis-card" style="border-left:4px solid #f44336;">
                    <div class="analysis-title">‚ôÇ Marte - Tu Deseo</div>
                    <div style="display:flex;align-items:flex-start;gap:15px;background:var(--bg-elevated);padding:15px;border-radius:12px;">
                        <div style="font-size:2.5rem;color:#f44336;">‚ôÇ</div>
                        <div style="flex:1;">
                            <div style="font-weight:600;">Marte en ${marte.signo.toUpperCase()}
                                ${dignidadMarte ? `<span style="display:inline-block;padding:2px 8px;border-radius:10px;font-size:0.7rem;background:${dignidadMarte.color}22;color:${dignidadMarte.color};margin-left:8px;">${dignidadMarte.texto}</span>` : ''}
                            </div>
                            <div style="font-size:0.85rem;color:#f44336;">Casa ${marte.casa}</div>
                            <div style="font-size:0.85rem;color:var(--text-dim);margin-top:8px;">${infoMarte.deseo}</div>
                            <div style="font-size:0.85rem;color:var(--gold-light);margin-top:4px;">${infoMarte.conquista}</div>
                            <div style="font-size:0.8rem;color:var(--text-dim);margin-top:4px;font-style:italic;">En la intimidad: ${infoMarte.intimidad}</div>
                        </div>
                    </div>
                </div>`;
            
            // Luna - Necesidades emocionales
            html += `
                <div class="analysis-card" style="border-left:4px solid #9c27b0;">
                    <div class="analysis-title">‚òΩ Luna - Necesidades Emocionales</div>
                    <div style="display:flex;align-items:flex-start;gap:15px;background:var(--bg-elevated);padding:15px;border-radius:12px;">
                        <div style="font-size:2.5rem;color:#9c27b0;">‚òΩ</div>
                        <div style="flex:1;">
                            <div style="font-weight:600;">Luna en ${luna.signo.toUpperCase()}
                                ${dignidadLuna ? `<span style="display:inline-block;padding:2px 8px;border-radius:10px;font-size:0.7rem;background:${dignidadLuna.color}22;color:${dignidadLuna.color};margin-left:8px;">${dignidadLuna.texto}</span>` : ''}
                            </div>
                            <div style="font-size:0.85rem;color:#9c27b0;">Casa ${luna.casa}</div>
                            <div style="font-size:0.85rem;color:var(--text-dim);margin-top:8px;">${infoLuna.necesidad}</div>
                            <div style="font-size:0.85rem;color:var(--gold-light);margin-top:4px;">En pareja: ${infoLuna.enPareja}</div>
                            <div style="font-size:0.8rem;color:#e91e63;margin-top:4px;">üò∞ ${infoLuna.miedos}</div>
                        </div>
                    </div>
                </div>`;
            
            // Planetas en Casa 7
            if (planetasEnCasa7.length > 0) {
                html += `
                <div class="analysis-card">
                    <div class="analysis-title">‚≠ê Planetas en Casa 7</div>
                    <div style="display:flex;flex-wrap:wrap;gap:10px;">
                        ${planetasEnCasa7.map(([nombre, data]) => `
                            <div style="background:var(--bg-elevated);padding:10px 15px;border-radius:10px;">
                                <strong>${PLANET_SYMBOLS[nombre]||'ü™ê'} ${nombre}</strong> en ${SIGN_SYMBOLS[data.signo]||'?'} ${data.signo}
                            </div>`).join('')}
                    </div>
                    <p style="font-size:0.85rem;color:var(--text-dim);margin-top:10px;">
                        Los planetas en Casa 7 a√±aden energ√≠as espec√≠ficas a tu experiencia de pareja.
                    </p>
                </div>`;
            }
            
            // Casas del Amor
            html += `
                <div class="analysis-card">
                    <div class="analysis-title">üè† Casas del Amor</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                        <div style="background:linear-gradient(135deg, rgba(255,105,180,0.1), rgba(255,105,180,0.05));padding:15px;border-radius:10px;border:1px solid rgba(255,105,180,0.3);">
                            <div style="font-weight:600;color:#ff69b4;margin-bottom:8px;">
                                <span style="font-size:1.5rem;margin-right:8px;">${SIGN_SYMBOLS[signoCasa5] || '?'}</span>Casa 5 - Romance
                            </div>
                            <div style="font-size:0.9rem;margin-bottom:4px;"><strong>${signoCasa5.toUpperCase()}</strong></div>
                            <div style="font-size:0.8rem;color:var(--text-dim);">C√≥mo vives el romance, las citas, la diversi√≥n amorosa.</div>
                        </div>
                        <div style="background:linear-gradient(135deg, rgba(156,39,176,0.1), rgba(156,39,176,0.05));padding:15px;border-radius:10px;border:1px solid rgba(156,39,176,0.3);">
                            <div style="font-weight:600;color:#9c27b0;margin-bottom:8px;">
                                <span style="font-size:1.5rem;margin-right:8px;">${SIGN_SYMBOLS[signoCasa8] || '?'}</span>Casa 8 - Intimidad
                            </div>
                            <div style="font-size:0.9rem;margin-bottom:4px;"><strong>${signoCasa8.toUpperCase()}</strong></div>
                            <div style="font-size:0.8rem;color:var(--text-dim);">Sexualidad, recursos compartidos, transformaci√≥n.</div>
                        </div>
                    </div>
                </div>`;
            
            // S√≠ntesis
            html += `
                <div class="analysis-card" style="background:linear-gradient(135deg, rgba(233,30,99,0.1), rgba(156,39,176,0.05));">
                    <div class="analysis-title">üíù S√≠ntesis de tu Perfil Amoroso</div>
                    <div style="font-size:0.9rem;line-height:1.7;color:var(--text-secondary);">
                        Con el <strong>Descendente en ${signoDesc.toUpperCase()}</strong>, buscas parejas que encarnen las cualidades de ese signo.
                        Tu <strong>Venus en ${venus.signo}</strong> (Casa ${venus.casa}) define c√≥mo amas y atraes.
                        Tu <strong>Marte en ${marte.signo}</strong> (Casa ${marte.casa}) muestra tu deseo y forma de conquistar.
                        Tu <strong>Luna en ${luna.signo}</strong> revela tus necesidades emocionales m√°s profundas.
                        ${planetasEnCasa7.length > 0 ? `Los planetas en tu Casa 7 (${planetasEnCasa7.map(([n]) => n).join(', ')}) a√±aden capas a tu experiencia de pareja.` : ''}
                    </div>
                </div>`;
            
            document.getElementById('tab-relaciones').innerHTML = html;
            console.log('üíï Relaciones renderizado OK');
            
        } catch (error) {
            console.error('‚ùå Error en renderRelaciones:', error);
            document.getElementById('tab-relaciones').innerHTML = `
                <div class="analysis-card" style="background:rgba(231,76,60,0.1);border:1px solid #e74c3c;">
                    <div class="analysis-title">‚ùå Error al cargar Relaciones</div>
                    <p>${error.message}</p>
                </div>`;
        }
    }
    
    // ========================================================================
    // ELECCIONES - Astrolog√≠a Electiva (Mejor momento para actividades)
    // ========================================================================
    
    // Estado para elecciones
    let eleccionesState = { 
        tipoSeleccionado: null,
        vista: 'selector', // selector, resultados
        diasBuscar: 14,
        resultados: []
    };
    
    // Calcular fase lunar
    function calcularFaseLunar(fecha) {
        // Luna nueva de referencia: 6 de enero de 2000
        const lunaRef = new Date(2000, 0, 6, 18, 14, 0);
        const cicloLunar = 29.53059; // d√≠as
        
        const diff = (fecha - lunaRef) / (1000 * 60 * 60 * 24);
        const ciclos = diff / cicloLunar;
        const fase = (ciclos - Math.floor(ciclos)) * cicloLunar;
        
        // Determinar fase
        if (fase < 1.85) return { nombre: 'Luna Nueva', icono: 'üåë', valor: 0 };
        if (fase < 7.38) return { nombre: 'Creciente', icono: 'üåí', valor: 0.25 };
        if (fase < 9.23) return { nombre: 'Cuarto Creciente', icono: 'üåì', valor: 0.25 };
        if (fase < 14.77) return { nombre: 'Gibosa Creciente', icono: 'üåî', valor: 0.5 };
        if (fase < 16.61) return { nombre: 'Luna Llena', icono: 'üåï', valor: 0.5 };
        if (fase < 22.15) return { nombre: 'Gibosa Menguante', icono: 'üåñ', valor: 0.75 };
        if (fase < 24.00) return { nombre: 'Cuarto Menguante', icono: 'üåó', valor: 0.75 };
        if (fase < 27.69) return { nombre: 'Bals√°mica', icono: 'üåò', valor: 1 };
        return { nombre: 'Luna Nueva', icono: 'üåë', valor: 0 };
    }
    
    // Per√≠odos de retrogradaci√≥n 2025-2026 (precalculados)
    const RETROGRADACIONES = {
        mercurio: [
            { inicio: new Date('2025-03-15'), fin: new Date('2025-04-07') },
            { inicio: new Date('2025-07-18'), fin: new Date('2025-08-11') },
            { inicio: new Date('2025-11-09'), fin: new Date('2025-11-29') },
            { inicio: new Date('2026-03-02'), fin: new Date('2026-03-25') },
            { inicio: new Date('2026-07-02'), fin: new Date('2026-07-26') },
            { inicio: new Date('2026-10-24'), fin: new Date('2026-11-13') }
        ],
        venus: [
            { inicio: new Date('2025-03-02'), fin: new Date('2025-04-13') },
            { inicio: new Date('2026-10-03'), fin: new Date('2026-11-14') }
        ]
    };
    
    function esRetrogrado(planeta, fecha) {
        const periodos = RETROGRADACIONES[planeta] || [];
        return periodos.some(p => fecha >= p.inicio && fecha <= p.fin);
    }
    
    function analizarDia(fecha, evento) {
        let puntos = 50; // Base
        const factores = [];
        
        // 1. Fase lunar
        const fase = calcularFaseLunar(fecha);
        const fasesIdeales = {
            'boda': ['creciente', 'gibosa'],
            'negocio': ['nueva', 'creciente'],
            'viaje': ['creciente', 'llena'],
            'operacion': ['menguante', 'bals√°mica'],
            'compra': ['creciente', 'gibosa', 'llena'],
            'estudios': ['nueva', 'creciente'],
            'entrevista': ['creciente', 'gibosa', 'llena'],
            'cita': ['creciente', 'llena'],
            'lanzamiento': ['nueva', 'creciente'],
            'contrato': ['creciente', 'gibosa']
        };
        const faseNorm = fase.nombre.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        const ideales = fasesIdeales[evento.id] || ['creciente'];
        if (ideales.some(f => faseNorm.includes(f))) {
            puntos += 20;
            factores.push({ texto: `${fase.icono} Fase ideal`, tipo: 'positivo' });
        } else if (faseNorm.includes('menguante') && evento.id !== 'operacion') {
            puntos -= 10;
            factores.push({ texto: `${fase.icono} Fase no ideal`, tipo: 'negativo' });
        }
        
        // 2. D√≠a de la semana
        const diaSemana = fecha.getDay();
        const planetaDia = ['Sol', 'Luna', 'Marte', 'Mercurio', 'J√∫piter', 'Venus', 'Saturno'][diaSemana];
        if (evento.horasPlanetarias.some(p => p.toLowerCase() === planetaDia.toLowerCase())) {
            puntos += 15;
            factores.push({ texto: `üìÖ D√≠a de ${planetaDia}`, tipo: 'positivo' });
        }
        
        // 3. Mercurio retr√≥grado
        if (esRetrogrado('mercurio', fecha)) {
            if (evento.mercurio.includes('estrictamente')) {
                puntos -= 30;
                factores.push({ texto: '‚òø‚Ñû Mercurio Ret.', tipo: 'negativo' });
            } else if (evento.mercurio.includes('Evitar')) {
                puntos -= 20;
                factores.push({ texto: '‚òø‚Ñû Mercurio Ret.', tipo: 'negativo' });
            }
        } else {
            if (evento.mercurio.includes('Evitar')) {
                puntos += 10;
                factores.push({ texto: '‚òø Mercurio directo', tipo: 'positivo' });
            }
        }
        
        // 4. Venus retr√≥grado
        if (esRetrogrado('venus', fecha)) {
            if (evento.venus.includes('estrictamente')) {
                puntos -= 30;
                factores.push({ texto: '‚ôÄ‚Ñû Venus Ret.', tipo: 'negativo' });
            } else if (evento.venus.includes('Evitar')) {
                puntos -= 15;
                factores.push({ texto: '‚ôÄ‚Ñû Venus Ret.', tipo: 'negativo' });
            }
        }
        
        // Normalizar puntos
        puntos = Math.max(0, Math.min(100, puntos));
        
        // Calificaci√≥n
        let calificacion, color;
        if (puntos >= 80) { calificacion = 'Excelente'; color = '#4caf50'; }
        else if (puntos >= 65) { calificacion = 'Bueno'; color = '#8bc34a'; }
        else if (puntos >= 50) { calificacion = 'Aceptable'; color = '#ffc107'; }
        else if (puntos >= 35) { calificacion = 'Regular'; color = '#ff9800'; }
        else { calificacion = 'Evitar'; color = '#f44336'; }
        
        return { fecha, puntos, calificacion, color, factores, fase };
    }
    
    function buscarMejoresDias(evento, dias) {
        const resultados = [];
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        
        for (let i = 0; i < dias; i++) {
            const fecha = new Date(hoy);
            fecha.setDate(fecha.getDate() + i);
            resultados.push(analizarDia(fecha, evento));
        }
        
        return resultados.sort((a, b) => b.puntos - a.puntos);
    }
    
    function renderElecciones() {
        try {
            const TIPOS_EVENTO = {
                'boda': {
                    nombre: 'Boda / Matrimonio',
                    icono: 'üíí',
                    descripcion: 'Ceremonia de matrimonio o compromiso formal',
                    lunaFavorable: ['Tauro', 'C√°ncer', 'Leo', 'Libra', 'Piscis', 'Pegaso'],
                    lunaEvitar: ['Aries', 'Escorpio', 'Capricornio'],
                    planetasClave: ['Venus', 'Luna', 'J√∫piter'],
                    casasImportantes: [7, 5, 1],
                    casasDesc: 'Casa 7 (pareja), Casa 5 (romance), Casa 1 (identidad)',
                    faseLunarIdeal: 'Luna creciente o gibosa',
                    diasSemana: ['Viernes (Venus)', 'S√°bado'],
                    horasPlanetarias: ['Venus', 'J√∫piter', 'Luna'],
                    mercurio: 'Evitar retr√≥grado',
                    venus: 'Evitar estrictamente retr√≥grado',
                    consejos: [
                        'Venus bien aspectado es fundamental',
                        'Luna creciente simboliza crecimiento de la uni√≥n',
                        'Casa 7 sin mal√©ficos (Saturno, Marte)',
                        'Evitar Luna en signos de agua excepto Piscis'
                    ]
                },
                'negocio': {
                    nombre: 'Iniciar Negocio / Empresa',
                    icono: 'üè¢',
                    descripcion: 'Fundar empresa, firmar contratos, abrir local',
                    lunaFavorable: ['Tauro', 'Leo', 'Virgo', 'Capricornio', 'Acuario'],
                    lunaEvitar: ['C√°ncer', 'Escorpio', 'Piscis'],
                    planetasClave: ['Mercurio', 'J√∫piter', 'Saturno', 'Sol'],
                    casasImportantes: [10, 2, 6, 1],
                    casasDesc: 'Casa 10 (carrera), Casa 2 (dinero), Casa 6 (trabajo)',
                    faseLunarIdeal: 'Luna nueva o creciente',
                    diasSemana: ['Mi√©rcoles (Mercurio)', 'Jueves (J√∫piter)'],
                    horasPlanetarias: ['J√∫piter', 'Sol', 'Mercurio'],
                    mercurio: 'Evitar estrictamente retr√≥grado',
                    venus: 'Precauci√≥n si retr√≥grado',
                    consejos: [
                        'Mercurio directo es esencial para contratos',
                        'J√∫piter bien aspectado trae expansi√≥n',
                        'Luna nueva para nuevos comienzos',
                        'Evitar Saturno en Casa 10'
                    ]
                },
                'viaje': {
                    nombre: 'Viaje / Mudanza',
                    icono: '‚úàÔ∏è',
                    descripcion: 'Iniciar viaje importante o mudanza de hogar',
                    lunaFavorable: ['G√©minis', 'Sagitario', 'Acuario', 'Ofiuco'],
                    lunaEvitar: ['Tauro', 'Leo', 'Escorpio'],
                    planetasClave: ['Mercurio', 'J√∫piter', 'Luna'],
                    casasImportantes: [9, 3, 4],
                    casasDesc: 'Casa 9 (viajes largos), Casa 3 (cortos), Casa 4 (hogar)',
                    faseLunarIdeal: 'Luna creciente o llena',
                    diasSemana: ['Mi√©rcoles', 'Jueves'],
                    horasPlanetarias: ['Mercurio', 'J√∫piter', 'Luna'],
                    mercurio: 'Evitar retr√≥grado',
                    venus: 'Neutral',
                    consejos: [
                        'Mercurio directo evita retrasos y confusiones',
                        'Luna en signos mutables favorece adaptaci√≥n',
                        'Evitar Luna vac√≠a de curso',
                        'J√∫piter en Casa 9 es excelente para viajes largos'
                    ]
                },
                'operacion': {
                    nombre: 'Cirug√≠a / Operaci√≥n',
                    icono: 'üè•',
                    descripcion: 'Intervenci√≥n quir√∫rgica programada',
                    lunaFavorable: ['Virgo', 'Capricornio', 'Acuario'],
                    lunaEvitar: ['Aries', 'Escorpio', 'Leo', 'Tauro'],
                    planetasClave: ['Marte', 'Saturno', 'Luna'],
                    casasImportantes: [6, 8, 1],
                    casasDesc: 'Casa 6 (salud), Casa 8 (transformaci√≥n), Casa 1 (cuerpo)',
                    faseLunarIdeal: 'Luna menguante o bals√°mica',
                    diasSemana: ['S√°bado (Saturno - precisi√≥n)'],
                    horasPlanetarias: ['Saturno', 'Mercurio'],
                    mercurio: 'Precauci√≥n',
                    venus: 'Neutral',
                    consejos: [
                        'Luna menguante reduce sangrado e inflamaci√≥n',
                        'Evitar Luna en el signo que rige la parte del cuerpo',
                        'Marte sin aspectos tensos',
                        'Luna no en signo fijo (recuperaci√≥n m√°s lenta)'
                    ],
                    zonasSigno: {
                        'Aries': 'Cabeza, cara, cerebro',
                        'Tauro': 'Cuello, garganta, tiroides',
                        'G√©minis': 'Brazos, manos, pulmones',
                        'C√°ncer': 'Pecho, est√≥mago, √∫tero',
                        'Leo': 'Coraz√≥n, espalda, columna',
                        'Virgo': 'Intestinos, p√°ncreas',
                        'Libra': 'Ri√±ones, zona lumbar',
                        'Escorpio': '√ìrganos reproductores, colon',
                        'Ofiuco': 'Sistema inmune',
                        'Sagitario': 'Caderas, muslos, h√≠gado',
                        'Capricornio': 'Rodillas, huesos, piel',
                        'Acuario': 'Tobillos, sistema circulatorio',
                        'Pegaso': 'Sistema nervioso',
                        'Piscis': 'Pies, sistema linf√°tico'
                    }
                },
                'compra': {
                    nombre: 'Compra Importante',
                    icono: 'üè†',
                    descripcion: 'Comprar casa, coche, inversi√≥n grande',
                    lunaFavorable: ['Tauro', 'C√°ncer', 'Leo', 'Capricornio'],
                    lunaEvitar: ['Aries', 'G√©minis', 'Sagitario'],
                    planetasClave: ['Venus', 'J√∫piter', 'Saturno'],
                    casasImportantes: [2, 4, 8],
                    casasDesc: 'Casa 2 (posesiones), Casa 4 (hogar), Casa 8 (recursos compartidos)',
                    faseLunarIdeal: 'Luna creciente, gibosa o llena',
                    diasSemana: ['Viernes', 'Jueves'],
                    horasPlanetarias: ['Venus', 'J√∫piter'],
                    mercurio: 'Evitar retr√≥grado',
                    venus: 'Evitar retr√≥grado',
                    consejos: [
                        'Venus y J√∫piter bien aspectados atraen valor',
                        'Luna en signos fijos para estabilidad',
                        'Evitar compras impulsivas con Luna en Aries',
                        'Saturno favorable da durabilidad'
                    ]
                },
                'estudios': {
                    nombre: 'Iniciar Estudios / Curso',
                    icono: 'üìö',
                    descripcion: 'Comenzar carrera, curso, formaci√≥n',
                    lunaFavorable: ['G√©minis', 'Virgo', 'Sagitario', 'Acuario', 'Ofiuco'],
                    lunaEvitar: ['Aries', 'Tauro'],
                    planetasClave: ['Mercurio', 'J√∫piter', 'Urano'],
                    casasImportantes: [3, 9, 11],
                    casasDesc: 'Casa 3 (aprendizaje), Casa 9 (educaci√≥n superior), Casa 11 (metas)',
                    faseLunarIdeal: 'Luna nueva o creciente',
                    diasSemana: ['Mi√©rcoles (Mercurio)'],
                    horasPlanetarias: ['Mercurio', 'J√∫piter', 'Urano'],
                    mercurio: 'Evitar retr√≥grado',
                    venus: 'Neutral',
                    consejos: [
                        'Mercurio fuerte mejora la capacidad de aprendizaje',
                        'J√∫piter en Casa 9 para estudios superiores',
                        'Luna creciente para absorber conocimiento',
                        'Urano favorable trae insights y comprensi√≥n r√°pida'
                    ]
                },
                'entrevista': {
                    nombre: 'Entrevista de Trabajo',
                    icono: 'üíº',
                    descripcion: 'Entrevista laboral, presentaci√≥n profesional',
                    lunaFavorable: ['Leo', 'Virgo', 'Libra', 'Capricornio'],
                    lunaEvitar: ['C√°ncer', 'Piscis', 'Escorpio'],
                    planetasClave: ['Sol', 'Mercurio', 'J√∫piter'],
                    casasImportantes: [10, 6, 1],
                    casasDesc: 'Casa 10 (carrera), Casa 6 (trabajo), Casa 1 (presencia)',
                    faseLunarIdeal: 'Luna creciente, gibosa o llena',
                    diasSemana: ['Domingo (Sol)', 'Jueves (J√∫piter)'],
                    horasPlanetarias: ['Sol', 'J√∫piter', 'Mercurio'],
                    mercurio: 'Evitar retr√≥grado',
                    venus: 'Precauci√≥n',
                    consejos: [
                        'Sol fuerte da confianza y presencia',
                        'Mercurio directo para comunicar bien',
                        'Luna en Leo da carisma',
                        'Evitar aspectos tensos a Casa 10'
                    ]
                },
                'cita': {
                    nombre: 'Primera Cita / Romance',
                    icono: '‚ù§Ô∏è',
                    descripcion: 'Primera cita, declaraci√≥n, inicio de relaci√≥n',
                    lunaFavorable: ['Tauro', 'Leo', 'Libra', 'Piscis', 'Pegaso'],
                    lunaEvitar: ['Virgo', 'Capricornio', 'Acuario'],
                    planetasClave: ['Venus', 'Luna', 'Marte'],
                    casasImportantes: [5, 7, 1],
                    casasDesc: 'Casa 5 (romance), Casa 7 (pareja), Casa 1 (atractivo)',
                    faseLunarIdeal: 'Luna creciente o llena',
                    diasSemana: ['Viernes (Venus)'],
                    horasPlanetarias: ['Venus', 'Luna'],
                    mercurio: 'Precauci√≥n',
                    venus: 'Evitar estrictamente retr√≥grado',
                    consejos: [
                        'Venus es la estrella del romance',
                        'Luna llena intensifica las emociones',
                        'Marte bien aspectado a√±ade atracci√≥n',
                        'Evitar Saturno en Casa 5 (frialdad)'
                    ]
                },
                'lanzamiento': {
                    nombre: 'Lanzamiento de Proyecto',
                    icono: 'üöÄ',
                    descripcion: 'Lanzar producto, servicio, campa√±a',
                    lunaFavorable: ['Aries', 'Leo', 'Sagitario', 'Acuario'],
                    lunaEvitar: ['C√°ncer', 'Escorpio', 'Piscis'],
                    planetasClave: ['Sol', 'Marte', 'J√∫piter', 'Urano'],
                    casasImportantes: [1, 10, 11],
                    casasDesc: 'Casa 1 (identidad), Casa 10 (visibilidad), Casa 11 (audiencia)',
                    faseLunarIdeal: 'Luna nueva o creciente',
                    diasSemana: ['Domingo (Sol)', 'Martes (Marte)'],
                    horasPlanetarias: ['Sol', 'Marte', 'J√∫piter'],
                    mercurio: 'Evitar estrictamente retr√≥grado',
                    venus: 'Precauci√≥n',
                    consejos: [
                        'Luna nueva para nuevos comienzos con impacto',
                        'Sol fuerte da visibilidad',
                        'Marte aporta energ√≠a de lanzamiento',
                        'J√∫piter expande el alcance'
                    ]
                },
                'contrato': {
                    nombre: 'Firma de Contrato',
                    icono: 'üìù',
                    descripcion: 'Firmar contrato, acuerdo legal, documento importante',
                    lunaFavorable: ['Tauro', 'Virgo', 'Libra', 'Capricornio'],
                    lunaEvitar: ['Aries', 'G√©minis', 'Sagitario'],
                    planetasClave: ['Mercurio', 'Saturno', 'J√∫piter'],
                    casasImportantes: [3, 7, 10],
                    casasDesc: 'Casa 3 (documentos), Casa 7 (acuerdos), Casa 10 (autoridad)',
                    faseLunarIdeal: 'Luna creciente o gibosa',
                    diasSemana: ['Mi√©rcoles', 'S√°bado'],
                    horasPlanetarias: ['Mercurio', 'Saturno'],
                    mercurio: 'Evitar estrictamente retr√≥grado',
                    venus: 'Evitar retr√≥grado',
                    consejos: [
                        'Mercurio directo es absolutamente esencial',
                        'Saturno bien aspectado da solidez al acuerdo',
                        'Evitar Luna vac√≠a de curso',
                        'Casa 7 sin mal√©ficos para acuerdos justos'
                    ]
                }
            };
            
            const tipo = eleccionesState.tipoSeleccionado;
            const evento = tipo ? TIPOS_EVENTO[tipo] : null;
            
            // Calcular fase lunar actual
            const hoy = new Date();
            const faseLunar = calcularFaseLunar(hoy);
            const diaSemana = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'][hoy.getDay()];
            const planetaDia = { 0: 'Sol', 1: 'Luna', 2: 'Marte', 3: 'Mercurio', 4: 'J√∫piter', 5: 'Venus', 6: 'Saturno' }[hoy.getDay()];
            
            // HTML
            let html = `
                <div class="analysis-card" style="background:linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.1));border-left:4px solid #667eea;">
                    <div class="analysis-title">üåü Astrolog√≠a Electiva</div>
                    <p style="margin:0;font-size:0.9rem;color:var(--text-dim);">
                        Encuentra el mejor momento astrol√≥gico para iniciar actividades importantes.
                        Selecciona el tipo de evento para ver los requisitos ideales.
                    </p>
                    <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;padding:10px;background:var(--bg-elevated);border-radius:10px;">
                        <span style="font-size:0.85rem;"><strong>Hoy:</strong> ${diaSemana} (${planetaDia})</span>
                        <span style="font-size:0.85rem;">‚Ä¢</span>
                        <span style="font-size:0.85rem;"><strong>Fase:</strong> ${faseLunar.icono} ${faseLunar.nombre}</span>
                    </div>
                </div>
                
                <div class="analysis-card">
                    <div class="analysis-title">üìã Tipo de Actividad</div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(100px, 1fr));gap:10px;">
                        ${Object.entries(TIPOS_EVENTO).map(([key, ev]) => `
                            <div class="evento-selector ${tipo === key ? 'selected' : ''}" data-tipo="${key}"
                                 style="background:${tipo === key ? 'var(--gold-gradient)' : 'var(--bg-elevated)'};
                                        padding:12px 8px;border-radius:10px;text-align:center;cursor:pointer;
                                        transition:all 0.2s;border:2px solid ${tipo === key ? 'var(--gold)' : 'transparent'};">
                                <div style="font-size:1.8rem;margin-bottom:4px;">${ev.icono}</div>
                                <div style="font-size:0.7rem;font-weight:${tipo === key ? '600' : '400'};
                                            color:${tipo === key ? 'var(--bg-primary)' : 'var(--text-secondary)'};">
                                    ${ev.nombre.split('/')[0].trim()}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            
            // Si hay un tipo seleccionado, mostrar detalles
            if (evento) {
                html += `
                <div class="analysis-card" style="border-left:4px solid #667eea;">
                    <div class="analysis-title">${evento.icono} ${evento.nombre}</div>
                    <p style="margin:0 0 15px 0;font-size:0.9rem;color:var(--text-dim);">${evento.descripcion}</p>
                    
                    <!-- Luna -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:15px;">
                        <div style="background:rgba(76,175,80,0.1);padding:12px;border-radius:10px;border:1px solid rgba(76,175,80,0.3);">
                            <div style="font-weight:600;color:#4caf50;font-size:0.85rem;margin-bottom:6px;">‚òΩ Luna Favorable</div>
                            <div style="font-size:0.8rem;display:flex;flex-wrap:wrap;gap:4px;">
                                ${evento.lunaFavorable.map(s => `<span style="background:rgba(76,175,80,0.2);padding:2px 6px;border-radius:4px;">${s}</span>`).join('')}
                            </div>
                        </div>
                        <div style="background:rgba(244,67,54,0.1);padding:12px;border-radius:10px;border:1px solid rgba(244,67,54,0.3);">
                            <div style="font-weight:600;color:#f44336;font-size:0.85rem;margin-bottom:6px;">‚òΩ Luna a Evitar</div>
                            <div style="font-size:0.8rem;display:flex;flex-wrap:wrap;gap:4px;">
                                ${evento.lunaEvitar.map(s => `<span style="background:rgba(244,67,54,0.2);padding:2px 6px;border-radius:4px;">${s}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Planetas y Casas -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:15px;">
                        <div style="background:var(--bg-elevated);padding:12px;border-radius:10px;">
                            <div style="font-weight:600;font-size:0.85rem;margin-bottom:6px;">ü™ê Planetas Clave</div>
                            <div style="font-size:0.85rem;">${evento.planetasClave.join(', ')}</div>
                        </div>
                        <div style="background:var(--bg-elevated);padding:12px;border-radius:10px;">
                            <div style="font-weight:600;font-size:0.85rem;margin-bottom:6px;">üè† Casas Importantes</div>
                            <div style="font-size:0.8rem;color:var(--text-dim);">${evento.casasDesc}</div>
                        </div>
                    </div>
                    
                    <!-- Timing -->
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:15px;">
                        <div style="background:var(--bg-elevated);padding:10px;border-radius:8px;text-align:center;">
                            <div style="font-size:0.7rem;color:var(--text-dim);">üåô Fase Lunar</div>
                            <div style="font-size:0.8rem;font-weight:600;">${evento.faseLunarIdeal}</div>
                        </div>
                        <div style="background:var(--bg-elevated);padding:10px;border-radius:8px;text-align:center;">
                            <div style="font-size:0.7rem;color:var(--text-dim);">üìÖ D√≠as</div>
                            <div style="font-size:0.8rem;font-weight:600;">${evento.diasSemana.join(', ')}</div>
                        </div>
                        <div style="background:var(--bg-elevated);padding:10px;border-radius:8px;text-align:center;">
                            <div style="font-size:0.7rem;color:var(--text-dim);">‚è∞ Horas</div>
                            <div style="font-size:0.8rem;font-weight:600;">${evento.horasPlanetarias.join(', ')}</div>
                        </div>
                    </div>
                    
                    <!-- Retrogradaciones -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">
                        <div style="background:var(--bg-elevated);padding:10px;border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-dim);">‚òø Mercurio Retr√≥grado</div>
                            <div style="font-size:0.85rem;font-weight:600;color:${evento.mercurio.includes('estrictamente') ? '#f44336' : evento.mercurio.includes('Evitar') ? '#ff9800' : '#4caf50'};">
                                ${evento.mercurio}
                            </div>
                        </div>
                        <div style="background:var(--bg-elevated);padding:10px;border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-dim);">‚ôÄ Venus Retr√≥grado</div>
                            <div style="font-size:0.85rem;font-weight:600;color:${evento.venus.includes('estrictamente') ? '#f44336' : evento.venus.includes('Evitar') ? '#ff9800' : '#4caf50'};">
                                ${evento.venus}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Consejos -->
                    <div style="background:rgba(102,126,234,0.1);padding:12px;border-radius:10px;border:1px solid rgba(102,126,234,0.3);">
                        <div style="font-weight:600;color:#667eea;font-size:0.85rem;margin-bottom:8px;">üí° Consejos</div>
                        ${evento.consejos.map(c => `
                            <div style="font-size:0.8rem;margin-bottom:4px;padding-left:12px;position:relative;">
                                <span style="position:absolute;left:0;color:#667eea;">‚Ä¢</span> ${c}
                            </div>
                        `).join('')}
                    </div>
                    
                    ${evento.zonasSigno ? `
                    <div style="margin-top:15px;background:rgba(255,152,0,0.1);padding:12px;border-radius:10px;border:1px solid rgba(255,152,0,0.3);">
                        <div style="font-weight:600;color:#ff9800;font-size:0.85rem;margin-bottom:8px;">‚ö†Ô∏è Zonas del Cuerpo por Signo</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:0.7rem;">
                            ${Object.entries(evento.zonasSigno).map(([s, z]) => `
                                <div><strong>${s}:</strong> ${z}</div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- BUSCADOR DE FECHAS -->
                    <div style="margin-top:20px;padding:15px;background:var(--gold-gradient);border-radius:12px;">
                        <div style="font-weight:600;color:var(--bg-primary);font-size:0.9rem;margin-bottom:10px;">üîÆ Buscar Mejores Fechas</div>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <select id="dias-buscar" style="flex:1;padding:10px;border-radius:8px;border:none;font-size:0.9rem;">
                                <option value="7">Pr√≥ximos 7 d√≠as</option>
                                <option value="14" selected>Pr√≥ximos 14 d√≠as</option>
                                <option value="30">Pr√≥ximo mes</option>
                            </select>
                            <button id="btn-buscar-fechas" style="padding:10px 20px;background:var(--bg-primary);color:var(--gold);border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                Buscar
                            </button>
                        </div>
                    </div>
                </div>`;
            }
            
            // Vista de resultados
            if (eleccionesState.vista === 'resultados' && eleccionesState.resultados.length > 0) {
                const top5 = eleccionesState.resultados.slice(0, 5);
                const resto = eleccionesState.resultados.slice(5);
                
                html += `
                <div class="analysis-card">
                    <button id="btn-volver-elecciones" style="padding:8px 16px;background:var(--bg-elevated);border:1px solid var(--border-color);border-radius:20px;font-size:0.8rem;cursor:pointer;margin-bottom:15px;">
                        ‚Üê Volver
                    </button>
                    <div class="analysis-title">üèÜ Mejores Fechas para ${evento?.nombre || 'tu actividad'}</div>
                    <p style="font-size:0.8rem;color:var(--text-dim);margin:0 0 15px 0;">
                        Pr√≥ximos ${eleccionesState.diasBuscar} d√≠as ordenados por puntuaci√≥n
                    </p>
                    
                    <!-- Top 5 -->
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        ${top5.map((r, i) => {
                            const fechaStr = r.fecha.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
                            return `
                            <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-elevated);border-radius:10px;border-left:4px solid ${r.color};">
                                <div style="font-size:1.5rem;font-weight:700;color:${r.color};min-width:45px;text-align:center;">
                                    ${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `#${i+1}`}
                                </div>
                                <div style="flex:1;">
                                    <div style="font-weight:600;font-size:0.95rem;">${fechaStr}</div>
                                    <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;">
                                        <span style="font-size:0.7rem;padding:2px 6px;border-radius:4px;background:${r.color}22;color:${r.color};">${r.calificacion}</span>
                                        <span style="font-size:0.7rem;padding:2px 6px;border-radius:4px;background:var(--bg-card);">${r.fase.icono} ${r.fase.nombre}</span>
                                        ${r.factores.filter(f => f.tipo === 'positivo').slice(0, 2).map(f => `
                                            <span style="font-size:0.65rem;padding:2px 5px;border-radius:4px;background:rgba(76,175,80,0.15);color:#4caf50;">${f.texto}</span>
                                        `).join('')}
                                        ${r.factores.filter(f => f.tipo === 'negativo').slice(0, 1).map(f => `
                                            <span style="font-size:0.65rem;padding:2px 5px;border-radius:4px;background:rgba(244,67,54,0.15);color:#f44336;">${f.texto}</span>
                                        `).join('')}
                                    </div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:1.3rem;font-weight:700;color:${r.color};">${r.puntos}</div>
                                    <div style="font-size:0.6rem;color:var(--text-dim);">pts</div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                    
                    ${resto.length > 0 ? `
                    <details style="margin-top:15px;">
                        <summary style="cursor:pointer;font-size:0.85rem;color:var(--text-dim);padding:10px;">
                            Ver ${resto.length} fechas m√°s...
                        </summary>
                        <div style="display:flex;flex-direction:column;gap:8px;margin-top:10px;">
                            ${resto.map(r => {
                                const fechaStr = r.fecha.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
                                return `
                                <div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-elevated);border-radius:8px;border-left:3px solid ${r.color};">
                                    <div style="flex:1;">
                                        <span style="font-weight:500;font-size:0.85rem;">${fechaStr}</span>
                                        <span style="font-size:0.7rem;margin-left:8px;color:${r.color};">${r.calificacion}</span>
                                    </div>
                                    <div style="font-weight:600;color:${r.color};">${r.puntos}</div>
                                </div>`;
                            }).join('')}
                        </div>
                    </details>
                    ` : ''}
                </div>`;
            }
            
            // Info adicional (solo en selector)
            if (eleccionesState.vista === 'selector') {
                html += `
                <div class="analysis-card" style="background:linear-gradient(135deg, rgba(156,39,176,0.1), rgba(103,58,183,0.05));">
                    <div class="analysis-title">üìñ Sobre la Astrolog√≠a Electiva</div>
                    <div style="font-size:0.85rem;line-height:1.6;color:var(--text-dim);">
                        <p style="margin:0 0 10px 0;">
                            La <strong>astrolog√≠a electiva</strong> es el arte de elegir el momento √≥ptimo para iniciar 
                            actividades importantes. Se basa en analizar la posici√≥n de los planetas, la fase lunar, 
                            y otros factores astrol√≥gicos.
                        </p>
                        <p style="margin:0;">
                            <strong>Factores clave:</strong> La Luna es fundamental (su signo y fase), los planetas 
                            regentes de la actividad, las retrogradaciones de Mercurio y Venus, y las casas astrol√≥gicas 
                            involucradas.
                        </p>
                    </div>
                </div>`;
            }
            
            document.getElementById('tab-elecciones').innerHTML = html;
            
            // Agregar event listeners a los selectores
            document.querySelectorAll('.evento-selector').forEach(el => {
                el.addEventListener('click', () => {
                    eleccionesState.tipoSeleccionado = el.dataset.tipo;
                    eleccionesState.vista = 'selector';
                    renderElecciones();
                });
            });
            
            // Bot√≥n buscar
            document.getElementById('btn-buscar-fechas')?.addEventListener('click', () => {
                const dias = parseInt(document.getElementById('dias-buscar')?.value || '14');
                eleccionesState.diasBuscar = dias;
                const eventoCompleto = { ...evento, id: tipo };
                eleccionesState.resultados = buscarMejoresDias(eventoCompleto, dias);
                eleccionesState.vista = 'resultados';
                renderElecciones();
            });
            
            // Bot√≥n volver
            document.getElementById('btn-volver-elecciones')?.addEventListener('click', () => {
                eleccionesState.vista = 'selector';
                renderElecciones();
            });
            
            console.log('üåü Elecciones renderizado OK');
            
        } catch (error) {
            console.error('‚ùå Error en renderElecciones:', error);
            document.getElementById('tab-elecciones').innerHTML = `
                <div class="analysis-card" style="background:rgba(231,76,60,0.1);border:1px solid #e74c3c;">
                    <div class="analysis-title">‚ùå Error al cargar Elecciones</div>
                    <p>${error.message}</p>
                </div>`;
        }
    }
    
    // Event listeners para Personal
    // Campo de ciudad de nacimiento
    document.getElementById('perfil-ciudad')?.addEventListener('input', (e) => {
        clearTimeout(citySearchTimeout);
        citySearchTimeout = setTimeout(() => searchCities(e.target.value, 'birth'), 500);
    });
    
    // Campo de ciudad de residencia
    document.getElementById('perfil-residencia')?.addEventListener('input', (e) => {
        clearTimeout(citySearchTimeout);
        citySearchTimeout = setTimeout(() => searchCities(e.target.value, 'residence'), 500);
    });
    
    // Click en resultados de ciudad de nacimiento
    document.getElementById('city-results')?.addEventListener('click', (e) => {
        const item = e.target.closest('.city-result-item');
        if (item && item.dataset.lat) {
            const lon = parseFloat(item.dataset.lon);
            const countryCode = item.dataset.country || '';
            const fechaInput = document.getElementById('perfil-fecha').value;
            
            document.getElementById('perfil-ciudad').value = item.dataset.name;
            document.getElementById('perfil-lat').value = item.dataset.lat;
            document.getElementById('perfil-lon').value = lon;
            document.getElementById('perfil-country').value = countryCode;
            
            // Calcular TZ usando timezone name
            let tz = getTZFromLongitude(lon);
            let tzName = 'UTC' + (tz >= 0 ? '+' : '') + tz;
            let esVerano = false;
            
            if (countryCode && fechaInput) {
                const [year, month, day] = fechaInput.split('-').map(Number);
                const tzIANA = getTimezoneFromCountry(countryCode);
                tz = calcularTZ(countryCode, year, month, day);
                
                // Detectar si es horario de verano comparando con invierno
                const tzInvierno = getTimezoneOffset(tzIANA, year, 1, 15);
                esVerano = tz > tzInvierno;
                tzName = tzIANA.split('/')[1]?.replace('_', ' ') || tzIANA;
            }
            
            document.getElementById('perfil-tz').value = tz;
            
            // Mostrar info del TZ
            const tzInfo = document.getElementById('tz-info');
            const tzDisplay = document.getElementById('tz-display');
            if (tzInfo && tzDisplay) {
                tzDisplay.textContent = `${tzName} (UTC${tz >= 0 ? '+' : ''}${tz}) ${esVerano ? '‚òÄÔ∏è Verano' : '‚ùÑÔ∏è Invierno'}`;
                tzInfo.style.display = 'block';
            }
            
            document.getElementById('city-results').classList.remove('show');
        }
    });
    
    // Click en resultados de ciudad de residencia
    document.getElementById('city-results-res')?.addEventListener('click', (e) => {
        const item = e.target.closest('.city-result-item');
        if (item && item.dataset.lat) {
            const lon = parseFloat(item.dataset.lon);
            const countryCode = item.dataset.country || '';
            
            document.getElementById('perfil-residencia').value = item.dataset.name;
            document.getElementById('perfil-res-lat').value = item.dataset.lat;
            document.getElementById('perfil-res-lon').value = lon;
            
            // Para residencia usamos fecha actual
            let tz = getTZFromLongitude(lon);
            if (countryCode) {
                const now = new Date();
                tz = calcularTZ(countryCode, now.getFullYear(), now.getMonth() + 1, now.getDate());
            }
            document.getElementById('perfil-res-tz').value = tz;
            document.getElementById('city-results-res').classList.remove('show');
        }
    });
    
    // Recalcular TZ cuando cambia la fecha (por DST)
    document.getElementById('perfil-fecha')?.addEventListener('change', (e) => {
        const countryCode = document.getElementById('perfil-country')?.value || '';
        const lon = parseFloat(document.getElementById('perfil-lon').value);
        
        if (e.target.value) {
            const [year, month, day] = e.target.value.split('-').map(Number);
            let tz = isNaN(lon) ? 0 : getTZFromLongitude(lon);
            let tzName = 'UTC' + (tz >= 0 ? '+' : '') + tz;
            let esVerano = false;
            
            if (countryCode) {
                const tzIANA = getTimezoneFromCountry(countryCode);
                tz = calcularTZ(countryCode, year, month, day);
                
                // Detectar si es horario de verano comparando con invierno
                const tzInvierno = getTimezoneOffset(tzIANA, year, 1, 15);
                esVerano = tz > tzInvierno;
                tzName = tzIANA.split('/')[1]?.replace('_', ' ') || tzIANA;
            }
            
            document.getElementById('perfil-tz').value = tz;
            
            // Mostrar info del TZ
            const tzInfo = document.getElementById('tz-info');
            const tzDisplay = document.getElementById('tz-display');
            if (tzInfo && tzDisplay && countryCode) {
                tzDisplay.textContent = `${tzName} (UTC${tz >= 0 ? '+' : ''}${tz}) ${esVerano ? '‚òÄÔ∏è Verano' : '‚ùÑÔ∏è Invierno'}`;
                tzInfo.style.display = 'block';
            }
        }
    });
    
    document.getElementById('calcular-carta')?.addEventListener('click', () => {
        const name = document.getElementById('perfil-nombre').value.trim();
        const birthDate = document.getElementById('perfil-fecha').value;
        const birthTime = document.getElementById('perfil-hora').value;
        const city = document.getElementById('perfil-ciudad').value;
        const lat = parseFloat(document.getElementById('perfil-lat').value);
        const lon = parseFloat(document.getElementById('perfil-lon').value);
        const countryCode = document.getElementById('perfil-country')?.value || '';
        const tz = parseFloat(document.getElementById('perfil-tz').value) || getTZFromLongitude(lon);
        
        // Residencia
        const residencia = document.getElementById('perfil-residencia').value;
        const resLat = parseFloat(document.getElementById('perfil-res-lat').value);
        const resLon = parseFloat(document.getElementById('perfil-res-lon').value);
        const resTz = parseFloat(document.getElementById('perfil-res-tz').value) || getTZFromLongitude(resLon);
        
        if (!name || !birthDate || !birthTime || !city || isNaN(lat)) {
            alert('Por favor, completa los datos de nacimiento');
            return;
        }
        
        // Si no hay residencia, usar lugar de nacimiento
        const residence = residencia && !isNaN(resLat) ? {
            city: residencia,
            lat: resLat,
            lon: resLon,
            tz: resTz
        } : { city, lat, lon, tz };
        
        perfilState.perfil = { name, birthDate, birthTime, city, lat, lon, tz, countryCode, residence };
        
        // Debug TZ
        console.log('üïê TZ Debug:', { birthTime, tz, countryCode, lon });
        
        // Crear fecha "ingenua" - la hora es la que introduce el usuario
        const [year, month, day] = birthDate.split('-').map(Number);
        const [hour, minute] = birthTime.split(':').map(Number);
        const fechaNac = { year, month, day, hour, minute };
        
        console.log('üïê Fecha nacimiento:', fechaNac, 'TZ:', tz);
        
        perfilState.cartaNatal = calcularCartaNatal(fechaNac, lat, lon, tz);
        
        guardarPerfil();
        renderPersonal();
    });
    
    document.getElementById('editar-perfil')?.addEventListener('click', () => {
        if (perfilState.perfil) {
            document.getElementById('perfil-nombre').value = perfilState.perfil.name;
            document.getElementById('perfil-fecha').value = perfilState.perfil.birthDate;
            document.getElementById('perfil-hora').value = perfilState.perfil.birthTime;
            document.getElementById('perfil-ciudad').value = perfilState.perfil.city;
            document.getElementById('perfil-lat').value = perfilState.perfil.lat;
            document.getElementById('perfil-lon').value = perfilState.perfil.lon;
            document.getElementById('perfil-tz').value = perfilState.perfil.tz || '';
            document.getElementById('perfil-country').value = perfilState.perfil.countryCode || '';
            
            // Mostrar info del TZ
            const countryCode = perfilState.perfil.countryCode;
            if (countryCode && perfilState.perfil.birthDate) {
                const [year, month, day] = perfilState.perfil.birthDate.split('-').map(Number);
                const tzIANA = getTimezoneFromCountry(countryCode);
                const tz = perfilState.perfil.tz;
                const tzInvierno = getTimezoneOffset(tzIANA, year, 1, 15);
                const esVerano = tz > tzInvierno;
                const tzName = tzIANA.split('/')[1]?.replace('_', ' ') || tzIANA;
                
                const tzInfo = document.getElementById('tz-info');
                const tzDisplay = document.getElementById('tz-display');
                if (tzInfo && tzDisplay) {
                    tzDisplay.textContent = `${tzName} (UTC${tz >= 0 ? '+' : ''}${tz}) ${esVerano ? '‚òÄÔ∏è Verano' : '‚ùÑÔ∏è Invierno'}`;
                    tzInfo.style.display = 'block';
                }
            }
            
            // Residencia
            if (perfilState.perfil.residence) {
                document.getElementById('perfil-residencia').value = perfilState.perfil.residence.city || '';
                document.getElementById('perfil-res-lat').value = perfilState.perfil.residence.lat || '';
                document.getElementById('perfil-res-lon').value = perfilState.perfil.residence.lon || '';
                document.getElementById('perfil-res-tz').value = perfilState.perfil.residence.tz || '';
            }
        }
        document.getElementById('personal-setup').style.display = 'block';
        document.getElementById('personal-content').style.display = 'none';
    });
    
    // Tabs de Personal
    document.querySelectorAll('.personal-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.personal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.personal-panel').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            const tabId = tab.dataset.tab;
            document.getElementById('tab-' + tabId).classList.add('active');
            
            // Render content on demand
            if (tabId === 'vocacion') renderVocacion();
            if (tabId === 'finanzas') renderFinanzas();
            if (tabId === 'hogar') renderHogar();
            if (tabId === 'relaciones') renderRelaciones();
            if (tabId === 'elecciones') renderElecciones();
            if (tabId === 'espiritual') renderEspiritual();
        });
    });

    // ========================================================================
    // INICIALIZACI√ìN
    // ========================================================================
    
    if ('serviceWorker' in navigator) {
        // Solo registrar SW si no estamos en file://
        if ('serviceWorker' in navigator && location.protocol !== 'file:') {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
    }

    // ========================================================================
    // SISTEMA DE EVENTOS - UI (con fotos y v√≠deos)
    // ========================================================================
    
    // Variables temporales para fotos y v√≠deos
    let tempEventPhotos = [];
    let tempEventVideos = [];
    let currentEditEventId = null;
    
    function imageToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }
    
    function extractYouTubeId(url) {
        const match = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
        return match ? match[1] : null;
    }
    
    function renderEventPhotosPreview() {
        const container = document.getElementById('event-photos-preview');
        if (!container) return;
        container.innerHTML = tempEventPhotos.map((photo, i) => `
            <div class="photo-preview-item">
                <img src="${photo}" alt="Preview">
                <button type="button" class="remove-photo" onclick="removeEventPhoto(${i})">√ó</button>
            </div>
        `).join('');
    }
    
    function renderEventVideosList() {
        const container = document.getElementById('event-videos-list');
        if (!container) return;
        container.innerHTML = tempEventVideos.map((video, i) => {
            const isLocal = video.startsWith('data:') || video.startsWith('blob:');
            const isYouTube = video.includes('youtube.com') || video.includes('youtu.be');
            const label = isLocal ? 'üì± V√≠deo local' : (isYouTube ? '‚ñ∂ YouTube' : 'üîó URL');
            const displayUrl = isLocal ? 'V√≠deo del equipo' : video.substring(0, 40) + (video.length > 40 ? '...' : '');
            return `
                <div class="video-item">
                    <span>${label}</span>
                    <span class="video-url">${displayUrl}</span>
                    <button type="button" class="remove-video" onclick="removeEventVideo(${i})">√ó</button>
                </div>
            `;
        }).join('');
    }
    
    // Handler para subir v√≠deos locales
    async function handleEventVideoUpload(e) {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith('video/')) return;
        
        try {
            // Convertir a base64 para guardar en localStorage
            const base64 = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
            tempEventVideos.push(base64);
            renderEventVideosList();
        } catch (err) {
            console.error('Error al cargar v√≠deo:', err);
            alert('Error al cargar el v√≠deo. Puede ser demasiado grande.');
        }
        e.target.value = '';
    }
    
    window.removeEventPhoto = function(index) {
        tempEventPhotos.splice(index, 1);
        renderEventPhotosPreview();
    };
    
    window.removeEventVideo = function(index) {
        tempEventVideos.splice(index, 1);
        renderEventVideosList();
    };
    
    async function handleEventPhotoUpload(e) {
        const files = Array.from(e.target.files);
        for (const file of files) {
            if (file.type.startsWith('image/')) {
                try {
                    const base64 = await imageToBase64(file);
                    tempEventPhotos.push(base64);
                } catch (err) {
                    console.error('Error al cargar imagen:', err);
                }
            }
        }
        renderEventPhotosPreview();
        e.target.value = '';
    }
    
    function resetEventForm() {
        document.getElementById('event-title').value = '';
        document.getElementById('event-time').value = '';
        document.getElementById('event-notes').value = '';
        document.getElementById('event-video-url').value = '';
        document.getElementById('event-recurrence').value = 'none';
        document.getElementById('event-rec-start').value = '';
        document.getElementById('event-rec-end').value = '';
        document.getElementById('recurrence-dates').style.display = 'none';
        tempEventPhotos = [];
        tempEventVideos = [];
        currentEditEventId = null;
        renderEventPhotosPreview();
        renderEventVideosList();
        document.querySelectorAll('#event-categories .category-item').forEach(i => i.classList.remove('selected'));
        document.querySelector('#event-categories .category-item[data-cat="trabajo"]')?.classList.add('selected');
    }
    
    // Mostrar/ocultar campos de fechas de recurrencia
    window.toggleRecurrenceFields = function() {
        const recurrence = document.getElementById('event-recurrence').value;
        const datesDiv = document.getElementById('recurrence-dates');
        const fechaEvento = document.getElementById('event-date').value;
        
        if (recurrence !== 'none') {
            datesDiv.style.display = 'block';
            // Auto-rellenar fecha inicio con la fecha del evento si est√° vac√≠a
            if (!document.getElementById('event-rec-start').value && fechaEvento) {
                document.getElementById('event-rec-start').value = fechaEvento;
            }
        } else {
            datesDiv.style.display = 'none';
        }
    };
    
    function renderEventosDelDia(fecha) {
        const eventos = getEventosPorFecha(fecha);
        const container = document.querySelector('.events-section');
        if (!container) return;
        
        // Guardar la fecha seleccionada para usarla al crear eventos
        state.fechaSeleccionada = fecha;
        
        const fechaStr = fecha.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
        
        if (eventos.length === 0) {
            container.innerHTML = `
                <div class="events-section-title">üìã ${fechaStr}</div>
                <p style="color:var(--text-dim);text-align:center;padding:16px;">No hay eventos</p>
            `;
        } else {
            container.innerHTML = `
                <div class="events-section-title">üìã ${fechaStr} (${eventos.length})</div>
                ${eventos.map(e => {
                    const cat = CATEGORIAS_EVENTOS[e.categoria] || CATEGORIAS_EVENTOS.otro;
                    const hasMedia = (e.fotos && e.fotos.length > 0) || (e.videos && e.videos.length > 0);
                    const recIcon = e.recurrencia && e.recurrencia !== 'none' ? (e.recurrencia === 'yearly' ? ' üéÇ' : ' üîÑ') : '';
                    return `
                        <div class="event-item" style="border-left-color:${cat.color};cursor:pointer;" onclick="verEvento(${e.id})">
                            <div class="event-time">${e.hora || '--:--'}</div>
                            <div class="event-title">${e.titulo}${recIcon}${hasMedia ? ' üìé' : ''}</div>
                            <div class="event-category">${cat.icon}</div>
                            <button class="event-delete" onclick="event.stopPropagation();eliminarEventoUI(${e.id})">√ó</button>
                        </div>
                    `;
                }).join('')}
            `;
        }
    }
    
    
    
    // Funci√≥n para descargar imagen del d√≠a seleccionado
    // ========== EXPORTAR IMAGEN (PNG) - Captura del modal ==========
    window.descargarImagenDia = async function() {
        const fecha = state.fechaSeleccionada || new Date();
        const diaLunar = state.diaLunar28Seleccionado || getDiaLunar(fecha);
        const exalt = getExaltacionDia(diaLunar);
        const esFileProtocol = window.location.protocol === 'file:';
        
        // En file:// usamos canvas manual directamente
        if (esFileProtocol) {
            try {
                const canvas = await generarCanvasManual(fecha);
                const link = document.createElement('a');
                const fechaFile = fecha.toISOString().split('T')[0];
                link.download = `tarot_${exalt.planeta.toLowerCase().replace(/\s/g, '_')}_${fechaFile}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch(e) {
                console.error('Error al exportar imagen:', e);
                alert('Error al exportar imagen: ' + e.message);
            }
            return;
        }
        
        // En servidor web usamos html2canvas
        const modalContent = document.querySelector('#modal .modal');
        if (!modalContent) {
            alert('No hay contenido para exportar. Abre un d√≠a del calendario primero.');
            return;
        }
        
        // Ocultar botones temporalmente
        const botones = modalContent.querySelectorAll('button');
        botones.forEach(b => b.style.display = 'none');
        
        try {
            const canvas = await html2canvas(modalContent, {
                backgroundColor: '#12121f',
                scale: 2,
                useCORS: true,
                allowTaint: true,
                logging: false
            });
            
            // Restaurar botones
            botones.forEach(b => b.style.display = '');
            
            // Descargar
            const link = document.createElement('a');
            const fechaFile = fecha.toISOString().split('T')[0];
            link.download = `tarot_${exalt.planeta.toLowerCase().replace(/\s/g, '_')}_${fechaFile}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        } catch(e) {
            console.error('Error al exportar imagen:', e);
            botones.forEach(b => b.style.display = '');
            alert('Error al exportar imagen: ' + e.message);
        }
    };
    
    // ========== EXPORTAR PDF - Captura del modal ==========
    window.descargarPDFDia = async function() {
        const fecha = state.fechaSeleccionada || new Date();
        const diaLunar = state.diaLunar28Seleccionado || getDiaLunar(fecha);
        const exalt = getExaltacionDia(diaLunar);
        const esFileProtocol = window.location.protocol === 'file:';
        
        // En file:// usamos canvas manual directamente
        if (esFileProtocol) {
            try {
                const canvas = await generarCanvasManual(fecha);
                
                const { jsPDF } = window.jspdf;
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                let position = 0;
                let heightLeft = imgHeight;
                
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                const fechaFile = fecha.toISOString().split('T')[0];
                pdf.save(`tarot_${exalt.planeta.toLowerCase().replace(/\s/g, '_')}_${fechaFile}.pdf`);
            } catch(e) {
                console.error('Error al exportar PDF:', e);
                alert('Error al exportar PDF: ' + e.message);
            }
            return;
        }
        
        // En servidor web usamos html2canvas
        const modalContent = document.querySelector('#modal .modal');
        if (!modalContent) {
            alert('No hay contenido para exportar. Abre un d√≠a del calendario primero.');
            return;
        }
        
        // Ocultar botones temporalmente
        const botones = modalContent.querySelectorAll('button');
        botones.forEach(b => b.style.display = 'none');
        
        try {
            const canvas = await html2canvas(modalContent, {
                backgroundColor: '#12121f',
                scale: 2,
                useCORS: true,
                allowTaint: true,
                logging: false
            });
            
            // Restaurar botones
            botones.forEach(b => b.style.display = '');
            
            // Crear PDF
            const { jsPDF } = window.jspdf;
            const imgWidth = 210; // A4 width in mm
            const pageHeight = 297; // A4 height in mm
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            const pdf = new jsPDF('p', 'mm', 'a4');
            let position = 0;
            let heightLeft = imgHeight;
            
            // Primera p√°gina
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
            
            // P√°ginas adicionales si el contenido es muy largo
            while (heightLeft > 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }
            
            // Descargar
            const fechaFile = fecha.toISOString().split('T')[0];
            pdf.save(`tarot_${exalt.planeta.toLowerCase().replace(/\s/g, '_')}_${fechaFile}.pdf`);
        } catch(e) {
            console.error('Error al exportar PDF:', e);
            botones.forEach(b => b.style.display = '');
            alert('Error al exportar PDF: ' + e.message);
        }
    };
    
    // ========== GENERAR CANVAS MANUAL (fallback para file://) ==========
    async function generarCanvasManual(fecha) {
        // Usar el d√≠a lunar guardado del modal (que usa el ciclo de 28)
        const diaLunar = state.diaLunar28Seleccionado || getDiaLunar(fecha);
        const exalt = getExaltacionDia(diaLunar);
        const fase = getFaseLunar(diaLunar);
        const infoDia = DIAS_SEMANA[fecha.getDay()];
        const posiciones = getPosicionesPlanetarias(fecha);
        const carta = getCartaDia(diaLunar);
        const aspectos = calcularAspectos(posiciones);
        const patrones = detectarPatrones(posiciones);
        const interpretacion = getInterpretacionDia(exalt, fecha.getDay(), fecha);
        const eventos = getEventosPorFecha(fecha);
        
        // Aspectos y figuras tr√°nsito-natal
        let aspectosNatal = [];
        let patronesNatal = [];
        if (typeof perfilState !== 'undefined' && perfilState.cartaNatal && perfilState.cartaNatal.posiciones) {
            aspectosNatal = calcularAspectosTransitoNatalModal(posiciones, perfilState.cartaNatal);
            patronesNatal = detectarPatronesTransitoNatalModal(posiciones, perfilState.cartaNatal);
        }
        
        // Filtrar aspectos mayores
        const aspectosMayores = ['conjuncion', 'sextil', 'cuadratura', 'trigono', 'oposicion'];
        const aspectosFiltrados = aspectos.filter(a => aspectosMayores.includes(a.tipo));
        
        // Limpiar HTML de la interpretaci√≥n
        const interpLimpio = interpretacion.replace(/<[^>]+>/g, '');
        
        // Crear canvas temporal para medir texto
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.font = '15px Georgia, serif';
        
        // Calcular altura necesaria
        let alturaEstimada = 150; // Header
        alturaEstimada += 80; // Fecha y exaltaci√≥n
        alturaEstimada += 60; // Fase lunar
        alturaEstimada += 80; // Posiciones planetarias
        alturaEstimada += 30 + (7 * 24); // Funciones planetarias
        alturaEstimada += 30 + (wrapText(tempCtx, interpLimpio, 700).length * 22); // Interpretaci√≥n
        
        if (patrones.length > 0) {
            alturaEstimada += 40 + (patrones.length * 50); // Figuras
        }
        if (aspectosFiltrados.length > 0) {
            alturaEstimada += 40 + (Math.min(aspectosFiltrados.length, 6) * 45); // Aspectos detallados
        }
        if (patronesNatal.length > 0 || aspectosNatal.length > 0) {
            alturaEstimada += 50; // T√≠tulo tr√°nsitos-natal
            if (patronesNatal.length > 0) {
                alturaEstimada += 30 + (patronesNatal.length * 28);
            }
            if (aspectosNatal.length > 0) {
                alturaEstimada += 30 + (Math.min(aspectosNatal.length, 6) * 28);
            }
        }
        alturaEstimada += 280; // Carta del d√≠a
        alturaEstimada += 50 + (wrapText(tempCtx, exalt.texto, 700).length * 20); // Mito
        if (eventos.length > 0) {
            alturaEstimada += 50 + (eventos.length * 60);
        }
        alturaEstimada += 80; // Footer
        
        // Crear canvas
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = Math.max(1600, alturaEstimada);
        
        // Fondo degradado
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#0a0a1a');
        gradient.addColorStop(0.3, '#12121f');
        gradient.addColorStop(0.7, '#12121f');
        gradient.addColorStop(1, '#0a0a1a');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Estrellas decorativas
        ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
        for (let i = 0; i < 150; i++) {
            ctx.beginPath();
            ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, Math.random() * 1.5, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Borde dorado
        ctx.strokeStyle = '#d4a853';
        ctx.lineWidth = 3;
        ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
        
        let y = 70;
        const centerX = canvas.width / 2;
        const maxWidth = canvas.width - 100;
        ctx.textAlign = 'center';
        
        // ========== HEADER ==========
        ctx.fillStyle = '#d4a853';
        ctx.font = 'bold 32px Georgia, serif';
        ctx.fillText('‚ú¶ TAROT 28 ARCANOS ‚ú¶', centerX, y);
        y += 25;
        ctx.font = '14px Georgia, serif';
        ctx.fillStyle = '#888';
        ctx.fillText('Los Trabajos de H√©rcules', centerX, y);
        y += 50;
        
        // ========== FECHA ==========
        const fechaStr = fecha.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        ctx.fillStyle = '#ffffff';
        ctx.font = '18px Georgia, serif';
        ctx.fillText(fechaStr, centerX, y);
        y += 45;
        
        // ========== EXALTACI√ìN ==========
        ctx.fillStyle = '#d4a853';
        ctx.font = 'bold 42px Georgia, serif';
        ctx.fillText(`${PLANET_SYMBOLS[exalt.planeta]} ${exalt.planeta} en ${SIGN_SYMBOLS[exalt.signo]} ${exalt.signo}`, centerX, y);
        y += 35;
        
        // Fase lunar y d√≠a
        ctx.fillStyle = '#aaaaaa';
        ctx.font = '16px Georgia, serif';
        ctx.fillText(`${fase.emoji} ${fase.nombre} ‚Ä¢ D√≠a lunar ${diaLunar} ‚Ä¢ ${infoDia.simbolo} ${infoDia.nombre}`, centerX, y);
        y += 50;
        
        // ========== POSICIONES PLANETARIAS ==========
        y = dibujarSeccion(ctx, '‚òø Posiciones Planetarias', y, centerX);
        ctx.fillStyle = '#ffffff';
        ctx.font = '22px Georgia, serif';
        const posStr = Object.entries(posiciones).map(([p, pos]) => `${pos.simbolo}${pos.signoSimbolo}`).join(' ');
        ctx.fillText(posStr, centerX, y);
        y += 45;
        
        // ========== FUNCIONES PLANETARIAS ==========
        y = dibujarSeccion(ctx, 'üé® Funciones Planetarias', y, centerX);
        const planetasPrincipales = ['Sol', 'Luna', 'Mercurio', 'Venus', 'Marte', 'J√∫piter', 'Saturno'];
        ctx.font = '14px Georgia, serif';
        planetasPrincipales.forEach(planeta => {
            const pos = posiciones[planeta];
            if (pos) {
                const colorInfo = getInfoColorPlanetario(planeta, pos.lon);
                if (colorInfo) {
                    ctx.fillStyle = colorInfo.color;
                    ctx.fillText(`${pos.simbolo} ${colorInfo.funcion}`, centerX, y);
                    y += 22;
                }
            }
        });
        y += 25;
        
        // ========== INTERPRETACI√ìN ==========
        y = dibujarSeccion(ctx, 'üìñ Interpretaci√≥n del D√≠a', y, centerX);
        ctx.fillStyle = '#ffffff';
        ctx.font = 'italic 15px Georgia, serif';
        const interpLineas = wrapText(ctx, interpLimpio, maxWidth);
        interpLineas.forEach(linea => {
            ctx.fillText(linea, centerX, y);
            y += 22;
        });
        y += 30;
        
        // ========== FIGURAS DEL D√çA ==========
        if (patrones.length > 0) {
            y = dibujarSeccion(ctx, '‚ú° Figuras del D√≠a', y, centerX);
            ctx.font = '14px Georgia, serif';
            patrones.forEach(p => {
                const def = PATRONES_DEF[p.tipo];
                if (def) {
                    ctx.fillStyle = def.color || '#d4a853';
                    const planetasStr = p.planetas.map(pl => PLANET_SYMBOLS[pl] || pl).join(' ');
                    ctx.fillText(`${def.icono} ${def.nombre}${p.elemento ? ' de ' + p.elemento : ''}: ${planetasStr}`, centerX, y);
                    y += 24;
                    // Descripci√≥n breve
                    ctx.fillStyle = '#999';
                    ctx.font = 'italic 12px Georgia, serif';
                    ctx.fillText(def.descripcion || '', centerX, y);
                    y += 22;
                    ctx.font = '14px Georgia, serif';
                }
            });
            y += 20;
        }
        
        // ========== ASPECTOS DEL D√çA ==========
        if (aspectosFiltrados.length > 0) {
            y = dibujarSeccion(ctx, '‚òç Aspectos del D√≠a', y, centerX);
            ctx.font = '14px Georgia, serif';
            aspectosFiltrados.slice(0, 6).forEach(a => {
                const pos1 = posiciones[a.planeta1];
                const pos2 = posiciones[a.planeta2];
                const color1 = pos1 ? getInfoColorPlanetario(a.planeta1, pos1.lon) : null;
                const color2 = pos2 ? getInfoColorPlanetario(a.planeta2, pos2.lon) : null;
                const func1 = color1 ? color1.funcion : a.planeta1;
                const func2 = color2 ? color2.funcion : a.planeta2;
                const sigAspecto = SIGNIFICADOS_ASPECTOS[a.tipo];
                
                ctx.fillStyle = a.color || '#888';
                ctx.fillText(`${PLANET_SYMBOLS[a.planeta1]}${a.simbolo}${PLANET_SYMBOLS[a.planeta2]} (${a.orbe}¬∞)`, centerX, y);
                y += 20;
                ctx.fillStyle = '#aaa';
                ctx.font = 'italic 12px Georgia, serif';
                ctx.fillText(`${func1} ${sigAspecto?.esencia || ''} ${func2}`, centerX, y);
                y += 22;
                ctx.font = '14px Georgia, serif';
            });
            y += 20;
        }
        
        // ========== TR√ÅNSITOS SOBRE CARTA NATAL ==========
        if (patronesNatal.length > 0 || aspectosNatal.length > 0) {
            y = dibujarSeccion(ctx, 'üåü Tr√°nsitos sobre tu Carta Natal', y, centerX, '#667eea');
            
            // Figuras tr√°nsito-natal
            if (patronesNatal.length > 0) {
                ctx.fillStyle = '#667eea';
                ctx.font = 'bold 13px Georgia, serif';
                ctx.fillText('Figuras Tr√°nsito-Natal:', centerX, y);
                y += 22;
                ctx.font = '13px Georgia, serif';
                patronesNatal.forEach(p => {
                    ctx.fillStyle = '#9999ff';
                    ctx.fillText(p.descripcion || `${p.tipo}`, centerX, y);
                    y += 20;
                });
                y += 15;
            }
            
            // Aspectos tr√°nsito-natal
            if (aspectosNatal.length > 0) {
                ctx.fillStyle = '#667eea';
                ctx.font = 'bold 13px Georgia, serif';
                ctx.fillText('Aspectos Tr√°nsito-Natal:', centerX, y);
                y += 22;
                ctx.font = '12px Georgia, serif';
                aspectosNatal.slice(0, 6).forEach(a => {
                    const infoT = getInfoColorPlanetario(a.planetaTransito, a.lonTransito);
                    const infoN = getInfoColorPlanetario(a.planetaNatal, a.lonNatal);
                    const funcT = infoT ? infoT.funcion : a.planetaTransito;
                    const funcN = infoN ? infoN.funcion : a.planetaNatal;
                    const esencia = SIGNIFICADOS_ASPECTOS[a.tipo]?.esencia || a.tipo;
                    
                    ctx.fillStyle = a.color || '#9999ff';
                    ctx.fillText(`${PLANET_SYMBOLS[a.planetaTransito]}${a.simbolo}${PLANET_SYMBOLS[a.planetaNatal]}‚Åø (${a.orbe}¬∞)`, centerX, y);
                    y += 18;
                    ctx.fillStyle = '#aaaaaa';
                    const textoFunc = `${funcT} ${esencia} ${funcN} natal`;
                    const lineas = wrapText(ctx, textoFunc, 700);
                    lineas.forEach(linea => {
                        ctx.fillText(linea, centerX, y);
                        y += 16;
                    });
                    y += 8;
                });
                y += 10;
            }
            y += 20;
        }
        
        // ========== CARTA DEL D√çA ==========
        y = dibujarSeccion(ctx, 'üÉè Carta del D√≠a', y, centerX);
        
        const cartaWidth = 140;
        const cartaHeight = 240;
        const cartaX = centerX - cartaWidth/2;
        const cartaY = y;
        
        let imagenCargada = false;
        
        // Intentar cargar imagen (desde base64 o URL)
        try {
            const imgCarta = await cargarImagenCanvas(carta.imagen);
            if (imgCarta && imgCarta.complete && imgCarta.naturalWidth > 0) {
                ctx.drawImage(imgCarta, cartaX, cartaY, cartaWidth, cartaHeight);
                ctx.strokeStyle = '#d4a853';
                ctx.lineWidth = 2;
                ctx.strokeRect(cartaX, cartaY, cartaWidth, cartaHeight);
                imagenCargada = true;
            }
        } catch(e) {
            console.log('No se pudo cargar imagen de carta:', e);
        }
        
        // Fallback: dibujar carta estilizada
        if (!imagenCargada) {
            // Fondo de carta
            const cartaGradient = ctx.createLinearGradient(cartaX, cartaY, cartaX + cartaWidth, cartaY + cartaHeight);
            cartaGradient.addColorStop(0, '#1a1a4e');
            cartaGradient.addColorStop(0.5, '#2a2a6e');
            cartaGradient.addColorStop(1, '#1a1a4e');
            ctx.fillStyle = cartaGradient;
            ctx.fillRect(cartaX, cartaY, cartaWidth, cartaHeight);
            
            // Borde dorado doble
            ctx.strokeStyle = '#d4a853';
            ctx.lineWidth = 3;
            ctx.strokeRect(cartaX, cartaY, cartaWidth, cartaHeight);
            ctx.strokeStyle = 'rgba(212, 168, 83, 0.4)';
            ctx.lineWidth = 1;
            ctx.strokeRect(cartaX + 8, cartaY + 8, cartaWidth - 16, cartaHeight - 16);
            
            // Decoraci√≥n superior
            ctx.fillStyle = '#d4a853';
            ctx.font = '18px Georgia, serif';
            ctx.fillText('‚òÜ', centerX, cartaY + 28);
            
            // N√∫mero de la carta grande
            ctx.font = 'bold 48px Cinzel, Georgia, serif';
            ctx.fillStyle = '#d4a853';
            ctx.fillText(carta.numero, centerX, cartaY + cartaHeight/2 + 10);
            
            // Nombre de la carta
            ctx.font = 'bold 11px Georgia, serif';
            ctx.fillStyle = 'rgba(212, 168, 83, 0.9)';
            ctx.fillText(carta.nombreEs, centerX, cartaY + cartaHeight - 30);
            
            // Decoraci√≥n inferior
            ctx.font = '18px Georgia, serif';
            ctx.fillText('‚òÜ', centerX, cartaY + cartaHeight - 12);
        }
        y += cartaHeight + 25;
        
        // Nombre de la carta
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 20px Georgia, serif';
        ctx.fillText(`${carta.numero} - ${carta.nombreEs}`, centerX, y);
        y += 25;
        
        // Palabras clave
        ctx.font = '14px Georgia, serif';
        ctx.fillStyle = '#d4a853';
        ctx.fillText(carta.palabrasClave.join(' ‚Ä¢ '), centerX, y);
        y += 40;
        
        // ========== MITO ==========
        y = dibujarSeccion(ctx, `üìú ${exalt.titulo}`, y, centerX);
        ctx.fillStyle = '#cccccc';
        ctx.font = 'italic 14px Georgia, serif';
        const mitoLineas = wrapText(ctx, exalt.texto, maxWidth);
        mitoLineas.forEach(linea => {
            ctx.fillText(linea, centerX, y);
            y += 20;
        });
        y += 15;
        ctx.fillStyle = '#666';
        ctx.font = 'italic 11px Georgia, serif';
        ctx.fillText('‚Äî Los Mitos Griegos, Robert Graves', centerX, y);
        y += 35;
        
        // ========== EVENTOS ==========
        if (eventos.length > 0) {
            y = dibujarSeccion(ctx, `üìã Eventos del D√≠a (${eventos.length})`, y, centerX);
            ctx.font = '14px Georgia, serif';
            eventos.forEach(e => {
                const cat = CATEGORIAS_EVENTOS[e.categoria] || CATEGORIAS_EVENTOS.otro;
                ctx.fillStyle = cat.color || '#d4a853';
                ctx.fillText(`${cat.icon} ${e.titulo}`, centerX, y);
                y += 20;
                if (e.hora) {
                    ctx.fillStyle = '#888';
                    ctx.font = '12px Georgia, serif';
                    ctx.fillText(e.hora, centerX, y);
                    y += 18;
                    ctx.font = '14px Georgia, serif';
                }
                y += 15;
            });
        }
        
        // ========== FOOTER ==========
        y = canvas.height - 50;
        ctx.fillStyle = 'rgba(212, 168, 83, 0.3)';
        ctx.fillRect(50, y - 5, canvas.width - 100, 1);
        y += 20;
        ctx.fillStyle = '#666666';
        ctx.font = '12px Georgia, serif';
        ctx.fillText('Tarot 28 Arcanos - Los Trabajos de H√©rcules', centerX, y);
        
        return canvas;
    }
    
    // Funci√≥n auxiliar para dibujar t√≠tulo de secci√≥n
    function dibujarSeccion(ctx, titulo, y, centerX, color = '#d4a853') {
        ctx.fillStyle = color;
        ctx.font = 'bold 16px Georgia, serif';
        ctx.fillText(titulo, centerX, y);
        return y + 25;
    }
    
    // Funci√≥n para cargar imagen en canvas (usa base64 si est√° disponible)
    function cargarImagenCanvas(src) {
        return new Promise((resolve) => {
            // Si ya es un data URL (base64), cargarlo directamente
            if (src && src.startsWith('data:')) {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => resolve(null);
                img.src = src;
                return;
            }
            
            // Verificar si tenemos la imagen en el diccionario base64
            if (typeof TAROT_IMAGES_BASE64 !== 'undefined' && TAROT_IMAGES_BASE64[src]) {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => resolve(null);
                img.src = TAROT_IMAGES_BASE64[src];
                return;
            }
            
            // Fallback: cargar desde URL
            const img = new Image();
            if (window.location.protocol !== 'file:') {
                img.crossOrigin = 'anonymous';
            }
            
            const timeout = setTimeout(() => {
                console.log('Timeout cargando imagen:', src);
                resolve(null);
            }, 5000);
            
            img.onload = () => {
                clearTimeout(timeout);
                resolve(img);
            };
            img.onerror = (e) => {
                clearTimeout(timeout);
                console.log('Error cargando imagen:', src, e);
                resolve(null);
            };
            img.src = src;
        });
    }
    
    // Funci√≥n auxiliar para envolver texto
    function wrapText(ctx, text, maxWidth) {
        if (!text) return [];
        const palabras = text.split(' ');
        const lineas = [];
        let linea = '';
        
        palabras.forEach(palabra => {
            const test = linea + palabra + ' ';
            if (ctx.measureText(test).width > maxWidth && linea) {
                lineas.push(linea.trim());
                linea = palabra + ' ';
            } else {
                linea = test;
            }
        });
        if (linea.trim()) lineas.push(linea.trim());
        return lineas;
    }
    
    window.abrirModalEventoDia = function() {
        resetEventForm();
        const fecha = state.fechaSeleccionada || new Date();
        // Formatear fecha correctamente para input type="date" (YYYY-MM-DD)
        const year = fecha.getFullYear();
        const month = String(fecha.getMonth() + 1).padStart(2, '0');
        const day = String(fecha.getDate()).padStart(2, '0');
        const fechaStr = `${year}-${month}-${day}`;
        document.getElementById('event-date').value = fechaStr;
        document.getElementById('modal-event').classList.add('active');
    };
    
    window.verEvento = function(id) {
        const evento = state.eventos.find(e => e.id === id);
        if (!evento) return;
        
        const cat = CATEGORIAS_EVENTOS[evento.categoria] || CATEGORIAS_EVENTOS.otro;
        const fechaFormateada = new Date(evento.fecha).toLocaleDateString('es-ES', {
            weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
        });
        
        // Texto de recurrencia
        const recurrenciaTexto = {
            'none': '',
            'daily': 'üîÑ Cada d√≠a',
            'weekly': 'üîÑ Cada semana',
            'monthly': 'üîÑ Cada mes',
            'yearly': 'üéÇ Cada a√±o'
        };
        
        // Periodo de recurrencia
        let periodoTexto = '';
        if (evento.recurrencia && evento.recurrencia !== 'none') {
            const desde = evento.recInicio ? new Date(evento.recInicio).toLocaleDateString('es-ES', {day: 'numeric', month: 'short', year: 'numeric'}) : '';
            const hasta = evento.recFin ? new Date(evento.recFin).toLocaleDateString('es-ES', {day: 'numeric', month: 'short', year: 'numeric'}) : 'siempre';
            if (desde || evento.recFin) {
                periodoTexto = ` (${desde} ‚Üí ${hasta})`;
            }
        }
        
        let html = `
            <div style="margin-bottom:16px;">
                <h3 style="font-family:'Cinzel',serif;font-size:1.3rem;color:var(--text);margin-bottom:8px;">${evento.titulo}</h3>
                <div style="display:flex;flex-wrap:wrap;gap:12px;font-size:0.85rem;color:var(--text-dim);">
                    <span>${fechaFormateada}</span>
                    <span>${evento.hora || '--:--'}</span>
                    <span>${cat.icon} ${cat.nombre}</span>
                </div>
                ${evento.recurrencia && evento.recurrencia !== 'none' ? `
                    <div style="margin-top:8px;font-size:0.85rem;color:var(--gold);">
                        ${recurrenciaTexto[evento.recurrencia] || ''}${periodoTexto}
                    </div>
                ` : ''}
            </div>
        `;
        
        if (evento.notas) {
            html += `<div style="white-space:pre-wrap;color:var(--text);line-height:1.6;margin-bottom:16px;">${evento.notas}</div>`;
        }
        
        if (evento.fotos && evento.fotos.length > 0) {
            html += `
                <div class="event-detail-photos">
                    ${evento.fotos.map(foto => `<img src="${foto}" alt="Foto" class="event-photo-view">`).join('')}
                </div>
            `;
        }
        
        if (evento.videos && evento.videos.length > 0) {
            html += `<div class="event-detail-videos">`;
            evento.videos.forEach(url => {
                if (url.startsWith('data:') || url.startsWith('blob:')) {
                    // V√≠deo local
                    html += `<video src="${url}" controls style="width:100%;max-height:300px;border-radius:8px;"></video>`;
                } else {
                    // YouTube
                    const videoId = extractYouTubeId(url);
                    if (videoId) {
                        html += `<iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>`;
                    }
                }
            });
            html += `</div>`;
        }
        
        // Secci√≥n de exportar a calendario con alarma
        html += `
            <div class="export-calendar-section">
                <div class="export-calendar-title">üìÖ A√±adir a Calendario</div>
                
                <div class="alarm-selector">
                    <label>‚è∞ Recordatorio:</label>
                    <select id="alarm-time-${evento.id}">
                        <option value="0">Sin recordatorio</option>
                        <option value="5">5 minutos antes</option>
                        <option value="15">15 minutos antes</option>
                        <option value="30" selected>30 minutos antes</option>
                        <option value="60">1 hora antes</option>
                        <option value="120">2 horas antes</option>
                        <option value="1440">1 d√≠a antes</option>
                        <option value="2880">2 d√≠as antes</option>
                        <option value="10080">1 semana antes</option>
                    </select>
                </div>
                
                <div class="export-btns">
                    <button class="export-btn google" onclick="exportarAGoogleCalendar(${evento.id})">
                        <span class="icon">üìÜ</span>
                        Google Calendar
                    </button>
                    <button class="export-btn" onclick="descargarICS(${evento.id})">
                        <span class="icon">üì•</span>
                        Descargar .ics
                    </button>
                </div>
            </div>
            
            <div class="export-calendar-section">
                <div class="export-calendar-title">üìÑ Exportar Evento</div>
                <div style="display:flex;gap:10px;margin-top:10px;">
                    <button class="export-btn" onclick="exportarEventoAPNG(${evento.id})" style="flex:1;">
                        <span class="icon">üñºÔ∏è</span>
                        PNG
                    </button>
                    <button class="export-btn" onclick="exportarEventoAPDF(${evento.id})" style="flex:1;background:linear-gradient(135deg,#e74c3c,#c0392b);">
                        <span class="icon">üìÑ</span>
                        PDF
                    </button>
                </div>
            </div>
        `;
        
        html += `
            <div class="event-actions">
                <button class="event-btn-edit" onclick="editarEvento(${evento.id})">‚úèÔ∏è Editar</button>
                <button class="event-btn-delete" onclick="eliminarEventoUI(${evento.id});document.getElementById('modal').classList.remove('active');">üóëÔ∏è Eliminar</button>
            </div>
        `;
        
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('modal-title').textContent = cat.icon + ' Evento';
        document.getElementById('modal').classList.add('active');
        
        // A√±adir eventos a las fotos para ampliar
        document.querySelectorAll('.event-photo-view').forEach(img => {
            img.addEventListener('click', () => {
                document.getElementById('photo-lightbox-img').src = img.src;
                document.getElementById('photo-lightbox').classList.add('active');
            });
        });
    };
    
    // ========================================================================
    // FUNCIONES DE EXPORTAR A CALENDARIO
    // ========================================================================
    
    function formatDateForICS(fecha, hora) {
        // Formato: YYYYMMDDTHHMMSS
        const date = fecha.replace(/-/g, '');
        const time = hora ? hora.replace(/:/g, '') + '00' : '000000';
        return date + 'T' + time;
    }
    
    function formatDateForGoogle(fecha, hora) {
        // Formato: YYYYMMDDTHHMMSS
        const date = fecha.replace(/-/g, '');
        const time = hora ? hora.replace(/:/g, '') + '00' : '000000';
        return date + 'T' + time;
    }
    
    function generarICS(evento, alarmMinutes = 30) {
        const cat = CATEGORIAS_EVENTOS[evento.categoria] || CATEGORIAS_EVENTOS.otro;
        const dtstart = formatDateForICS(evento.fecha, evento.hora);
        // Si hay hora, el evento dura 1 hora, si no, es todo el d√≠a
        let dtend;
        if (evento.hora) {
            const [h, m] = evento.hora.split(':').map(Number);
            const endH = String((h + 1) % 24).padStart(2, '0');
            dtend = formatDateForICS(evento.fecha, `${endH}:${String(m).padStart(2, '0')}`);
        } else {
            // Evento de todo el d√≠a: fecha siguiente
            const nextDay = new Date(evento.fecha);
            nextDay.setDate(nextDay.getDate() + 1);
            dtend = nextDay.toISOString().slice(0, 10).replace(/-/g, '');
        }
        
        const uid = `${evento.id}@tarot28.app`;
        const dtstamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        const summary = `${cat.icon} ${evento.titulo}`.replace(/,/g, '\\,');
        const description = (evento.notas || '').replace(/,/g, '\\,').replace(/\n/g, '\\n');
        
        let ics = [
            'BEGIN:VCALENDAR',
            'VERSION:2.0',
            'PRODID:-//Tarot 28 Arcanos//ES',
            'CALSCALE:GREGORIAN',
            'METHOD:PUBLISH',
            'BEGIN:VEVENT',
            `UID:${uid}`,
            `DTSTAMP:${dtstamp}`
        ];
        
        if (evento.hora) {
            ics.push(`DTSTART:${dtstart}`);
            ics.push(`DTEND:${dtend}`);
        } else {
            ics.push(`DTSTART;VALUE=DATE:${dtstart.split('T')[0]}`);
            ics.push(`DTEND;VALUE=DATE:${dtend}`);
        }
        
        ics.push(`SUMMARY:${summary}`);
        ics.push(`DESCRIPTION:${description}`);
        ics.push('STATUS:CONFIRMED');
        ics.push('TRANSP:OPAQUE');
        
        // A√±adir alarma si se especific√≥
        if (alarmMinutes > 0) {
            ics.push('BEGIN:VALARM');
            ics.push('ACTION:DISPLAY');
            ics.push(`DESCRIPTION:Recordatorio: ${evento.titulo}`);
            ics.push(`TRIGGER:-PT${alarmMinutes}M`);
            ics.push('END:VALARM');
        }
        
        ics.push('END:VEVENT');
        ics.push('END:VCALENDAR');
        
        return ics.join('\r\n');
    }
    
    window.descargarICS = function(id) {
        const evento = state.eventos.find(e => e.id === id);
        if (!evento) return;
        
        // Obtener el tiempo de alarma seleccionado
        const alarmSelect = document.getElementById(`alarm-time-${id}`);
        const alarmMinutes = alarmSelect ? parseInt(alarmSelect.value) : 30;
        
        const icsContent = generarICS(evento, alarmMinutes);
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `${evento.titulo.replace(/[^a-zA-Z0-9√°√©√≠√≥√∫√±√Å√â√ç√ì√ö√ë ]/g, '')}.ics`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Mostrar mensaje si hay alarma
        if (alarmMinutes > 0) {
            const tiempoTexto = alarmMinutes >= 1440 ? `${alarmMinutes/1440} d√≠a(s)` : 
                               alarmMinutes >= 60 ? `${alarmMinutes/60} hora(s)` : 
                               `${alarmMinutes} minutos`;
            alert(`üì• Archivo descargado con recordatorio ${tiempoTexto} antes.\n\nImporta el archivo .ics en tu aplicaci√≥n de calendario.`);
        }
    };
    
    window.exportarAGoogleCalendar = function(id) {
        const evento = state.eventos.find(e => e.id === id);
        if (!evento) return;
        
        // Obtener el tiempo de alarma seleccionado
        const alarmSelect = document.getElementById(`alarm-time-${id}`);
        const alarmMinutes = alarmSelect ? parseInt(alarmSelect.value) : 30;
        
        const cat = CATEGORIAS_EVENTOS[evento.categoria] || CATEGORIAS_EVENTOS.otro;
        const title = encodeURIComponent(`${cat.icon} ${evento.titulo}`);
        
        // A√±adir nota sobre recordatorio en la descripci√≥n
        let descripcion = evento.notas || '';
        if (alarmMinutes > 0) {
            const tiempoTexto = alarmMinutes >= 1440 ? `${alarmMinutes/1440} d√≠a(s)` : 
                               alarmMinutes >= 60 ? `${alarmMinutes/60} hora(s)` : 
                               `${alarmMinutes} minutos`;
            descripcion += `\n\n‚è∞ Recordatorio sugerido: ${tiempoTexto} antes`;
        }
        const details = encodeURIComponent(descripcion);
        
        let dates;
        if (evento.hora) {
            const dtstart = formatDateForGoogle(evento.fecha, evento.hora);
            const [h, m] = evento.hora.split(':').map(Number);
            const endH = String((h + 1) % 24).padStart(2, '0');
            const dtend = formatDateForGoogle(evento.fecha, `${endH}:${String(m).padStart(2, '0')}`);
            dates = `${dtstart}/${dtend}`;
        } else {
            // Evento de todo el d√≠a
            const date = evento.fecha.replace(/-/g, '');
            dates = `${date}/${date}`;
        }
        
        const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dates}&details=${details}`;
        
        // Mostrar mensaje sobre c√≥mo configurar la alarma
        if (alarmMinutes > 0) {
            const tiempoTexto = alarmMinutes >= 1440 ? `${alarmMinutes/1440} d√≠a(s)` : 
                               alarmMinutes >= 60 ? `${alarmMinutes/60} hora(s)` : 
                               `${alarmMinutes} minutos`;
            alert(`üìÜ Se abrir√° Google Calendar.\n\n‚è∞ Para a√±adir el recordatorio de ${tiempoTexto} antes:\n1. Revisa los detalles del evento\n2. Haz clic en "M√°s opciones"\n3. Configura la notificaci√≥n manualmente\n\nGoogle Calendar no permite a√±adir alarmas autom√°ticamente desde enlaces externos.`);
        }
        
        window.open(url, '_blank');
    };
    
    window.exportarTodosEventos = function(alarmMinutes = 30) {
        if (state.eventos.length === 0) {
            alert('No hay eventos para exportar');
            return;
        }
        
        let ics = [
            'BEGIN:VCALENDAR',
            'VERSION:2.0',
            'PRODID:-//Tarot 28 Arcanos//ES',
            'CALSCALE:GREGORIAN',
            'METHOD:PUBLISH'
        ];
        
        state.eventos.forEach(evento => {
            const cat = CATEGORIAS_EVENTOS[evento.categoria] || CATEGORIAS_EVENTOS.otro;
            const dtstart = formatDateForICS(evento.fecha, evento.hora);
            let dtend;
            if (evento.hora) {
                const [h, m] = evento.hora.split(':').map(Number);
                const endH = String((h + 1) % 24).padStart(2, '0');
                dtend = formatDateForICS(evento.fecha, `${endH}:${String(m).padStart(2, '0')}`);
            } else {
                const nextDay = new Date(evento.fecha);
                nextDay.setDate(nextDay.getDate() + 1);
                dtend = nextDay.toISOString().slice(0, 10).replace(/-/g, '');
            }
            
            const uid = `${evento.id}@tarot28.app`;
            const dtstamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            const summary = `${cat.icon} ${evento.titulo}`.replace(/,/g, '\\,');
            const description = (evento.notas || '').replace(/,/g, '\\,').replace(/\n/g, '\\n');
            
            ics.push('BEGIN:VEVENT');
            ics.push(`UID:${uid}`);
            ics.push(`DTSTAMP:${dtstamp}`);
            
            if (evento.hora) {
                ics.push(`DTSTART:${dtstart}`);
                ics.push(`DTEND:${dtend}`);
            } else {
                ics.push(`DTSTART;VALUE=DATE:${dtstart.split('T')[0]}`);
                ics.push(`DTEND;VALUE=DATE:${dtend}`);
            }
            
            ics.push(`SUMMARY:${summary}`);
            ics.push(`DESCRIPTION:${description}`);
            ics.push('STATUS:CONFIRMED');
            
            // A√±adir alarma
            if (alarmMinutes > 0) {
                ics.push('BEGIN:VALARM');
                ics.push('ACTION:DISPLAY');
                ics.push(`DESCRIPTION:Recordatorio: ${evento.titulo}`);
                ics.push(`TRIGGER:-PT${alarmMinutes}M`);
                ics.push('END:VALARM');
            }
            
            ics.push('END:VEVENT');
        });
        
        ics.push('END:VCALENDAR');
        
        const blob = new Blob([ics.join('\r\n')], { type: 'text/calendar;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'mis_eventos_tarot28.ics';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert(`üì• Exportados ${state.eventos.length} eventos con recordatorio de 30 minutos.\n\nImporta el archivo .ics en tu calendario.`);
    };
    
    // Exportar un evento a Word
    window.exportarEventoAWord = function(id) {
        const evento = state.eventos.find(e => e.id === id);
        if (!evento) return;
        
        let contenido = generarHTMLWord([evento], true, `Evento: ${evento.titulo}`);
        descargarWord(contenido, `evento_${evento.titulo.replace(/[^a-z0-9]/gi, '_')}.doc`);
    };
    
    // Exportar evento como PNG
    window.exportarEventoAPNG = async function(id) {
        const evento = state.eventos.find(e => e.id === id);
        if (!evento) return;
        
        const canvas = await generarCanvasEvento(evento);
        
        // Descargar PNG
        const link = document.createElement('a');
        const fechaFile = new Date(evento.fecha).toISOString().split('T')[0];
        link.download = `evento_${evento.titulo.replace(/[^a-z0-9]/gi, '_')}_${fechaFile}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    };
    
    // Exportar evento como PDF
    window.exportarEventoAPDF = async function(id) {
        const evento = state.eventos.find(e => e.id === id);
        if (!evento) return;
        
        const canvas = await generarCanvasEvento(evento);
        
        // Crear PDF
        const { jsPDF } = window.jspdf;
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 297; // A4 height in mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        const pdf = new jsPDF('p', 'mm', 'a4');
        let position = 0;
        let heightLeft = imgHeight;
        
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        while (heightLeft > 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }
        
        const fechaFile = new Date(evento.fecha).toISOString().split('T')[0];
        pdf.save(`evento_${evento.titulo.replace(/[^a-z0-9]/gi, '_')}_${fechaFile}.pdf`);
    };
    
    // Generar canvas para evento (usado por PNG y PDF)
    async function generarCanvasEvento(evento) {
        const cat = CATEGORIAS_EVENTOS[evento.categoria] || CATEGORIAS_EVENTOS.otro;
        const fechaEvento = new Date(evento.fecha);
        const fechaFormateada = fechaEvento.toLocaleDateString('es-ES', {
            weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
        });
        
        // Calcular altura seg√∫n contenido
        let alturaEstimada = 200; // Header
        alturaEstimada += evento.notas ? Math.ceil(evento.notas.length / 60) * 25 + 50 : 0;
        if (evento.fotos && evento.fotos.length > 0) {
            alturaEstimada += 250 * evento.fotos.length;
        }
        alturaEstimada += 100; // Footer
        
        // Crear canvas
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = Math.max(500, alturaEstimada);
        
        // Fondo
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#0a0a1a');
        gradient.addColorStop(0.5, '#12121f');
        gradient.addColorStop(1, '#0a0a1a');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Borde
        ctx.strokeStyle = cat.color || '#d4a853';
        ctx.lineWidth = 4;
        ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
        
        let y = 70;
        const centerX = canvas.width / 2;
        const maxWidth = canvas.width - 100;
        ctx.textAlign = 'center';
        
        // Categor√≠a
        ctx.fillStyle = cat.color || '#d4a853';
        ctx.font = 'bold 24px Georgia, serif';
        ctx.fillText(`${cat.icon} ${cat.nombre}`, centerX, y);
        y += 50;
        
        // T√≠tulo
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 28px Georgia, serif';
        const tituloLineas = wrapText(ctx, evento.titulo, maxWidth);
        tituloLineas.forEach(linea => {
            ctx.fillText(linea, centerX, y);
            y += 35;
        });
        y += 20;
        
        // Fecha y hora
        ctx.fillStyle = '#aaaaaa';
        ctx.font = '18px Georgia, serif';
        ctx.fillText(`üìÖ ${fechaFormateada}`, centerX, y);
        y += 30;
        if (evento.hora) {
            ctx.fillText(`‚è∞ ${evento.hora}`, centerX, y);
            y += 30;
        }
        
        // Recurrencia
        if (evento.recurrencia && evento.recurrencia !== 'none') {
            const recTexto = {
                'daily': 'üîÑ Se repite cada d√≠a',
                'weekly': 'üîÑ Se repite cada semana',
                'monthly': 'üîÑ Se repite cada mes',
                'yearly': 'üéÇ Se repite cada a√±o'
            };
            ctx.fillStyle = '#d4a853';
            ctx.fillText(recTexto[evento.recurrencia] || '', centerX, y);
            y += 25;
            
            // Mostrar periodo si existe
            if (evento.recInicio || evento.recFin) {
                const desde = evento.recInicio ? new Date(evento.recInicio).toLocaleDateString('es-ES', {day: 'numeric', month: 'short', year: 'numeric'}) : '';
                const hasta = evento.recFin ? new Date(evento.recFin).toLocaleDateString('es-ES', {day: 'numeric', month: 'short', year: 'numeric'}) : 'siempre';
                ctx.fillStyle = '#888888';
                ctx.font = '14px Georgia, serif';
                ctx.fillText(`(${desde} ‚Üí ${hasta})`, centerX, y);
                y += 25;
            }
        }
        y += 20;
        
        // Notas
        if (evento.notas) {
            ctx.fillStyle = '#d4a853';
            ctx.font = 'bold 16px Georgia, serif';
            ctx.fillText('üìù Notas', centerX, y);
            y += 25;
            
            ctx.fillStyle = '#cccccc';
            ctx.font = '15px Georgia, serif';
            const notasLineas = wrapText(ctx, evento.notas, maxWidth);
            notasLineas.forEach(linea => {
                ctx.fillText(linea, centerX, y);
                y += 22;
            });
            y += 30;
        }
        
        // Fotos
        if (evento.fotos && evento.fotos.length > 0) {
            ctx.fillStyle = '#d4a853';
            ctx.font = 'bold 16px Georgia, serif';
            ctx.fillText('üì∑ Fotos', centerX, y);
            y += 30;
            
            for (const foto of evento.fotos) {
                try {
                    const img = await cargarImagenCanvas(foto);
                    if (img) {
                        const maxW = 400;
                        const maxH = 200;
                        let w = img.width;
                        let h = img.height;
                        
                        if (w > maxW) {
                            h = h * maxW / w;
                            w = maxW;
                        }
                        if (h > maxH) {
                            w = w * maxH / h;
                            h = maxH;
                        }
                        
                        const x = centerX - w / 2;
                        ctx.drawImage(img, x, y, w, h);
                        
                        // Borde de foto
                        ctx.strokeStyle = '#d4a853';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(x, y, w, h);
                        
                        y += h + 20;
                    }
                } catch(e) {
                    console.log('Error cargando foto:', e);
                }
            }
        }
        
        // Footer
        ctx.fillStyle = '#666666';
        ctx.font = '12px Georgia, serif';
        ctx.fillText('Tarot 28 Arcanos', centerX, canvas.height - 40);
        
        return canvas;
    }
    
    // Exportar todos los eventos a Word
    window.exportarTodosEventosAWord = function(incluirImagenes = true) {
        if (state.eventos.length === 0) {
            alert('No hay eventos para exportar');
            return;
        }
        
        const eventosOrdenados = [...state.eventos].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
        let contenido = generarHTMLWord(eventosOrdenados, incluirImagenes, 'Mis Eventos - Tarot 28 Arcanos');
        descargarWord(contenido, `todos_eventos_${new Date().toISOString().split('T')[0]}.doc`);
    };
    
    // Generar documento Word con im√°genes embebidas
    function generarHTMLWord(eventos, incluirImagenes, titulo) {
        let html = `<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!--[if gte mso 9]><xml><w:WordDocument><w:View>Print</w:View></w:WordDocument></xml><![endif]-->
<title>${titulo}</title>
<style>
body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; line-height: 1.5; margin: 40px; }
h1 { font-size: 18pt; color: #1a1a4e; border-bottom: 2px solid #d4a853; padding-bottom: 8px; }
h2 { font-size: 14pt; color: #d4a853; margin-top: 20px; }
.evento { margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-left: 4px solid #d4a853; }
.evento-titulo { font-size: 14pt; font-weight: bold; color: #1a1a4e; margin-bottom: 8px; }
.evento-meta { font-size: 10pt; color: #666; margin-bottom: 10px; }
.evento-notas { margin-top: 10px; white-space: pre-wrap; }
.evento-fotos { margin-top: 15px; }
.footer { margin-top: 30px; font-size: 9pt; color: #999; text-align: center; border-top: 1px solid #ddd; padding-top: 10px; }
</style>
</head>
<body>
<h1>${titulo}</h1>
<p style="color:#666;font-size:10pt;">Exportado el ${new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
`;
        
        let mesActual = '';
        
        eventos.forEach(evento => {
            const fechaEvento = new Date(evento.fecha);
            const mesEvento = fechaEvento.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            
            if (eventos.length > 1 && mesEvento !== mesActual) {
                mesActual = mesEvento;
                html += `<h2>üìÖ ${mesEvento.charAt(0).toUpperCase() + mesEvento.slice(1)}</h2>`;
            }
            
            const cat = CATEGORIAS_EVENTOS[evento.categoria] || CATEGORIAS_EVENTOS.otro;
            const fechaFormateada = fechaEvento.toLocaleDateString('es-ES', {
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
            });
            
            html += `
<div class="evento">
<div class="evento-titulo">${cat.icon} ${evento.titulo}</div>
<div class="evento-meta">üìÜ ${fechaFormateada} | ‚è∞ ${evento.hora || 'Sin hora'} | ${cat.icon} ${cat.nombre}</div>
`;
            
            if (evento.notas) {
                html += `<div class="evento-notas">${evento.notas}</div>`;
            }
            
            // Im√°genes directamente en base64
            if (incluirImagenes && evento.fotos && evento.fotos.length > 0) {
                html += `<div class="evento-fotos">`;
                evento.fotos.forEach(foto => {
                    html += `<p><img src="${foto}" width="400" style="max-width:400px;border:1px solid #ccc;"></p>`;
                });
                html += `</div>`;
            }
            
            html += `</div>`;
        });
        
        html += `
<div class="footer">Generado por Tarot 28 Arcanos - ${new Date().getFullYear()}</div>
</body>
</html>`;
        
        return html;
    }
    
    // Descargar archivo Word
    function descargarWord(contenido, filename) {
        const blob = new Blob(['\ufeff' + contenido], { 
            type: 'application/msword;charset=utf-8' 
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // Fin de funciones de exportar
    
    window.editarEvento = function(id) {
        const evento = state.eventos.find(e => e.id === id);
        if (!evento) return;
        
        currentEditEventId = id;
        document.getElementById('event-title').value = evento.titulo;
        document.getElementById('event-date').value = evento.fecha;
        document.getElementById('event-time').value = evento.hora || '';
        document.getElementById('event-notes').value = evento.notas || '';
        document.getElementById('event-recurrence').value = evento.recurrencia || 'none';
        document.getElementById('event-rec-start').value = evento.recInicio || evento.fecha;
        document.getElementById('event-rec-end').value = evento.recFin || '';
        
        // Mostrar/ocultar campos de recurrencia
        const datesDiv = document.getElementById('recurrence-dates');
        datesDiv.style.display = (evento.recurrencia && evento.recurrencia !== 'none') ? 'block' : 'none';
        
        document.querySelectorAll('#event-categories .category-item').forEach(i => i.classList.remove('selected'));
        document.querySelector(`#event-categories .category-item[data-cat="${evento.categoria}"]`)?.classList.add('selected');
        
        tempEventPhotos = evento.fotos ? [...evento.fotos] : [];
        tempEventVideos = evento.videos ? [...evento.videos] : [];
        renderEventPhotosPreview();
        renderEventVideosList();
        
        document.getElementById('modal').classList.remove('active');
        document.getElementById('modal-event').classList.add('active');
    };
    
    function eliminarEventoUI(id) {
        if (confirm('¬øEliminar este evento?')) {
            eliminarEvento(id);
            renderCalendario();
        }
    }
    window.eliminarEventoUI = eliminarEventoUI;
    
    // Modal de eventos
    document.getElementById('modal-event-close')?.addEventListener('click', () => {
        document.getElementById('modal-event').classList.remove('active');
    });
    
    document.querySelectorAll('#event-categories .category-item').forEach(item => {
        item.addEventListener('click', () => {
            document.querySelectorAll('#event-categories .category-item').forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
        });
    });
    
    // Fotos
    document.getElementById('event-photos-gallery')?.addEventListener('change', handleEventPhotoUpload);
    document.getElementById('event-photos-camera')?.addEventListener('change', handleEventPhotoUpload);
    
    // V√≠deos locales
    document.getElementById('event-video-file')?.addEventListener('change', handleEventVideoUpload);
    document.getElementById('event-video-camera')?.addEventListener('change', handleEventVideoUpload);
    
    // V√≠deos YouTube
    document.getElementById('event-add-video')?.addEventListener('click', () => {
        const input = document.getElementById('event-video-url');
        const url = input.value.trim();
        if (url && (url.includes('youtube.com') || url.includes('youtu.be'))) {
            tempEventVideos.push(url);
            renderEventVideosList();
            input.value = '';
        } else if (url) {
            alert('Por favor, introduce un enlace de YouTube v√°lido');
        }
    });
    
    // Guardar evento
    document.getElementById('event-save')?.addEventListener('click', () => {
        const categoria = document.querySelector('#event-categories .category-item.selected')?.dataset.cat || 'otro';
        const titulo = document.getElementById('event-title').value.trim();
        const fecha = document.getElementById('event-date').value;
        const hora = document.getElementById('event-time').value;
        const notas = document.getElementById('event-notes').value;
        const recurrencia = document.getElementById('event-recurrence').value;
        const recInicio = document.getElementById('event-rec-start').value || fecha;
        const recFin = document.getElementById('event-rec-end').value || '';
        
        if (!titulo || !fecha) {
            alert('Por favor, introduce t√≠tulo y fecha');
            return;
        }
        
        if (currentEditEventId) {
            // Editar existente
            const index = state.eventos.findIndex(e => e.id === currentEditEventId);
            if (index !== -1) {
                state.eventos[index] = {
                    ...state.eventos[index],
                    categoria, titulo, fecha, hora, notas, recurrencia, recInicio, recFin,
                    fotos: tempEventPhotos,
                    videos: tempEventVideos
                };
            }
        } else {
            // Nuevo evento
            agregarEvento({ 
                categoria, titulo, fecha, hora, notas, recurrencia, recInicio, recFin,
                fotos: tempEventPhotos,
                videos: tempEventVideos
            });
        }
        
        guardarEventos();
        resetEventForm();
        document.getElementById('modal-event').classList.remove('active');
        
        if (state.currentScreen === 'calendario') {
            renderCalendario();
            // Re-renderizar los eventos del d√≠a si hay uno seleccionado
            if (state.fechaSeleccionada) {
                renderEventosDelDia(state.fechaSeleccionada);
            }
        }
    });
    
    document.getElementById('modal-event')?.addEventListener('click', (e) => {
        if (e.target.id === 'modal-event') {
            document.getElementById('modal-event').classList.remove('active');
        }
    });
    
    // Lightbox para fotos
    document.getElementById('photo-lightbox-close')?.addEventListener('click', () => {
        document.getElementById('photo-lightbox').classList.remove('active');
    });
    
    document.getElementById('photo-lightbox')?.addEventListener('click', (e) => {
        if (e.target.id === 'photo-lightbox') {
            document.getElementById('photo-lightbox').classList.remove('active');
        }
    });

    renderHoy();
    </script>
    <script src="modules-personal.js"></script>
    
    <script>
        // Inicializar banner AdMob despu√©s de cargar la p√°gina
        window.addEventListener('load', function() {
            try {
                (adsbygoogle = window.adsbygoogle || []).push({});
                console.log('‚úÖ Banner AdMob inicializado');
            } catch (err) {
                console.log('‚ö†Ô∏è Error al cargar AdMob:', err);
            }
        });
    </script>
</body>
</html>
